var fileUpdateCnt = 0;
var loadFile = 0;
var closeProductNumber = 0;
var $thisUploadCheck = '', taxUse = '', CANCEL = false, ABORT = false;

(function (jQuery) {
    jQuery.modalON = function (text) {
        var msg = (text) ? text : "";
        if ($('.ModalPlugin').length < 1) {
            $('body').prepend('<div class="ModalPlugin"><svg version="1.1" xmlns="http://www.w3.org/svg/2000" viewBox="0 0 30 30" width="60"><circle cy="15" cx="15" r="14" /></svg><p>' + msg + '</p></div>');
        }

        $('.ModalPlugin').css({
            "pointer-events":"none",
            "display": "inherit",
            "position": "fixed",
            "z-index": "99999999",
            "top": "0",
            "left": "0",
            "right": "0",
            "bottom": "0",
            "background": "#fff",
            "width": "100%",
            "text-align": "center",
            "height": "100%"
        });


        $('.ModalPlugin').show();
    }

    jQuery.modalOFF = function () {
        $('.ModalPlugin').remove();
    }

    jQuery.uploadON = function (text) {
        UPLOAD = 0;
        UPLOADED = 0;
        var msg = (text) ? text : "Uploading images...";
        if ($('.uploadModal').length < 1) {
            $('body').prepend('<div class="uploadModal"></div>');
            $('.uploadModal').append("<div class='upload-wrap'></div>");
            $('.uploadModal .upload-wrap').append("<div class='upload-header'></div>");
            $('.uploadModal .upload-wrap').append("<div class='upload-content'></div>");

            $('.uploadModal .upload-header').append('<h1>' + $.lang[LANG]['editor.upload.title.1'] + '</h1>');
            $('.uploadModal .upload-header').append('<div class="close"></div>');
            $('.uploadModal .upload-content').append('<div class="upload-cancel"><div class="btn btn-default">' + $.lang[LANG]['config.close'] + '</div></div>');
        }
        $('.uploadModal .upload-content').find('.file').remove();

        $progress = $("<div id='file-upload-progress' class='file-upload-progress'></div>");
        $bar = $("<div class='progress-bar'></div>");
        $progress.css({
            'height': '2px',
            'background-color':'#f5f5f5',
            'overflow' : 'hidden',
        });
        $progress.append($bar);
        if($('.uploadModal #file-upload-progress').length==0) {
            $('.uploadModal .upload-header').append($progress);
            $('.uploadModal .upload-header').append("<div class='info1'></div>");
            $('.uploadModal .upload-header').append("<div class='info2'></div>");
            $('.uploadModal .upload-header').append("<p>&nbsp;</p>");
        }
        // $('.uploadModal').show();
    }

    jQuery.uploadOFF = function () {
        $('.uploadModal').fadeOut(500, function(){
            $(this).remove();
        });
    }

    jQuery.upload_add = function(e,data) {
        $('.uploadModal').show();
        var submit = true, err = '';
        var filesize = data.files[0].size;
        if( filesize > 1e+7) { //10MB == 10485760Byte == 1e+7
            filesize = filesize/1024/1024;
            err = $.lang[LANG]['editor.upload.max.1'] + $.lang[LANG]['editor.upload.max.2'];
            submit = false;
        }

        var filename = data.files[0].name;
        var search = /%/g,
            match = filename.match(search);

        if(match===null) {
            var uploadErrors = [];
            var validImageTypes = ['image/gif', 'image/jpeg', 'image/png'];
            if(!validImageTypes.includes(data.files[0]['type'])) {
                err = $.lang[LANG]['editor.upload.error.ext'];
                submit = false;
            }
        } else {
            err = $.lang[LANG]['editor.upload.filename'];
            submit = false;
        }

        var fileSize = (data.files[0].size/1024/1024).toFixed(1) + ' Mb';
        var tpl = '<div class="file"><span class="loading"><i class="fa fa-circle-o-notch fa-spin fa-3x fa-fw"></i></span><a target="_blank">' + data.files[0].name + '</a><span class="file-size">' + fileSize + '</span><div class="progress"><div class="progress-bar"></div></div><div class="progress-info"><span class="ing"></span><span class="rate"></span></div><div class="preview"></div></div>';
        data.context = $(tpl).insertBefore($('.uploadModal .upload-content .upload-cancel'));

        if(data.files[0].type.match('image.*')) {
            if (data.files && data.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    data.context.find('.preview').append('<img src="' + e.target.result + '">');
                }
                reader.readAsDataURL(data.files[0]);
            }
        } else data.context.find('.preview').addClass('not_image');
        return {
            submit : submit,
            err : err
        }
    }

    jQuery.upload_progress = function(e,data) {
        var rate = (data.bitrate/1024).toFixed(1) + ' kbps';
        var progress = parseInt((data.loaded / data.total) * 100, 10);
        if(typeof data.context != 'undefined') {
            data.context.find('.res').text(data.bitrate);
            data.context.find('.progress-bar').css('width',progress + "%");
            data.context.find('.ing').text(progress + "%");
            data.context.find('.rate').text(rate);
            if(progress == 100) {
                data.context.find('.ing').text($.lang[LANG]['editor.upload.response']);
            }
        }
    }

    jQuery.upload_done = function(e,data) {
        data.context.addClass("done");
        data.context.find("i").removeClass("fa-circle-o-notch fa-spin fa-3x fa-fw").addClass("fa-check");
        data.context.find('.ing').text($.lang[LANG]['form.button.done']);
        data.context.find('.rate').fadeOut();

        if(typeof data.result.error != 'undefined') {
            data.context.find('.loading').html('<i class="fa fa-times error"></i>');
            data.context.find('.ing').addClass('error').text(data.result.error);
        }
    }

    jQuery.upload_progressall = function(e,data) {
        var total = (data.total/1024/1024).toFixed(1) + ' Mb';
        $('.uploadModal .info1').text($.lang[LANG]['editor.upload.size.total'] + total);
        $('.uploadModal .info2').text((UPLOADED+1) + ' / ' + UPLOAD.toString());
        var progress = parseInt((data.loaded / data.total) * 100, 10);
        $('.file-upload-progress .progress-bar').css('width',progress + "%");
    }

    jQuery.upload_start = function(e,data) {
        $('.uploadModal .upload-header h1').text($.lang[LANG]['editor.upload.title.2']);
        $('.uploadModal .upload-content .upload-cancel .btn-default').text($.lang[LANG]['config.cancel']);
    }

    jQuery.progressON = function(text,sub,delay,cancel_off) {
        CANCEL = false;
        var msg = (typeof text !='undefined') ? text : $.lang[LANG]['editor.delete.title.2'];
        if ($('.progressModal').length < 1) {
            $('body').prepend('<div class="progressModal"></div>');
            $('.progressModal').append("<div class='progress-wrap'></div>");
            $('.progressModal .progress-wrap').append("<div class='progress-header'></div>");
            $('.progressModal .progress-wrap').append("<div class='progress-content'></div>");

            $('.progressModal .progress-header').append('<h1>' + msg + '</h1>');
            // $('.progressModal .progress-header').append('<div class="close"></div>');
            
            if(typeof cancel_off != 'undefined' && cancel_off === true) {
            } else {
                if(typeof delay == 'undefined') {
                    $('.progressModal .progress-content').append('<div class="progress-cancel"><div class="btn btn-default">' + $.lang[LANG]['config.cancel'] + '</div></div>');
                } else {
                    setTimeout(function() {
                        $('.progressModal .progress-content').append('<div class="progress-cancel"><div class="btn btn-default">' + $.lang[LANG]['config.cancel'] + '</div></div>');
                    },delay);
                }
            }
            $progress = $("<div id='file-upload-progress' class='file-upload-progress'></div>");
            $bar = $("<div class='progress-bar progress-bar-success'></div>");
            $progress.css({
                'height': '5px',
                'background-color':'#f5f5f5',
                'overflow' : 'hidden',
            });
            $progress.append($bar);
            $progress = $("<div id='file-upload-progress' class='file-upload-progress'></div>");
            $bar = $("<div class='progress-bar'></div>");
            $progress.css({
                'height': '2px',
                'background-color':'#f5f5f5',
                'overflow' : 'hidden',
            });
            $progress.append($bar);
            if($('.progressModal #file-upload-progress').length==0) {
                $('.progressModal .progress-header').append($progress);
                $('.progressModal .progress-header').append("<div class='info1'></div>");
                $('.progressModal .progress-header').append("<div class='info2'></div>");
                $('.progressModal .progress-header').append("<p>&nbsp;</p>");
            }            
        }
        if(typeof sub != 'undefined') {
            $('.progressModal .progress-header .info1').html('<i class="fa fa-circle-o-notch fa-spin fa-3x fa-fw"></i> ' + sub);
        }


        $('body').addClass('overflow-hidden');

        $(document).on('click','.progress-cancel',function(e) {
            CANCEL = true; ABORT = true;
            $.progressOFF();
        });
        $('.progressModal').show();
    }

    jQuery.progressOFF = function() {
        $('body').removeClass('overflow-hidden');
        $('.progressModal').fadeOut().remove();
    }

    jQuery.processON = function(text,bg) {
        var msg = (text) ? text : "";
        bg = (bg) ? bg : "rgba(0,0,0,0.75)";
        if ($('.processModal').length < 1) {
            if($('.reorderModal').length) {
                $('.reorderModal').after('<div class="processModal"><svg version="1.1" xmlns="http://www.w3.org/svg/2000" viewBox="0 0 30 30" width="60"><circle cy="15" cx="15" r="14" /></svg><p>' + msg + '</p></div>');
            } else {
                $('body').prepend('<div class="processModal"><svg version="1.1" xmlns="http://www.w3.org/svg/2000" viewBox="0 0 30 30" width="60"><circle cy="15" cx="15" r="14" /></svg><p>' + msg + '</p></div>');
            }
        } else {
            $('.processModal').find('p').html(text);
        }

        $('.processModal').css({
            "display": "inherit",
            "position": "fixed",
            "z-index": "9999999999",
            "top": "0",
            "left": "0",
            "width": "100%",
            "text-align": "center",
            "height": "100%",
            "background-color" : bg
        });
        $('.processModal').fadeIn();
    }

    jQuery.processOFF = function() {
        $('.processModal').fadeOut().remove();
    }

    jQuery.guideON = function(step) {
        hideElementListPanel();
        var $guide = $('<div class="guideModal"></div>');

        if ($('.guideModal').length < 1) {
            $('body').prepend($guide);
            $('.guideModal').append('<div class="content"></div>')
            $('.guideModal').css({
                display: "inherit",
                position: "fixed",
                "z-index": "99999999",
                top: "0",
                left: "0",
                width: "100%",
                "text-align": "center",
                "background-color" : "transparent",
                height: "100%",
            });
            $('.guideModal .content').css({
                "width" : "100%",
                "height" : "100%",
                "background-color" : "rgba(0,0,0,0.6)",
                "margin-top" : "35px"
            });
            $('.guideModal').fadeIn();
        }

        $('.guideModal').find(".popover").fadeOut().remove();
        $('.menu-config.edit-menu').removeClass('active');
        $('.menu-config.edit-site').removeClass('active');
        $('.el_0_ctrl .config-element').css('z-index','4');
        $('.addElementButton').css('z-index','1');
        $('.config-image-edit').hide();
        $('.config-element').removeClass('disabled');
        $('.add-block').removeClass('disabled');

        switch(step) {
            case 1 : 
                $('.menu-config.edit-menu').addClass('active');
                var str = '\
                <div class="popover bottom">\
                    <div class="arrow"></div>\
                    <div class="popover-content" style="padding:15px 15px 10px;font-weight:600;">\
                        <p>' + $.lang[LANG]["editor.guide.steps.1"] + '</p>\
                    </div>\
                    <h3 style="padding:5px;overflow:auto;" class="popover-title" id="popover-bottom">\
                        <div class="pull-left"><span class="btn btn-default btn-sm" onclick="$.guideON();">' + $.lang[LANG]['config.close'] + '</span></div>\
                        <div class="pull-right"><span style="padding-right:5px;"> <b>1</b> / 7 </span><span class="btn btn-primary btn-sm" onclick="$.guideON(2);">' + $.lang[LANG]['editor.guide.next'] + '</span></div>\
                    </h3>\
                </div>\
                ';
                $step1 = $(str);
                $('.guideModal').find('.content').append($step1);
                $step1.css({
                    "top" : $('.editor-navbar').outerHeight()+2,
                    "left" : "0px"
                });

                $('.dsgn-body').scrollTop(0);
                $step1.fadeIn();
                break;

            case 2 :
                $('.menu-config.edit-site').addClass('active');
                var str = '\
                <div class="popover bottom">\
                    <div class="arrow"></div>\
                    <div class="popover-content" style="padding:15px 15px 10px;font-weight:600;">\
                        <p>' + $.lang[LANG]["editor.guide.steps.2"] + '</p>\
                    </div>\
                    <h3 style="padding:5px;overflow:auto;" class="popover-title" id="popover-bottom">\
                        <div class="pull-left"><button class="btn btn-default btn-sm" onclick="$.guideON()">' + $.lang[LANG]['config.close'] + '</button></div>\
                        <div class="pull-right"><span style="padding-right:5px;"> <b>2</b> / 7 </span><span class="btn btn-primary btn-sm" onclick="$.guideON(3);">' + $.lang[LANG]['editor.guide.next'] + '</span></div>\
                    </h3>\
                </div>\
                ';
                $step2 = $(str);
                $('.guideModal').find('.content').append($step2);
                $step2.css({
                    "top" : $('.editor-navbar').outerHeight()+2,
                    "left" : "268px"
                });
                $step2.fadeIn();
                break;

            case 3:
                $('.menu-config.edit-site').removeClass('active');
                $('.element').removeClass('active');
                if($('.el_0').length<1) {
                    $.guideON(13);
                    return false;
                }
                $('.el_0_ctrl').hide();
                $('.config-element-section').first().show().addClass('active');
                //$('.el_0_ctrl').show();

                var popover_direction = ($('header').hasClass('sidebar')) ? 'right' : 'left',
                    arrow_style = (popover_direction == 'right') ? 'style="left:-8px; margin-top: -8px; border-right: none;"' : '';
                var str = '\
                <div class="popover '+popover_direction+'">\
                    <div class="arrow" '+arrow_style+'></div>\
                    <div class="popover-content" style="padding:15px 15px 10px;font-weight:600;">\
                        <p>' + $.lang[LANG]["editor.guide.steps.3"] + '</p>\
                    </div>\
                    <h3 style="padding:5px;overflow:auto;" class="popover-title" id="popover-bottom">\
                        <div class="pull-left"><button class="btn btn-default btn-sm" onclick="$.guideON()">' + $.lang[LANG]['config.close'] + '</button></div>\
                        <div class="pull-right"><span style="padding-right:5px;"> <b>3</b> / 7 </span><span class="btn btn-primary btn-sm" onclick="$.guideON(4);">' + $.lang[LANG]['editor.guide.next'] + '</span></div>\
                    </h3>\
                </div>\
                ';
                $step3 = $(str);
                $('.guideModal').find('.content').append($step3);
                var right = ($('header').hasClass('sidebar')) ? 'inherit' : '80px',
                    left = ($('header').hasClass('sidebar')) ?  '270px' : 'inherit';
                $step3.css({
                    "left" : left,
                    "top"  : 0,
                    "right" : right
                });
                $step3.fadeIn();
                $('.el-menu_ctrl').show().css('z-index','99999999');
                addElementButtonDisplay('el_0');
                break;

            case 4:
                $('.el-menu_ctrl').hide();
                var winHeight = $('.dsgn-body').height(),
                    elOffsetTop = $('.addel_0').offset().top;

                var arrow = (winHeight>elOffsetTop) ? "bottom" : "top";
                $('.addElementButton').css('z-index','99999999');
                $('.add-block').removeClass('disabled').css('z-index','99999999');
                $('.addel_0 li .add-block').show().css('z-index','99999999');

                var str = '\
                <div class="popover ' + arrow + '">\
                    <div class="arrow"></div>\
                    <div class="popover-content" style="padding:15px 15px 10px;font-weight:600;">\
                        <p>' + $.lang[LANG]["editor.guide.steps.4"] + '</p>\
                    </div>\
                    <h3 style="padding:5px;overflow:auto;" class="popover-title" id="popover-bottom">\
                        <div class="pull-left"><button class="btn btn-default btn-sm" onclick="$.guideON()">' + $.lang[LANG]['config.close'] + '</button></div>\
                        <div class="pull-right"><span style="padding-right:5px;"> <b>4</b> / 7 </span><span class="btn btn-primary btn-sm" onclick="$.guideON(5);">' + $.lang[LANG]['editor.guide.next'] + '</span></div>\
                    </h3>\
                </div>\
                ';
                $step4 = $(str);
                $('.guideModal').find('.content').append($step4);

                var left = ($('.dsgn-body').width()/2) - ($step4.width()/2) - 10;
                if($('header').hasClass('sidebar')) left = left + 260;

                if(elOffsetTop>winHeight) {
                    $('.dsgn-body').animate({scrollTop:elOffsetTop-($('.dsgn-body').height()/2)},'500','swing', function() {
                        var top = $('.addel_0').offset().top - 150;
                        $step4.css({
                            "top" : top + "px",
                            "left" : left + "px"
                        });
                        $step4.fadeIn();
                    });
                } else {
                    if(winHeight/2 > elOffsetTop) {
                        $step4.removeClass(arrow).addClass('bottom');
                        var top = elOffsetTop + 40;
                        $step4.css({
                            "top" : top + "px",
                            "left" : left + "px"
                        });
                        $step4.fadeIn();
                    } else {
                        $step4.removeClass(arrow).addClass('top');
                        var top = elOffsetTop -150;
                        $step4.css({
                            "top" : top + "px",
                            "left" : left + "px"
                        });
                        $step4.fadeIn();
                    }
                }
                break;

            case 5: 
                showElList();

                var str = '\
                <div class="popover right">\
                    <div class="arrow" style="left:-8px; margin-top: -8px; border-right: none;"></div>\
                    <div class="popover-content" style="padding:15px 15px 10px;font-weight:600;">\
                        <p>' + $.lang[LANG]["editor.guide.steps.5"] + '</p>\
                    </div>\
                    <h3 style="padding:5px;overflow:auto;" class="popover-title" id="popover-bottom">\
                        <div class="pull-left"><button class="btn btn-default btn-sm" onclick="$.guideON()">' + $.lang[LANG]['config.close'] + '</button></div>\
                        <div class="pull-right"><span style="padding-right:5px;"> <b>5</b> / 7 </span><span class="btn btn-primary btn-sm" onclick="$.guideON(6);">' + $.lang[LANG]['editor.guide.next'] + '</span></div>\
                    </h3>\
                </div>\
                ';
                $step5 = $(str);
                $('.guideModal').find('.content').append($step5);
                var top = ($('.dsgn-body').height()/2) - ($step5.height()/2);
                $step5.css({
                    "top" : top + "px",
                    "left" : "320px"
                });
                $step5.fadeIn(function() {
                    $('.guideModal .content').css('margin-left','315px');
                });
                break;

            case 6:
                $('.guideModal .content').css('margin-left','0px');
                hideElementListPanel();
                var str = '\
                <div class="popover bottom">\
                    <div class="arrow"></div>\
                    <div class="popover-content" style="padding:15px 15px 10px;font-weight:600;">\
                        <p>' + $.lang[LANG]["editor.guide.steps.6"] + '</p>\
                    </div>\
                    <h3 style="padding:5px;overflow:auto;" class="popover-title" id="popover-bottom">\
                        <div class="pull-left"><button class="btn btn-default btn-sm" onclick="$.guideON();">' + $.lang[LANG]['config.close'] + '</button></div>\
                        <div class="pull-right"><span style="padding-right:5px;"> <b>6</b> / 7 </span><span class="btn btn-primary btn-sm" onclick="$.guideON(7);">' + $.lang[LANG]['editor.guide.next'] + '</span></div>\
                    </h3>\
                </div>\
                ';
                $step6 = $(str);
                $('.guideModal').find('.content').append($step6);
                var left = $('#change-mode').offset().left - ($step6.width()/2) + ($('#change-mode').width()/2);
                $step6.css({
                    "top" : $('.editor-navbar').outerHeight()+2,
                    "left" : left + "px"
                });
                $step6.fadeIn();

                break;

            case 7:
                $('.guideModal .content').css('margin-left','0px');
                hideElementListPanel();
                var str = '\
                <div class="popover bottom">\
                    <div class="arrow"></div>\
                    <div class="popover-content" style="padding:15px 15px 10px;font-weight:600;">\
                        <p>' + $.lang[LANG]["editor.guide.steps.7"] + '</p>\
                    </div>\
                    <h3 style="padding:5px;text-align:right;" class="popover-title" id="popover-bottom"><span style="padding-right:5px;"> <b>7</b> / 7 </span><span class="btn btn-primary btn-sm" onclick="$.guideON();">' + $.lang[LANG]['editor.guide.start'] + '</span></h3>\
                </div>\
                ';
                $step7 = $(str);
                $('.guideModal').find('.content').append($step7);
                var left = $('#config-publishing').offset().left - ($step7.width()/2) + ($('#config-publishing').width()/2);
                $step7.css({
                    "top" : $('.editor-navbar').outerHeight()+2,
                    "left" : left + "px"
                });
                $step7.fadeIn();

                break;
            case 13:
                $('.el-menu').addClass('active');
                $('.config-element-section').hide();
                $('.el-menu_ctrl').show();

                var str = '\
                <div class="popover left">\
                    <div class="arrow"></div>\
                    <div class="popover-content" style="padding:15px 15px 10px;font-weight:600;">\
                        <p>메뉴변경, 이미지 업로드, 배경색, 여백 조절 등 블럭의 세부사항을 설정할 수 있습니다.</p>\
                    </div>\
                    <h3 style="padding:5px;overflow:auto;" class="popover-title" id="popover-bottom">\
                        <div class="pull-left"><button class="btn btn-default btn-sm" onclick="$.guideON()">' + $.lang[LANG]['config.close'] + '</button></div>\
                        <div class="pull-right"><span style="padding-right:5px;"> <b>3</b> / 7 </span><span class="btn btn-primary btn-sm" onclick="$.guideON(14);">' + $.lang[LANG]['editor.guide.next'] + '</span></div>\
                    </h3>\
                </div>\
                ';
                $step3 = $(str);
                $('.guideModal').find('.content').append($step3);
                var top = $('.el-menu_ctrl').offset().top - ($step3.height()/2)+27;
                $step3.css({
                    "top" : top + "px",
                    "left" : "inherit",
                    "right" : "80px"
                });
                $step3.fadeIn();
                $('.config-element').addClass('disabled');
                $('.el-menu_ctrl .config-element').css('z-index','99999999');
                //addElementButtonDisplay('el_0');

                break;

            case 14:
                $('.el-menu_ctrl .config-element').hide();
                var str = '\
                <div class="popover right">\
                    <div class="arrow"></div>\
                    <div class="popover-content" style="padding:15px 15px 10px;font-weight:600;">\
                        <p>현재 선택된 위치에 블럭을 추가하여 사이트를 만들 수 있습니다.</p>\
                    </div>\
                    <h3 style="padding:5px;overflow:auto;" class="popover-title" id="popover-bottom">\
                        <div class="pull-left"><button class="btn btn-default btn-sm" onclick="$.guideON()">' + $.lang[LANG]['config.close'] + '</button></div>\
                        <div class="pull-right"><span style="padding-right:5px;"> <b>4</b> / 7 </span><span class="btn btn-primary btn-sm" onclick="$.guideON(5);">' + $.lang[LANG]['editor.guide.next'] + '</span></div>\
                    </h3>\
                </div>\
                ';
                $step4 = $(str);
                var top = $('.addEL-wrap').offset().top + ($('.addEL-wrap').height()/2) - 90;
                $step4.css({
                    'top' : top + 'px',
                    'left': '50%',
                    'margin-left' : '100px'
                });
                $('.guideModal').find('.content').append($step4);
                $step4.fadeIn();
                break;
            default : 
                var settings = {
                    showGuide : 'none'
                }

                $.post('/template/settings',{ sid : SID, settings : JSON.stringify(settings) }, function(data) {
                    checkError(data);
                },'json');

                $('.guideModal').find(".popover").fadeOut().remove();
                $('.menu-config.edit-menu').removeClass('active');
                $('.menu-config.edit-site').removeClass('active');
                $('.el_0_ctrl .config-element').css('z-index','4');
                $('.addElementButton').css('z-index','1').hide();
                $('.config-image-edit').hide();
                $('.config-element').removeClass('disabled');
                $('.add-block').removeClass('disabled');
                $('.config-element-section.active').removeClass('active').fadeOut();
                $('.guideModal').fadeOut().remove();
                //$.quickON(0);
                $.guideVideoON();
                break;
        }
    }

    jQuery.quickON = function(menu) {
        hideElementListPanel();
        var $quick = $('<div class="quickModal"></div>'),
            $content = $('<div class="content"></div>');

        if ($('.quickModal').length < 1) {
            $('body').prepend($quick);
            /*$content.on('click',function() {
                $.quickOFF();
            });*/
            $content.css({
                "width" : "100%",
                "height" : "100%",
                "background-color" : "rgba(0,0,0,0.6)",
                "display" : "none"
            });

            $quick.append($content);
            $quick.css({
                "display": "inherit",
                "position": "fixed",
                "z-index": "99999999",
                "top": "0",
                "left": "0",
                "width": "100%",
                "height": "100%",
                "text-align": "center",
                "background-color" : "transparent"
            });
            $quick.fadeIn();

            var hostAry = HOST.split('.');

            if (hostAry.length >= 3) {
                HOST = hostAry[1]+'.'+hostAry[2];
            }

            var $guide = $('<div class="guide">'),
                $close = $('<div class="close"><img src="https://storage.googleapis.com/i.addblock.net/fa-close-modal.png" alt="close" /></div>'),
                $header = $('<div class="header"><h2>' + $.lang[LANG]["editor.guide-title"] + '</h2></div>'),
                $linksWrap = $('<div class="links-wrap"></div>'),
                $mainguide = $('<span class="mainguide"><i class="fa fa-plus-circle"></i>' + $.lang[LANG]["editor.guide.walkthrough"] + '</sort-page-linen>'),
                $supportLink = $('</div><span class="support-link-wrap"><a class="support-link" href="//'+HOST+'/support" target="_blank"><i class="fa fa-plus-circle"></i>' + $.lang[LANG]["editor.guide.support-center"] + '</a></span>'),
                $body = $('<div class="body"></div>'),
                $sidebar = $('<div class="sidebar"></div>'),
                nav = new Array( $.lang[LANG]["editor.guide.tutorial-video"], $.lang[LANG]["editor.menu-config"], $.lang[LANG]["editor.site-config"], $.lang[LANG]["config.element-config"], $.lang[LANG]["editor.guide.add-blocks"], $.lang[LANG]["editor.image.add-change"], $.lang[LANG]["editor.guide.edit-text"], $.lang[LANG]["editor.guide.gallery"], $.lang[LANG]["editor.guide.preview-publish"]),
                $nav = $('<ul class="nav"></ul>'),
                $bottom = $('<div class="bottom"></div>');

            $mainguide.on('click', function() {
                $.quickOFF();
                $.guideON(1);
            });

            $close.on('click',function() { $.quickOFF(); });

            // 임시 - 한국어 동영상이 완료될 때까지 만 
            if (LANG != 'en') {
               nav.shift();
            }

            $.each(nav, function(i,v){
                $li = $('<li class="'+i+'">'+v+'<img src="https://storage.googleapis.com/i.addblock.net/config/fa_thin_right_w.png" alt="" /></li>');
                $nav.append($li);
            });
            $navli = $nav.children();
            $navli.on('click',function() {
                var classtext = $(this).attr('class');
                $.quickON(Number(classtext.substring(0,1)));
            });
            $sidebar.append($nav).append($bottom);

            var $contentbox = $('<div class="contentbox"></div>');

            $body.append($sidebar).append($contentbox);
            $linksWrap.append($mainguide, $supportLink);
            $header.append($linksWrap);
            $guide.append($header).append($close).append($body);
            $content.append($guide);
            $content.fadeIn();

        }

        var $thisContent = $('.quickModal .contentbox'),
            $thisMenu = $('.quickModal .sidebar .nav li');
        $thisMenu.removeClass('active');
        $thisMenu.eq(menu).addClass('active');

        var lang;

        if (LANG == 'en') {
            lang = '_' + LANG;

            // 제임스: 임시로 여기로 옮겼음 (나중에 한 switch으로 할 예정)
            switch(menu) {
                case 0 :  /* 가이드 동영상 */

                    var str = '\
                    <ul>\
                        <li><h4>' + $.lang[LANG]["editor.guide.tutorial-video"] + '</h4></li>\
                        <li><p>' + $.lang[LANG]["editor.guide.tutorial-video.text"] + '</p></li>\
                    </ul>\
                    ';

                    var $quickVideoWrap = $('<li></li>'),
                        $tutorialVideo = $('<div class="tutorial-video"></div>'),
                        $videoWrap = $('<div class="video-wrap guideVideo-stopPlay"><div id="quick-guide-video-overlay"></div></div>');

                    $menu0 = $(str);
                    $tutorialVideo.append( $videoWrap ); 
                    $quickVideoWrap.append( $tutorialVideo );
                    $menu0.append( $quickVideoWrap );

                    $thisContent.empty();
                    $thisContent.append($menu0);
                    $menu0.fadeIn();

                    $videoWrap.on('click', function() {

                        $(this).toggleClass('guideVideo-stopPlay');

                        if(!$(this).hasClass('guideVideo-stopPlay')) {
                            if ( LANG == 'en' )
                                var link = "https://www.youtube.com/embed/p6fyIMl2BcI";

                            var html = '<iframe class="video embed-responsive-item" width="765" height="380" src="' + link + '?enablejsapi=1&rel=0&vq=large&wmode=opaque&showinfo=0&controls=1&autoplay=0&loop=0;playlist=Fn0Mpyh3xto;" frameborder="0" allowfullscreen></iframe>';
                            $(this).html(html);
                        }
                    });   

                    break;
                case 1 :  /*메뉴 설정*/
                    var str = '\
                    <ul>\
                        <li><h4>' + $.lang[LANG]["editor.menu-config"] + '</h4></li>\
                        <li><p>' + $.lang[LANG]["editor.guide.menu-config.text.1"] + '</p></li>\
                        <li><img src="https://storage.googleapis.com/i.addblock.net/config/quickguid_0_1' + lang + '.png " alt="" /></li>\
                    </ul>\
                    ';
                    $menu1 = $(str);

                    $thisContent.empty();
                    $thisContent.append($menu1);
                    $menu1.fadeIn();
                    break;
                case 2 :  /*사이트 설정*/
                    var str = '\
                    <ul>\
                        <li><h4>' + $.lang[LANG]["editor.site-config"] + '</h4></li>\
                        <li><p>' + $.lang[LANG]["editor.guide.site-config.text.1"] + '</p></li>\
                        <li><img src="https://storage.googleapis.com/i.addblock.net/config/quickguid_1_1' + lang + '.png" alt="" /></li>\
                    </ul>\
                    ';
                    $menu2 = $(str);
                    $thisContent.empty();
                    $thisContent.append($menu2);
                    $menu2.fadeIn();
                    break;
                case 3 :  /*블럭 설정*/
                    var str = '\
                    <ul>\
                        <li><h4>' + $.lang[LANG]["config.element-config"] + '</h4></li>\
                        <li><p>' + $.lang[LANG]["editor.guide.element-config.text.1"] + '</p></li>\
                        <li><h6><img src="https://storage.googleapis.com/i.addblock.net/config/fa_exclamation.png" alt="" class="fa"/> ' + $.lang[LANG]["editor.guide.element-config.text.note"] + '</h6></li>\
                        <li><img src="https://storage.googleapis.com/i.addblock.net/config/quickguid_2_1' + lang + '.png" alt="" /></li>\
                    </ul>\
                    ';
                    $menu3 = $(str);
                    $thisContent.empty();
                    $thisContent.append($menu3);
                    $menu3.fadeIn();
                    break;
                case 4 :  /*블럭 추가*/
                    var str = '\
                    <ul>\
                        <li><h4>' + $.lang[LANG]["editor.guide.add-blocks"] + '</h4></li>\
                        <li><p>' + $.lang[LANG]["editor.guide.add-block.text.1"] + '</p></li>\
                        <li><img src="https://storage.googleapis.com/i.addblock.net/config/quickguid_3_1' + lang + '.png" alt="" /></li>\
                    </ul>\
                    ';
                    $menu4 = $(str);
                    $thisContent.empty();
                    $thisContent.append($menu4);
                    $menu4.fadeIn();
                    break;
                case 5 :  /*이미지 추가/변경*/
                    var str = '\
                    <ul>\
                        <li><h4>' + $.lang[LANG]["editor.image.add-change"] + '</h4></li>\
                        <li><p>' + $.lang[LANG]["editor.guide.add-change-images.text.1"] + '</p></li>\
                        <li><h6><img src="https://storage.googleapis.com/i.addblock.net/config/fa_exclamation.png" alt="" class="fa"/>' + $.lang[LANG]["editor.guide.add-change-images.text.note"] + '</h6></li>\
                        <li><img src="https://storage.googleapis.com/i.addblock.net/config/quickguid_4_1.png" alt="" /></li>\
                    </ul>\
                    ';
                    $menu5 = $(str);
                    $thisContent.empty();
                    $thisContent.append($menu5);
                    $menu5.fadeIn();
                    break;
                case 6 :  /*텍스트*/
                    var str = '\
                    <ul>\
                        <li><h4>' + $.lang[LANG]["config.text"] + '</h4></li>\
                        <li><p>' + $.lang[LANG]["editor.guide.edit-text.text.1"] + '</p></li>\
                        <li><img src="https://storage.googleapis.com/i.addblock.net/config/quickguid_5_1' + lang + '.png" alt="" /></li>\
                    </ul>\
                    ';
                    $menu6 = $(str);
                    $thisContent.empty();
                    $thisContent.append($menu6);
                    $menu6.fadeIn();
                    break;
                case 7 :  /*갤러리*/
                    var str = '\
                    <ul>\
                        <li><h4>' + $.lang[LANG]["editor.block.gallery"] + '</h4></li>\
                        <li><p>' + $.lang[LANG]["editor.guide.gallery.text.1"] + '</p></li>\
                        <li><img src="https://storage.googleapis.com/i.addblock.net/config/quickguid_6_1.png" alt="" /></li>\
                        <li><hr /></li>\
                        <li><p>' + $.lang[LANG]["editor.guide.gallery.text.2"] + '</p></li>\
                        <li><img src="https://storage.googleapis.com/i.addblock.net/config/quickguid_6_2' + lang + '.png" alt="" /></li>\
                        <li><h6><img src="https://storage.googleapis.com/i.addblock.net/config/fa_exclamation.png" alt="" class="fa"/> ' + $.lang[LANG]["editor.guide.gallery.text.note"] + '</h6></li>\
                    </ul>\
                    ';
                    $menu7 = $(str);
                    $thisContent.empty();
                    $thisContent.append($menu7);
                    $menu7.fadeIn();
                    break;
                case 8 :  /*저장/게시*/
                    var str = '\
                    <ul>\
                        <li><h4>' + $.lang[LANG]["editor.guide.preview-publish"] + '</h4></li>\
                        <li><img src="https://storage.googleapis.com/i.addblock.net/config/quickguid_7_1' + lang + '.png" alt="" style="margin-top: 0"/></li>\
                        <li><p>' + $.lang[LANG]["editor.guide.preview-publish.text.1"] + '</p></li>\
                        <li><h6><img src="https://storage.googleapis.com/i.addblock.net/config/fa_exclamation.png" alt="" class="fa"/> ' + $.lang[LANG]["editor.guide.preview-publish.text.note"] + '</h6></li>\
                    </ul>\
                    ';
                    $menu8 = $(str);
                    $thisContent.empty();
                    $thisContent.append($menu8);
                    $menu8.fadeIn();
                    break;
                default : 
                    $.quickOFF();
                    break;
            }
        }
        else {
            lang = '';

            // 제임스: 임시로 여기로 옮겼음 (나중에 한 switch으로 할 예정)
            switch(menu) {
                case 0 :  /*메뉴 설정*/
                    var str = '\
                    <ul>\
                        <li><h4>' + $.lang[LANG]["editor.menu-config"] + '</h4></li>\
                        <li><p>' + $.lang[LANG]["editor.guide.menu-config.text.1"] + '</p></li>\
                        <li><img src="https://storage.googleapis.com/i.addblock.net/config/quickguid_0_1' + lang + '.png " alt="" /></li>\
                    </ul>\
                    ';
                    $menu0 = $(str);

                    $thisContent.empty();
                    $thisContent.append($menu0);
                    $menu0.fadeIn();
                    break;
                case 1 :  /*사이트 설정*/
                    var str = '\
                    <ul>\
                        <li><h4>' + $.lang[LANG]["editor.site-config"] + '</h4></li>\
                        <li><p>' + $.lang[LANG]["editor.guide.site-config.text.1"] + '</p></li>\
                        <li><img src="https://storage.googleapis.com/i.addblock.net/config/quickguid_1_1' + lang + '.png" alt="" /></li>\
                    </ul>\
                    ';
                    $menu1 = $(str);
                    $thisContent.empty();
                    $thisContent.append($menu1);
                    $menu1.fadeIn();
                    break;
                case 2 :  /*블럭 설정*/
                    var str = '\
                    <ul>\
                        <li><h4>' + $.lang[LANG]["config.element-config"] + '</h4></li>\
                        <li><p>' + $.lang[LANG]["editor.guide.element-config.text.1"] + '</p></li>\
                        <li><h6><img src="https://storage.googleapis.com/i.addblock.net/config/fa_exclamation.png" alt="" class="fa"/> ' + $.lang[LANG]["editor.guide.element-config.text.note"] + '</h6></li>\
                        <li><img src="https://storage.googleapis.com/i.addblock.net/config/quickguid_2_1' + lang + '.png" alt="" /></li>\
                    </ul>\
                    ';
                    $menu2 = $(str);
                    $thisContent.empty();
                    $thisContent.append($menu2);
                    $menu2.fadeIn();
                    break;
                case 3 :  /*블럭 추가*/
                    var str = '\
                    <ul>\
                        <li><h4>' + $.lang[LANG]["editor.guide.add-blocks"] + '</h4></li>\
                        <li><p>' + $.lang[LANG]["editor.guide.add-block.text.1"] + '</p></li>\
                        <li><img src="https://storage.googleapis.com/i.addblock.net/config/quickguid_3_1' + lang + '.png" alt="" /></li>\
                    </ul>\
                    ';
                    $menu3 = $(str);
                    $thisContent.empty();
                    $thisContent.append($menu3);
                    $menu3.fadeIn();
                    break;
                case 4 :  /*이미지 추가/변경*/
                    var str = '\
                    <ul>\
                        <li><h4>' + $.lang[LANG]["editor.image.add-change"] + '</h4></li>\
                        <li><p>' + $.lang[LANG]["editor.guide.add-change-images.text.1"] + '</p></li>\
                        <li><h6><img src="https://storage.googleapis.com/i.addblock.net/config/fa_exclamation.png" alt="" class="fa"/>' + $.lang[LANG]["editor.guide.add-change-images.text.note"] + '</h6></li>\
                        <li><img src="https://storage.googleapis.com/i.addblock.net/config/quickguid_4_1.png" alt="" /></li>\
                    </ul>\
                    ';
                    $menu4 = $(str);
                    $thisContent.empty();
                    $thisContent.append($menu4);
                    $menu4.fadeIn();
                    break;
                case 5 :  /*텍스트*/
                    var str = '\
                    <ul>\
                        <li><h4>' + $.lang[LANG]["config.text"] + '</h4></li>\
                        <li><p>' + $.lang[LANG]["editor.guide.edit-text.text.1"] + '</p></li>\
                        <li><img src="https://storage.googleapis.com/i.addblock.net/config/quickguid_5_1' + lang + '.png" alt="" /></li>\
                    </ul>\
                    ';
                    $menu5 = $(str);
                    $thisContent.empty();
                    $thisContent.append($menu5);
                    $menu5.fadeIn();
                    break;
                case 6 :  /*갤러리*/
                    var str = '\
                    <ul>\
                        <li><h4>' + $.lang[LANG]["editor.block.gallery"] + '</h4></li>\
                        <li><p>' + $.lang[LANG]["editor.guide.gallery.text.1"] + '</p></li>\
                        <li><img src="https://storage.googleapis.com/i.addblock.net/config/quickguid_6_1.png" alt="" /></li>\
                        <li><hr /></li>\
                        <li><p>' + $.lang[LANG]["editor.guide.gallery.text.2"] + '</p></li>\
                        <li><img src="https://storage.googleapis.com/i.addblock.net/config/quickguid_6_2' + lang + '.png" alt="" /></li>\
                        <li><h6><img src="https://storage.googleapis.com/i.addblock.net/config/fa_exclamation.png" alt="" class="fa"/> ' + $.lang[LANG]["editor.guide.gallery.text.note"] + '</h6></li>\
                    </ul>\
                    ';
                    $menu6 = $(str);
                    $thisContent.empty();
                    $thisContent.append($menu6);
                    $menu6.fadeIn();
                    break;
                case 7 :  /*저장/게시*/
                    var str = '\
                    <ul>\
                        <li><h4>' + $.lang[LANG]["editor.guide.preview-publish"] + '</h4></li>\
                        <li><img src="https://storage.googleapis.com/i.addblock.net/config/quickguid_7_1' + lang + '.png" alt="" style="margin-top: 0"/></li>\
                        <li><p>' + $.lang[LANG]["editor.guide.preview-publish.text.1"] + '</p></li>\
                        <li><h6><img src="https://storage.googleapis.com/i.addblock.net/config/fa_exclamation.png" alt="" class="fa"/> ' + $.lang[LANG]["editor.guide.preview-publish.text.note"] + '</h6></li>\
                    </ul>\
                    ';
                    $menu7 = $(str);
                    $thisContent.empty();
                    $thisContent.append($menu7);
                    $menu7.fadeIn();
                    break;
                default : 
                    $.quickOFF();
                    break;
            }
        }

    }

    jQuery.quickOFF = function() {
        $('.quickModal').fadeOut(function() {
            $(this).remove();  
        });
    }

    jQuery.reorderON = function() {
        var enable = true;
        if($('.ctrl-reorder').hasClass('disabled')) return;
        if(VIEW && COUNT<2) {
            alert('순서 변경을 위해서는 최소한 2개 이상의 블럭이 필요합니다');
            return false;
        }
        /*
        $.getJSON('/template/contents/sid/' + SID + '/page/' + PAGE, function(data) {
            checkError(data);
            if(data.length<2) {
                alert('순서 변경을 위해서는 최소한 2개 이상의 블럭이 필요합니다');
                enable = false; 
            }
        });
        if(!enable) return false;
        */

        var el = [], idx = 0;
        var toolbar = ($('.editor-navbar').css('display')=='none') ? 0 : 35;
        var sidebar = ($('header').hasClass('sidebar')) ? true : false;
        var el_fixed = (reorderFIXED) ? reorderFIXED.split(':') : [];

        $.each($('.element'),function(i,v) {
            if( $(v).data('el') == 'el-menu' || 
                $(v).data('el') == 'el-footer' || 
                $(v).hasClass('add-footer-information') ||
                $(v).hasClass('cl-s-product-review') ||
                $(v).hasClass('cl-s-product-qna')
            ) return true;

            if(reorderFIXED) {
                if($(v).hasClass('el-fixedblock')) {
                    if($(v).attr('data-posby') != el_fixed[2]) return true;
                } else return true;
            } else {
                if($(v).hasClass('el-fixedblock')) return true;
            }

            el[idx] = $(v).attr('data-el') + '|' + ($(v).offset().top - toolbar) + '-' + $(v).outerHeight();    
            idx++;
        });
        eloffSet = el.toString();

        var $reorder = $('<div class="reorderModal"></div>');

        if($('.reorderModal').length < 1) {
            $reorder.css({
                "position" : "fixed",
                "width" : "100%",
                "height" : "100%",
                "background" : "rgba(0,0,0,1)",
                "z-index" : "10000000000",
                "display" : "none",
                "overflow" : "auto"
            });
            $('body').prepend($reorder);
            var $content = $('<div class="content" style="min-height:900px;"></div>'),
                $scale = $('<div class="scale"></div>'),
                reorder_title = (reorderFIXED) ? $.lang[LANG]['editor.reorder-blocks.title.'+el_fixed[2]] : $.lang[LANG]['editor.reorder-blocks.title'],
                $h1 = $('<h1 class="fixed-btn-wrap"><span class="title">' + reorder_title + '</title></h1>').css({
                    'position' : 'fixed',
                    'width' : '100%',
                    'right' : '15px',
                    'margin' : '0',
                    'padding-top' : '30px',
                    'padding-right' : '40px',
                    'overflow' : 'auto',
                    'padding-bottom' : '20px',
                    'padding-left' : '30px',
                    'font-size' : '18px',
                    'letter-spacing' : '2px',
                    'color' : '#fff',
                    'background-color' : 'transparent',
                    'font-family' : 'Raleway,"Nanum gothic"',
                    'top': '0',
                    'z-index': '1'
                });
                $sub = $('<span class="sub">' + $.lang[LANG]['editor.reorder-blocks.text.1'] + '</span>').css({
                    'font-family' : 'Raleway,"Nanum gothic"',
                    'color' : '#a5a5a5',
                    'font-size' : '13px',
                    'padding-left' : '20px',
                    'line-height' : '20px',
                    'letter-spacing' : '0px',
                });
                $h1.append($sub);
            $save = $('<span class="btn btn-primary btn-flat btn-sm pull-right">' + $.lang[LANG]['config.save'] + '</span>'),
            $close = $('<span class="btn btn-default btn-flat btn-sm pull-right">' + $.lang[LANG]['config.close'] + '</span>').css('margin-right','10px');

            $close.on('click',function() {
                $.processON($.lang[LANG]['config.reorder.loading']);
                if(!prevONE && !VIEW) {
                    var check = 'false';
                    $.ajax({
                        type: 'POST',
                        url: '/template/update/type/onepage',
                        data: { id : SID, s : check },
                        dataType: 'json',                    
                        async: true,
                        success: function(data) {
                            internalLink = true;
                            var refer = prevPAGE.replace(',','/view/');
                            location.replace('/'+CONFIG_URL+'config/page/' + refer);
                            $.processOFF();
                            $.reorderOFF();
                        }
                    });                      
                } else {
                    $.processOFF();
                    $.reorderOFF();
                }
            });

            $save.on('click',function() {
                $.processON($.lang[LANG]['config.reorder.loading']);

                var rPage = '';
                $.each($('.el-sortable').children(), function(i,v) {
                    var page_name = $(v).attr('data-result-page');
                    if(typeof page_name !='undefined' && page_name && $(v).hasClass('sort-empty')) {
                        rPage = $(v).attr('data-result-page');
                        return true;
                    }

                    $(v).attr('data-reorder-page',rPage);
                });
                var r = [];
                $.each($('.reorderBlock'), function(i,v) {
                    tmp = $(this).attr('data-reorder-page') + ':' + $(this).attr('data-id');
                    if(reorderFIXED) tmp += ':' + el_fixed[2];
                    r.push(tmp);
                });

                var view_page = (reorderFIXED) ? el_fixed[1] : PAGE;
                $.ajax({
                    type: 'POST',
                    url: '/template/update/type/block-reorder',
                    data: { s: JSON.stringify(r), id: SID, page: view_page, onepage : ONE},
                    async:false,
                    cache: false,
                    success: function (data) {
                        var type = getElementType();
                        setLogs(type,"block.reorder","block-sort","");
                        $('.element').removeClass('active').removeClass('el-active');
                        $('#el-property').hide();

                        if(!prevONE && !VIEW) {
                            var check = 'false';
                            $.ajax({
                                type: 'POST',
                                url: '/template/update/type/onepage',
                                data: { id : SID, s : check },
                                dataType: 'json',                    
                                async: true,
                                success: function(r) {
                                    internalLink = true;
                                    var refer = prevPAGE.replace(",","/view/");
                                    location.replace('/'+CONFIG_URL+'config/page/' + refer);
                                    $('.el-sortable').empty();
                                    $.processOFF();
                                    $.reorderOFF();
                                }
                            });                      
                        } else {
                            $('.el-sortable').empty();
                            $.processOFF();
                            $.reorderOFF();
                            checkError(data);
                            showPageCallback(showPage);
                        }
                    }
                });
                /*
                var ids = [];
                $.each($('.render'), function(i,v) {
                    if(typeof $(v).attr('data-id') != 'undefined') ids.push($(v).attr('data-id').trim());
                });

                $.post('/template/update/type/block-reorder',{ id : SID, page : PAGE, s:ids.join(",")}, function(data) {
                    checkError(data);
                },'json');
                return false;
                */
            });

            $content.append($h1);
            $h1.append($save);
            $h1.append($close);
            $content.append($scale);
            $reorder.append($content);
            $reorder.fadeIn();

            //var $scale = $('<div class="scale"></div>');
            //$scale.css('color',$('.dsgn-body').css('color'));
            var pages = -1, pageIndex = 0, pageEL = [];
            var pageList = [];

            $.each($('.element'),function(i,v) {
                if( $(v).hasClass('el-menu') || 
                    $(v).hasClass('el-footer') || 
                    $(v).hasClass('add-footer-information') ||
                    $(v).hasClass('cl-s-product-review') ||
                    $(v).hasClass('cl-s-product-qna')
                ) return true;

                if(reorderFIXED) {
                    if($(v).hasClass('el-fixedblock')) {
                        if($(v).attr('data-posby') != el_fixed[2]) return true;
                    } else return true;
                } else {
                    if($(v).hasClass('el-fixedblock')) return true;
                }
                    
                var classes = $(v).attr('class').split(/\s+/);
                if(ONE && !VIEW) {
                    $.each(classes,function(index,item) {
                        if(item.match(/link-to-\S+/g)) {
                            var name_check = item.replace('link-to-','');
                            if($.inArray(name_check,MENULINK) > -1) {
                                pages++;
                                pageIndex=0;
                                pageList[pages] = [];
                            }
                        }
                    });
                } else {
                    if(pages == -1) {
                        pages++;
                        pageList[pages] = [];
                    }
                }
                pageList[pages][pageIndex] = $(v).attr('data-el').replace(/ /g,"-");
                pageIndex++;
            });

            var elIndex = 0;
            var $sort = $('<div class="el-sortable"></div>');
            $sort.css('color',$('.dsgn-body').css('color'));

            var pageMenu = [];
            if(PAGE == 'index') {
                $.each(MENULINK,function(i,v) {
                //$.each(SMENU,function(i,v) {
                    pageMenu.push(v.replace(/ /g,"-"));
                    //if(v.display == 'on') pageMenu.push(v.name);
                });
            } else {
                var view_page = (reorderFIXED) ? el_fixed[1] : PAGE;
                pageMenu.push(view_page);
                pageList = pageList.filter(function(){ return true; });
            }

            $.each(pageMenu, function(index,val) {

                var $empty = $('<div class="render sort-empty" data-result-page="' + val + '">&nbsp;</div>'),
                    $pageLine = $('<div class="sort-page-line"></div>'),
                    pageName = val.replace(/,/,'/'),
                    menulist_index = $.inArray(pageName,MENULIST),
                    pageNameOrg = (index==0 && pageName=='INTRO') ? pageName : $('#nestable').find('.dd-item').eq(menulist_index-1).attr('data-id'),
                    $pageInfo = $("<div class='sort-page-info'>" + pageNameOrg + "</div>"),
                    isLink = (index==0 && pageName=='INTRO' || menulist_index == -1) ? false : $('#nestable').find('.dd-item').eq(menulist_index-1).find('.menu-link').first().hasClass('active');
                
                if(pageName.indexOf("/")>-1 || reorderFIXED) $pageInfo.addClass('hide');

                if($('#nestable *[data-id="' + pageNameOrg + '"]').length) {
                    var pMenu = $('#nestable *[data-id="' + pageNameOrg + '"]').parents('.dd-item').attr('data-id');
                    if(typeof pMenu != 'undefined') $empty.append('<div class="sort-page-menu">' + pMenu + '</div>');
                }
                if(index==0) $empty.removeClass('render');
                $empty.append($pageLine);
                $empty.append($pageInfo);

                $empty = (isLink) ? $empty.addClass('use-link') : $empty;
                if(!isLink) $sort.append($empty);

                $.each(pageList[index], function(i,v) {
                    var $el = $('.'+v).clone();
                    // var isLink = $('#nestable .dd-item[data-id="'+pageNameOrg+'"] > span > .menu-link').hasClass('active');
                    if($el.attr('data-parallax')=='true') {
                        $el.css('background-attachment','fixed');
                    }

                    $el.removeClass('element')
                        .removeClass('el-active')
                        .removeClass('active')
                        .removeClass('emptyGallery')
                        .removeClass('el-fixedblock')
                        .removeAttr('data-parallax')
                        .addClass('render')
                        .addClass('reorderBlock')
                        .attr('data-reorder-page',val);

                    if(elIndex==0) {
                        $el.css('margin','0px');
                        if(VIEW && ($el.attr('data-type')=='project' || $el.attr('data-type')=='product')) $el.addClass('unsort');
                    }
                    if($el.attr('data-msny')=='true' && $el.find('.container').hasClass('full-width')) {
                        $el.css('padding-left',$('header.sidebar').width()+'px');
                    }
                    if($('.'+v).css('background-color')=='rgba(0, 0, 0, 0)' || $('.'+v).css('background-color')=='transparent') {
                        $el.css('background-color',$('.dsgn-body').css('background-color'));
                    }

                    $el.find('[data-edit="true"]').removeAttr('data-edit');
                    $el.css('position','relative');
                    $el.css('min-height','0px');
                    $el.css('margin-bottom','120px');
                    
                    if(!isLink) $sort.append($el);
                    elIndex++;
                });
            });
            var $last = $("<div class='render sort-empty'></div>");
            $sort.append($last);
            $scale.append($sort);

            $scale.css('height',(($scale.height()*0.22)+($('.sort-empty').length*50))+'px');

            $.each($('.sort-empty'),function(i,v) {
                if($(this).next().hasClass('sort-empty') && !$(this).next().hasClass('page')) {
                    var $empty = $('<div class="sort-empty page">PAGE EMPTY</div>');
                    //var $empty = ($(this).hasClass('use-link')) ?  $("<div class='sort-empty page'>PAGE LINKED</div>") :  $("<div class='sort-empty page'>PAGE EMPTY</div>");
                    if(!$(this).hasClass('page')) $(this).after($empty);
                }
            });

            $('.reorderModal').scrollTo('.reorderBlock[data-id="' + selectID + '"]',{offset:-200});
            $('.reorderBlock[data-id="' + selectID + '"]').addClass('active');
            blockSortable();
        }
    }

    jQuery.reorderOFF = function() {
        $('.reorderModal').fadeOut(function() {
            $(this).remove();
            reorderFIXED = '';
        });
    }

    jQuery.viewON = function() {
        var $view = $('<div class="viewModal"></div>');

        if ($('.viewModal').length < 1) {
            $view.css({
                "position" : "fixed",
                "width" : "100%",
                "height" : "100%",
                "background" : "#FFF url(https://storage.googleapis.com/i.addblock.net/preloader2.gif) center center no-repeat",
                "z-index" : "10000000000",
                "display" : "none",
                "overflow" : "auto"
            });
            $('body').prepend($view);
            var $content = $('<div class="content"></div>'),
                $h1 = $("<h1></h1>").css({
                    'position' : 'absolute',
                    'z-index' : '100001',
                    'right' : '0px'
                }),
                $close = $("<div class='pull-right'><i class='fa fa-times'></i></div>").css({
                    'margin-right' : '18px',
                    'margin-top' : '-16px',
                    'background-color': '#556273',
                    'color': '#fff',
                    'font-size': '18px',
                    'padding': '6px 9px',
                    'cursor': 'pointer',
                    'border-radius' : '20px'
                }),
                $iframe = $("<iframe src='http://" + SID + "." + HOST + "/render/" + PAGE + "'></iframe");

            $iframe.css({
                'position' : 'absolute',
                'top' : '0',
                'left' : '0',
                'width' : '100%',
                'height' : '100%',
                'z-index' : '100000',
                'border' : 'none'
            });


            $close.on('click',function() {
                $.viewOFF();
            });
            $content.append($h1).append($iframe);
            $h1.append($close);
            $view.append($content);
            $view.fadeIn();
        }
    }

    jQuery.viewOFF = function() {
        $('.viewModal').fadeOut(function() {
            $(this).remove();  
        });
    }

    jQuery.historyON = function() {
        viewmode('view');
    }

    $.fn.showUpgradePlanModal = function(sid, plan, upgrade_plan, fn) {
        if($('.site-upgrade-wrap').length > 0 || typeof checkUpgradeModal != "undefined" && checkUpgradeModal) return false;
        var checkUpgradeModal = true;

        var check_plan = (!plan || plan == 'FR' || plan == 'FREE') ? false : true,
            log_fn = (!fn) ? '' : '.' + fn,
            log_plan = (!upgrade_plan) ? '' : '.' + upgrade_plan,
            upgrade_plan = (!upgrade_plan) ? '' : '/plan/' + upgrade_plan,
            upgrade_url = (!upgrade_plan) ? '/upgrade' : ((check_plan) ? '/upgrade/change/site/' + sid + upgrade_plan : '/upgrade/buy/site/' + sid + upgrade_plan),
            modal_title = $.lang[LANG]['config.upgrade-plan' + log_plan + log_fn + '.title'],
            modal_description =  $.lang[LANG]['config.upgrade-plan' + log_plan + log_fn + '.description'],
            str = '\
                <div class="site-upgrade-wrap">\
                    <p class="description">' + modal_description + '</p>\
                    <div class="btn-box">\
                        <a href="' + upgrade_url + '"><i class="fa fa-level-up"></i>'+$.lang[LANG]['config.upgrade-plan.btn']+'</a>\
                    </div>\
                </div>\
            '; 

        var modal = $(this).showModalFlat(modal_title, str, false, false, '', '', '', '', '', '', '', function() {
            checkUpgradeModal = false;
        });
    }

    $.fn.showModal = function (header, content, footer, cancel, confirm, callback) {
        $('.editor-navbar').css('z-index','1030');
        var HTML = '<div class="modal modal-default fade" id="generic-modal">' +
            '   <div class="modal-dialog" style="padding-top:5%;">' +
            '       <div class="modal-content">' +
            '           <button type="" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"><img src="https://storage.googleapis.com/i.addblock.net/fa-close-modal.png" alt="close"></span></button>' +
            '           <div class="modal-body">' +
            '               <h3 class="modal-title">' + header +
            '               </h3>' + content +
            '           </div>';
            if(footer==true) {
                HTML = HTML + '<div class="modal-footer">';
                if(cancel == true) {
                    HTML = HTML + '<button type="button" class="btn btn-default btn-sm" data-dismiss="modal">취소</button>';
                } else if(confirm == true) {
                    HTML = HTML + '<button type="button" class="btn btn-primary btn-sm ok-button-dialog">확인</button>';
                }
                HTML = HTML +
                '       </div>';
            }
            HTML = HTML +
            '       </div>' +
            '   </div>' +
            '</div>';

        var container = $('<div class="generic-modal"></div>').html(HTML);
        $('body').append(container);
        var newInstance = jQuery.extend(true, {}, container);
        newInstance.find('.ok-button-dialog').bind('click', function () {
            callback();
        });
        var modalElement = newInstance.find('#generic-modal');
        modalElement.modal();

        modalElement.on('hidden.bs.modal', function(e) {
            // $('.editor-navbar').css('z-index','1040');
            $('.generic-modal').remove();
            $('.modal-backdrop').remove();
        });

        return modalElement;
    }


    $.fn.showModalFlat = function (header, content, footer, confirm, callback, closetext, oktext, size, backdrop, closecallback, showcallback, hidecallback) {
        // if($('#flat-modal.event').length) return;

        size = (typeof size == 'undefined') ? '' : size;        
        if(size.indexOf(',') > -1) {
            var modal_name = size.split(','),
                modal_class = '';

            size = modal_name[0];
            modal_class = modal_name[1];
        }

        backdrop = (typeof backdrop != 'undefined' && backdrop === true) ? true : false;

        // $('.editor-navbar').css('z-index','1030');

        var checkCLBtnMode = (size.indexOf('cl-s-btn') > -1) ? true : false,
            close_btn = $.lang[LANG]['config.close'],
            close_btn_class = 'btn-default',
            ok_btn = $.lang[LANG]['config.ok'],
            ok_btn_class = 'btn-primary';

        if( closetext == 'cancel') {
            close_btn = $.lang[LANG]['config.cancel'];
        } else if( closetext == 'close' ) {
            close_btn = $.lang[LANG]['config.close'];
        } else if( closetext == 'ok' ) {
            close_btn = $.lang[LANG]['config.ok'];
            close_btn_class = 'btn-primary ok-button-dialog';
        } else if ( typeof closetext != 'undefined') {
            if( closetext.match(/\./g) !== null ) close_btn = $.lang[LANG][closetext];
            else if(closetext.length > 0) close_btn = closetext;
        }
        
        if( oktext == 'save' ) {
            ok_btn = $.lang[LANG]['config.save'];
        } else if( oktext == 'send' ) {
            ok_btn = $.lang[LANG]['config.send'];
        } else if( oktext == 'ok' ) {
            ok_btn = $.lang[LANG]['config.ok'];
        } else if ( typeof oktext != 'undefined') {
            if( oktext.match(/\./g) !== null ) ok_btn = $.lang[LANG][oktext];
            else if(oktext.length > 0) ok_btn = oktext;
        }

        var flat_modal_id = ($('.modal-default').length == 0) ? 'flat-modal': 'flat-modal'+$('.modal-default').length;

        var HTML = '<div class="modal modal-default fade" id="'+flat_modal_id+'">' +
            '   <div class="modal-dialog '+size+'">' +
            '       <div class="modal-content">' +
            '           <button type="" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M8.71 8l7.15-7.15c0.2-0.2 0.2-0.51 0-0.71s-0.51-0.2-0.71 0L8 7.29 0.85 0.15c-0.2-0.2-0.51-0.2-0.71 0s-0.2 0.51 0 0.71L7.29 8l-7.15 7.15c-0.2 0.2-0.2 0.51 0 0.71C0.24 15.95 0.37 16 0.5 16s0.26-0.05 0.35-0.15L8 8.71l7.15 7.15c0.1 0.1 0.23 0.15 0.35 0.15s0.26-0.05 0.35-0.15c0.2-0.2 0.2-0.51 0-0.71L8.71 8z"/></svg></span></button>' +
            '           <div class="modal-body">' +
            '               <h3 class="modal-title">' + header +
            '               </h3>' + content +
            '           </div>';
            if(footer==true) {
                HTML = HTML + 
                '      <div class="modal-footer">';

                var btn_html = '<button type="button" class="btn '+ close_btn_class +' btn-sm close-button-dialog" data-dismiss="modal">' + close_btn + '</button>';                
                if(confirm == true) {
                    if(checkCLBtnMode) {
                        btn_html = '<button type="button" class="btn '+ ok_btn_class +' btn-sm ok-button-dialog">' + ok_btn + '</button>' + btn_html;
                    } else {
                        btn_html = btn_html + '<button type="button" class="btn '+ ok_btn_class +' btn-sm ok-button-dialog">' + ok_btn + '</button>';
                    }
                } 
                HTML = HTML + btn_html + 
                '      </div>';
            }
            HTML = HTML +
            '       </div>' +
            '   </div>' +
            '</div>';
        var time = new Date().getTime();
        var container = $('<div class="flat-modal"></div>').html(HTML);
        if(typeof modal_class != "undefined" && modal_class) container.addClass(modal_class);
        if(size && size.indexOf('cl-modal') > 0 || (size && size.indexOf('cl-cmmodal') > -1)) {
            var mobile_close_btn = '\
                    <button class="cl-mobile-btn close" data-dismiss="modal" aria-label="Close">\
                        <span aria-hidden="true">\
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16">\
                                <polygon points="16 1 15 0 8 7 1 0 0 1 7 8 0 15 1 16 8 9 15 16 16 15 9 8 "/>\
                            </svg>\
                        </span>\
                    </button>\
                    ';

            container.find('.modal').prepend(mobile_close_btn);
            
            if(confirm==false && closetext=='close') container.find('.close-button-dialog').addClass('clostbtnfalse'); //닫기 버튼 하나일 경우 공통 class

            if(size.indexOf('cl-modal') > -1) container.addClass('cl-flat-modal');
            else if(size.indexOf('cl-cmmodal') > -1) container.addClass('cl-common-modal');

            if(size.indexOf('pg-modal') > -1) container.addClass('pg-modal-wrap'); 
            else if(size.indexOf('cl-common-notice') > -1) {  //공통 notice icon 추가
                var svg = '\
                    <svg xmlns="http://www.w3.org/2000/svg" class="cl-notice-icon" viewBox="0 0 90 90" width="90" height="90"><path d="M45 4c22.61 0 41 18.39 41 41S67.61 86 45 86 4 67.61 4 45 22.39 4 45 4M45 0C20.15 0 0 20.15 0 45s20.15 45 45 45 45-20.15 45-45S69.85 0 45 0L45 0z"/>\
                        <path d="M45 20L45 20c1.1 0 2 0.9 2 2v32c0 1.1-0.9 2-2 2h0c-1.1 0-2-0.9-2-2V22C43 20.9 43.9 20 45 20z"/><circle cx="45" cy="67" r="3"/>\
                    </svg>\
                    ';
                container.find('.modal-title').before(svg);
                if(size.indexOf('modal-over-1') > -1) container.addClass('modal-over-1');
           } else if(size.indexOf('guidePopup') > -1) {
                container.find('.modal-title').not('.guidetitle').remove();
                container.addClass('guidePopup-wrap');
            }
        }


        $('body').append(container);
        var newInstance = jQuery.extend(true, {}, container);
        var modalElement = newInstance.find('#'+flat_modal_id);
        if(backdrop) modalElement.modal({ backdrop : 'static'});
        else modalElement.modal();

        newInstance.find('.ok-button-dialog').bind('click', function () {
            if(typeof callback == 'function')
                callback();
        });

        newInstance.find('.close-button-dialog').bind('click', function () {
            if(typeof closecallback == 'function') {
                closecallback();
            }
        });

        modalElement.on('shown.bs.modal', function(e) {
            var modal = document.querySelector('.modal');
            modal.style.position = 'absolute';
            setTimeout(function() {
                modal.style.position = 'fixed';
            },0);
            if(typeof showcallback == 'function') showcallback();
        });

        modalElement.on('hidden.bs.modal', function(e) {
            var flat_modal_id = $(this).attr('id');
            // $('.editor-navbar').css('z-index','1040');
            var this_modal = $('#'+flat_modal_id).closest('.flat-modal');
            this_modal.next('.modal-backdrop').remove();
            this_modal.remove();

            if($('.modal-backdrop').length) {
                setTimeout(function() {
                    $('body').addClass('modal-open');    
                },10);                
            }
            $('body').removeClass('no-fixed');
            if(typeof hidecallback == 'function') hidecallback();
        });

        return modalElement;
    }    


    $.fn.showPopupModal = function (data,sid) {
        var img_count = data.length,
            img_w = new Array(), 
            img_h = new Array(), 
            counter = 0,
            sid = (typeof sid != 'undefined') ? sid : SID,
            popup_data = new Array();

        $('#el-empty').html('');
        $.each(data,function(i,v) {
            var $img = $('<img/>').attr('src',v.popupimg);
            $('#el-empty').append($img);
        });

        var $imgs = $('#el-empty img');
        $.each($imgs,function(i,v) {
            $(this).one('load',function() {
                counter++;
                img_w[i] = this.width;
                img_h[i] = this.height;
                if(counter == img_count) getPopupFunction();
            });
            if(this.complete) $(this).load();
        });

        function getPopupFunction() {
            $('#el-empty').html('');
            var html = '',
                display = new Array();

            $.each(data, function(i,o) {
                var isCookie = ($.cookie(sid + 'Popup' + i)) ? 'style= display:none;' : '';
                display.push(isCookie);

                var plink = (typeof o.popuplink != "undefined" && o.popuplink != "javascript:;" && o.popuplink.length > 0) ? o.popuplink : "javascript:;",
                    plink_target = (typeof o.popuplink_target != "undefined" && o.popuplink_target === true) ? 'target="_blank"' : '',
                    link_option = '';

                if(typeof o.popuplink == "undefined") o.popuplink = '';
                if(typeof o.popuplink_target == "undefined") o.popuplink_target = '';
                if(typeof o.popuptime == "undefined") o.popuptime = '';

                if(plink != '' && plink != "javascript:;") {
                    if(checkBase64Encode(plink)) plink = Base64.decode(plink);
                    var _menuList = (PAGE_MODE == 'c') ? MENULIST : property.MENULIST;
                    
                    if(plink.match(/^\@/g) !== null) {                                                  // link-type: link-bookmark ==> a[attr-bookmark]
                        var _settings = (PAGE_MODE == 'c') ? SETTINGS : property.SETTINGS,
                            bookmark_seq = plink.replace(/^\@/g,'');
                            
                        if(typeof _settings == 'undefined' || typeof _settings.blockBookmarkList == 'undefined' || _settings.blockBookmarkList['bookmark' + bookmark_seq] == 'undefined') {
                            plink = '';
                            link_option = '';
                        } else {
                            link_option = 'attr-bookmark="' + bookmark_seq + '"';
                        }
                    } else if(_menuList.indexOf(plink.replace(/^\//g,"").replace(/ /g,"-")) > -1) {     // link-type: link-menu     ==> a[data-user-link]
                        link_option = 'data-user-link="' + plink + '"';
                    } else {                                                                            // link-type: link-out      ==> a[attr-link]
                        link_option = 'attr-link="' + plink + '"';
                    }

                    plink = (PAGE_MODE == 'c') ? makeLinkUrl(plink, ONE, VIEW) : makeLinkUrl(plink, property.ONE, property.VIEW);
                }

                html = html + '<div class="modal-popup" id="' + sid + 'Popup' + i + '" data-link="' + plink + '" data-target="' + o.popuplink_target + '" data-time="' + o.popuptime + '" data-idx="' + i + '" ' + display[i] + '>' + 
                '   <div class="popup-content">' +
                '       <div class="popup-header">' +
                '           <button type="button" class="close popup-close"><span aria-hidden="true"><svg viewBox="0 0 12 12" width="12" height="12"><path d="M6.71 6l5.15-5.15c0.2-0.2 0.2-0.51 0-0.71s-0.51-0.2-0.71 0L6 5.29 0.85 0.15c-0.2-0.2-0.51-0.2-0.71 0s-0.2 0.51 0 0.71L5.29 6l-5.15 5.15c-0.2 0.2-0.2 0.51 0 0.71C0.24 11.95 0.37 12 0.5 12s0.26-0.05 0.35-0.15L6 6.71l5.15 5.15c0.1 0.1 0.23 0.15 0.35 0.15s0.26-0.05 0.35-0.15c0.2-0.2 0.2-0.51 0-0.71L6.71 6z"/></svg></span></button>' +
                '       </div>' +
                '       <div class="popup-body">' +
                '          <a href="' + plink + '" ' + plink_target  + ' ' + link_option + '>' +
                '             <div class="img-wrap">' +
                '               <img src="' + o.popupimg + '" alt="" class="img-responsive img-popup" />' +
                '             </div>' +
                '          </a>' +
                '       </div>' +
                '       <div class="popup-footer clearfix">' +
                '           <ul class="text-center">' +
                '               <li class="sitePopupTodayHide">' +
                '                   <input type="checkbox" value="" class="hide">' +
                '                   ' + $.lang[LANG]['editor.popup.close-24hours'] + 
                '               </li>' +
                '               <li class="sitePopupClose">' + $.lang[LANG]['config.close'] + '</li>' +
                '           </ul>' +
                '       </div>' +
                '   </div>' +
                '</div>';
                if(data.length == (i+1) )  setPopupFunction(html,display);
            });

        }

        function setPopupFunction(html, display) {

            var container = $('<div class="popup"></div>').html('<div class="popup-modal">' + html + '</div>');
            if($('.dsgn-body').find('.popup').length > 0 )  { 
                $('.dsgn-body').find('.popup').replaceWith(container);
            } else { 
                $('.dsgn-body').append(container); 
            }

            var newInstance = jQuery.extend(true, {}, container);
            var sitePopupElement  = newInstance.find('.popup-modal');

            var total_w = 0,
                add_w = 0, 
                d_top = $('.header.el-menu').outerHeight() + 15, 
                d_left = 0,
                x = 0, y = 0, y_r = 0;

            for(i=0; i<img_w.length; i++) {
                if(parseInt(img_w[i]) > $('.dsgn-body').width()-30 ) {
                    img_w[i] = $('.dsgn-body').width()-30;
                }
                if(display[i]) { 
                    continue;
                } else {
                    total_w = total_w + parseInt(img_w[i]) + 30;
                }
            }
           
            var isOverflow = ($('.dsgn-body').width() < total_w) ? true : false,
                display_i = -1;
            
            if(isOverflow) { sitePopupElement.addClass('popupimg-overflow-y');
            } else { sitePopupElement.removeClass('popupimg-overflow-y'); }

            $.each(img_w, function(i,v) {
                if(display[i]) {
                    return true;
                } else {
                    display_i++;
                }

                if(isOverflow) {
                    x = (display_i==0) ? d_top : d_top + (display_i*30);
                    y = d_left + ((display_i+1)*30);
                    y_r = 120 - y;

                    img_w[i] = 'auto';
                } else {
                    d_left = ($('.dsgn-body').width() - total_w)/2;

                    x = d_top;
                    y = d_left + add_w + (i*15);
                }
                add_w = add_w + v;

                var css_val = (isOverflow) ? {'top': x +'px', 'left': y+'px', 'right': y_r+'px', 'margin-left': '0px', 'width': img_w[i], 'max-width': v} : {'top': x +'px', 'left': y+'px' , 'width': img_w[i]};
                sitePopupElement.find('#'+sid +'Popup'+ i).css(css_val);
            });
            return sitePopupElement;
        }
    }


    $.fn.forumModal = function (header, content, footer, confirm, callback, closetext) {
        $('.editor-navbar').css('z-index','1030');
        var confirm_btntext = '',
            confirm_btn_class = 'btn-default';
        if( closetext == 'cancel' ) {
            confirm_btn = $.lang[LANG]['config.cancel'];
        } else if( closetext == 'ok') {
            confirm_btn = $.lang[LANG]['config.ok'];
            confirm_btn_class = 'btn-primary';
        } else {
            confirm_btn = $.lang[LANG]['config.close'];
        }
        var HTML = '<div class="modal modal-default fade" class="forum-modal" id="forum-modal">' +
            '   <div class="container">' +
            '       <div class="modal-content">' +
            '           <div class="modal-body">' +
            '               ' + content +
            '           </div>';
            HTML = HTML +
            '       </div>' +
            '   </div>' +
            '</div>';
                HTML = HTML +
                "<ul class='sideToolbar'>" + 
                "   <li><img src='https://storage.googleapis.com/i.addblock.net/icon/stbImage.png' class='tb-attach-file'></li>" +
                "   <li><img src='https://storage.googleapis.com/i.addblock.net/icon/stbVideo.png' class='tb-video-insert'></li>" +
                "   <li><img src='https://storage.googleapis.com/i.addblock.net/icon/stbAttach.png' class='tb-file-insert'></li>" +
                "   <li><img src='https://storage.googleapis.com/i.addblock.net/icon/stbMap.png' class='test'></li>" +
                // "   <li><img src='https://storage.googleapis.com/i.addblock.net/icon/stbDivider.png'></li>" +
                "</ul>";
            if(footer==true) {
                HTML = HTML + 
                '      <div class="modal-footer">';
                if(confirm == true) {
                    HTML = HTML + 
                '        <div class="pull-right"><button type="button" class="btn btn-default btn-xs btn-modal ok-button-dialog">' + $.lang[LANG]['config.ok'] + '</button></div>';
                }
                HTML = HTML + 
                '        <div class="pull-right"><button type="button" class="btn '+ confirm_btn_class +' btn-xs btn-modal no-border" data-dismiss="modal">' + confirm_btn + '</button></div>';
                HTML = HTML +
                '      </div>';
            }
        var time = new Date().getTime();
        var container = $('<div class="forum-modal fade"></div>').html(HTML);
        $('body').append(container);
        var newInstance = jQuery.extend(true, {}, container);
        var modalElement = newInstance.find('#forum-modal');
        modalElement.modal({
            keyboard: false,
            backdrop: 'static'
        });

        newInstance.find('.ok-button-dialog').bind('click', function () {
            callback();
        });

        newInstance.find('button[data-dismiss="modal"]').bind('click', function () {
            modalElement.modal('hide');
        });

        modalElement.on('scroll', function() {
            $('.fr-line-breaker').css('left','-100%');
            var thisPos = $(this).scrollTop(),
                newPos = (scrollPos > thisPos) ? (scrollPos - thisPos) :  (scrollPos - thisPos),
                newPos2 = (scrollPos2 > thisPos) ? (scrollPos2 - thisPos) :  (scrollPos2 - thisPos),
                caPos = Number(toolPos) + Number(newPos),
                caPos2 = Number(popPos) + Number(newPos);

            $('.fr-toolbar').css('top', caPos + 'px');

            if(frAbove) {
                var caPos2 = caPos -170;
                if($('.fr-popup.fr-active .fr-link-insert-layer.fr-active').length) caPos2 = caPos-180;
                if($('.fr-popup.fr-active button[data-cmd="linkOpen"]').length) caPos2 = caPos + 170;
           }

            if($('.fr-active').prev().hasClass('fr-image-overlay')) {
                $('.fr-popup.fr-active').css('top', (Number(popPos) + Number(newPos)) + 'px');  
            } else {
                if($('.fr-popup').hasClass('fr-above')) caPos2 = caPos2 - 20;
                $('.fr-popup').css('top', caPos2 + 'px');  
            }
            // console.log(caPos2);
            // console.log('caPos : ' + caPos + ', caPos2 : ' + caPos2);
        });
        modalElement.on('hide.bs.modal', function(e) {
            $('.forum-modal').removeClass('in');
        });
        modalElement.on('hidden.bs.modal', function(e) {
            // $('.editor-navbar').css('z-index','1040');
            $('.tmp-user').remove();
            $('.note-dialog').remove();
            $('.forum-modal').remove();
            $('.modal-backdrop').remove();
            $('#fm-editor').froalaEditor('destroy');
        });

        return modalElement;
    }           

    jQuery.guideVideoON = function() {
        // 편집 모드를 처음으로 보는 경우가 아니면 ( 주요기능을 이미 둘려봤으면 )
        if( LANG == 'ko' || typeof SETTINGS.showGuide != 'undefined')
            return false;

        hideElementListPanel();
        var $guideVideoModal = $('<div class="guideVideoModal config-modal"></div>'),
            $content = $('<div class="content"></div>');

        if ($('.guideVideoModal').length < 1) {
            $('body').prepend($guideVideoModal);
            $content.css({
                "width" : "100%",
                "height" : "100%",
                "background-color" : "rgba(0,0,0,0.6)",
                "display" : "none"
            });

            $guideVideoModal.append($content);
            $guideVideoModal.css({
                "display": "inherit",
                "position": "fixed",
                "z-index": "99999999",
                "top": "0",
                "left": "0",
                "width": "100%",
                "height": "100%",
                "text-align": "center",
                "background-color" : "transparent"
            });
            $guideVideoModal.fadeIn();

            var $guideVideo = $('<div class="guideVideo">'),
                $close = $('<div class="close"><img src="https://storage.googleapis.com/i.addblock.net/fa-close-modal.png" alt="close" /></div>'),
                $close2 = $('<button type="button" class="btn btn-primary btn-sm ok-button-dialog">' + $.lang[LANG]['config.ok'] + '</button>');
                $header = $('<div class="header"><h2>' + $.lang[LANG]["editor.guide.tutorial-video"] + '</h2></div>'),
                $body = $('<div class="body"></div>'),
                $contentbox = $('<div class="contentbox"></div>'),
                $tutorialVideo = $('<div class="tutorial-video"></div>'),
                $videoWrap = $('<div class="video-wrap guideVideo-stopPlay"><div id="guide-video-modal-video-overlay"></div></div>'),
                $watchAgainNote = $('<span class="watch-again-note">' + $.lang[LANG]['tutorial-video.watch-again-note'] + '</span>'),
                $bottom = $('<div class="bottom"></div>');

            $close.on('click',function() { $.guideVideoOFF(); });
            $close2.on('click',function() { $.guideVideoOFF(); });

            $videoWrap.on('click', function() {

                $(this).toggleClass('guideVideo-stopPlay');

                if(!$(this).hasClass('guideVideo-stopPlay')) {
                    if ( LANG == 'en' )
                        var link = "https://www.youtube.com/embed/p6fyIMl2BcI";

                    var html = '<iframe class="video embed-responsive-item" width="765" height="380" src="' + link + '?enablejsapi=1&rel=0&vq=large&wmode=opaque&showinfo=0&controls=1&autoplay=0&loop=0;playlist=Fn0Mpyh3xto;" frameborder="0" allowfullscreen></iframe>';

                    $(this).html(html);

                }
            });

            $tutorialVideo.append( $videoWrap );
            $contentbox.append( $tutorialVideo );

            $bottom.append($close2).append($watchAgainNote);
            $body.append($contentbox).append($bottom);
            $guideVideo.append($header).append($close).append($body);
            $content.append($guideVideo);
            $content.fadeIn();

        }

        var $thisContent = $('.guideVideoModal .contentbox');
        
    }

    jQuery.guideVideoOFF = function() {
        $('.guideVideoModal').fadeOut(function() {
            $(this).remove();  
        });
    }

    jQuery.siteCopy = function(sid, dest_sid, check, code) {
        var deferred = jQuery.Deferred();
        $.ajax({
            type: 'POST',
            url: '/template/siteCopy/1',
            data: { sid : sid, dest : dest_sid, check : check, code : code },
            dataType: 'json',                    
            async: true,
            success: function(data) {
                deferred.resolve(data);
            }
        });
        return deferred.promise();
    }

    jQuery.siteDelete = function(sid,code) {
        var deferred = jQuery.Deferred();
        $.ajax({
            url: '/template/deleteSiteLanguage/1',
            data : { sid : sid, code : code },
            type: 'POST',
            dataType: 'json',
            async: true,
            cache: false,
            success: function (data) {
                deferred.resolve(data);
            }
        });
        return deferred.promise();
    }    

    $.musicON = function(play) {
        play = (typeof play == 'undefined') ? true : play;
        var tpl = '\
            <div id="cl-music-player" class="cl-mplayer"></div>\
            <div id="cl-music-container" class="jp-audio" role="application" aria-label="media player">\
                <div class="jp-type-playlist">\
                    <div class="jp-gui jp-interface">\
                        <div class="jp-controls-holder">\
                            <div class="jp-controls">\
                                <div class="music-player-controls">\
                                    <span class="jp-backward" role="button" tabindex="0"><i class="fa fa-backward" aria-hidden="true"></i></span>\
                                    <span class="jp-play" role="button" tabindex="0"><i class="fa fa-pause" aria-hidden="true"></i></span>\
                                    <span class="jp-forward" role="button" tabindex="0"><i class="fa fa-forward" aria-hidden="true"></i></span>\
                                </div>\
                                <div class="music-player-progress">\
                                    <div class="jp-progress">\
                                        <div class="jp-seek-bar">\
                                            <div class="jp-play-bar"></div>\
                                        </div>\
                                    </div>\
                                </div>\
                                <div class="jp-lists">\
                                    <span class="music-lists" role="button" tabindex="0">LIST</span>\
                                </div>\
                                <div class="music-playlist-wrap">\
                                    <div class="jp-playlist"><ul class="music-playlist"><li></li></li></div>\
                                </div>\
                            </div>\
                        </div>\
                    </div>\
                    <div class="jp-no-solution">\
                        <span>Update Required</span>\
                        To play the media you will need to either update your browser to a recent version or update your <a href="http://get.adobe.com/flashplayer/" target="_blank">Flash plugin</a>.\
                    </div>\
                </div>\
            </div>\
            ',
            equalizer_img = ($('body').width() < 769) ? "https://storage.googleapis.com/i.addblock.net/equal_stop.gif" : "https://storage.googleapis.com/i.addblock.net/equal.gif",
            checkFree = (!property.VALIDPLAN || property.VALIDTYPE == 'FR' || property.VALIDPLAN == 'PK') ? true : false,
            move_position = (checkFree) ? "class='moved'" : "",
            vpModeOnoff = (property.SETTINGS.vpMode_onoff === true) ? true : false,
            vpOption = (property.SETTINGS.viewportMode) ? property.SETTINGS.viewportMode : '',
            WebType = $.mpcWeb.mpcCheckWebType(),
            checkFnav = ($('.fnav').length > 0 && vpOption=="mobile_web") ? true : false,
            $music_icon = $("<div id='cl-music-player-icon' "+move_position+"><img src='" + equalizer_img + "' class='hand'></div>");

        $('#goto-top').after($music_icon);
        $('#cl-music-player-icon').after(tpl);

        if($('.fnav').length > 0) {
            if(window.innerWidth <= 480) {
                $('#goto-top').addClass('movedOne');
                $music_icon.addClass('movedOne');
            } 
        }

        if(vpModeOnoff && WebType == 'MOBILE') $.mpcWeb.mpcMusicandGoTop(checkFnav,vpOption);

        ($('body').width() < 769) ? $('.jp-play i').removeClass('fa-pause').addClass('fa-play').parent().addClass('pause') : "";
        var music = (typeof property == "undefined") ? [] : property.MUSIC;

        if(music.length==0) {
            $music_icon.addClass('hide');
        }
        var myPlaylist = new jPlayerPlaylist({
            jPlayer: "#cl-music-player",
                cssSelectorAncestor: "#cl-music-container"
            }, music, {
            playlistOptions: {
                loop: true,
                autoPlay: play,
                loopOnPrevious: true,
                enableRemoveControls: false
            },
            ended: function() { 
                // var $item = $('.music-playlist li'),
                //     idx = $item.parent().find('.active').index(),
                //     active = (idx+1 > $item.length) ? 0 : idx+1;

                // $item.removeClass('active');
                // $item.eq(active).addClass('active');
            },            
            swfPath: '/js',
            solution: 'html, flash',
            supplied: 'mp3',
            preload: 'metadata',
            volume: 1,
            loop: true,
            muted: false,
            backgroundColor: '#000000',

            smoothPlayBar: true,
            keyEnabled: true,
            audioFullScreen: false // Allows the audio poster to go full screen via keyboard
        });

        $music_icon.click(function() {
            $(this).toggleClass('show');
            if($(this).hasClass('show')) {
                $('#cl-music-container').css('display','block');
            } else {
                $('#cl-music-container').css('display','none');
            }
        });

        var $play = $('.jp-play'),
            $next = $('.jp-forward'),
            $prev = $('.jp-backward'),
            $list = $('.music-lists'),
            $playlist_wrap = $('.music-playlist-wrap'),
            $playlist = $('.music-playlist'),
            $item = $('.music-playlist li');

        $playlist.empty();
        if(myPlaylist.playlist.length) {
            var index = myPlaylist.current;
            $.each(myPlaylist.playlist, function(i,v) {
                var active = (i == index) ? "jp-playlist-current" : "",
                    item = "<li class='" + active + "' data-music-index='" + i + "'><span class='hand'>" + v.title + "</span></li>";
                $playlist.append(item);
            });
        }

        $list.click(function() {
            $playlist_wrap.toggle();
            if($playlist_wrap.css('display') == 'block') {
                $list.text('CLOSE');
            } else {
                $list.text('LIST');
            }
        });

        $('body').on( 'click', '.music-playlist li a', function(e) {
            var $pause_icon = "<i class='fa fa-pause'></i>";
                $equalizer = $("#cl-music-player-icon"),
                src = "https://storage.googleapis.com/i.addblock.net/equalizer.gif",
            $equalizer.find('img').attr('src',src);
            $('.jp-play').removeClass('pause');
            $('.jp-play').html($pause_icon);
        });

        $('.music-playlist li span').click(function() {
            var idx = $(this).parent().attr('data-music-index');
            if(typeof idx == "undefined") return;
            myPlaylist.play(idx);
            myPlaylist.current = idx;
            $('.music-playlist li').removeClass('jp-playlist-current');
            $('.music-playlist li').eq(idx).addClass('jp-playlist-current');
            // $.musicPlay();
        });

        $play.click(function() {
            if($(this).hasClass('pause')) {
                $.musicPlay();
            } else {
                $.musicPause();
            }
        });
        $next.click(function() {
            $.musicNext(myPlaylist);

        });
        $prev.click(function() {
            $.musicPrev(myPlaylist);
        })

        document.onkeydown = function(evt) {
            evt = evt || window.event;
            if (evt.keyCode == 27) {
                $.musicPause();
            }
        };
        // myPlaylist.play();
        // $('#cl-music-player').jPlayer('play');
    }
    $.musicPause = function() {
        var $play_icon = "<i class='fa fa-play'></i>",
            $equalizer = $("#cl-music-player-icon"),
            src = "https://storage.googleapis.com/i.addblock.net/equal_stop.gif";
        $equalizer.find('img').attr('src',src);
        $('.jp-play').addClass('pause');
        $('.jp-play').html($play_icon);
        $('#cl-music-player').jPlayer('pause');
    }
    $.musicPlay = function() {
        var $pause_icon = "<i class='fa fa-pause'></i>";
            $equalizer = $("#cl-music-player-icon"),
            src = "https://storage.googleapis.com/i.addblock.net/equalizer.gif",
        $equalizer.find('img').attr('src',src);
        $('.jp-play').removeClass('pause');
        $('.jp-play').html($pause_icon);
        $('#cl-music-player').jPlayer('play');
    }
    $.musicStop = function() {
        $('#cl-music-player').jPlayer('stop');
    }
    $.musicRepeat = function() {

    }
    $.musicOFF = function() {

    }
    $.musicNext = function(player) {
        player.next();
        var index = player.current;
        $.musicPlay();
    }
    $.musicPrev = function(player) {
        player.previous();
        var index = player.current;
        $.musicPlay();
    }


    $.slang = {
        init: function(data) {
            if(typeof data != "undefined" && data) {
                if(PAGE_MODE == 'c') SLANG = data;
                else property.SLANG = data;
            }

            var slang = (PAGE_MODE == 'c') ? SLANG : property.SLANG;
            if(!$.isEmptyObject(slang)) $.slang.set('on');
            else $.slang.set('off');
        },
        set: function(onoff) {
            if(onoff.match(/on/gi)) $.slang.make();
            else $('#tpl-menu').find('.siteLANG').remove();
        },
        make: function() {
            var slang_data = (PAGE_MODE == 'c') ? SLANG['lists'] : property.SLANG['lists'],
                slang_str = (PAGE_MODE == 'c') ? SLANG['select'] : property.SLANG['select'],
                slang_list = '';

            $.each(slang_data, function(i,o) {
                var active = (o['name'] == slang_str) ? 'active' : '';
                slang_list += '\
                        <li><a href="javascript:;" data-code="' + o['code'] + '">' + o['name'] + '</a></li>\
                ';
            });

            var content = '\
                <li class="siteLANG dropdown">\
                    <a href="javascript:;" class="dropdown-toggle"><span class="slang-active">' + slang_str + '</span> <i class="fa fa-caret-down fa-1" aria-hidden="true"></i></a>\
                    <ul class="dropdown-menu">\
                        ' + slang_list + '\
                    </ul>\
                </li>\
            ';

            if($('#tpl-menu').find('.siteLANG').length > 0) $('#tpl-menu').find('.siteLANG').replaceWith(content);
            else $('#tpl-menu').append(content);
        }
    }


    $.fnav = {
        getFnav: function() {
            var data = (PAGE_MODE == 'c') ? SETTINGS.fnav : property.SETTINGS.fnav;
            if(typeof data == "undefined" || $.isEmptyObject(data)) data = new Array();
            
            return data;
        },
        getFnavBg: function() {
            var bg = (PAGE_MODE == 'c') ? SETTINGS.fnavBg : property.SETTINGS.fnavBg;
            if(typeof bg == "undefined" || !bg) bg = '000000';
            else {
                if(bg.indexOf('rgb') > -1) bg = style.getHex(bg).substring(1);
            }

            return bg;
        },
        checkFnavON: function(data) {
            var result = false,
                fnav_data = (typeof data != "undefined") ? data : $.fnav.getFnav();

            $.each(fnav_data, function(i,obj) {
                if(obj['display'] == 'on') result = true;
            });

            return result;
        },
        draw: function(data) {
            var fnav_data = (typeof data != "undefined") ? data : $.fnav.getFnav(),
                hasON = $.fnav.checkFnavON(fnav_data);

            if (window.location.href.indexOf('_checkout') != -1) hasON = false;

            if(!hasON) {
                $('.fnav.fnav-mobile-fnav').remove();
            } else {
                var fnav_html = $.fnav.listHTML(fnav_data,hasON);
                if(fnav_html.length > 0) {
                    if($('.dsgn-body').find('.fnav.fnav-mobile-fnav').length > 0) $('.dsgn-body .fnav.fnav-mobile-fnav').replaceWith(fnav_html);
                    else $('.dsgn-body').find('.el-footer').before(fnav_html);
                } else {
                    $('.dsgn-body').find('.fnav.fnav-mobile-fnav').remove();
                }
            }
        },
        listHTML: function(fnav_data,hasON) {
            if(typeof fnav_data == "undefined") fnav_data = $.fnav.getFnav();
            if(typeof hasON == "undefined") hasON = $.fnav.checkFnavON(fnav_data);

            var fnav_bg = $.fnav.getFnavBg(),
                str = '';
                
            if(hasON) {
                $.each(fnav_data, function(i,v) {
                    str += $.fnav.itemHTML(v.idx, v.name, v.type, v.value, v.target, v.icon, v.display); 
                });
            }

            return '\
                            <div class="fnav fnav-mobile-fnav" style="background-color: #'+fnav_bg+';">\
                            ' + str + '\
                            </div>\
            ';
        },
        itemHTML: function(idx,name,type,value,target,icon,display) {
            var href = '#', 
                attr_target = (type == "tel") ? ' target=""' : ' target="' + target + '"',
                attr_link = '';

            if(icon == 'empty') icon = '';

            if(value) {
                if(type == "tel") {
                    href = (value.match(/^tel:/)) ? value : 'tel:' + value;
                } else { //link
                    value = (checkBase64Encode(value)) ? Base64.decode(value) : value;
                    
                    var menulist = (PAGE_MODE == 'c') ? MENULIST : property.MENULIST,
                        one = (PAGE_MODE == 'c') ? ONE : property.ONE,
                        view = (PAGE_MODE == 'c') ? VIEW : property.VIEW;

                    href = makeLinkUrl(value,one,view);
                    if(menulist.indexOf(value.replace(/ /g,'-'))>-1) {
                        attr_link = 'data-user-link="' + href + '"';
                    } else if(value.match(/^\@/g)) {
                        attr_link = 'attr-bookmark="' + value.replace(/^\@/g,'') + '"';
                    } else {
                        attr_link = 'attr-link="' + value + '"';
                    }
                }

            }

            if(display != 'on') return '';
            else return '\
                                <div class="fnav-item" data-idx="' + idx + '" data-type="' + type + '">\
                                    <a href="' + href + '" ' + attr_target + ' ' + attr_link + '>\
                                        <i class="' + icon + '" aria-hidden="true"></i>\
                                        <span class="fnav-name">' + name + '</span>\
                                    </a>\
                                </div>\
            ';
        },

    }

    $.mpcWeb = {
        init: function(vpOption,contents,WebType,zoom,pagemove) {   
            var device_w = (vpOption=="mobile_pc") ? 1440 : 'device-width',
                scale = (vpOption=="mobile_pc") ? (window.screen.width / 1440) : 1.0,
                zoom = (zoom) ? '' : ', maximum-scale=1, user-scalable=no',
                mpc_icon = (vpOption == "mobile_pc") ? '<i class="fa fa-mobile mpc_icon" aria-hidden="true"></i>' : '<i class="fa fa-desktop mpc_icon" aria-hidden="true"></i>',
                checkFnav = ($('.fnav').length > 0 && vpOption=="mobile_web") ? true : false;

            //$.mpcWeb.mpcWebShowcase(vpOption,contents,pagemove);

            $('.dsgn-body .mobilepc_ch .mpc_icon').remove();
            $('.dsgn-body .mobilepc_ch').prepend(mpc_icon);
            
            var viewport = document.querySelector('meta[name="viewport"]');
            if(viewport) viewport.setAttribute('content','width='+device_w+', initial-scale='+scale+''+zoom+'');

            /*if($('.dsgn-body').hasClass('sidebar')) {
                $('.dsgn-body').removeClass('sidebar').addClass('removed-sidebar');
            } else if ($('.dsgn-body').hasClass('removed-sidebar')) {
                $('.dsgn-body').removeClass('removed-sidebar').addClass('sidebar');                
            }*/

            $.mpcWeb.mpcMusicandGoTop(checkFnav,vpOption);     

            if(checkFnav && WebType == 'MOBILE') {
                $('.fnav.fnav-mobile-fnav').css('margin-bottom','53px');
                $('.element.el-footer').css('margin-bottom','100px');
            } else {
                $('.mobilepc_ch').css('margin-bottom','0px');
                $('.element.el-footer').css('margin-bottom','0px');
            }
        },


        mpcWebhtml: function(vpOption,contents,zoom,pagemove) {
            if (window.location.href.indexOf('_checkout') != -1) return false;
            
            pagemove = ((typeof pagemove == 'undefined') || !pagemove) ? '' : pagemove;

            if($.cookie('desktop-option')) {
                vpOption = $.cookie('desktop-option');
                $.removeCookie('desktop-option',{path:'/'});
            }

            var vpChangeText = (vpOption=="mobile_pc") ? $.lang[LANG]['editor.mobile.changePc.mobileWeb'] : $.lang[LANG]['editor.mobile.changePc.mobilePc'],    
                mpc_html = "\
                <div class='mobilepc_ch' data-desktop-option='"+vpOption+"'>\
                    <p class='hand'>\
                        <span class='mpc-name'>" + vpChangeText + "</span>\
                    </p>\
                </div>\
            ",
                WebType = $.mpcWeb.mpcCheckWebType();

            if(WebType == 'MOBILE') {
                $('.dsgn-body').find('.mobilepc_ch').remove();
                $('.dsgn-body').find('.el-footer').after(mpc_html);
                $.mpcWeb.init(vpOption,contents,WebType,zoom,pagemove);
                $.mpcWeb.mpcChangeVal(vpOption,contents,WebType,zoom,pagemove);
            }
        },   

        mpcWebShowcase : function(vpOption,contents,pagemove) {
            $.each(contents,function(i,v) {
                var v_el = (pagemove=='pagemove') ? v : v.element;
                if((vpOption == "mobile_pc") && (v_el.type == 'showcase')) $("."+v_el.elname).addClass('mobilePc_height');
                else $("."+v_el.elname).removeClass('mobilePc_height');
            });
            
        },

        mpcChangeVal : function(vpOption,contents,WebType,zoom,pagemove) {
            if (window.location.href.indexOf('_checkout') != -1) return false;
            
            $('.mobilepc_ch').on('click', function() {
                vpOption = (vpOption=="mobile_pc") ? 'mobile_web' : 'mobile_pc';
                var vpChangeText = (vpOption=="mobile_pc") ? $.lang[LANG]['editor.mobile.changePc.mobileWeb'] : $.lang[LANG]['editor.mobile.changePc.mobilePc'];
                 
                $.mpcWeb.init(vpOption,contents,WebType,zoom,pagemove);
                
                $(this).find('.mpc-name').text(vpChangeText);
                $(this).attr('data-desktop-option',vpOption);

                if(property.ONE && !property.VIEW || property.PAGE == property.MENULINK[0] && !property.VIEW) setSitePopup();
                if($('.element[data-type="gallery"][data-msny="true"]').length > 0) {
                    $('.element[data-type="gallery"][data-msny="true"]').each(function() {
                        RENDER.refreshMasonry($(this).attr('data-name'));
                    });
                }
                
            });
        },

        mpcCheckWebType : function(){
            var filter = "win16|win32|win64|mac|macintel",
                WebType = "";

            if (navigator.platform) {
                if (filter.indexOf(navigator.platform.toLowerCase()) < 0) WebType = "MOBILE";
                else WebType = "PC";
            }

            return WebType;
        },

        mpcMusicandGoTop : function(checkFnav,vpOption) {
            var checkmpc = ($('.mobilepc_ch').length > 0) ? true : false;

            if(checkmpc && vpOption == 'mobile_pc') {
                if($('#cl-music-player-icon').length > 0) $('#goto-top,#cl-music-player-icon').removeClass('moveMpc movepc movedOne').addClass('moved');
                else $('#goto-top,#cl-music-player-icon').removeClass('movedOne moveMpc movepc').addClass('moved');
            } else {
                if(checkFnav) {
                    if($('#cl-music-player-icon').length > 0) {
                        $('#goto-top').css('bottom','');  
                        $('#goto-top,#cl-music-player-icon').removeClass('movedOne movepc moved').addClass('moveMpc');
                    } else $('#goto-top').removeClass('movedOne movepc moved moveMpc').css('bottom','120px');  
                } else {
                    if($('#cl-music-player-icon').length > 0) $('#goto-top,#cl-music-player-icon').removeClass('moveMpc movepc moved').addClass('movedOne');
                    else $('#goto-top,#cl-music-player-icon').removeClass('movedOne movepc moveMpc moved');
                }          
            }
        },
    }

    /*** shopping Guide Popup ***/
    $.guidePopup = {
        set: function() {
            var str = '\
                    <div class="guide-top">\
                        <h3 class="modal-title guidetitle">'+$.lang[LANG]['editor.meta.shoppingmall.guide.title']+'</h3>\
                        <div class="guide-menu">\
                            <ul>\
                                <li class="active hand">\
                                    <p>'+$.lang[LANG]['editor.meta.shoppingmall.guide.step.1']+'</p>\
                                    <div class="line right"></div>\
                                </li>\
                                <li class="hand">\
                                    <div class="line left"></div>\
                                    <div class="line right"></div>\
                                    <p>'+$.lang[LANG]['editor.meta.shoppingmall.guide.step.2']+'</p>\
                                </li>\
                                <li class="hand">\
                                    <div class="line left"></div>\
                                    <div class="line right"></div>\
                                    <p>'+$.lang[LANG]['editor.meta.shoppingmall.guide.step.3']+'</p>\
                                </li>\
                                <li class="hand">\
                                    <div class="line left"></div>\
                                    <p>'+$.lang[LANG]['editor.meta.shoppingmall.guide.step.4']+'</p>\
                                </li>\
                            </ul>\
                        </div>\
                    </div>\
                    <div class="guide-wrap">\
                        <div class="step">\
                            <div id="step1">\
                                <h3>'+$.lang[LANG]['editor.meta.shoppingmall.guide.step.1.title']+'</h3>\
                                <p>'+$.lang[LANG]['editor.meta.shoppingmall.guide.step.1.1.contents']+'</p>\
                                <img class="img-responsive" src="//storage.googleapis.com/i.addblock.net/guide_img01_1.jpg">\
                                <p>'+$.lang[LANG]['editor.meta.shoppingmall.guide.step.1.2.contents']+'</p>\
                                <img class="img-responsive" src="//storage.googleapis.com/i.addblock.net/guide_img01_2.jpg">\
                                <p>'+$.lang[LANG]['editor.meta.shoppingmall.guide.step.1.3.contents']+'</p>\
                                <img class="img-responsive" src="//storage.googleapis.com/i.addblock.net/guide_img01_3.jpg">\
                            </div>\
                            <div id="step2">\
                                <h3>'+$.lang[LANG]['editor.meta.shoppingmall.guide.step.2.title']+'</h3>\
                                <p>'+$.lang[LANG]['editor.meta.shoppingmall.guide.step.2.1.contents']+'</p>\
                                <img class="img-responsive" src="//storage.googleapis.com/i.addblock.net/guide_img02_1.jpg">\
                                <p>'+$.lang[LANG]['editor.meta.shoppingmall.guide.step.2.2.contents']+'</p>\
                                <img src="//storage.googleapis.com/i.addblock.net/guide_img02_2.jpg">\
                                <p>'+$.lang[LANG]['editor.meta.shoppingmall.guide.step.2.3.contents']+'</p>\
                                <img class="img-responsive" src="//storage.googleapis.com/i.addblock.net/guide_img02_3.jpg">\
                                <p>'+$.lang[LANG]['editor.meta.shoppingmall.guide.step.2.4.contents']+'</p>\
                                <img class="img-responsive" src="//storage.googleapis.com/i.addblock.net/guide_img02_4.jpg">\
                            </div>\
                            <div id="step3">\
                                <h3>'+$.lang[LANG]['editor.meta.shoppingmall.guide.step.3.title']+'</h3>\
                                <p>'+$.lang[LANG]['editor.meta.shoppingmall.guide.step.3.1.contents']+'</p>\
                                <img class="img-responsive" src="//storage.googleapis.com/i.addblock.net/guide_img03_1.jpg">\
                                <p>'+$.lang[LANG]['editor.meta.shoppingmall.guide.step.3.2.contents']+'</p>\
                                <img class="img-responsive" src="//storage.googleapis.com/i.addblock.net/guide_img03_2.jpg">\
                            </div>\
                            <div id="step4">\
                                <h3>'+$.lang[LANG]['editor.meta.shoppingmall.guide.step.4.title']+'</h3>\
                                <p>'+$.lang[LANG]['editor.meta.shoppingmall.guide.step.4.1.contents']+'</p>\
                                <img class="img-responsive" src="//storage.googleapis.com/i.addblock.net/guide_img04_1.jpg">\
                                <p>'+$.lang[LANG]['editor.meta.shoppingmall.guide.step.4.2.contents']+'</p>\
                                <img class="img-responsive" src="//storage.googleapis.com/i.addblock.net/guide_img04_2.jpg">\
                            </div>\
                        </div>\
                        <div class="modal-footer guideClose">\
                            <button type="button" class="btn btn-default btn-sm close-button-dialog clostbtnfalse" data-dismiss="modal">닫기</button>\
                        </div>\
                    </div>\
                    ';
                                                    
            var shopguideModal = $(this).showModalFlat('',str,true,false,'','close','','guidePopup cl-cmmodal cl-s-btn cover w700', false ,'',function() {
                $.guidePopup.scrollevent();
            });
        },
        scrollevent : function() {
            $('.guidePopup-wrap').on('shown.bs.modal', function(e) {                    
                $('.guidePopup .guide-wrap').scroll(function() {
                    if($(this).hasClass('moving')) return false;
                    var scrollValue = $('.guidePopup .guide-wrap').scrollTop(),
                        issclogin = ($('.guidePopup').attr('class').indexOf('sclogin') > 0) ? true : false;

                    if(issclogin) {
                        if( scrollValue >= $("#step2").position().top && scrollValue < $("#step3").position().top) {
                            $('.guidePopup ul li').eq(1).addClass('active').siblings().removeClass('active');
                            $('.guidePopup ul li').eq(1).css('zIndex', '2').siblings().css('zIndex', '1');
                        } else if( scrollValue >= $("#step3").position().top) {
                            $('.guidePopup ul li').eq(2).addClass('active').siblings().removeClass('active');
                            $('.guidePopup ul li').eq(2).css('zIndex', '2').siblings().css('zIndex', '1');
                        } else {
                            $('.guidePopup ul li').eq(0).addClass('active').siblings().removeClass('active');
                            $('.guidePopup ul li').eq(0).css('zIndex', '2').siblings().css('zIndex', '1');
                        }
                    } else {
                        if( scrollValue >= $("#step2").position().top && scrollValue < $("#step3").position().top) {
                            $('.guidePopup ul li').eq(1).addClass('active').siblings().removeClass('active');
                            $('.guidePopup ul li').eq(1).css('zIndex', '2').siblings().css('zIndex', '1');
                        } else if( scrollValue >= $("#step3").position().top && scrollValue < $("#step4").position().top) {
                            $('.guidePopup ul li').eq(2).addClass('active').siblings().removeClass('active');
                            $('.guidePopup ul li').eq(2).css('zIndex', '2').siblings().css('zIndex', '1');
                        } else if( scrollValue >= $("#step4").position().top) {
                            $('.guidePopup ul li').eq(3).addClass('active').siblings().removeClass('active');
                            $('.guidePopup ul li').eq(3).css('zIndex', '2').siblings().css('zIndex', '1');
                        } else {
                            $('.guidePopup ul li').eq(0).addClass('active').siblings().removeClass('active');
                            $('.guidePopup ul li').eq(0).css('zIndex', '2').siblings().css('zIndex', '1');
                        }
                    }
                    
                });

                $('.guidePopup .guide-menu li').click(function() {
                    if($('.guidePopup .guide-wrap').hasClass('moving')) return false;
                    $('.guidePopup .guide-wrap').addClass('moving');
                    var top = ($(this).index())+1,
                        top_position = (top==1) ? $('#step'+top).position().top : ($('#step'+top).position().top)+60;
                   
                    $('.guidePopup .guide-wrap').animate({scrollTop : top_position}, 1000, 'easeInOutExpo');

                    setTimeout(function() {
                        $('.guidePopup .guide-wrap').removeClass('moving');
                    },1000);

                    $(this).addClass('active').siblings().removeClass('active');
                    $(this).css('zIndex', '2').siblings().css('zIndex', '1');                    
                });
            });
        }
    }

    //mobile정보 가져오기
    var mrequest_uri = location.pathname + location.search;
    function getMobileInfo(data) {        
        var page = location.pathname.split('/')[1],
            mb = data.mb,
            paidUser = data.paidUser,
            settings_url = data.settings_url,
            sid = data.sid,
            valid_plan = data.valid_plan,
            site_nickname =  (typeof $('.site-username').text() != 'undefined' && $('.site-username').text()) ? $('.site-username').text() : data.site_nickname,
            site_profile = (typeof $('#dashboard-image-top image').attr('xlink:href') != 'undefined' && $('#dashboard-image-top image').attr('xlink:href')) ? $('#dashboard-image-top image').attr('xlink:href') : data.site_profile,
            umprofile = data.umprofile,
            newCount = data.newCount;
            
        mb.mb_id = (mb.mb_id) ? mb.mb_id : mb.um_id;

        if(mb.mb_id){
            var empty = (mb.mb_id) ? '' : 'empty',
                newMessage = (newCount == 0) ? false : true,
                badge = newMessage ? "<span class='badge'></span>" : "";

            var adminhtml = (mb.mb_level >= 10) ? '<li><a href="/adm" target="_blank">Admin</a></li>' : '',
                uadminmypage = (data.is_uadmin == false) ? '/mypage' : 'javascript:;',
                siteum = (data.is_uadmin == false) ? '' : 'siteUM',
                mypage = (data.is_uadmin == false) ? '' : 'mypage',
                dashboarduadmin = (data.is_uadmin == false) ? '/' : '/_admin/dashboard', 
                marketinguadmin = (data.is_uadmin == false) ? '/marketing' : '/_admin/marketing'; 

            var str = '<div class="nav navbar-nav navbar-right">\
                            <div class="mobile-menu">\
                                    <div class="m-myinfo">\
                                        <div class="profile_left">\
                                            <label class="m-profile hand '+umprofile+'" data-user-img="'+site_profile+'" data-user-plan="'+paidUser+'">\
                                                <svg viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >\
                                                <pattern id="m-dashboard-image-top" patternUnits="userSpaceOnUse" width="60" height="60">\
                                                    <image xlink:href='+site_profile+' x="-10" width="60" height="40"></image>\
                                                </pattern><circle cx="20" cy="20" r="20" fill="url(#m-dashboard-image-top)"></circle></svg>\
                                            </label>\
                                            <div class="inner-box hand">\
                                                <span class="name-text m-profile m-text-size">'+site_nickname+'</span>\
                                            </div>\
                                        </div>\
                                        <div class="profile_right">';
                                            if(data.is_uadmin) {
                                                str += '<div class="mlogout siteUM"><a href="javascript:;" class="logout">'+$.lang[LANG]['header.logout']+'</a></div>';
                                            } else {
                                                str += '<div class="mlogout"><a href="/member/login/out">'+$.lang[LANG]['header.logout']+'</a></div>';
                                            }
                                str +=  '</div>\
                                    </div>\
                                    <div class="mMymenu-wrap"><ul class="mMymenu">'; 
                                    var newCountlink = (data.is_uadmin == false) ? '/' : '/_admin';
                                            str +=  '<li class="newCount prorightmenu">\
                                                    <a href="'+newCountlink+'" class='+empty+'><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18px" height="18px"><path d="M16 16.5V9c0-3.6-2.75-6.58-6.25-6.96V0h-1.5v2.04C4.75 2.42 2 5.4 2 9v7.5H0V18h2 14 2v-1.5H16zM3.5 16.5V9c0-3.03 2.47-5.5 5.5-5.5s5.5 2.47 5.5 5.5v7.5H3.5z"/></svg>'+badge+'<span class="menu-title">'+$.lang[LANG]['header.bell']+'</span></a>\
                                                </li>\
                                                <li class="m-mypage prorightmenu '+siteum+'"><a href="'+uadminmypage+'" class="'+mypage+'"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 17 18" width="17px" height="18px"><path d="M11.55 10.08C13.03 9.09 14 7.41 14 5.5 14 2.46 11.54 0 8.5 0 5.46 0 3 2.46 3 5.5c0 1.91 0.97 3.59 2.45 4.58C2.27 11.31 0 14.4 0 18h1.5c0-3.86 3.14-7 7-7s7 3.14 7 7H17C17 14.4 14.73 11.31 11.55 10.08zM4.5 5.5c0-2.21 1.79-4 4-4s4 1.79 4 4c0 2.21-1.79 4-4 4S4.5 7.71 4.5 5.5z"/></svg>\
                                                <span class="menu-title">'+$.lang[LANG]['header.mypage']+'</span></a></li>';
                                        
                                        if(location.host.indexOf('gabia') <= -1) str += '<li class="m-langselect prorightmenu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18px" height="18px"><path d="M9 0C4.03 0 0 4.03 0 9c0 4.97 4.03 9 9 9s9-4.03 9-9C18 4.03 13.97 0 9 0zM15.33 5h-2.75c-0.27-1.2-0.65-2.25-1.11-3.07C13.08 2.49 14.43 3.58 15.33 5zM11.5 9c0 0.9-0.07 1.74-0.17 2.5H6.67C6.57 10.74 6.5 9.9 6.5 9s0.07-1.74 0.17-2.5h4.65C11.43 7.26 11.5 8.1 11.5 9zM9 16.5c-0.57 0-1.48-1.29-2.03-3.5h4.07C10.48 15.21 9.57 16.5 9 16.5zM6.97 5C7.52 2.79 8.43 1.5 9 1.5s1.48 1.29 2.03 3.5H6.97zM6.53 1.93C6.07 2.75 5.69 3.8 5.42 5H2.67C3.57 3.58 4.92 2.49 6.53 1.93zM1.94 6.5h3.22C5.06 7.29 5 8.13 5 9s0.06 1.71 0.16 2.5H1.94C1.66 10.72 1.5 9.88 1.5 9S1.66 7.28 1.94 6.5zM2.67 13h2.75c0.27 1.2 0.65 2.25 1.11 3.07C4.92 15.51 3.57 14.42 2.67 13zM11.47 16.07c0.47-0.82 0.85-1.87 1.11-3.07h2.75C14.43 14.42 13.08 15.51 11.47 16.07zM16.06 11.5h-3.22C12.94 10.71 13 9.87 13 9s-0.06-1.71-0.16-2.5h3.22C16.34 7.28 16.5 8.12 16.5 9S16.34 10.72 16.06 11.5z"/></svg>\
                                            <span class="menu-title">'+$.lang[LANG]['header.changeLang']+'</span></li>';
                                        str += '</ul></div>\
                                    <ul class="dropdown-menu" role="menu">'+adminhtml+
                                        '<li><a href="'+dashboarduadmin+'"  class="myhome-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 16"  width="18px" height="16px"><path d="M9 0L0 7.03V16h6 6 6V7L9 0zM7.5 14.5v-4h3v4H7.5zM16.5 14.5H12V9H6v5.5H1.5V7.76L9 1.9l7.5 5.83V14.5z"/></svg>'+$.lang[LANG]['mobile.menu.title.mysite']+'</a></li>';
                                    
                                    var supportlink = (location.host.indexOf('gabia') > -1) ? 'http://creatorlink-gabia.com/support' : '/support',
                                        helplink = (location.host.indexOf('gabia') > -1) ? 'http://creatorlink.gabia.com/consult' : '/help',
                                        helptext = (location.host.indexOf('gabia') > -1) ? $.lang[LANG]['mobile.menu.title.gabia.gotocts'] : $.lang[LANG]['mobile.menu.title.gotocts'],
                                        is_uadminMember = (data.is_uadmin) ? '_admin' : 'manager',
                                        memberlink = (valid_plan=='' || valid_plan['type'] == 'BS') ? '#' : '/'+is_uadminMember+'/member/list',
                                        siteNotice = (valid_plan=='' || valid_plan['type'] == 'BS') ? 'siteNotice("manager");' : '';

                                        helplink = (data.is_uadmin == false) ? helplink : '/_admin/help';

                                        str += '<li class="m_memberlist" onclick='+siteNotice+'><a href="'+memberlink+'">'+$.lang[LANG]['mobile.menu.title.memberlist']+'</a></li>';

                                    if(LANG == 'ko' && location.host.indexOf('gabia') <= -1) {
                                        var applySm = (valid_plan['type'] == 'SM') ? '' : 'siteNotice(\'shopping\')',
                                            collapsed = (valid_plan['type'] == 'SM') ? 'collapsed' : '',
                                            smHide = ((valid_plan['type'] == 'BN') && (data.is_uadmin==true)) ? 'hide' : '';

                                        str += '\
                                        <li class="'+collapsed+' mshoppingtab '+smHide+'" onclick="'+applySm+'" data-toggle="collapse" data-target=".mshopping_menu" aria-expanded="true">\
                                            <a type="button" class="collapsed hand">' + $.lang[LANG]['mobile.menu.title.shopping'] + '</a>\
                                        ';
                                        
                                        if(valid_plan['type'] == 'SM') {
                                            var url = '',
                                                hide = '';
                                            if (data.is_uadmin == false) {
                                                url = '/shopping';
                                            } else {
                                                url = '/_admin/shopping';                                                
                                                hide = 'hide';
                                            }
                                            
                                            str +=  '\
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 10" width="10px" height="10px"><polygon points="9 2 5 6 1 2 0 3 4 7 5 8 6 7 10 3 "></polygon></svg>\
                                            </li>\
                                            <ul class="mshopping_menu collapse">\
                                                <li><a href="'+url+'/product_search/order">'+$.lang[LANG]['mobile.menu.title.shopping.order']+'</a></li>\
                                                <li><a href="'+url+'/product_search/cancel">'+$.lang[LANG]['mobile.menu.title.shopping.cancel']+'</a></li>\
                                                <li><a href="'+url+'/product_search/return">'+$.lang[LANG]['mobile.menu.title.shopping.refund']+'</a></li>\
                                                <li><a href="'+url+'/product_search/exchange">'+$.lang[LANG]['mobile.menu.title.shopping.change']+'</a></li>\
                                                <li><a href="'+url+'/question_list/P">'+$.lang[LANG]['mobile.menu.title.shopping.qna']+'</a></li>\
                                                <li class="'+hide+'"><a href="'+url+'/point">'+$.lang[LANG]['mobile.menu.title.shopping.point']+'</a></li>\
                                                <li><a href="'+url+'/setting/W">'+$.lang[LANG]['mobile.menu.title.shopping.setting']+'</a></li>\
                                            </ul>';
                                        } else {
                                            str += '</li>';
                                        }
                                    }

                                    if(valid_plan) {
                                        var pageactive = (page == 'settings') ? 'active' : '',
                                            settingslink = (page == 'settings') ? '#' : settings_url,
                                            helpbox = (data.is_uadmin == false) ? '<li><a href="'+helplink+'">'+helptext+'</a></li>' : ((data.su_eadmin == false) ? '' : '<li><a href="'+helplink+'">'+helptext+'</a></li>'),
                                            settingHide = (data.is_uadmin == true && data.su_eadmin == false) ? 'hide' : '';
                                            

                                        str += '<li class="m_marketing '+settingHide+'"><a href="'+marketinguadmin+'">'+$.lang[LANG]['mobile.menu.title.marketing']+'</a></li>\
                                                <li class="'+settingHide+'"><a href="'+settings_url+'">'+$.lang[LANG]['mobile.menu.title.settings']+'</a></li>\
                                                ';

                                        if (data.is_uadmin == false) str +='<li><a href="'+supportlink+'">'+$.lang[LANG]['mobile.menu.title.supportcenter']+'</a></li>';
                                        else str += '';
                                         

                                        str += helpbox;
                                    }

                            str +=  '</ul>\
                                </div>\
                        </div>'; 
                $('.m-header_user').empty().prepend(str);
        }
        return data;        
    }

    $.mobileToggleMenu = {
        set : function() {
            var request_uri = location.pathname + location.search;
            var returnData = '';

            $.ajax({
                type: 'POST',
                data: { type:'get', sid:SID },
                dataType: 'json',
                url: '/template/getMobileMenu',   
                async:false,
                success : function(data) {
                    returnData = getMobileInfo(data);
                }
            }); 

            $.mobileToggleMenu.clickEvnt();

            return returnData;
            
        },
        setSignIn : function() {
            var langkor = (LANG=='ko') ? '':'hide',
                langen = (LANG=='en') ? '' : 'hide',
                str = '<div class="nav navbar-nav navbar-right signinwrap">\
                        <div class="mobile-menu">\
                                <div class="m-myinfo">\
                                    <div class="profile_left">\
                                        <div class="inner-box hand">\
                                            <a href="/"><img src="https://storage.googleapis.com/i.addblock.net/creatorlink_logo_b1.png" class="logo-img" data-attach="true" alt="Creatorlink logo"></a>\
                                        </div>\
                                    </div>\
                                    <div class="profile_right msignin">\
                                        <button data-toggle="modal" data-target="#loginModal" class="mlogin-text">'+$.lang[LANG]['mobile.menu.signin']+'</button>\
                                    </div>\
                                </div>\
                                <ul class="dropdown-menu" role="menu">';
                                   if(LANG == 'ko') str += '<li><a href="/mainfunction" class="logoutmenu">'+$.lang[LANG]['mobile.menu.logout.title.mainfunc']+'</a></li>';     
                            str += '<li><a href="/upgrade/site" class="logoutmenu">'+$.lang[LANG]['mobile.menu.logout.title.plan']+'</a></li>\
                                    <li><a href="/template" class="logoutmenu">'+$.lang[LANG]['mobile.menu.logout.title.template']+'</a></li>\
                                </ul>\
                                <div class="mchange-lang">\
                                    <img src="https://storage.googleapis.com/i.addblock.net/lang_kor.png" class="lang-ch '+langkor+'" data-attach="true" alt="Creatorlink logo">\
                                    <img src="https://storage.googleapis.com/i.addblock.net/lang_eng.png" class="lang-ch '+langen+'" data-attach="true" alt="Creatorlink logo">\
                                </div>\
                            </div>\
                    </div>';    

            $('.m-header_user').prepend(str);   

            $.mobileToggleMenu.clickEvnt();
        },
        mobileResize : function(data) {
            getMobileInfo(data);
            $.mobileToggleMenu.clickEvnt();
        },
        clickEvnt : function() {
            $('.navbar-toggle').click(function() {
                $.mobileToggleMenu.open();
                $('.m-header_user').css('left','0');
                $('html').css({'overflow': 'hidden'});
            });
            $('.m-langselect,.lang-ch').on('click',function(){  
                $.mobileToggleMenu.langSelect(mrequest_uri);
            });
            /*$('.applySm').click(function(){
                $(this).showModalFlat('INFORMATION', '쇼핑 기능은 심플쇼핑 요금제로 이용이 가능합니다.<br>심플쇼핑 신청 페이지로 이동할까요?', true, true, function() {
                    location.href = '/shoppingevent';
                }, 'cancel', '이동','mUpgradeSmModal');
            });*/
            $('.mshopping_menu').on('show.bs.collapse',function(e){
                $('.mshoppingtab,.mshoppingtab > a').css('background-color','#eeeff3');
                $('.mshoppingtab svg').remove();
                $('.mshoppingtab > a ').prepend('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 10" width="10px" height="10px"><polygon points="1 8 5 4 9 8 10 7 6 3 5 2 4 3 0 7 "/></svg>');
            });
            $('.mshopping_menu').on('hide.bs.collapse',function(e){
                $('.mshoppingtab,.mshoppingtab > a').css('background-color','inherit');
                $('.mshoppingtab svg').remove();
                $('.mshoppingtab > a ').prepend('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 10 10" width="10px" height="10px"><polygon points="9 2 5 6 1 2 0 3 4 7 5 8 6 7 10 3 "/></svg>');
            });

            $('#loginModal').on('show.bs.modal', function(e) {
                $.mobileToggleMenu.close();
            });
            $('#loginModal').on('shown.bs.modal', function(e) {
                $('html').css({'overflow': 'inherit'});
            });  
        },
        open : function (){
            var height = window.outerHeight;

            $('#nav.default-nav .header .navbar-header a.navbar-toggle,#nav.default-nav .header .navbar_right').css('zIndex','99');
            $('.mobile-detail-popup.billhead,.mobile-detail-popup.helphead').css('height', '100%');
            $('.m-headermenu').remove();
            $('.m-headerClose').addClass('in');
            $('.m-headerClose').removeClass('hide');
            $.mobileToggleMenu.scrollheight();

            $(window).resize(function (){
                $.mobileToggleMenu.scrollheight();
            });
            $('.m-headerClose').click(function(){
                $.mobileToggleMenu.close();
                $('html').css({'overflow': 'inherit'});
            });
        },
        close : function() {
            $('.m-headermenu').remove();
            $('.m-header_user').css('left','-100%');
            $('.m-headerClose').removeClass('in');
            $('.mobile-detail-popup.billhead,.mobile-detail-popup.helphead').css('height', 'auto');
            $('#nav.default-nav .header .navbar_right').css('zIndex','');
            $('#nav.default-nav .header .navbar-header a.navbar-toggle').css('zIndex','120');
        },
        langSelect : function(request_uri) {
            $('.m-headermenu').remove();
            $('.m-header_user.menu').css('left','-100%');
            $('.m-headerClose').addClass('hide');
            $('#nav.default-nav .header .navbar-header a.navbar-toggle').css('zIndex','120');

            var dashlang = (LANG == 'ko') ? 'ko' : 'en',
                html = "<ul class='dashlang-wrap'>\
                            <li class='dashlang-select'>\
                                <a href='/lang/switchLanguage/korean"+request_uri+"'><p class='mdash-lang'>한국어 (KO)</p>\
                                <span class='cl-icon cl-check-lang "+(dashlang == 'ko' ? 'cl_icon_checked04' : 'cl_icon_unchecked04')+"' data-lang='ko'></span></a>\
                            </li>\
                            <li class='dashlang-select'>\
                                <a href='/lang/switchLanguage/english"+request_uri+"'><p class='mdash-lang'>English (EN)</p>\
                                <span class='cl-icon cl-check-lang "+(dashlang == 'en' ? 'cl_icon_checked04' : 'cl_icon_unchecked04')+"' data-lang='en'></span></a>\
                            </li>\
                        </ul>";

            $('.m-dashboard').showModalFlat('',html,false,false,'','','','changelang');
            $('.modal-dialog.changelang').parents('.modal-default').attr('id','changelangModal');

            $('#changelangModal').on('show.bs.modal', function(e) {
                $('.dashlang-select > a').click(function() {
                    var datalang = $('.dashlang-select .cl-check-lang').attr('data-lang');

                    $('.cl-check-lang').each(function () {
                        $(this).addClass('cl_icon_checked04').removeClass('cl_icon_unchecked04');
                    });
                    $(this).addClass('cl_icon_unchecked04').removeClass('cl_icon_checked04');
                });
            });

            $('#changelangModal').on('hide.bs.modal', function(e) {
                $('#nav.default-nav .header .navbar_right').css('zIndex','');
                $('#nav.default-nav .header .navbar-header a.navbar-toggle').css('zIndex','120');
            });
        },
        upgradePopup : function(){
            $(this).showModalFlat('INFORMATION', '쇼핑 기능은 심플쇼핑 요금제로 이용이 가능합니다.<br>심플쇼핑 신청 페이지로 이동할까요?', true, true, function() {
                location.href = '/shoppingevent';
            }, 'cancel', '이동','mUpgradeSmModal');
        },
        scrollheight : function() {
            var menuheight = $(window).height()-135;
            $('.m-header_user .mobile-menu .dropdown-menu').css('height',menuheight);
        }
    }

    //** dashboard-bottom : shopping / 회원가입 탭 공통 div **//
    /*$.dashbtSubMenu = {
        adminCheck : function() {
            var checkAdmin = '';

            $.ajax({
                type: 'POST',
                data: { type:'get', sid:SID },
                dataType: 'json',
                url: '/template/getAdminVal',   
                async:false,
                success : function(data) {
                   checkAdmin = data;
                }
            }); 
            
            return checkAdmin;
        },
        init : function(tabname) {
            var location = window.location.href,
                isadmin_url='', submenu_url='',
                tabSubMenu = [],
                checkAdmin = '';

            checkAdmin = $.dashbtSubMenu.adminCheck();

            switch(tabname) {
                case "shopping" : 
                    isadmin_url = (location.indexOf('_admin') != -1) ? '/_admin/shopping' : '/shopping';
                    submenu_url = isadmin_url+'/product_search/';
                    tabSubMenu = ['order','cancel','exchange','return','question_list','point','setting/W'];
                    tagSubMenu_name = 'shopping.dashboard.title.';
                    break;

                case "manager" :
                    isadmin_url = (location.indexOf('_admin') != -1) ? '/_admin' : '/manager';
                    submenu_url = isadmin_url+'/member/';
                    tabSubMenu = ['list','waitlist','blocklist','','admin'];
                    tagSubMenu_name = 'manager.top.nav.';
                    break;
                default:
                    break;
            }

            var tabSubMenuData = {
                    'location' : location,
                    'isadmin_url' : isadmin_url,
                    'submenu_url' : submenu_url,
                    'tabSubMenu' : tabSubMenu,
                    'checkAdmin' : checkAdmin,
                    'tagSubMenu_name' : tagSubMenu_name
                },
                tabSubMenuData_arr = Object.keys(tabSubMenuData).map(function(e) { return tabSubMenuData[e];});

            return tabSubMenuData;
            
        },
        set : function(tabname) {
            var location = window.location.href,
                isadmin_url = '';
            var tabSubMenuData_arr = $.dashbtSubMenu.init(tabname),
                location = tabSubMenuData_arr['location'],
                tagSubMenu_name = (tabname == 'shopping') ? 'shopping.dashboard.title.' : 'manager.top.nav.',
                html = '\
                        <div class="navbar-header nav-container new-nav-container">\
                            <ul class="sub-navbar">',
                locationArray = [],
                checkAdmin = tabSubMenuData_arr['checkAdmin'];
                
                    if(tabname=='manager') locationArray = location.split('/');
                    $.each(tabSubMenuData_arr['tabSubMenu'], function(k, v) { 
                        if (v=='point') {
                            isadmin_url = (location.indexOf('_admin') != -1) ? '/_admin/shopping' : '/shopping';
                            submenu_url = isadmin_url+'/point';
                        }
                        var active = (location.indexOf(v) != -1) ? 'active' : '',
                            submenu_link = (v=='question_list' || v=='setting/W' || v=='point') ? tabSubMenuData_arr['isadmin_url']+'/'+v : tabSubMenuData_arr['submenu_url']+v,
                            uadminHide = (((checkAdmin.is_uadmin) && (v=='admin')) || (location.indexOf('gabia') > -1) || ((checkAdmin.is_uadmin) && (v=='point'))) ? ' hide' : '';

                        if(tabname == 'shopping') {
                            active = ((location.indexOf('setting') != -1) && v=='setting/W') ? 'active' : active;
                            active = (location.indexOf('_list') != -1 && v=='question_list') ? 'active' : active;
                        } else if(tabname == 'manager') {   //회원관리일 경우 
                            active = (locationArray[5] == v) ? 'active' : ((location.indexOf('/admin') != -1 && v=='admin') ? 'active' : '');
                            v = (v=='') ? v.replace('','config') : v;
                            if(location.indexOf('/admin') != -1) submenu_link = (v !='admin') ? submenu_link : submenu_link.replace('/member','');
                            else submenu_link = (v == 'admin') ? submenu_link.replace('/member','') : submenu_link;
                        }
                        
                        html = html + '\
                                <li class="'+active+uadminHide+'"><a href="'+submenu_link+'"><span class="subnav-title">'+$.lang[LANG][''+tabSubMenuData_arr['tagSubMenu_name']+v+'']+'</span></a></li>'; 
                                            
                    });
                           
            html = html + '</ul>\
                    </div>';

            $('#section-top-menu').html(html);
        }   
    }*/

    $.setMobileNav = {
        set : function() {
            var windowWidth = window.innerWidth;
            var totalWidth = 0;
            if (windowWidth <= 767) {
                var totalCnt = 0;
                $('.submenu_nav > ul > li').each(function () {
                    totalWidth += ($(this).innerWidth());
                    totalCnt++;
                });
                totalWidth += (28 * totalCnt);
                $('.submenu_nav').css({'width': totalWidth+'px'});
            } else {
                $('.submenu_nav').css({'width': '100%'});
            }
        },
        resize : function() {
            $(window).on('resize', function () {
                $.setMobileNav.set();
            });
        },
        firstCover : function() {
            setTimeout(function () {
                $('.mobile-first-cover').remove();
            }, 500);
        }
    }

    $.resource = {
        init : function() {
            var $modal = $('#el-fileupload'),
                fSearch = {'type' : '', 'page' : 1, 'text' : '', 'total' : 0},
                fileDrag = false,
                isEdit = false,
                depfolderClick = false,
                isFEdit = false;


            $('#nestableFolder').nestable({
                maxDepth: 1
            }).on('change', function(el) {
                var prevFolder = $('#nestableFolder-output').val();
                updateOutputFolder($('#nestableFolder').data('output', $('#nestableFolder-output')));
            });

            $modal.on('show.bs.modal', function (e) {
                ADD = false;
                UPLOAD = 0;
                UPLOADED = 0;
                UPLOADSIZE = 0;
                cPage = 1;
                initResource();
                resourceGetPage(1,SFOLDER_ACTIVE);

                $('.resource-selectAll').show();
                
                if($('.fli.active').length == 0 ) {
                    $('.fli[data-id="all"]').click();
                } 
                $('.resource-useit').removeClass('active');

                $('.progress .progress-bar').css({
                    'width' : '0%',
                    'padding-right' : '0px'
                }).text('');
            });

            $modal.on('hide.bs.modal', function (e) {

                if($('.fli.active[data-id="clEmptyFolder"]').length > 0 ) {//new folder name_input open
                    $('.fli.active[data-id="clEmptyFolder"]').remove();
                    isFEdit = false;
                }
                if($('#nestableFolder .fli.active .dd-fln').find('input').length > 0 ) { //edit folder name_input open
                    $('#nestableFolder .fli.active .dd-fln').find('input').val('').remove();
                    isFEdit = false;
                }

                if($('#el-property [data-loop-type="matrix"] .attach-thumb[data-toggle="modal"]').length > 0 ) { //clear matrix loop item - modal toggle
                    var idx =  $('#el-property [data-loop-type="matrix"] .attach-thumb[data-toggle="modal"]').attr('idx');
                    $('#el-property [data-loop-type="matrix"] .attach-thumb[data-toggle="modal"]').removeAttr('data-toggle');

                    if(!$('#el-property [data-loop-type="matrix"] .ui-sortable').children().first().hasClass('active')) 
                        $('#el-property [data-loop-type="matrix"] .ui-sortable').children().first().click();
                }

                if(typeof selectEL != 'undefined' && selectEL && typeof $('.'+selectEL).attr('data-parallax') != "undefined" && $('.'+selectEL).attr('data-parallax')) {
                    $('#prop-method-background').attr('data-target','');
                }

                $('.add-folder').attr('data-content','').popover('hide');
                $('.resource-useit').show();
                selectCount=0;
            });

            $("#resource-files").selectable({
                filter: ".fitem",
                cancel: "i,.ui-selected",
                selected: function(event, ui) {
                    var files = [], files_path = [], files_size=[], files_seq=[], file ='', file_path = '', file_size =0, file_seq='', magic = '';  

                    if($(ui.selected).is(".fitem")) {
                        file = $(ui.selected).closest('.fitem').find(".resource-file-name").attr("data-source");
                        magic = $(ui.selected).closest('.fitem').find(".resource-file-name").attr("data-magic");
                        file_path = RPATH + "60/" + file;
                        file_size = $(ui.selected).closest('.fitem').find('.resource-file-size').text();
                        file_seq =  $(ui.selected).closest('.fitem').find(".resource-file-name").attr("data-seq");

                        var full_path = (magic == '') ? file_path : magic+'=s60-c';
                        var ffloder = $("#resource-files ul[data-source='"+ file +"']").attr('data-ffolder');
                        if($(".selected-files").find("li[data-source='"+file+"']").length==0) {
                            var selected_file_name = (magic) ? magic : file;
                            $(".selected-files").append("<li data-source='" + file + "' data-ffolder='" + ffloder + "' data-seq='"+file_seq+"' data-size='"+file_size+"'><img src='" + full_path + "'><div class='selected-hover'>&times;<p class='selected-file-name'>" + selected_file_name + "</p><p class='selected-file-size'>"+file_size+"</p></div></li>");
                        }
                    }
                    resetFileSelectedStr();
                },
                unselected: function(event, ui) {
                    if($(ui.unselected).is('.fitem')) {
                        if(!event.ctrlKey && !event.shiftKey) {
                            $(".selected-files").empty();
                        }
                    }
                    resetFileSelectedStr();
                },
                stop: function(event, ui) {
                    if($('.selected-files').children().length != $('#resource-files').children('.fitem').length ) {
                        if($('#selectAll').prop('checked')) $('#selectAll').removeAttr('checked');
                    }
                }
            });  

            $('a[href="#mystorage"]').click(function(e) {
                resetFileSelectedStr();
            });    

            $('a[href="#freestorage"]').click(function(e) {
                $('.listprogress').remove();
                resetFileSelectedFr();

                if($('.fr-storage').length == 0) {
                    fSearch.type = 'new';
                    fSearch.page = 1,
                    fSearch.total = -1;

                    storageInit();

                    var $ul = $('<ul class="fr-storage-list"></ul>'),
                        $latest = $('<li class="latest"><i class="fa fa-check" aria-hidden="true"></i> ' + $.lang[LANG]['free.storage.new'] + '</li>'),
                        $favor = $('<li class="favor"><i class="fa fa-star"></i> ' + $.lang[LANG]['free.storage.favor'] + '</li>'),
                        $used = $('<li class="used"><i class="fa fa-thumb-tack" aria-hidden="true"></i> ' + $.lang[LANG]['free.storage.used'] + '</li>');
                    if($('.fr-storage-list').length==0) {
                        $ul.append($latest).append($favor).append($used);
                        $('.fr-strg.resource-filelist').append($ul);

                        $ul.find('li').click(function(e) {
                            if($(this).hasClass('latest')) {
                                if(!$('.fr-storage').hasClass('new')) {
                                    fSearch.type = 'new';
                                    fSearch.page = 1,
                                    fSearch.total = -1;

                                    storageInit();
                                    getFreeImage(fSearch.page,fSearch.type);
                                }

                                $('.fr-storage').removeClass('favor used').addClass('new');
                            } else if($(this).hasClass('favor')) {
                                if(!$('.fr-storage').hasClass('favor')) {
                                    fSearch.type = 'favor';
                                    fSearch.page = 1;
                                    fSearch.total = -1;
                                    storageInit();
                                    getFreeImage(fSearch.page,fSearch.type);
                                }
                                $('.fr-storage').removeClass('new used').addClass('favor');
                                var items = $('.fr-storage .imgs').length;
                                if(fSearch.total == items) return;
                            } else if($(this).hasClass('used')) {
                                if(!$('.fr-storage').hasClass('used')) {
                                    fSearch.type = 'used';
                                    fSearch.page = 1;
                                    fSearch.total = -1;
                                    storageInit();
                                    getFreeImage(fSearch.page,fSearch.type);
                                }
                                $('.fr-storage').removeClass('new favor').addClass('used');
                                var items = $('.fr-storage .imgs').length;
                            }

                            $ul.find('li').removeClass('active');
                            $(this).addClass('active');
                            $(".fr-selected-files").empty();
                            resetFileSelectedFr();
                        });
                        $('.fr-storage-list .latest').addClass('active');
                        fSearch.type = 'new';
                        fSearch.page = 1,
                        fSearch.total = -1;
                        getFreeImage(fSearch.page,fSearch.type);                
                    }
                }
            });

            $('.free-search').keyup(function(e) {
                var keyCode = e.keyCode,
                    search = $(this).val().trim();
                if(keyCode == 13) {
                    if(search=='') {
                        alert('Please enter search text...');
                        $(this).focus();
                        return false;
                    }

                    fSearch.type = 'search';
                    fSearch.page = 1;
                    fSearch.text = search;
                    fSearch.total = 0;

                    $('.free-search').val('');
                    $('.free-search-result').text('');
                    $('.fr-storage-list li').removeClass('active');

                    $('.fr-storage').remove();
                    $('.fr-strg.resource-container').prepend('<div class="fr-storage"></div>');
                    $('.fr-storage').prepend('<div class="listprogress" style="width: 100%; min-height: 40px; text-align:center; padding-top:50px;"><svg version="1.1" xmlns="http://www.w3.org/svg/2000" viewBox="0 0 30 30" width="60" style="width:30px; height: 30px;"><circle cy="15" cx="15" r="14" style="stroke:#00baff;"></circle></svg></div>');
                    var $frstorage = $('.fr-strg.resource-container .fr-storage');
                    for(var i=0; i < 4; i++) {
                        $frstorage.append('<div class="fr-row"></div>');
                    }

                    $.getJSON('/template/translate/' + encodeURIComponent(search), function(data) {
                        search = data.data.translations[0].translatedText;
                        fSearch.text = search;
                        $('.free-search').val(search);
                        getFreeImage(fSearch.page,fSearch.type,search);
                    });
                }
            });

            var storageInit = function() {
                $('.free-search').val('');
                $('.free-search-result').text('');
                $('.fr-storage').remove();
                $('.fr-strg.resource-container').prepend('<div class="fr-storage"></div>');
                $('.fr-storage').prepend('<div class="listprogress" style="width: 100%; min-height: 40px; text-align:center; padding-top:50px;"><svg version="1.1" xmlns="http://www.w3.org/svg/2000" viewBox="0 0 30 30" width="60" style="width:30px; height: 30px;"><circle cy="15" cx="15" r="14" style="stroke:#00baff;"></circle></svg></div>');
                var $frstorage = $('.fr-strg.resource-container .fr-storage');
                for(var i=0; i < 4; i++) {
                    $frstorage.append('<div class="fr-row"></div>');
                }
            }

            var rePaintFavor = function() {
                var $org = $('.fr-storage .imgs'),
                    $items = {};

                for(var i=0; i<$org.length; i++) {
                    var $i = $('.fr-storage .imgs[data-idx="' + i + '"]');
                    $items[i] = $i.clone();
                    $i.remove();
                }

                var idx = 0, 
                    $fHeight = $('.fr-storage .fr-row'),
                    height = [
                        $fHeight.eq(0).height(),
                        $fHeight.eq(1).height(),
                        $fHeight.eq(2).height(),
                        $fHeight.eq(3).height(),
                    ];

                $.each($items, function(i,v) {
                    var set = (i < 4) ? i : height.indexOf(Math.min.apply(null,height)),
                        w = $(this).find('.control-area').attr('data-width'),
                        h = $(this).find('.control-area').attr('data-height'),
                        r = Math.round(h*1080/w);

                    height[set] = height[set] + r;
                    $('.fr-storage .fr-row').eq(set).append($(this));
                });
            }

            var getFreeImage = function(page,type,stx,collection) {
                type = (typeof type == 'undefined') ? 'new' : type;
                stx = (typeof stx == 'undefined') ? '' : stx;
                page = (typeof page == 'undefined') ? 1 : page;
                collection = (typeof collection == 'undefined') ? '' : collection;
                if(type == 'new') {
                    dest = '/template/free/new/photos';
                } else if(type == 'favor') {
                    dest = '/template/favorite/list/type/F';
                } else if(type == 'search') {
                    dest = '/template/free/search/' + encodeURIComponent(stx);
                } else if(type == 'used') {
                    dest = '/template/favorite/list/type/U';
                }

                if(page>1) dest = dest + '/page/' + page;

                $.ajax({
                    type: 'GET',
                    url: dest,
                    dataType: 'json',
                    async:true,
                    success : function(data) {
                        var photos;
                        if(fSearch.type == 'new') {
                            if(data.photos != null) {
                                photos = data.photos;    
                            } else photos = {};
                        } else {
                            photos = (data.photos == null) ? {} : data.photos.results;
                        }

                        if(photos) {
                            $('.listprogress').remove();
                            if(photos.length==0 || photos == null) {
                                $('.fr-storage').append('<div class="result-none">No results found</div>');
                            } else {
                                var idx = 0, 
                                    $fHeight = $('.fr-storage .fr-row'),
                                    height = [
                                        $fHeight.eq(0).height(),
                                        $fHeight.eq(1).height(),
                                        $fHeight.eq(2).height(),
                                        $fHeight.eq(3).height(),
                                    ];

                                $.each(photos, function(i,v) {
                                    var set = (i < 4) ? i : height.indexOf(Math.min.apply(null,height)),
                                        r = Math.round(v.height*1080/v.width);

                                    var tpl = tplPhoto(v.urls.small, v.user.profile_image.small, v.user.username, v.user.links.html, v.color, v.urls.full, v.urls.raw,v.links.download, v.width, v.height, v.id, fSearch.type, i);
                                    height[set] = height[set] + r;
                                    $('.fr-storage .fr-row').eq(set).append(tpl);
                                });

                                $('.fr-storage').selectable({ 
                                    filter: " .imgs",
                                    cancel: "i,.ui-selected, .user-name",
                                    selected: function(event, ui) {
                                        var files = [], files_path = [], files_size=[], files_seq=[], file ='', file_path = '', file_size =0, file_seq='';  

                                        if($(ui.selected).is(".imgs")) {
                                            file = $(ui.selected).find('.control-area').attr("data-small");
                                            id = $(ui.selected).find('.control-area').attr("data-id");
                                            urls = new getLocation(file);
                                            file = (urls.pathname).replace("/","");
                                            file_path = 'https://' + urls.host + urls.pathname + '?ixlib=rb-0.3.5&q=80&fm=jpg&crop=face&cs=tinysrgb&w=60&h=60&fit=crop';
                                            tmp_image = 'https://' + urls.host + urls.pathname + '?ixlib=rb-0.3.5&q=85&fm=jpg&crop=entropy&cs=srgb';
                                            file_size = $(ui.selected).closest('.imgs').find('.resource-file-size').text();
                                            file_seq =  $(ui.selected).closest('.imgs').find(".resource-file-name").attr("data-seq");
                                            var ffloder = $("#resource-files ul[data-source='"+ file +"']").attr('data-ffolder');
                                            if($(".fr-selected-files").find("li[data-source='"+file+"']").length==0) {
                                                $(".fr-selected-files").append("<li data-source='" + file + "' data-id='" + id + "' data-ffolder='" + ffloder + "' data-seq='"+file_seq+"' data-size='"+file_size+"'><img src='" + file_path + "'><div class='selected-hover'>&times;<p class='selected-file-name'>" + file + "</p><p class='selected-file-size'>"+file_size+"</p><p class='tmp-image'>" + tmp_image + "</p></div></li>");
                                            }
                                        }
                                        resetFileSelectedFr();
                                    },
                                    unselected: function(event, ui) {
                                        if($(ui.unselected).is('.imgs')) {
                                            if(!event.ctrlKey && !event.shiftKey) {
                                                $(".fr-selected-files").empty();
                                            }
                                        }
                                        resetFileSelectedFr();
                                    },
                                    stop: function(event, ui) {
                                        if($('.selected-files').children().length != $('#resource-files').children('.fitem').length ) {
                                            if($('#selectAll').prop('checked')) $('#selectAll').removeAttr('checked');
                                        }
                                    }                        
                                });
                                if(fSearch.type == 'search' || fSearch.type == 'favor' || fSearch.type == 'used') fSearch.total = data.photos.total;
                                fSearch.page = fSearch.page + 1;

                                if(typeof data.photos.total != 'undefined' && fSearch.type == 'search') {
                                    if(data.photos.total > 0) $('.free-search-result').text(Number(data.photos.total).format());
                                    else $('.free-search-result').text('');
                                }
                            }                
                        } else {
                            $('.listprogress').remove();
                            $('.fr-storage').append('<div class="result-none text-center">Error get photo lists</div>');
                        }

                    }
                });

            }

            var tplPhoto = function(src,profile,name,link,color,full,raw,down,width,height,id,type,i) {
                var str = '';
                str = '\
                    <div class="imgs" data-idx="' + i + '">\
                        <div class="fitem">\
                            <img src="' + src + '">\
                            <div class="control-area" data-color="' + color + '" data-full="' + full + '" data-username="' + name + '" data-raw="' + raw + '" data-full="' + full + '" data-small="' + src + '" data-down="' + down + '" data-userlink="' + link + '" data-width="' + width + '" data-height="' + height + '" data-id="' + id + '" data-color="' + color + '">\
                                <ul>\
                                    <li class="fr-search"><i class="fa fa-search"></i></li>\
                ';
                if(type != 'used') {
                    str = str + '\
                                    <li class="fr-star"><i class="fa fa-star' + ((type=='favor') ? '' : '-o') + '"></i></li>\
                    ';
                }
                str = str + '\
                                </ul>\
                            </div>\
                        </div>\
                        <div class="user-name">Photo by <a href="' + link + '?utm_source=creatorlink&utm_medium=referral&utm_campaign=api-credit" target="_blank">' + name + '</a></div>\
                    </div>\
                ';
                return str;
            }

            $('.fr-storage .imgs .control-area .fr-search').live('click', function(e) {
                var $popup = $('<div class="photo-popup"></div>'),
                    $close = $('<div class="photo-close"><img src="https://storage.googleapis.com/i.addblock.net/fa-close-modal-white.png"></div>'),
                    color = $(this).parents('.control-area').attr('data-color'),
                    full = $(this).parents('.control-area').attr('data-full');

                $popup.append('<img src="' + full + '">');
                $('.photo-popup').css('background-color',color);
                if($('.photo-popup').length==0) {
                    $('body').append($popup).append($close);
                    $('.photo-popup').css('background-color',color);
                }
                $popup.hover(function() {
                    $('.photo-close').show();
                });
                resetFileSelectedFr();
            });

            $('.fr-storage .imgs .control-area .fr-star').live('click', function(e) {
                var $i = $(this).parents('.control-area'),
                    image = {
                        'id' : $i.attr('data-id'),
                        'width' : $i.attr('data-width'),
                        'height' : $i.attr('data-height'),
                        'username' : $i.attr('data-username'),
                        'userlink' : $i.attr('data-userlink'),
                        'raw' : $i.attr('data-raw'),
                        'full' : $i.attr('data-full'),
                        'small' : $i.attr('data-small'),
                        'down' : $i.attr('data-down'),
                        'color' : $i.attr('data-color')
                    },
                    $star = $(this).find('i'),
                    $item = $(this).parents('.imgs');

                $.post('/template/favorite/image', { image : image },  function(data) {
                    if(data.type == 'insert') {
                        $star.removeClass('fa-star-o').addClass('fa-star');    
                    } else if(data.type == 'delete') {
                        $star.removeClass('fa-star').addClass('fa-star-o');
                        if(fSearch.type == 'favor') {
                            var idx = $item.attr('data-idx');
                            $.each($('.fr-storage .imgs'),function(i,v) {
                                var cidx = $(this).attr('data-idx');
                                if(cidx == idx) $(this).remove();
                                if(idx < cidx) $(this).attr('data-idx',Number(cidx)-1);
                            });
                            fSearch.total = fSearch.total -1;
                            rePaintFavor();
                        }
                    }
                },'json');
            });

            $('.fr-storage .imgs .control-area .fr-download').live('click', function(e) {
                var $i = $(this).parents('.control-area'),
                    down = $i.attr('data-down');
                window.open(down + '?force=true', '_blank'); 
            });

            $('.photo-popup, .photo-close').live('click', function(e) {
                $(this).addClass('down');
                setTimeout(function() {
                    $('.photo-close').remove();
                    $('.photo-popup').remove();
                },400);
            });

            $('.fr-storage').live({
                mousemove : function() {
                    $(this).scroll( function() {

                        var listScroll = $('.fr-storage').scrollTop();
                        if((this.scrollTop+this.clientHeight) > (this.scrollHeight-100)){
                            if((fSearch.type == 'search' || fSearch.type == 'favor' || fSearch.type == 'used') && fSearch.total != 0) {
                                var items = $('.fr-storage .imgs').length;
                                if(fSearch.total == items) {
                                    return false;
                                }
                            }

                            if($('.fr-storage').find('.listprogress').length == 0 ) {
                                $('.fr-storage').append('<div class="listprogress" style="width: 100%; min-height: 40px; text-align:center; padding-top:10px;"><svg version="1.1" xmlns="http://www.w3.org/svg/2000" viewBox="0 0 30 30" width="60" style="width:30px; height: 30px;"><circle cy="15" cx="15" r="14" style="stroke:#00baff;"></circle></svg></div>');  
                                getFreeImage(fSearch.page,fSearch.type,fSearch.text);
                            }
                        }
                    });
                }
            });

            $('.modal-upload-button-resource').live({
                click: function() {
                    var ffolder = (SFOLDER_ACTIVE) ? SFOLDER_ACTIVE : 'all';
                    $.uploadON();
                    $(this).fileupload({
                        url: '/template/resource/upload/ffolder/'+ffolder,
                        dataType: 'json',
                        pasteZone: null,
                        async: true,
                        prependFiles: true,
                        sequentialUploads: true,
                        add: function(e,data) {
                            var r = $.upload_add(e,data);

                            if(r.submit) {
                                var jqXHR = data.submit();
                                UPLOAD++;
                            } else {
                                data.context.find('.loading').html('<i class="fa fa-times error"></i>');
                                data.context.find('.ing').addClass('error').text(r.err);
                            }

                            $(document).on('click','.upload-cancel .btn', function(e) {
                                if(jqXHR != undefined) jqXHR.abort();
                                data.context.fadeOut().remove();
                                $('.uploadModal #file-upload-progress').css('width','0%');
                                $.uploadOFF();

                                if(SFOLDER_ACTIVE != '') resetFolderInfo(UPLOAD, UPLOADSIZE, 'all', 'upload');
                                UPLOAD = 0;
                                UPLOADED = 0;
                                UPLOADSIZE = 0;
                                PROGRESS = 0;
                                $.uploadOFF();
                                resourceGetPage(1,SFOLDER_ACTIVE);
                                updateOutputFolder($('#nestableFolder').data('output', $('#nestableFolder-output')));
                            });
                        },
                        progress: function(e, data) {
                            $.upload_progress(e,data);
                        },                        
                        done: function (e, data) {
                            $.upload_done(e,data);
                            UPLOADED++;
                            if(UPLOADED) {
                                //$.uploadON(UPLOADED + " / " + UPLOAD + "<br>images creating...");
                                if(UPLOAD==UPLOADED) {
                                    setTimeout(function() {
                                        if(SFOLDER_ACTIVE != '') resetFolderInfo(UPLOAD, UPLOADSIZE, 'all', 'upload');
                                        UPLOAD = 0;
                                        UPLOADED = 0;
                                        UPLOADSIZE = 0;
                                        PROGRESS = 0;
                                        $.uploadOFF();
                                        resourceGetPage(1,SFOLDER_ACTIVE);
                                        updateOutputFolder($('#nestableFolder').data('output', $('#nestableFolder-output')));
                                    },1000);
                                }
                            }
                        },
                        progressall: function (e, data) {
                            $.upload_progressall(e,data);
                        },
                        start : function(e, data) {
                            $.upload_start(e,data);
                            progress1 = 0; progress2 = 0; PROGRESS = 0;
                        },
                        dragover : function(e, data) {
                            e.preventDefault();
                        }
                    }).prop('disabled', !$.support.fileInput)
                        .parent().addClass($.support.fileInput ? undefined : 'disabled');
                }
            });

            // Moves the "item count" tooltip
            var mouseX, mouseY;
            $('#el-fileupload').mousemove( function(e) {
               mouseX = e.pageX; 
               mouseY = e.pageY;
               $('.resource-tooltip').css({'top': mouseY-20,'left':mouseX-20 });
            });
            
            $('#selectAll').click(function () {
                var check = $(this);
                var selected = $('.selected-files li').map(function (i, n) {
                    return $(this).find("p.selected-file-name").text();
                }).get();

                $('#resource-files li').each(function () {
                    var file = $(this).find('.resource-file-name').attr('data-source'),
                        file_path = RPATH + '60/' + file,
                        ffloder = $("#resource-files ul[data-source='"+ file +"']").attr('data-ffolder'),
                        file_size = $("#resource-files .resource-file-name[data-source='"+ file +"']").next('.resource-file-size').text(),
                        file_seq = $(this).find('.resource-file-name').attr('data-seq');
                    var magic = (file_path.indexOf('googleusercontent') > -1) ? file + '=s60-c' : file_path;
                    if (check.prop('checked')) {
                        $(this).find('.fitem').addClass('ui-selected');
                        exist = $('p.resource-file-name[data-source="' + file + '"]').attr('data-source');
                        isAppend = ($.inArray(exist,selected)>-1) ? false : true;
                        if(exist && isAppend) {
                            $('.selected-files').append("<li data-source='"+ file +"' data-ffolder='" + ffloder + "' data-seq='"+file_seq+"'><img src='" + magic + "'><div class='selected-hover'>&times;<p class='selected-file-name'>" + file + "</p><p class='selected-file-size'>"+file_size+"</p></div></li>");
                            $('.selected-files-count').text(selected.length);
                        }
                    } else {
                        $('.selected-files p:contains("' + file + '")').parents('li').remove();
                        $(this).find('.resource-image').removeClass('ui-selected');
                        $('.resource-selected-str').hide();
                    }
                });
                resetFileSelectedStr();
            });

            $('#resource-delete').click(function () {
                if($('.selected-files').children().length==0) return;

                var r_pages = Number($('.resource-paging .pagination').attr('data-pages')),
                    r_page = Number($('.resource-paging .pagination li.active').text()),
                    r_file_cnt = $('#resource-files li.fitem').length;
                    
                var modal = $(this).showModalFlat($.lang[LANG]['config.common.resource.delete.title'],$.lang[LANG]['config.common.resource.delete'], true, true, function() {
                    modal.modal('hide');
                    $.progressON();              
                    var files = [], 
                        seqs = [],
                        sizes = [],
                        ffolders = [];
                    $('.selected-files li').each(function () {
                        files.push($(this).attr('data-source'));
                        seqs.push($(this).attr('data-seq'));
                        sizes.push($(this).find('.selected-file-size').text());
                        ffolders.push($(this).attr('data-ffolder'));
                    });

                    $('.selected-files').empty();
                    $('.resource-useit').removeClass('active');

                    var total = files.length, deleting = '', progress = 0; loading = '<i class="fa fa-circle-o-notch fa-spin fa-3x fa-fw"></i> ';
                        done = 0; deleting = $('.resource-file-name[data-seq="' + seqs[0] + '"]').text();
                    $('.progressModal .info1').html(loading + deleting);

                    $.each(files,function(i,v) {
                        var t = setTimeout(function() {
                            console.log('cancel : ' + CANCEL);
                            if(CANCEL) {
                                if(ABORT) {
                                    resourceGetPage(1,SFOLDER_ACTIVE);
                                    updateOutputFolder($('#nestableFolder').data('output', $('#nestableFolder-output')));
                                    ABORT = false;
                                    $.progressOFF();
                                }
                                i=0; return false;
                            }
                            resourceFileDelete(v,seqs[i],function() {
                                done++;
                                progress = parseInt((done / total) * 100,10);
                                $('.file-upload-progress .progress-bar').css('width',progress + "%");
                                $('.progressModal .info2').text(done.toString() + ' / ' + total.toString());
                                if(total == done) {
                                    r_page = ((r_file_cnt-files.length) == 0 && r_pages<=r_page) ? r_page-1 : r_page;
                                    r_page = 1;
                                    setTimeout(function() {
                                        $.progressOFF();
                                        resourceGetPage(r_page,SFOLDER_ACTIVE);
                                        updateOutputFolder($('#nestableFolder').data('output', $('#nestableFolder-output')));
                                    },1000);
                                } else {
                                    deleting = $('.resource-file-name[data-seq="' + seqs[i+1] + '"]').text();
                                    $('.progressModal .info1').html(loading + deleting);
                                }
                            });
                        },500*i);
                    });

                },'cancel','ok','modal-over-1 cl-cmmodal cl-s-btn cl-common-notice w560',false);
            });

            var resourceFileFolderUpdate = function(prevText,newText) {
                $.ajax({
                    type: 'POST',
                    url: '/template/resource/update-ffolder',
                    data: { sid: SID, prevffolder: prevText, newffolder: newText },
                    async: true,
                    success: function(data) {
                        checkError(data);
                    }
                });
            }
            var resourceFileDelete = function(file,seq,callback) {
                if(CANCEL) return true;
                $.ajax({
                    type: 'POST',
                    url: '/template/resource/delete',
                    data: { s: file, sid: SID, seq: seq},
                    async: true,
                    success: function(data) {
                        checkError(data);
                        if(typeof callback == 'function') {
                            callback();
                        }
                    }
                });
            }

            $('.resource-file-delete').live({
                click : function(e) {
                    var file    = $(this).closest('ul').attr('data-source'),
                        seq     = $(this).closest('ul').attr('data-seq'),
                        size    = $(this).closest('ul').attr('data-fsize'),
                        ffolder = $(this).closest('ul').attr('data-ffolder'),
                        page    = $(this).closest('ul').attr('data-page'),
                        $parent = $(this).parent(),
                        files =  $('.selected-files li').map(function (i, n) {
                            return $(this).find("p.selected-file-name").text();
                        }).get();

                    var modal = $(this).showModalFlat($.lang[LANG]['config.common.resource.delete.title'],$.lang[LANG]['config.common.resource.delete'], true, true, function() {
                        // $('.selected-files p:contains("' + file + '")').parents('li').remove();
                        $('.selected-files li[data-seq="' + seq + '"]').remove();
                        $.processON('Deleting the image(s)...');
                        modal.modal('hide');
                        $('.resource-image p[data-seq="' + seq + '"]').remove();
                        $('.resource-useit').removeClass('active');

                        resourceFileDelete(file,seq,function() {
                            if(SFOLDER_ACTIVE!='') {
                                resetFolderInfo(-1, -size, 'all', 'delete');
                            } else {
                                resetFolderInfo(-1, -size, ffolder, 'delete');
                            }

                            // page = (page) ? page : 1;
                            page = 1;
                            resourceGetPage(page,SFOLDER_ACTIVE);
                            updateOutputFolder($('#nestableFolder').data('output', $('#nestableFolder-output')));
                            $.processOFF();   
                        });

                    },'cancel','ok','modal-over-1 cl-cmmodal cl-s-btn cl-common-notice w560',false);
                }
            });

            $('.resource-file-search').live({
                click: function(e) {
                    $('#resourceImgView .img-wrapper > .img-responsive').attr('src',$(this).closest("ul").children(3).find("a").attr("href"));
                    $('#resourceImgView').modal('show');
                }
            });

            $('#resource-files').live('mousedown',function(e) {
                if(event.shiftKey) {
                    $('.selected-files').children('li').each(function () {
                        var s_file = $(this).attr('data-source'),
                            s_file_seq = $(this).attr('data-seq'),
                            s_file_size = $(this).attr('data-size');
                        if($("#resource-files .ui-selected ul[data-source='"+ s_file +"']").length == 0) {
                            $("#resource-files ul[data-source='"+ s_file +"']").closest('.fitem').find('.resource-image').addClass('ui-selected');
                        }
                    });
                }
            });
            $('.resource-image img').live('mousedown',function(e) {
                if($(this).closest('.fitem').hasClass('ui-selected')) {
                    fileDrag = true;
                }
                if(e.ctrlKey || e.shiftKey) {
                    if($(this).closest('.fitem').hasClass('ui-selected')) {
                        $(this).closest('.fitem').removeClass('ui-selected');
                        $('.selected-files').find('li[data-source="'+$(this).attr('alt')+'"]').remove();
                    }

                    if($('.selected-files').children().length != $('#resource-files').children('.fitem').length ) {
                        if($('#selectAll').prop('checked')) $('#selectAll').removeAttr('checked');
                    }
                    resetFileSelectedStr();
                }
            }).live('mouseup',function(e) {
                $('.fli').removeClass('drag-selected');
                fileDrag = false;
            }).live('mousemove', function(e) {
                if(fileDrag) {
                    var classstr = ($('.ui-selected').length > 1) ? 'multiple' : '';
                    $('.resource-tooltip').fadeIn().addClass(classstr)
                     .find('img').attr('src',$('.selected-files').children().last().find('img').attr('src'))
                     .next('.count').text($('.selected-files').children().length);
                }
            }).live('dragstart', function(e) {
                e.preventDefault();
            });

            $('.fli').live('mouseup',function(e) {
                if(fileDrag) {
                    $('li.fitem .resource-image').removeClass('ui-selected');
                    $('.fli').removeClass('drag-selected');

                    // selected-files 파일을 $.post로 보내고 리스트 페이지 갱신
                    var prevffolder = [], fsize = [],
                        targetffolder = $(this).attr('data-id'),
                        fselected = $('.selected-files li').map(function (i, n) {
                            prevffolder.push($(this).attr('data-ffolder')); 
                            fsize.push(parseInt($(this).find('p.selected-file-size').text()));
                            return $(this).attr('data-source');
                        }).get();

                    if(SID) {
                        var activeffolder = $('#nestableFolder').find('.fli.active').attr('data-id'),
                            r_pages = Number($('.resource-paging .pagination').attr('data-pages')),
                            r_page = Number($('.resource-paging .pagination li.active').text()),
                            r_file_cnt = $('#resource-files li.fitem').length;

                        $.post('/template/resource/update-fmove', { sid: SID, fselected: fselected, prevffolder: prevffolder, targetffolder: targetffolder }, function (data) {
                            checkError(data);
                            $.each(fselected, function(i,v) {
                                if(activeffolder[i] != prevffolder) {
                                    resetFolderInfo(-1, -fsize[i], prevffolder[i], 'move');
                                }
                                resetFolderInfo(1, fsize[i], targetffolder, 'move');
                            });

                            r_page = ((r_file_cnt-fselected.length) == 0 && r_pages<=r_page && SFOLDER_ACTIVE) ? r_page-1 : r_page;
                            r_page = 1;
                            cPage = 1;
                            resourceGetPage(r_page,SFOLDER_ACTIVE);
                            updateOutputFolder($('#nestableFolder').data('output', $('#nestableFolder-output')));
                            $('#resource-files').find('li.fitem .resource-image.ui-selected').removeClass('ui-selected');
                            $(".selected-files").empty();
                            resetFileSelectedStr();
                        }, 'json');
                    }
                }
            }).live('mouseenter',function(e) {
                $('.fli').removeClass('drag-selected');
                if(fileDrag) {
                    $(this).addClass('drag-selected');
                }
            }).live('mouseleave',function(e) {
                $('.fli').removeClass('drag-selected');
            });

            $('.resource-files-content').live('mouseup',function(e) {
                $('.resource-tooltip').fadeOut();
                fileDrag = false;
            });

            $('.add-folder').live({
                click: function(e) {
                    if(isFEdit) { 
                        if($('.fln-input').length > 0 ) $('.fln-input').focus();
                        return; 
                    } else {
                        $('.add-folder').attr('data-content','').popover('hide');
                    }

                    var checkMaximum = (!VALIDPLAN && $('#nestableFolder .fli').length > 50) ? true : false;
                    if(checkMaximum) {
                        $(this).showModalFlat('INFORMATION', $.lang[LANG]['editor.resource.folder.maximum'], true, false, '', 'close');
                        return;
                    } else {
                        $('#nestableFolder .fli.active').removeClass('active').find('.fa-fl').attr('src','https://storage.googleapis.com/i.addblock.net/icon/fa_folder.png');
                        var add_folder = '\
                            <li class="dd-item fli active" data-id="clEmptyFolder">\
                                <img src="https://storage.googleapis.com/i.addblock.net/icon/fa_folder_open.png" alt="folder icon" class="fa-fl dd-handle" />\
                                <span class="dd-fln"></span>\
                                <span class="dd-flc" attr-count="0">0</span>\
                                <span class="dd-fls" attr-size="0" attr-size-unit="KB">0</span>\
                                <span class="dd-fld" attr-id="clEmptyFolder"><img src="https://storage.googleapis.com/i.addblock.net/icon/icon-menu-delete-w.png" class="fa"></span>\
                            </li>\
                        ';
                        
                        if($('#nestableFolder .fli[data-id="clclEmptyFolder"]').length == 0) {
                            $('#nestableFolder .fll').append(add_folder);
                        } else {
                            $('#nestableFolder .fli[data-id="clEmptyFolder"]').find('.dd-fln').val('');
                        }

                        $('<input type="text" />').appendTo($('#nestableFolder .fli[data-id="clEmptyFolder"] .dd-fln')).dblclick();
                        if($('.dd-list.fll').children().length > 10) {
                            $('#nestableFolder .fli[data-id="clEmptyFolder"] .dd-fln').find('input').css('max-width','153px');
                            $('#nestableFolder').scrollTop(2000);
                        }
                    }
                }
            });

            $('#nestableFolder .fll > .fli').live({
                click: function(e) {
                    if(isFEdit) { return; }
                    if($(this).parents('.fll').length == 2) {
                         depfolderClick = true;
                    }
                    if($(this).parents('.fll').length == 1 && depfolderClick) {
                        depfolderClick = false;
                        return;
                    } else {
                        if($(this).hasClass('active')) return;
                        $('#nestableFolder .fli.active').removeClass('active').find('.fa-fl').first().attr('src','https://storage.googleapis.com/i.addblock.net/icon/fa_folder.png');
                        $(this).addClass('active').find('.fa-fl').first().attr('src','https://storage.googleapis.com/i.addblock.net/icon/fa_folder_open.png');
                        SFOLDER_ACTIVE = ($(this).attr('data-id')!='all') ? $(this).attr('data-id') : '';

                        cPage = 1;
                        resourceGetPage(1,SFOLDER_ACTIVE);
                    }
                }
            });

            $('#nestableFolder .fli .dd-fln').live({
                dblclick: function(e) {
                    if(isFEdit) { return; }
                    if($(this).parent().closest('.fli').index() > 0) {
                        isFEdit = true;
                        editFolder($(this));
                    }
                }
            });

            $('#nestableFolder .fli .dd-fld').live({
                click: function(e) {
                    if(isFEdit) { return; }
                    if($(this).prev().attr('attr-size') > 0) {
                        $(this).showModalFlat('INFORMATION', $.lang[LANG]['editor.resource.regExp.delete'], true, false, '', 'close');
                    } else {
                        if($(this).parent().parent().parent('.dd-list').children().length == 1 ) {
                            $(this).parent().parent().parent('.dd-list').parent('.fli').first().click();
                            $(this).parent().parent().parent('.dd-list').parent('.fli').find('button[data-action="collapse"]').remove();
                            $(this).parent().parent().parent('.dd-list').parent('.fli').find('button[data-action="expand"]').remove();
                            $(this).parent().parent().parent('.dd-list').remove();
                        } else {
                            $(this).closest('li').remove();
                        }
                        updateOutputFolder($('#nestableFolder').data('output', $('#nestableFolder-output')));
                        $('#nestableFolder').find('.fll').children().first().click();
                    }
                }
            });

            var editFolder = function(ddfl) {
                $this = ddfl;
                var text = ( $this.closest('li.fli').attr('data-id') != 'clEmptyFolder') ? trim($this.text()).replace(/ /g,'-') : 'clEmptyFolder';

                var input_css = ($('.dd-list.fll').children().length > 10) ? "height: 36px; max-width: 153px;" : "height: 36px;";
                $('<input type="text" class="fln-input"/>').appendTo($this).val((text == 'clEmptyFolder')? "" : text.replace(/-/g,' ')).focusout(function(e) {

                    var regExp = /[\{\}\[\]\/!?.,;:|\)*~`^\-_+<>@\#$%&\\\=\(\'\"]/gi,
                        newText = (trim($(this).val())) ? trim($(this).val()) : (text =='clEmptyFolder') ? '' : text,
                        err_str = '';

                    if(regExp.test(newText)) {
                        $('#nestableFolder').css('pointer-events','none');
                        err_str = $.lang[LANG]['editor.resource.regExp.specialchar'];
                    } else if($('#nestableFolder .fli[data-id="'+newText.replace(/ /g,'-')+'"]:not(.active)').length > 0) {
                        $('#nestableFolder').css('pointer-events','none');
                        err_str = $.lang[LANG]['editor.resource.regExp.overlap'];
                    } else if(newText.length > 20) {
                        $('#nestableFolder').css('pointer-events','none');
                        err_str = $.lang[LANG]['editor.resource.regExp.maximum'];
                    } else { 
                        $('#nestableFolder').css('pointer-events','auto');
                        err_str = '';
                    }
                    
                    newText = newText.replace(/ /g,'-');

                    if(err_str!=''){ 
                        $(this).focus();
                        $('.add-folder').attr('data-content',err_str).popover("show");
                        if($(this).closest('.fli').index() > 9) $('.popover.in').css('top',$(this).offset().top-($('.dd-list').offset().top+5)-$('#nestableFolder').scrollTop());
                        else $('.popover.in').css('top',$(this).offset().top-$('.dd-list').offset().top-5);
                        
                    } else { 
                        $('.add-folder').popover("hide");
                        if(!newText && text =='clEmptyFolder') {
                            $(this).parent().closest('.fli[data-id="clEmptyFolder"]').remove();
                            var last_class = $('#nestableFolder .fli').last().attr('data-id');
                            $('#nestableFolder .fli').last().addClass('active').find('.fa-fl').first().attr('src','https://storage.googleapis.com/i.addblock.net/icon/fa_folder_open.png');
                            SFOLDER_ACTIVE = last_class;
                            resourceGetPage(1,SFOLDER_ACTIVE);
                        } else {
                            $(this).parent().closest('.fli').attr('data-id',newText);
                            $(this).parent().closest('.fli').find('.dd-fld').attr('attr-id',newText);
                            $(this).parent().text(newText.replace(/-/g,' ')).find('input').remove();
                            updateOutputFolder($('#nestableFolder').data('output', $('#nestableFolder-output')));
                            resourceFileFolderUpdate(text,newText);
                            SFOLDER_ACTIVE = newText;
                            if(text == 'clEmptyFolder') resourceGetPage(1,SFOLDER_ACTIVE);
                            else {
                                $('#resource-files .fitem').each(function() {
                                    $(this).find('.control-area ul[data-ffolder="'+text+'"]').attr('data-ffolder',newText);
                                });
                            }
                        }
                        $('.add-folder').attr('data-content','').popover('hide');
                        isFEdit = false;
                    }
                }).attr('style',input_css);
            }

            $('.selected-files li').live({
                mouseenter : function() {
                    $(this).find('.selected-hover').show();
                },
                mouseleave : function() {
                    $(this).find('.selected-hover').hide();
                }
            });

            $('.fr-selected-files li').live({
                mouseenter : function() {
                    $(this).find('.selected-hover').show();
                },
                mouseleave : function() {
                    $(this).find('.selected-hover').hide();
                }
            });

            $(document).on({
                click : function() { 
                    var file = $(this).find('p.selected-file-name').text();
                    $(this).parent().fadeOut(300,function() {
                        $(this).remove();
                        if(myStorageActive()) {
                            $('#resource-files li .ui-selected').find('p.resource-file-name[data-source="' + file + '"]').closest('.fitem').removeClass('ui-selected');
                            displaySelectedFilesStr();
                        } else {
                            var id = $(this).attr('data-id');
                            $('.fr-storage .imgs.ui-selected').find('.control-area[data-id="' + id + '"]').parents('.imgs').removeClass('ui-selected');
                        }
                    });
                    if($('.selected-files li').length==1) {
                        $('.resource-useit').removeClass('active');
                        $('#selectAll').prop('checked',false);
                    }
                }
            },'.selected-hover');

        },
        open: function() {
            var $modal = $('#el-fileupload');
            $modal.modal('show');
        },
        close: function() {
            var $modal = $('#el-fileupload');
            $modal.modal('hide');
            $('.uploadModal').remove();
        },
        selected: function() {
            if(myStorageActive()) {
                var selected = $('.selected-files li').map(function (i, n) {
                    return $(this).find("p.selected-file-name").text();
                }).get();
            } else {
                var selected = $('.fr-selected-files li').map(function (i, n) {
                    return $(this).find("p.selected-file-name").text();
                }).get();
            }
            return selected;
        }
    }

    $.category = {
        delete : [],
        init : function() {
            $(document).on('click', '#prod-category-text', function(e) { 
                e.stopPropagation(); 
                if($('.category-wrap').hasClass('open')) {
                    $('.category-lists').slideUp(200, function() {
                        $('.category-wrap').removeClass('open');    
                    }); 
                } else {
                    $('.category-wrap').toggleClass('open');
                    $('.category-lists').slideDown(200); 
                }
            });
            $(document).on('click','.form-ctrl-button.category, .gallery-ctrl-category', function(e) { 
                e.stopPropagation();
                var s = $(this).attr('data-category');
                $.category.open(s); 
            });
            $(document).on('click','.cl-category-modal-close',function(e) { $.category.close(); });
            $(document).on('click','.prod-option-title, .prod-option-price, .prod-option-quantity, .prod-option-status',function(e) {
                e.stopPropagation();
                var submit = true;
                $('.prod-option-item').each(function () {
                    $(this).next().find('.form-wrap').removeClass('err');
                });
                if($('.prod-option-item.hide').length) {
                    $.each($('.prod-option-item.hide'), function(i,v) {
                        var opt_title = $(this).parent().find('.prod-option-edit .edit-option-title input').val(),
                            opt_price = $(this).parent().find('.prod-option-edit .edit-option-price input').val(),
                            opt_quantity = $(this).parent().find('.prod-option-edit .edit-option-quantity input').val(),
                            opt_status = $(this).parent().find('.prod-option-edit .option-price-status-str').attr('data-val');

                        $(this).next().find('.form-wrap').removeClass('err');
                        if(opt_title.length == 0) {
                            $(this).next().find('.form-wrap').addClass('err').find('.edit-option-title input').focus();
                            submit = false;
                            return true;
                        }
                        switch(opt_status) {
                            case "S" : str = '판매'; break;
                            case "O" : str = '품절'; break;
                            case "H" : str = '숨김'; break;
                            default : str = '판매'; break;
                        }

                        if (!opt_quantity) opt_quantity = 0;
                        if (!opt_price) opt_price = 0;

                        opt_quantity = (opt_quantity * 1);
                        opt_price = (opt_price * 1);
                        $(this).find('.prod-option-title').text(opt_title);
                        $(this).find('.prod-option-price').text(opt_price);
                        $(this).find('.prod-option-quantity').text(opt_quantity);
                        $(this).find('.prod-option-status').text(str).attr('data-val',opt_status);
                        $(this).parent().find('.prod-option-edit').css('display','none');
                        $(this).removeClass('hide');
                    });
                }

                if(submit) {
                    var title = $(this).parent().find('.prod-option-title').text(),
                        price = $(this).parent().find('.prod-option-price').text(),
                        quantity = $(this).parent().find('.prod-option-quantity').text(),
                        status = $(this).parent().find('.prod-option-status').attr('data-val'),
                        $title = $(this).parent().siblings('.prod-option-edit').find('.edit-option-title input'),
                        $price = $(this).parent().siblings('.prod-option-edit').find('.edit-option-price input'),
                        $quantity = $(this).parent().siblings('.prod-option-edit').find('.edit-option-quantity input'),
                        $status = $(this).parent().siblings('.prod-option-edit').find('.option-price-status-str');

                    switch(status) {
                        case "S" : str = '판매'; break;
                        case "O" : str = '품절'; break;
                        case "H" : str = '숨김'; break;
                        default : str = '판매'; break;
                    }

                    if (!quantity) quantity = 0;
                    if (!price) price = 0;

                    price = (price * 1);
                    quantity = (quantity * 1);
                    $title.val(title);
                    $price.val(price);
                    $quantity.val(quantity);
                    $status.text(str).attr('data-val',status);
                    $(this).parent().addClass('hide');
                    $(this).parent().siblings('.prod-option-edit').show();
                    if($(this).hasClass('prod-option-title')) $title.focus();
                    if($(this).hasClass('prod-option-price')) $price.focus();
                }
            });
            $(document).on('keyup click','.edit-option-title input, .edit-option-price input, .edit-option-quantity input',function(e) {
                e.stopPropagation();
                var keyCode = e.keyCode,
                    $title = $(this).parents('.form-wrap').find('.edit-option-title input'),
                    $price = $(this).parents('.form-wrap').find('.edit-option-price input'),
                    $quantity = $(this).parents('.form-wrap').find('.edit-option-quantity input'),
                    $status = $(this).parents('.form-wrap').find('.option-price-status-str');

                $(this).parents('li').find('.prod-option-title').text($title.val());
                $(this).parents('li').find('.prod-option-price').text($price.val());
                $(this).parents('li').find('.prod-option-quantity').text($quantity.val());
                $(this).parents('li').find('.prod-option-status').text($status.text());
                if(keyCode == 13) {
                    if($title.val().trim().length == 0) {
                        return false;
                    }
                    if($quantity.val() == '') $(this).parents('li').find('.prod-option-quantity').text('0');
                    if($('.switch-quantity').is(':checked') == true && $(this).parents('li').find('.prod-option-quantity').text() == '0') {
                        $(this).parents('li').find('.option-price-status-str').attr('data-val','O').text('품절');
                        $(this).parents('li').find('.prod-option-status').attr('data-val','O').text('품절');
                    }
                    $(this).parents('.prod-option-edit').hide();
                    $(this).parents('li').find('.prod-option-item').removeClass('hide');
                }
            });
            $(document).on('click','.prod-modal', function(e) { 
                shoppingSetOption();
            });
            $(document).on('click','.prod-option-add', function(e) {
                if($('.prod-option-item.hide').length) {
                    // $('.prod-option-item.hide').next().find('.form-wrap').addClass('err').find('.edit-option-title input').focus();
                    r = shoppingSetOption();
                    if(r == false) return r;
                }

                var state = 'normal-product';
                $('.cl_product_state_check').each(function () {
                    if ($(this).hasClass('active') === true) {
                        state = $(this).attr('for');
                    }
                });
                var status = true;
                var productNumber = $('#prod-no').val();

                if (productNumber) {
                    $.ajax({
                        url: '/shopping/download_list_check',
                        type: 'post',
                        dataType: 'json',
                        data: {'product_number': productNumber},
                        success: function (data) {
                            if (data.code == 'fail') {
                                alert(data.message);
                                status = false;
                                return false;
                            }
                        }
                    });
                }

                if (status == false) return false;
            
                if ($('#add-upload-check .download-contents .file-name').length > 0 || $('#add-upload-check .download-contents .none-file-name').length > 0) {
                    if (confirm('업로드된 파일이 있습니다. 옵션을 추가하시면 삭제됩니다.\n계속 하시겠습니까?') !== true) {
                        return false;
                    }
                }
                if ($('#add-upload-check .product-upload').length) {
                    $('.ui-sortable li .product-status .file-box-list').each(function () {
                        $(this).empty();
                    });
                }
                $('#add-upload-check .product-upload').remove();
                var tax = $('#tax').attr('data-total-tax');

                var item = '\
                        <li>\
                            <div class="prod-option-item hide">\
                                <span class="prod-option-title"></span>\
                                <span class="prod-option-price"></span>\
                                <span class="prod-option-quantity"></span>\
                                <span class="prod-option-status"></span>\
                                <span class="prod-option-move"><i class="fa fa-arrows" aria-hidden="true"></i></span>\
                            </div>\
                            <div class="prod-option-edit" style="display:block;">\
                                <div class="form-wrap">\
                                    <div class="form-group edit-option-title">\
                                        <input type="text" maxlength="50" required="required" placeholder="옵션명"/>\
                                    </div>\
                                    <div class="form-group edit-option-price">\
                                        <input type="text" required="required" class="option-price-price" placeholder="0" />\
                                    </div>\
                                    <div class="form-group edit-option-quantity">\
                                        <input type="text" required="required" class="option-price-quantity" maxlength="5" placeholder="0" numberonly/>\
                                    </div>\
                                    <div class="form-group edit-option-select">';
                                    if (state == 'download-product') item += '<div class="option-price-status-str hand" data-val="O">품절</div>';
                                    else item += '<div class="option-price-status-str hand" data-val="S">판매</div>';
                                    item += '<ul class="option-price-status-select">\
                                            <li data-val="S">판매</li>\
                                            <li data-val="O">품절</li>\
                                            <li data-val="H">숨김</li>\
                                        </ul>\
                                    </div>\
                                    <div class="edit-option-delete"><i class="fa fa-trash-o"></i></div>\
                                </div>\
                            </div>';

                    if (state == 'download-product') {
                        item += '<div class="form-group product-status">\
                                <div class="product-state-box">\
                                    <div class="product-upload">\
                                        <div class="title">파일 업로드</div>\
                                        <div class="download-contents">\
                                            <span class="cl_icon_upload02" data-cnt="'+fileUpdateCnt+'">업로드</span>\
                                            <div class="file-box-list" id="file-box-'+fileUpdateCnt+'"></div>\
                                        </div>\
                                    </div>\
                                </div>\
                            </div>';
                        fileUpdateCnt++;
                    }
                    item += '</li>';
                var $item = $(item);
                $('.prod-option-list').append($item);
                $('.prod-option-list li:last-child').find('.edit-option-title input').focus();

                $('#plus-price').text('추가금액');
                $('#plus-quantity').text('수량');
                $('#plus-status').text('상태');
                if($('.switch-quantity').is(":checked") == true) {
                    // $('#prod-quantity').attr('readonly','true').removeClass('hide').attr('placeholder','옵션에서 재고 관리'); 
                    $('.quantity-label').addClass('on');
                    $('.prod-option-quantity, #plus-quantity, .edit-option-quantity').show();
                } else {
                    $('.prod-option-quantity, #plus-quantity, .edit-option-quantity').hide();
                }

            });
        
            $(document).on('click', '.cl_etc_state_check', function () {
                $('.cl_etc_state_check').each(function () {
                    $(this).removeClass('active');
                });

                $(this).addClass('active');
                var val = $(this).attr('data-val');
                $('#etc-date-state').val(val);

                if (val == 'N') $('.etc-setting').css('display', 'none');
                else $('.etc-setting').css('display', 'block');
            });
        
            $(document).on('click', '.cl_etc_status_check', function () {
                $('.cl_etc_status_check').each(function () {
                    $(this).removeClass('active');
                });

                $(this).addClass('active');
                var val = $(this).attr('data-val');
                $('#etc-date-status').val(val);
            });
        
            $(document).on('click', '.cl_etc_week_check', function () {
                $('.cl_etc_week_check').each(function () {
                    $(this).removeClass('active');
                });

                $(this).addClass('active');
                var val = $(this).attr('data-val');
                $('#etc-date-week').val(val);
            });
        
            $(document).on('click', '.cl_etc_date_time', function () {
                $('.cl_etc_date_time').each(function () {
                    $(this).removeClass('active');
                });

                $(this).addClass('active');
                var startDate = $(this).attr('data-start_date');
                var endDate = $(this).attr('data-end_date');
                $('#etc-start-date').val(startDate);
                $('#etc-end-date').val(endDate);

            });

            $(document).on('click', '.cl_product_state_check', function () {
                var state = $(this).attr('for');
                var cnt = $('.prod-option-list > li').length;
                var tax = $('#tax').attr('data-total-tax');
                var productNumber = $('#prod-no').val();
                var status = true;

                if (state == "download-product") {
                    $('#state-append').fadeIn(0);
                    $('#etc-calendar').hide();
                    if (cnt < 2) {
                        if ($('.real-file-name').length < 1) $('.switch-product').prop('checked','').parents('.form-wrap').addClass('disabled');
                        var html = '<div class="form-group" id="product-state">\
                                        <input type="file" id="upload-file" name="files">\
                                        <div class="product-state-box" id="add-upload-check">\
                                            <div class="product-upload">\
                                                <div class="title">파일 업로드</div>\
                                                <div class="download-contents">\
                                                    <span class="cl_icon_upload02" data-cnt="0">업로드</span>\
                                                    <div id="none-option-file">\
                                                    </div>\
                                                </div>\
                                            </div>\
                                            <div class="download-setting">\
                                                <div class="title">다운로드<br>한도설정';
                                                /*html += '<span class="cl-icon cl_icon_info01"></span>';*/
                                                html += '</div>\
                                                <div id="download-contents">\
                                                    <div class="input-box">\
                                                        <div class="title">기간 제한</div>\
                                                        <div class="textbox">\
                                                            <input type="text" numberOnly class="download-input" id="download-date" value="1">\
                                                            <span>일</span>\
                                                        </div>\
                                                    </div>\
                                                    <div class="input-box">\
                                                        <div class="title">횟수 제한</div>\
                                                        <div class="textbox">\
                                                            <input type="text" numberOnly class="download-input" id="download-count" value="1">\
                                                            <span>회</span>\
                                                        </div>\
                                                    </div>\
                                                </div>\
                                            </div>\
                                        </div>\
                                    </div>';
                                    
                        $('#product-state').remove();
                        $('#state-append').append(html);

                        $('.prod-option-list > li').each(function () {
                            var $checkTag = $(this).children('.product-status');
                            if ($checkTag.hasClass('product-status') === false) {
                                var item = '<div class="form-group product-status">\
                                            <div class="product-state-box">\
                                                <div class="product-upload">\
                                                    <div class="title">파일 업로드</div>\
                                                    <div class="download-contents">\
                                                        <span class="cl_icon_upload02" data-cnt="0">업로드</span>\
                                                        <div class="file-box-list" id="file-box-0"></div>\
                                                    </div>\
                                                </div>\
                                            </div>\
                                        </div>';
                                fileUpdateCnt++;

                                $(this).append(item);
                            } else {
                                var $loadTag = $(this).find('.download-contents div');

                                $('#none-option-file').html($loadTag.html());
                            }
                        });
                    } else {
                        var html = '<div class="form-group" id="product-state">\
                                        <input type="file" id="upload-file" name="files" data-cnt="'+fileUpdateCnt+'">\
                                        <div class="product-state-box" id="add-upload-check">\
                                            <div class="download-setting">\
                                                <div class="title">다운로드<br>한도설정';
                                                /*html += '<span class="cl-icon cl_icon_info01"></span>';*/
                                                html += '</div>\
                                                <div class="download-contents">\
                                                    <div class="input-box">\
                                                        <div class="title">기간 제한</div>\
                                                        <div class="textbox">\
                                                            <input type="text" numberOnly class="download-input" id="download-date" value="1">\
                                                            <span>일</span>\
                                                        </div>\
                                                    </div>\
                                                    <div class="input-box">\
                                                        <div class="title">횟수 제한</div>\
                                                        <div class="textbox">\
                                                            <input type="text" numberOnly class="download-input" id="download-count" value="1">\
                                                            <span>회</span>\
                                                        </div>\
                                                    </div>\
                                                </div>\
                                            </div>\
                                        </div>\
                                    </div>';

                        $('#product-state').remove();
                        $('#state-append').append(html);

                        $('.prod-option-list > li').each(function () {
                            var $checkTag = $(this).children('.product-status');
                            var name = $(this).find('.prod-option-title').text();

                            if ($checkTag.hasClass('product-status') === false) {
                                var item = '<div class="form-group product-status">\
                                            <div class="product-state-box">\
                                                <div class="product-upload">\
                                                    <div class="title">파일 업로드</div>\
                                                    <div class="download-contents">\
                                                    <span class="cl_icon_upload02" data-cnt="'+fileUpdateCnt+'">업로드</span>';
                                                    if (name == 'noneOption') item += '<div class="file-box-list" id="file-box-0">';
                                                    else item += '<div class="file-box-list" id="file-box-'+fileUpdateCnt+'">';
                                                    item += '</div>\
                                                    </div>\
                                                </div>\
                                            </div>\
                                        </div>';
                                fileUpdateCnt++;

                                $(this).find('.prod-option-status').text('품절').attr('data-val', 'O');
                                $(this).find('.option-price-status-str').text('품절').attr('data-val', 'O');

                                $(this).append(item);
                            }
                        });
                    }
                    fileUpdateCnt++;
                } else {
                    if (taxUse != 'TG03' && state == "normal-product") $('#state-append').fadeOut(0);
                    else $('#state-append').fadeIn(0);
                    if (productNumber) {
                        $.ajax({
                            url: '/shopping/download_list_check',
                            type: 'post',
                            dataType: 'json',
                            data: {'product_number': productNumber},
                            success: function (data) {
                                if (data.code == 'fail') {
                                    alert(data.message);
                                    status = false;
                                    return false;
                                }
                            }
                        });
                    }

                    if (status == false) return false;

                    if (cnt > 0) {
                        var checkFile = $('.file-name').length;
                        if (checkFile > 0) {
                            if (confirm('상품 유형을 변경할 경우 옵션에 등록된 파일이 삭제됩니다.\n계속하시겠습니까?') === true) {
                                $('#product-state').remove();
                                $('.product-status').remove();
                            } else return false;
                        } else {
                            $('#product-state').remove();
                            $('.product-status').remove();
                        }
                    } else {
                        $('#product-state').remove();
                        $('.product-status').remove();
                    }

                    if (state == "etc-product") {
                        $('#etc-calendar').show();
                    } else {
                        $('#etc-calendar').hide();
                    }
                }

                $('.cl_product_state_check').each(function () {
                    $(this).children('.cl-icon').removeClass('cl_icon_check02_on').removeClass('cl_icon_check02_off').addClass('cl_icon_check02_off');
                    $(this).removeClass('active');
                });

                $(this).children('.cl-icon').removeClass('cl_icon_check02_off').addClass('cl_icon_check02_on');

                $(this).addClass('active');
            });

            $(document).on('mouseenter', '.cl-product-info', function () {
                $('.product-info').fadeIn(100);
            }).on('mouseleave', '.cl-product-info', function () {
                $('.product-info').fadeOut(100);
            });

            $(document).on('click', '.cl_icon_close', function () {
                var checkCnt = $(this).attr('data-cnt');
                var productNumber = $(this).attr('data-pn');
                var seq = $(this).attr('data-seq');
                var file = $(this).attr('data-file');
                var $parentFile = $(this).parent().parent();
                var $closeFile = $(this).parent();
                var $this = $(this);

                if (productNumber) {
                    $.ajax({
                        url: '/shopping/download_list_check',
                        type: 'post',
                        dataType: 'json',
                        data: {'product_number': productNumber},
                        success: function (data) {
                            if (data.code == 'fail') {
                                alert(data.message);
                                return false;
                            } else {
                                if (confirm(data.message) === true) {
                                    $.processON('Deleting File...');
                                    $.ajax({
                                        type: 'POST',
                                        url: '/shopping/file_delete',
                                        data: { s: file, seq: seq},
                                        async: true,
                                        success: function(data) {
                                            checkError(data);
                                            if (checkCnt || checkCnt == 0) {
                                                $closeFile.remove();
                                                $('.file-name-'+checkCnt).remove();
                                                    $this.parent().parent().parent().parent().parent().parent().find('.prod-option-status').text('품절').attr('data-val', 'O');
                                                    $this.parent().parent().parent().parent().parent().parent().find('.option-price-status-str').text('품절').attr('data-val', 'O');

                                            } else $closeFile.remove();
                                            
                                            var $fileCnt = $parentFile.find('.file-name');
                                            if ($fileCnt.length < 1) {
                                                if ($('#none-option-file').length > 0) $('.switch-product').prop('checked','').parents('.form-wrap').addClass('disabled');
                                                $.ajax({
                                                    url: '/shopping/file_zero',
                                                    type: 'post',
                                                    data: {'product_number': productNumber}
                                                });
                                            }

                                            $.processOFF();
                                        }
                                    });
                                }
                            }
                        }
                    });
                } else {
                    $.ajax({
                        type: 'POST',
                        url: '/shopping/file_delete',
                        data: {s: file},
                        async: true,
                        success: function(data) {
                            checkError(data);
                            if (checkCnt || checkCnt == 0) {
                                $closeFile.remove();
                                $('.file-name-'+checkCnt).remove();
                            } else $closeFile.remove();
                                            
                            var $fileCnt = $parentFile.find('.file-name');
                            if ($fileCnt.length < 1) {
                                $('.switch-product').prop('checked','').parents('.form-wrap').addClass('disabled');
                            }

                            $.processOFF();
                        }
                    });
                }
            });

            $(document).on('click', '.cl_icon_upload02', function () {
                var cnt = $(this).attr('data-cnt'),
                    fileCnt = 0;
                $('#file-box-'+cnt).find('.real-file-name').each(function () {fileCnt++;});
                if ($('#none-option-file').find('.real-file-name').length > 0) fileCnt++;

                if (fileCnt >= 1) {
                    alert('파일은 1개만 업로드 가능합니다.\n여러 파일을 업로드할 경우 압축 파일을 이용해 주세요.');
                    return false;
                }

                $thisUploadCheck = $(this);
                $('#product-state').find('input[type="file"]').attr('data-cnt', cnt).click();
            });

            $(document).on('click', '#upload-file', function (data) {
                var sid = (typeof SID == 'undefined') ? property.SID : SID
                    uid = '',
                    cnt = $(this).attr('data-cnt');
                $.uploadON();
                $(this).fileupload({
                    url: '/shopping/image_upload/type/file/sid/'+sid+'/uid/'+uid,
                    dataType: 'json',
                    pasteZone: null,
                    async: true,
                    add: function(e, data) {
                        $('.uploadModal').show();
                        var submit = true, err = '';                        
                        var ext = ['zip', 'txt', 'pdf', 'docx', 'xlsx', 'xls', 'csv', 'ppt', 'pptx', 'gif', 'jpg', 'jpeg', 'png', 'ico', 'hwp', 'mp3', 'wav', 'wma', 'mp4']
                        var extAry = data.fileInput[0]['files'][0]['name'].split(".");
                        if (ext.indexOf(extAry[extAry.length - 1]) == -1) {
                            err = $.lang[LANG]['editor.upload.error.ext'];
                            submit = false;
                        }

                        var maxSize  = 1024 * 1024 * 512;
                        var fileSize = data.fileInput[0]['files'][0]['size'];
            

                        if (fileSize > maxSize) {
                            err = $.lang[LANG]['editor.upload.max.500'] + $.lang[LANG]['editor.upload.max.2'];
                            submit = false;
                        }
                        $('#loading').css('left','-100%');

                        var fileSize = (data.files[0].size/1024/1024).toFixed(1) + ' Mb';
                        var tpl = '<div class="file"><span class="loading"><i class="fa fa-circle-o-notch fa-spin fa-3x fa-fw"></i></span><a target="_blank">' + data.files[0].name + '</a><span class="file-size">' + fileSize + '</span><div class="progress"><div class="progress-bar"></div></div><div class="progress-info"><span class="ing"></span><span class="rate"></span></div><div class="preview"></div></div>';
                        data.context = $(tpl).insertBefore($('.uploadModal .upload-content .upload-cancel'));
                        data.context.find('.preview').addClass('not_image');
                        if(submit) {
                            var jqXHR = data.submit();
                            UPLOAD++;
                        } else {
                            data.context.find('.loading').html('<i class="fa fa-times error"></i>');
                            data.context.find('.ing').addClass('error').text(err);
                        }
                        $(document).on('click','.upload-cancel .btn', function(e) {
                            if(jqXHR != undefined) jqXHR.abort();
                            data.context.fadeOut().remove();
                            $('.uploadModal #file-upload-progress').css('width','0%');
                            UPLOAD = 0;
                            UPLOADED = 0;
                            UPLOADSIZE = 0;
                            PROGRESS = 0;

                            $.uploadOFF();
                        });

                    },
                    progress: function(e, data) {
                        var rate = (data.bitrate/1024).toFixed(1) + ' kbps';
                        var progress = parseInt((data.loaded / data.total) * 100, 10);
                        if(typeof data.context != 'undefined') {
                            data.context.find('.res').text(data.bitrate);
                            data.context.find('.progress-bar').css('width',progress + "%");
                            data.context.find('.ing').text(progress + "%");
                            data.context.find('.rate').text(rate);
                            if(progress == 100) {
                                data.context.find('.ing').text($.lang[LANG]['editor.upload.response']);
                            }
                        }
                    },                        
                    done: function(e, data) {
                        if(typeof data.result.error != 'undefined' && data.result.error) {
                            alert(data.result.error);
                            $.uploadOFF();
                            return;
                        }
                        var fileSize = data.result.file_size, unit = 'KB';

                        if (fileSize >= 1000) {
                            fileSize = fileSize / 1000;
                            fileSize = fileSize.toFixed(2);
                            unit = 'MB';
                            if (fileSize >= 1000) {
                                fileSize = fileSize / 1000;
                                fileSize = fileSize.toFixed(2);
                                unit = 'GB';
                            }
                        }

                        var fileName = data.result.client_name, totalByte = 0, strFileName = '';
                        if (!fileName) {
                            alert('업로드 도중 오류가 발생했습니다. 다시 시도해 주세요.\n지속적으로 문제가 발생한다면 관리자에게 문의해 주세요.');
                            $.uploadOFF();
                            return false;
                        }
                        var file = fileName.split('.');
                        var fileLen = file[0].length;
                        for (var i=0;i<fileLen;i++) {
                            oneChar = file[0].charAt(i);
                            if (escape(oneChar).length > 4) {
                                totalByte += 2;
                            } else {
                                totalByte++;
                            }

                            if (totalByte > 10) {
                                strFileName += '..';
                                break;
                            }

                            strFileName += oneChar;
                        }
                        strFileName = strFileName+"."+file[(file.length - 1)];
                        var splitUrl = data.result.full_path.split('/');
                        var fileCnt = $('.file-name').length;

                        var file = '<div class="file-name file-name-'+fileCnt+'">\
                                        <span class="real-file-name">'+fileName+'</span>\
                                        <span class="file-name-detail" title="'+fileName+'">'+strFileName+'</span>\
                                        <span class="file-size">'+fileSize+unit+'</span>\
                                        <span class="cl-icon cl_icon_close" data-cnt="'+fileCnt+'" data-file="'+splitUrl[8]+'" data-pn="'+closeProductNumber+'"></span>\
                                        <span class="file-url">'+data.result.full_path+'</span>\
                                    </div>';


                        var licnt = $('.prod-option-list > li').length;
                        if ($thisUploadCheck.parent().parent().find('#none-option-file').length <= 0) {
                            $thisUploadCheck.parent().parent().parent().parent().parent().find('.prod-option-status').text('판매').attr('data-val', 'S');
                            $thisUploadCheck.parent().parent().parent().parent().parent().find('.option-price-status-str').text('판매').attr('data-val', 'S');
                        }
                        if (licnt < 2) {
                            var noneFile = '<div class="none-file-name">\
                                            <span class="none-real-file-name">'+fileName+'</span>\
                                            <span class="none-file-name-detail" title="'+fileName+'">'+strFileName+'</span>\
                                            <span class="none-file-size">'+fileSize+unit+'</span>\
                                            <span class="cl-icon cl_icon_close" data-cnt="'+fileCnt+'" data-file="'+splitUrl[8]+'" data-pn="'+closeProductNumber+'"></span>\
                                            <span class="none-file-url">'+data.result.full_path+'</span>\
                                        </div>';
                            $('#file-box-'+cnt).append(file);
                            $('#none-option-file').append(noneFile);
                        } else {
                            $('#file-box-'+cnt).append(file);
                        }

                        progress1 = parseInt(UPLOADED / UPLOAD * 100,10);
                        PROGRESS = progress1 + progress2;
                        $('.file-upload-progress .progress-bar').css({
                            'width' : PROGRESS + '%',
                            'text-align' : 'right',
                            'padding-right' : '5px'
                        }).text(PROGRESS + '% ');

                        UPLOADED++;
                        if(UPLOADED) {
                            //$.uploadON(UPLOADED + " / " + UPLOAD + "<br>images creating...");
                            if(UPLOAD==UPLOADED) {
                                UPLOAD = 0;
                                UPLOADED = 0;
                                UPLOADSIZE = 0;
                                PROGRESS = 0;

                                $('.file-upload-progress .progress-bar').css({
                                    'width' :  PROGRESS + '%',
                                    'padding-right' : '0px'
                                }).text('');
                            }
                        }

                        $.uploadOFF();
                    },
                    progressall: function(e, data) {
                        var total = (data.total/1024/1024).toFixed(1) + ' Mb';
                        $('.uploadModal .info1').text($.lang[LANG]['editor.upload.size.total'] + total);
                        $('.uploadModal .info2').text((UPLOADED+1) + ' / ' + UPLOAD.toString());
                        var progress = parseInt((data.loaded / data.total) * 100, 10);
                        $('.file-upload-progress .progress-bar').css('width',progress + "%");
                    },
                    start : function(e, data) {
                        $('.uploadModal .upload-header h1').text($.lang[LANG]['editor.upload.title.2']);
                        $('.uploadModal .upload-content .upload-cancel .btn-default').text($.lang[LANG]['config.cancel']);
                        progress1 = 0; progress2 = 0; PROGRESS = 0;
                    },
                    dragover : function(e, data) {
                        e.preventDefault();
                    }
                }).prop('disabled', !$.support.fileInput)
                    .parent().addClass($.support.fileInput ? undefined : 'disabled');
            });

            $(document).on('keyup', '#download-date', function () {
                if ($(this).val() != '') {
                    if ($(this).val() > 90) {
                        alert('기간 제한은 최소 1일에서 최대 90일입니다.');
                        $(this).val(90);
                        return false;
                    }

                    if ($(this).val() < 1) {
                        alert('기간 제한은 최소 1일에서 최대 90일입니다.');
                        $(this).val(1);
                        return false;
                    }
                }
            });

            $(document).on('focusout', '#download-date', function () {
                if ($(this).val() == '') {
                    alert('기간 제한은 최소 1일에서 최대 90일입니다.');
                    $(this).val(1);
                    return false;
                }
            });

            $(document).on('keyup', '#download-count', function () {
                if ($(this).val() != '') {
                    if ($(this).val() > 10) {
                        alert('다운로드 횟수는 최소 1회에서 최대 10회입니다.');
                        $(this).val(10);
                        return false;
                    }

                    if ($(this).val() < 1) {
                        alert('다운로드 횟수는 최소 1회에서 최대 10회입니다.');
                        $(this).val(1);
                        return false;
                    }
                }
            });

            $(document).on('focusout', '#download-count', function () {
                if ($(this).val() == '') {
                    alert('다운로드 횟수는 최소 1회에서 최대 10회입니다.');
                    $(this).val(1);
                    return false;
                }
            });

            $(document).on('click','.option-price-status-str', function(e) {
                e.stopPropagation();
                var check = $(this).attr('data-val');
                if($(this).hasClass('open')) {
                    $(this).next().slideUp(200, function() {
                        $('.option-price-status-str').removeClass('open');    
                    }); 
                } else {
                    $(this).addClass('open');
                    $(this).next().find('li').removeClass('active');
                    $(this).next().find('li[data-val="' + check + '"]').addClass('active');
                    $(this).next().slideDown(200); 
                }

            });

            $(document).on('click', '.option-price-status-select li', function(e) {
                e.stopPropagation();
                $('.option-price-status-select li').removeClass('active');
                $(this).addClass('active');
                var str = $(this).text(),
                    val = $(this).attr('data-val');

                $(this).parents('.edit-option-select').find('.option-price-status-str').text(str).attr('data-val',val);
                $(this).parents('li').find('.prod-option-status').text(str).attr('data-val',val);

                $(this).parent().slideUp(200);
            });

            $(document).on('click','.edit-option-delete', function(e) { 
                var $option = $(this),
                    seq = $(this).attr('data-seq'),
                    sid = (typeof SID == 'undefined') ? property.SID : SID;

                var modal = $(this).showModalFlat('INFORMATION', '선택한 옵션을 삭제하시겠습니까?', true, true, function() {
                    if(typeof seq != "undefined" || seq) {
                        $.post('/template/products', { seq : seq, sid : sid, type : 'delete', mode: 'option' }, function(data) {
                            if(typeof data.error != "undefined" || data.error) {
                                alert(data.error);
                                return false;
                            }
                            $option.parents('li').remove(); 

                            var liTotal = 0;
                            $('.prod-option-list > li').each(function () { liTotal++; });
                            if (liTotal < 2) $('#plus-price').text('');
                        }, 'json');
                    } else {
                        $option.parents('li').remove();

                        var liTotal = 0;
                        $('.prod-option-list > li').each(function () { liTotal++; });
                        if (liTotal < 2) $('.prod-str-price').text('');
                    }

                    if($('.prod-option-list > li').length > 1) {
                        // $('#prod-quantity').attr('readonly','true').removeClass('hide').attr('placeholder','옵션에서 재고 관리');
                        $('.quantity-label').addClass('on');
                    } else {
                        $('.prod-str-price').text('');
                        $('.quantity-label').removeClass('on');
                        if($('.switch-quantity').is(':checked') == true) {
                            $('#prod-quantity').removeAttr('readonly').removeClass('hide').attr('placeholder','수량 입력');
                        } else {
                            $('#prod-quantity').addClass('hide').attr('placeholder','수량 입력');
                        }   
                        
                    }


                    var cnt = $('.prod-option-list > li').length;
                    if (cnt < 2) {
                        var html = '<div class="product-upload">\
                                        <div class="title">파일 업로드</div>\
                                        <div class="download-contents">\
                                            <span class="cl_icon_upload02" data-cnt="0">업로드</span>\
                                            <div id="none-option-file"></div>\
                                        </div>\
                                    </div>';

                                fileUpdateCnt++;

                        $('#add-upload-check').prepend(html);
                        if ($('#none-option-file').length > 0) $('.switch-product').prop('checked','').parents('.form-wrap').addClass('disabled');
                    }

                    modal.modal('hide');
                }, 'cancel' );            });
            $(document).on('click','.category-lists li', function(e) { 
                e.stopPropagation();
                $(this).toggleClass('active'); 
                var selected = $('.category-lists li.active').map(function() {
                    return $(this).text();
                }).get().join(', ');
                selected = (selected.length==0) ? '카테고리를 선택하세요' : selected;
                $('#prod-category-text').text(selected);
            });
            $(document).on('click','.category-wrap', function(e) { 
                var txt = $(this).find('.category-text').text(),
                    selected = $.map(txt.split(","), $.trim);
                
                $.each($('.category-lists li'), function(i,v) {
                    var s = $.trim($(this).text());
                    if(selected.indexOf(s) > -1) {
                        $(this).addClass('active');
                    }
                });
                // $('.category-lists').slideToggle(); 
            });
            /*--------- move -------------*/
            $(document).on('click','.category-title', function() {
                var submit = true;
                if($('.category-move.delete').length) {
                    $.each($('.category-move.delete'), function(i,v) {
                        $(this).removeClass('delete').find('i').removeClass('fa-trash-o').addClass('fa-arrows');
                        var txt = $(this).parents('li').find('.category-input').val();
                        if(txt.length == 0) {
                            submit = false;
                            return true;
                        }
                        $(this).parents('li').find('.category-title').text(txt).removeClass('hide');
                    });
                }

                if(submit) {
                    var v = $(this).text();
                    if(!$(this).hasClass('hide')) {
                        $(this).addClass('hide');
                        $(this).siblings('.form-wrap').find('.category-input').val(v).focus();
                    }
                    $(this).parents('li').find('.category-move').addClass('delete').html('<i class="fa fa fa-trash-o" aria-hidden="true">');
                }
            });
            $(document).on('focus', '.category-input', function(e) {
                var submit = true;
                if($('.category-move.delete').length) {
                    $.each($('.category-move.delete'), function(i,v) {
                        $(this).removeClass('delete').find('i').removeClass('fa-trash-o').addClass('fa-arrows');
                        var txt = $(this).parents('li').find('.category-input').val();
                        if(txt.length == 0) {
                            submit = false;
                            return true;
                        }
                        $(this).parents('li').find('.category-title').text(txt).removeClass('hide');
                    });
                }

                $(this).parents('li').find('.category-move').addClass('delete').find('i').removeClass('fa-arrows').addClass('fa-trash-o');
            });
            $(document).on('keyup', '.category-input', function(e) {
                var keyCode = e.keyCode,
                    search = $(this).val().trim(),
                    v = $(this).val().trim();

                $(this).parents('.form-wrap').siblings('.category-title').text(v);
                if(v.length==0) return false;
                if(keyCode == 13) {
                    if($.category.check()) {
                        alert('카테고리명 중복입니다');
                        return false;
                    }
                    $(this).parents('.form-wrap').siblings('.category-title').removeClass('hide');
                    $(this).parents('.form-wrap').siblings('.category-move').removeClass('delete').html('<i class="fa fa-arrows" aria-hidden="true"></i>');

                }
            });
            $(document).on('click','.item-add', function() {
                $('.category-edit li:last-child').before($('<li><div class="form-wrap"><div class="form-group"><input type="text" class="category-input" required="required"/><label for="input" class="control-label">카테고리 이름</label><i class="bar"></i></div></div><div class="category-move delete"><i class="fa fa-trash-o" aria-hidden="true"></i></div><div class="category-title hide"></div></li>'));
                $('.category-input:last-child').focus();
            });
            $(document).on('click','.category-move.delete', function(e) {
                ($.category.delete).push($(this).next().text());
                $(this).parents('li').find('.category-input').val('');
                $(this).parents('li').remove();
            });
            $(document).on('click','.prod-button .modal-close', function(e) { $.products.close(); });
            $(document).on('click','.category-modal .cl-category-modal-ok', function(e) {
                var change = [], del = $.category.delete;
                var category_lists = $('.category-edit .category-title').map(function(){
                    var org = $(this).attr('data-org'),
                        val = $(this).text().trim();

                    if(org != val) change.push(org + '|' + val);

                    if($(this).text().trim()) {
                        return $(this).text().trim();
                    }
                }).get();

                if($.category.check()) {
                    alert('카테고리명 중복입니다');
                    return false;
                }

                var $category = $('#prod-category-text');
                var cate = ($category.text().trim()) ? $category.text().trim().split(', ') : [];

                if(cate.length && del.length) {
                    $.each(del, function(i,v) {
                        var idx = cate.indexOf(v);
                        if(idx > -1) cate.splice(idx, 1)
                    });
                    $category.text(cate.join(', '));
                }

                if(cate.length && change.length) {
                    $.each(change, function(i,v) {
                        var s = v.split('|'),
                            idx = cate.indexOf(s[0]);
                        if(idx > -1) cate[idx] = s[1];
                    });
                    $category.text(cate.join(', '));
                }
                if($category.text() == '') $category.text('카테고리를 선택하세요');
                
                var pid = ($('.prod-modal').length) ? $('#prod-pid').val() : $('.gallery-ctrl-category').attr('data-pid'),
                    gid = $('#prod-no').val();

                $.post('/template/gallery/category', { sid : SID, s : category_lists, mode : 'block', seq : pid, gid : gid, change : change, del : del }, function(r) {
                    if(typeof r.error !='undefined' && r.error) {
                        alert(r.error);
                        return false;
                    }

                    $('#prod-category-lists ul, .toolbar-category .item-submenu').empty();
                    $('.gallery-category li.category-text').remove();
                    var s = '';
                    $.each(category_lists, function(i,v) {
                        var li_str = '<li>' + v + '</li>',
                            li_str2 = '<li class="category-text">' + v + '</li>';
                        s = s + li_str;
                        $('#prod-category-lists ul').append(li_str);
                        $('.toolbar-category .item-submenu').append(li_str);
                        $('.gallery-category .gallery-category-onoff').before(li_str2);
                    });
                    $.gallery.cates = s;
                    $('#prod-category, .gallery-ctrl-category, .gallery-modal').attr('data-category',category_lists.toString());


                    $category = $('#prod-category-text');
                    var cate = ($category.text().trim()) ? $category.text().trim().split(', ') : [];
                    $.each($('.category-lists li'), function(i,v) {
                        if(cate.includes($(this).text())) $(this).addClass('active');
                    });
                    $.category.close();
                    $.gallery.update = true;

                }, 'json');
            });
        },
        open : function(s) {
            if($('.cl-category-modal-backdrop').length >0) $('.cl-category-modal-backdrop').remove();
            var text = s.split(',');
            var $backdrop = $('<div class="cl-category-modal-backdrop"></div>'),
                $title = $('<h1 class="category-modal-title">' + $.lang[LANG]['editor.block.gallery.category.edit.title'] + '</h1>'),
                $modal = $('<div class="cl-category-modal cl-p-modal category-modal"></div>'),
                $lists = $('<ul class="category-edit"></ul>'),
                $item_add = $('<li class="item-add"></li>');
                $modal_footer = $('<div class="cl-category-modal-footer"><div class="cl-category-modal-close">' + $.lang[LANG]['config.close'] + '</div><div class="cl-category-modal-ok">' + $.lang[LANG]['config.save'] + '</div></div>');

            $.each(text, function(i,v) {
                var item = "\
                    <li>\
                        <div class='form-wrap'>\
                            <div class='form-group'>\
                                <input type='text' class='category-input' required='required' value='" + v + "'>\
                                <label for='input' class='control-label'>카테고리 이름</label><i class='bar'></i>\
                            </div>\
                        </div>\
                        <div class='category-move'><i class='fa fa-arrows' aria-hidden='true'></i></div>\
                        <div class='category-title' data-org='" + v + "'>" + v + "</div>\
                    </li>\
                ";
                $lists.append($(item));
            });

            // $('.category-edit').append($(item));

            $lists.append($item_add);
            $modal.append($title).append($lists).append($modal_footer);
            $backdrop.append($modal);
            $('body').append($backdrop);
            $backdrop.fadeIn(500);
            $('.category-edit').sortable({
                handle : ".category-move"
            });
        },
        close : function() {
            $('.cl-category-modal-backdrop').fadeOut(500, function() { $(this).remove(); });
        },
        check : function() {
            var category = $.category.list(),
                set_category = new Set(category);

                // IE ERROR (filter)
                // check = category.filter((s => v => s.has(v) || !s.add(v))(new Set)); 
            return (category.length !== set_category.size) ? true : false;
        },
        list : function() {
            var category_lists = $('.category-edit .category-title').map(function(){
                var org = $(this).attr('data-org'),
                    val = $(this).text().trim();
                if($(this).text().trim()) {
                    return $(this).text().trim();
                }
            }).get();
            return category_lists;            
        }
    }


    $.shoppingmall = {        
        orderStatusDetailsModal: function(sid, pnum, onum, ognum, kind) {
            if(typeof sid == "undefined" || typeof pnum == "undefined" || typeof onum == "undefined" || typeof kind == "undefined") {
                alert('정보가 올바르지 않습니다');
                return false;
            }

            $.post('/_check_order', { sid:sid, pnum:pnum, onum:onum, ognum:ognum,mode:'kind/'+kind }, function(data) {

                if(typeof data.error != "undefined" && data.error) {
                    $(this).showModalFlat('ERROR', data.error, true, false, '', 'close');
                    return false;
                }
                var c_data = data.r,
                    status = c_data.odata.d_status,
                    kind_str = c_data.odata.kind_str,
                    product_status_str = c_data.odata.product_status_str,
                    payClass = c_data.odata.class;

                    option_name = (typeof c_data.pdata.option != "undefined" && c_data.pdata.option) ? c_data.pdata.option : '',
                    option_str = (option_name) ? '<br><span class="osd-gray">옵션: '+option_name+'</span>' : '',
                    now_status_html = '',
                    delivery_info = c_data.pay_info.delivery;

                if(status.length > 1) {
                    var now_title = c_data.odata.product_status_str.replace(/ /g,'').replace('거부재발송','거부'),
                        now_msg = (status.indexOf('W') > -1) ? c_data.odata.h_msg : c_data.odata.adm_msg,
                        now_msg_html = (jQuery.inArray(status, ['CY','EY','RY']) > -1) ? '' : '\
                                <tr>\
                                    <td class="label">' + now_title + '사유</td>\
                                    <td>' + now_msg + '</td>\
                                </tr>\
                        ',
                        now_msg_date = (jQuery.inArray(status, ['EW','RW']) > -1) ? c_data.odata.h_date : c_data.odata.adm_date;

                    now_status_html = '\
                        <h6 class="osd-title">' + now_title + '정보</h6>\
                        <table class="osd-table">\
                            <tbody>\
                                <tr>\
                                    <td class="label">' + now_title + '일자</td>\
                                    <td>' + now_msg_date + '</td>\
                                </tr>\
                    ';
                    if(status != 'CY' && status != 'RY') {
                        now_status_html+= '<tr>\
                                        <td class="label">배송지1</td>\
                                        <td>' + delivery_info.new_postcode + ' ' + delivery_info.new_addr + ' ' + delivery_info.new_addr2 + '</td>\
                                    </tr>\
                                    <tr>\
                                        <td class="label">배송회사</td>\
                                        <td>' + delivery_info.new_delivery_str + '</td>\
                                    </tr>\
                                    <tr>\
                                        <td class="label">송장번호</td>\
                                        <td>' + delivery_info.new_delivery_number + '</td>\
                                    </tr>\
                                    ' + now_msg_html + '\
                        ';
                    }
                    now_status_html+= '\
                            </tbody>\
                        </table>\
                    ';
                }


                var modal_str = '\
                    <div class="osd-body">\
                        \
                        <h6 class="osd-title">기본정보</h6>\
                        <table class="osd-table">\
                            <tbody>\
                                <tr>\
                                    <td class="label">주문번호</td>\
                                    <td>' + ognum + '</td>\
                                </tr>\
                                <tr>\
                                    <td class="label">상품명</td>\
                                    <td>' + c_data.pdata.name + option_str + '</td>\
                                </tr>\
                                <tr>\
                                    <td class="label">주문수량</td>\
                                    <td>' + c_data.odata.quantity + '개</td>\
                                </tr>\
                                <tr>\
                                    <td class="label">진행상태</td>\
                                    <td>' + product_status_str + '</td>\
                                </tr>';
                                if (payClass == '무통장 입금' || payClass == '가상계좌') {
                                    modal_str += '<tr>\
                                        <td class="label">환불계좌</td>\
                                        <td>' + c_data.odata.return_bank + ' ' + c_data.odata.return_bank_number + '<br>' + c_data.odata.return_bank_name + '</td>\
                                    </tr>';
                                }
                            modal_str += '</tbody>\
                        </table>\
                        \
                        ' + now_status_html +'\
                        \
                        <h6 class="osd-title">' + kind_str + '요청정보</h6>\
                        <table class="osd-table">\
                            <tbody>\
                                <tr>\
                                    <td class="label">' + kind_str + '요청일자</td>\
                                    <td>' + c_data.odata.date + '</td>\
                                </tr>\
                                <tr>\
                                    <td class="label">' + kind_str + '요청사유</td>\
                                    <td>' + c_data.odata.reason + '</td>\
                                </tr>\
                                <tr>\
                                    <td class="label">상세사유</td>\
                                    <td>' + c_data.odata.requests + '</td>\
                                </tr>\
                            </tbody>\
                        </table>\
                        \
                    </div>\
                    \
                    ';

/*
                var c_data = data.r,
                    status = c_data.odata.d_status,
                    kind_str = c_data.odata.kind_str,
                    product_status_str = c_data.odata.product_status_str,
                    option_name = (typeof c_data.pdata.option != "undefined" && c_data.pdata.option) ? c_data.pdata.option : '',
                    option_str = (option_name) ? '<br><span>옵션: '+option_name+'</span>' : '',
                    status_str = '',
                    response_str = '',
                    request_str = '\
                        <table class="osd-table">\
                            <tbody>\
                                <tr>\
                                    <td class="label">' + kind_str + '요청사유</td>\
                                    <td>' + c_data.odata.reason + '</td>\
                                </tr>\
                                <tr>\
                                    <td class="label">상세사유</td>\
                                    <td>' + c_data.odata.requests + '</td>\
                                </tr>\
                            </tbody>\
                        </table>\
                    ';

                if(jQuery.inArray(status, ['CN','CY','EN','EW','RN','RW']) > -1) {
                    var status_str = (status.indexOf('W') > -1) ? c_data.odata.h_msg : c_data.odata.adm_msg,
                        status_msg = (jQuery.inArray(status, ['CY']) > -1) ? '' : '\
                                <tr>\
                                    <td class="label">' + c_data.odata.product_status_str.replace(/ /g,'') + '사유</td>\
                                    <td>' + status_str + '</td>\
                                </tr>\
                    ',
                        status_date = (jQuery.inArray(status, ['EW','RW']) > -1) ? c_data.odata.h_date : c_data.odata.adm_date;

                    status_str = '\
                        <h6 class="osd-title">' + c_data.odata.product_status_str.replace(/ /g,'') + '정보</h6>\
                        <table class="osd-table">\
                            <tbody>\
                                <tr>\
                                    <td class="label">' + c_data.odata.product_status_str.replace(/ /g,'') + '일자</td>\
                                    <td>' + status_date + '</td>\
                                </tr>\
                                ' + status_msg + '\
                            </tbody>\
                        </table>\
                    ';
                }

                if(jQuery.inArray(status, ['EN', 'EW', 'RN', 'RW']) > -1) {
                    response_str = '\
                                <tr>\
                                    <td class="label">' + kind_str + ' ' + c_data.odata.h_kind_str + '사유</td>\
                                    <td>' + c_data.odata.h_reason + '</td>\
                                </tr>\
                                <tr>\
                                    <td class="label">상세사유</td>\
                                    <td>' + c_data.odata.h_msg + '</td>\
                                </tr>\
                    ';
                }

                var modal_str = '\
                    <div class="osd-body">\
                        \
                        <h6 class="osd-title">기본정보</h6>\
                        <table class="osd-table">\
                            <tbody>\
                                <tr>\
                                    <td class="label">주문번호</td>\
                                    <td>' + onum + '</td>\
                                </tr>\
                                <tr>\
                                    <td class="label">상품명</td>\
                                    <td>' + c_data.pdata.name + option_str + '</td>\
                                </tr>\
                                <tr>\
                                    <td class="label">주문수량</td>\
                                    <td>' + c_data.odata.quantity + '개</td>\
                                </tr>\
                                <tr>\
                                    <td class="label">' + kind_str + '요청일자</td>\
                                    <td>' + c_data.odata.date + '</td>\
                                </tr>\
                                <tr>\
                                    <td class="label">진행상태</td>\
                                    <td>' + product_status_str + '</td>\
                                </tr>\
                                ' + response_str + '\
                            </tbody>\
                        </table>\
                        \
                        ' + status_str +'\
                        \
                        <h6 class="osd-title">' + kind_str + '요청정보</h6>\
                        ' + request_str +'\
                        \
                    </div>\
                    \
                    ';

                */
                var osdModal = $(this).showModalFlat(kind_str + ' 상세정보', modal_str, true, false, '', 'ok', '', 'cl-s-order-status-details cl-modal cl-s-btn cover', false);

            },'json');

        },
        orderCancelModal: function(sid, pnum, onum, ognum, status, dStatus, pclass) {
            if(typeof sid == "undefined" || typeof pnum == "undefined" || typeof onum == "undefined") {
                alert('정보가 올바르지 않습니다');
                return false;
            }

            $.post('/_check_order', { sid:sid, pnum:pnum, onum:onum, mode:'cancel', ognum: ognum }, function(data) {
                if(typeof data.error != "undefined" && data.error) {
                    $(this).showModalFlat('ERROR', data.error, true, false, '', 'close');
                    return false;
                }

                var c_data = data.r, checkboxNone = '', noneAll = '', noneChecked = '', checkNoneAll = '', checkEscrowFooter = '', checkEscrowClass = '';
                var checkEscrow = '';
                if (status == 'Y') {
                    checkboxNone = 'checked';
                    noneAll = ' noneAll';
                    checkNoneAll = 'fule';
                    checkEscrow = '<div class="escrow-warring top-escrow">\
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 13 13" width="15" height="15">\
                                        <path fill="#4789e7" d="M6.5 0C2.91 0 0 2.91 0 6.5S2.91 13 6.5 13 13 10.09 13 6.5 10.09 0 6.5 0zM6.5 12C3.47 12 1 9.53 1 6.5S3.47 1 6.5 1 12 3.47 12 6.5 9.53 12 6.5 12z"/>\
                                        <rect fill="#4789e7" x="6" y="3" width="1" height="5"/>\
                                        <rect fill="#4789e7" x="6" y="9" width="1" height="1"/>\
                                    </svg>\
                                    에스크로 결제 상품은 취소/반품 요청 시 전체선택만 가능합니다.\
                                </div>';

                    checkEscrowFooter = '<div class="escrow-warring bottom-escrow">\
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 13 13" width="15" height="15">\
                                                <path fill="#4789e7" d="M6.5 0C2.91 0 0 2.91 0 6.5S2.91 13 6.5 13 13 10.09 13 6.5 10.09 0 6.5 0zM6.5 12C3.47 12 1 9.53 1 6.5S3.47 1 6.5 1 12 3.47 12 6.5 9.53 12 6.5 12z"/>\
                                                <rect fill="#4789e7" x="6" y="3" width="1" height="5"/>\
                                                <rect fill="#4789e7" x="6" y="9" width="1" height="1"/>\
                                            </svg>\
                                            에스크로 환불 안내\
                                            <div class="escrow-return-info">- 취소처리 시 구매자의 환불정산액에서 취소 수수료(330원)가 차감됩니다.</div>\
                                            <div class="escrow-return-info">- 환불정산액은 취소처리 후 1~3영업일 후에 지급됩니다.</div>\
                                        </div>';
                    checkEscrowClass = 'cl-s-escrow-info';
                }
                
                var modal_str = '\
                    <form name="cancel_form" method="post" action="/_return">\
                        <input type="hidden" name="sid" value="' + sid + '">\
                        <input type="hidden" name="order_group" id="cancel-order-group" value="' + ognum + '">\
                        <input type="hidden" name="order_number" id="cancel-order-number" value="' + onum + '">\
                        '+checkEscrow+'\
                        <div class="cancel-product-title">\
                            <div class="newcheckbox hand">\
                                <label>\
                                    <input type="checkbox" class="'+noneAll+'" id="product-check" '+checkboxNone+'>\
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16">\
                                        <path d="M13 0H3C1.3 0 0 1.3 0 3v10c0 1.7 1.3 3 3 3h10c1.7 0 3-1.3 3-3V3C16 1.3 14.7 0 13 0zM15 13c0 1.1-0.9 2-2 2H3c-1.1 0-2-0.9-2-2V3c0-1.1 0.9-2 2-2h10c1.1 0 2 0.9 2 2V13z"/>\
                                    </svg>\
                                    <svg class="active" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16">\
                                        <path d="M13 0H3C1.34 0 0 1.34 0 3v10c0 1.66 1.34 3 3 3h10c1.66 0 3-1.34 3-3V3C16 1.34 14.66 0 13 0zM13.03 6.03l-5.5 5.5C7.38 11.68 7.19 11.75 7 11.75s-0.38-0.07-0.53-0.22l-3.5-3.5c-0.29-0.29-0.29-0.77 0-1.06s0.77-0.29 1.06 0L7 9.94l4.97-4.97c0.29-0.29 0.77-0.29 1.06 0S13.32 5.74 13.03 6.03z"/>\
                                    </svg>\
                                </label>\
                            </div>\
                            취소요청 상품\
                        </div>';
                        for (var i=0;i<data.r.odata.length;i++) {
                            if (c_data.odata[i].d_status == '') {
                                noneChecked = '';
                                if (!checkNoneAll) noneAll = '';
                            } else {
                                if (!checkNoneAll) noneAll = 'noneAll';
                                noneChecked = 'noneChecked';
                            }
                            modal_str += '\
                            <div class="cl-s-product-jumbotron clearfix">\
                                <div class="newcheckbox hand">\
                                    <label>\
                                        <input type="checkbox" class="status-checkbox cancel-info-data '+noneAll+' '+noneChecked+'" data-type="'+c_data.pdata[i].state+'" name="order_number_ary[]" value="'+c_data.odata[i].order_number+'" '+checkboxNone+'>\
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16">\
                                        <path d="M13 0H3C1.3 0 0 1.3 0 3v10c0 1.7 1.3 3 3 3h10c1.7 0 3-1.3 3-3V3C16 1.3 14.7 0 13 0zM15 13c0 1.1-0.9 2-2 2H3c-1.1 0-2-0.9-2-2V3c0-1.1 0.9-2 2-2h10c1.1 0 2 0.9 2 2V13z"/>\
                                        </svg>\
                                        <svg class="active" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16">\
                                        <path d="M13 0H3C1.34 0 0 1.34 0 3v10c0 1.66 1.34 3 3 3h10c1.66 0 3-1.34 3-3V3C16 1.34 14.66 0 13 0zM13.03 6.03l-5.5 5.5C7.38 11.68 7.19 11.75 7 11.75s-0.38-0.07-0.53-0.22l-3.5-3.5c-0.29-0.29-0.29-0.77 0-1.06s0.77-0.29 1.06 0L7 9.94l4.97-4.97c0.29-0.29 0.77-0.29 1.06 0S13.32 5.74 13.03 6.03z"/>\
                                        </svg>\
                                    </label>\
                                </div>\
                                <div class="cl-s-product-thumb">\
                                    <img src="' + c_data.pdata[i].img + '" alt="' + c_data.pdata[i].name + '" class="' + c_data.pdata[i].img_align + '" />\
                                </div>\
                                <div class="cl-s-product-info">\
                                    <h5 class="cl-s-product-title">' + c_data.pdata[i].name + '</h5>\
                            ';

                            var price = (Number(c_data.odata[i].sale_price) > 0) ? c_data.odata[i].sale_price : c_data.odata[i].price,
                                quantity = Number(c_data.odata[i].quantity),
                                optionPrice = c_data.odata[i].price * quantity,
                                sum_price = quantity * price;
                                option_name = (typeof c_data.pdata[i].option != "undefined" && c_data.pdata[i].option) ? c_data.pdata[i].option : '',
                                option_str = (option_name) ? '<span>옵션: '+option_name+'</span>' : '',
                                etc_str = (typeof c_data.pdata[i].etc_date != "undefined" && c_data.pdata[i].etc_date) ? '<span>선택일자: '+c_data.pdata[i].etc_date+'</span>' : '';
                        
                            modal_str += '\
                                    <div class="option-str option-check" data-optionPrice="'+optionPrice+'" data-deliveryPirce="'+c_data.odata[i].delivery_price+'"><span>' + number_format(optionPrice) + '원</span>' + option_str + etc_str + '<span>' + quantity + '개</span></div>\
                                </div>\
                            </div>';
                        }

                        modal_str += '<div class="order-cancel-content">\
                            <div class="cl-s-form-selector">\
                                <select class="selectpicker dropdown" id="cancel-reason" name="reason">\
                                    <option value="구매의사 취소">구매의사 취소</option>\
                                    <option value="다른 상품 잘못 주문">다른 상품 잘못 주문</option>\
                                    <option value="기타">기타</option>\
                                </select>\
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 4" width="8" height="4"><polygon points="0 0 4 4 8 0 "></polygon></svg>\
                            </div>\
                            <div class="cl-s-form-wrap">\
                                <div class="cl-s-form-group input-label-hide">\
                                    <textarea class="cl-s-form-control control-textarea" id="cancel-requests" name="requests" maxlength="500" required="required"></textarea>\
                                    <label for="input" class="cl-s-control-label">자세한 내용을 적어주세요. (500자 이내)</label>\
                                </div>\
                            </div>\
                        </div>';

                        modal_str += '<div class="order-cancel-content">\
                            <div class="cancel-info-box">\
                                <div class="cancel-info"><span class="cancel-info-title">취소상품 합계</span><span class="cancel-info-price" id="cancel-price">0원</span></div>\
                                <div class="cancel-info"><span class="cancel-info-title">취소 배송비 합계</span><span class="cancel-info-price" id="cancel-delivery-price">0원</span></div>\
                                <div class="cancel-info"><span class="cancel-info-title">적립금</span><span class="cancel-info-price" id="cancel-point-price">0원</span></div>\
                                <div class="cancel-info-line"></div>\
                                <div class="return-total-info"><span class="cancel-info-title">환불 예정금액</span><span class="cancel-info-price" id="return-total-price">0원</span></div>\
                            </div>'+checkEscrowFooter+'\
                        </div>';

                    var status = [];
                    for (var i=0;i<c_data.pdata.length;i++) {
                        status.push(c_data.pdata[i].status);
                    }
                    
                    if ((pclass == '무통장 입금' || pclass == '가상계좌') && !status.includes('W')) {
                        var returnClass = '';
                        if (c_data.return_bank.length > 1 && c_data.return_bank.includes('')===false) returnClass = 'returnDisabled';
                        modal_str += '\
                            <div class="modal-sub-title">환불 계좌</div>\
                            <ul class="qna-writer clearfix">\
                                <li class="">\
                                    <div class="cl-s-form-wrap '+returnClass+'">\
                                        <div class="cl-s-form-group">';
                                        if (c_data.return_bank.length > 1 && c_data.return_bank.includes('')===false) modal_str += '<input type="text" class="cl-s-form-control has-value" id="no-bank" name="no_bank" readonly required="required" value="'+c_data.return_bank[1]+'">';
                                        else modal_str += '<input type="text" class="cl-s-form-control" id="no-bank" name="no_bank" required="required" value="">';
                                        modal_str += '<label for="input" class="cl-s-control-label">은행명</label>\
                                        </div>\
                                    </div>\
                                </li>\
                                <li>\
                                    <div class="cl-s-form-wrap '+returnClass+'">\
                                        <div class="cl-s-form-group">';
                                        if (c_data.return_bank.length > 1 && c_data.return_bank.includes('')===false) modal_str += '<input type="text" class="cl-s-form-control has-value" id="no-bank-name" readonly name="no_bank_name" required="required" value="'+c_data.return_bank[2]+'">';
                                        else modal_str += '<input type="text" class="cl-s-form-control" id="no-bank-name" name="no_bank_name" required="required">';
                                        modal_str += '<label for="input" class="cl-s-control-label">예금주</label>\
                                        </div>\
                                    </div>\
                                </li>\
                                <li>\
                                    <div class="cl-s-form-wrap '+returnClass+'">\
                                        <div class="cl-s-form-group">';
                                        if (c_data.return_bank.length > 1 && c_data.return_bank.includes('')===false) modal_str += '<input type="text" class="cl-s-form-control has-value" id="no-bank-number" name="no_bank_number" readonly data-type="email" required="required" value="'+c_data.return_bank[3]+'">';
                                        else modal_str += '<input type="text" class="cl-s-form-control" id="no-bank-number" name="no_bank_number" data-type="email" required="required" value="">';
                                        modal_str += '<label for="input" class="cl-s-control-label">계좌번호</label>\
                                        </div>\
                                    </div>\
                                </li>\
                            </ul>\
                            <div class="modal-comment">동일 주문 내 여러 상품을 환불 요청하시는 경우, 최초 입력한 환불계좌로 일괄 환불처리됩니다.</div>\
                        ';
                    }

                    modal_str += '</form>\
                ';

                var ocModal = $(this).showModalFlat('취소 요청', modal_str,true,true,function () {

                    var f = document.cancel_form;
                    if(ocModal.find('#cancel-reason').prop('value') == '') {
                        // $('#cancel-reason').selectpicker('toggle');
                        // return false;
                        $('#cancel-reason').closest('.cl-s-form-selector').addClass('empty');
                    }

                    ocModal.find('.cl-s-form-wrap').each(function() {
                        var check_input = $(this).find('.cl-s-form-control'),
                            val = check_input.val().trim();

                        if(val.length == 0) {
                            $(this).removeClass('error').addClass('empty');
                            $(this).find('.cl-s-control-label.error').remove();
                        } else {
                            if($(this).hasClass('error')) {
                                check_input.focus();
                            }
                        }
                    });
                    var checkCnt = 0;

                    $(".status-checkbox").each(function (i, index) {
                        if ($(this).is(":checked") === true) {
                            checkCnt++;
                        }
                    });

                    if (checkCnt < 1) {
                        alert('상품을 1개 이상 선택해 주세요');
                        return false;
                    }

                    if(ocModal.find('.cl-s-form-wrap.empty, .cl-s-form-wrap.error').length > 0) {
                        // ocModal.find('.cl-s-form-wrap.empty, .cl-s-form-wrap.error').eq(0).find('.cl-s-form-control').focus();
                        return false;
                    }
                    $.processON();

                    f.submit();
                    ocModal.modal('hide');

                },'close','등록하기','cl-s-order-cancel cl-modal cl-s-btn cover ' + checkEscrowClass, false, '', function() {
                    var totalCnt = 0, totalNomalCheck = 0, nomalCheck = 0;
                    var price = 0;
                    var deliveryPrice = 0;
                    $(".status-checkbox").each(function (i, index) {
                        if ($(this).is(":checked") === true) {
                            price += ($(this).closest('.cl-s-product-jumbotron').find('.option-check').attr('data-optionPrice') * 1);
                            totalCnt++;
                            if ($(this).attr('data-type') == 'normal') {
                                nomalCheck++;
                                deliveryPrice = ($(this).closest('.cl-s-product-jumbotron').find('.option-check').attr('data-deliveryPirce') * 1);
                            }
                        }

                        if ($(this).attr('data-type') == 'normal') {
                            totalNomalCheck++;
                        }
                    });

                    var product_price = price + deliveryPrice,
                        rePayment = parseInt(c_data.pay_info.request.payment.total) - parseInt(c_data.pay_info.request.cancel.total) - parseInt(c_data.pay_info.request.return.total);

                    rePayment = (rePayment > 0) ? rePayment : 0;
                    var use_point = (rePayment - product_price > 0) ? 0 : rePayment - product_price;
                    product_price = product_price + use_point;

                    $('#cancel-price').html(number_format(price)+'원');
                    $('#cancel-delivery-price').html(number_format(deliveryPrice)+'원');
                    $('#cancel-point-price').html('0원');
                    $('#return-total-price').html(number_format(product_price)+'원');

                    $('.cancel-info-data').on('change', function (e) {
                        var price = 0;
                        var oLength = $('.option-check').length;
                        var totalCnt = 0, totalNomalCheck = 0, nomalCheck = 0;
                        var deliveryPrice = 0;
                        if ($(this).hasClass('noneAll') === true) {
                            if ($(this).hasClass('noneChecked') === true) {
                                $(this).prop('checked', false);
                            } else {
                                $(this).prop('checked', true);
                                $(".status-checkbox").each(function () {
                                    if ($(this).prop('disabled') !== true) $(this).prop('checked', true);
                                });
                            }
                        }

                        $(".status-checkbox").each(function (i, index) {
                            if ($(this).is(":checked") === true) {
                                price += ($(this).closest('.cl-s-product-jumbotron').find('.option-check').attr('data-optionPrice') * 1);
                                totalCnt++;
                                if ($(this).attr('data-type') == 'normal') nomalCheck++;
                            }

                            if ($(this).attr('data-type') == 'normal') totalNomalCheck++;
                        });

                        if ($('.status-checkbox').length == totalCnt) {
                            deliveryPrice = ($('.status-checkbox').closest('.cl-s-product-jumbotron').find('.option-check').attr('data-deliveryPirce') * 1);
                        } else if (totalNomalCheck <= nomalCheck) {
                            deliveryPrice = ($('.status-checkbox').closest('.cl-s-product-jumbotron').find('.option-check').attr('data-deliveryPirce') * 1);
                        } else {
                            deliveryPrice = 0;
                        }

                        var product_price = price + deliveryPrice,
                            rePayment = parseInt(c_data.pay_info.request.payment.total) - parseInt(c_data.pay_info.request.cancel.total) - parseInt(c_data.pay_info.request.return.total);

                        rePayment = (rePayment > 0) ? rePayment : 0;
                        var use_point = (rePayment - product_price > 0) ? 0 : rePayment - product_price;
                        product_price = product_price + use_point;
                        $('#cancel-price').html(number_format(price)+'원');
                        $('#cancel-delivery-price').html(number_format(deliveryPrice)+'원');
                        $('#cancel-point-price').html(number_format(use_point)+'원');
                        $('#return-total-price').html(number_format(product_price)+'원');

                    });

                    $(document).on('click', '#product-check', function () {
                        var price = 0;
                        var deliveryPrice = 0;
                        var totalCnt = 0, totalNomalCheck = 0, nomalCheck = 0;
                        if ($(this).hasClass('noneAll') === true) {
                            $(this).prop('checked', true);
                            $(".status-checkbox").each(function () {
                                if ($(this).prop('disabled') !== true) $(this).prop('checked', true);
                            });
                        }
                        if ($(this).is(":checked") === true) {
                            $(".status-checkbox").each(function (i) {
                                if ($(this).prop('disabled') !== true) {
                                    $(this).prop('checked', true);

                                    price += ($(this).closest('.cl-s-product-jumbotron').find('.option-check').attr('data-optionPrice') * 1);
                                    totalCnt++;
                                    if ($(this).attr('data-type') == 'normal') {
                                        nomalCheck++;
                                        deliveryPrice = ($(this).closest('.cl-s-product-jumbotron').find('.option-check').attr('data-deliveryPirce') * 1);
                                    }
                                }

                                if ($(this).attr('data-type') == 'normal') {
                                    totalNomalCheck++;
                                }
                            });

                            var product_price = price + deliveryPrice,
                                rePayment = parseInt(c_data.pay_info.request.payment.total) - parseInt(c_data.pay_info.request.cancel.total) - parseInt(c_data.pay_info.request.return.total);

                            rePayment = (rePayment > 0) ? rePayment : 0;
                            var use_point = (rePayment - product_price > 0) ? 0 : rePayment - product_price;
                            product_price = product_price + use_point;

                            $('#cancel-price').html(number_format(price)+'원');
                            $('#cancel-delivery-price').html(number_format(deliveryPrice)+'원');
                            $('#cancel-point-price').html(number_format(use_point)+'원');
                            $('#return-total-price').html(number_format(product_price)+'원');

                        } else {
                            $(".status-checkbox").each(function () {
                                if ($(this).prop('disabled') !== true) $(this).prop('checked', false);
                            });

                            $('#cancel-price').html('0원');
                            $('#cancel-delivery-price').html('0원');
                            $('#cancel-point-price').html('0원');
                            $('#return-total-price').html('0원');
                        }
                    });

                    /* first option setting */
                    $('.cl-s-order-cancel .cl-s-form-selector').each(function(e) {
                        var checkSelectOption = ($(this).find('select option').length > 0) ? true : false;
                        if(checkSelectOption) {
                            var selectId = $(this).find('select').attr('id'),
                                val = $(this).find('select').children().eq(0).val();
                            $(this).find('select').selectpicker({'val':val, dropupAuto:false});
                        }
                    });

                    $('.cl-s-order-cancel .cl-s-form-group').on('click',function(e) {
                        if($(e.target).hasClass('cl-s-form-group')) {
                            $(e.target).find('.cl-s-form-control:not([type=hidden])').focus();
                        }
                    });

                    $('#cancel-reason').on({
                        'show.bs.select': function (e) {
                            $(this).closest('.cl-s-form-selector').addClass('active');
                        },
                        'hidden.bs.select': function(e) {
                            $(this).closest('.cl-s-form-selector').removeClass('active');

                            if($('#cancel-reason').prop('value') == '') {
                                $(this).closest('.cl-s-form-selector').addClass('empty');
                            } else {
                                $(this).closest('.cl-s-form-selector').removeClass('empty');
                            }
                        },
                        'changed.bs.select': function (e, clickedIndex, newValue, oldValue) {
                            // console.log(this.value, clickedIndex, newValue, oldValue);
                        }
                    });

                    $('.cl-s-order-cancel .control-textarea').on({
                        focus: function(e) {
                            $(this).closest('.cl-s-form-wrap').addClass('active');
                        },
                        blur: function(e) {
                            var val = $(this).val().trim();

                            $(this).closest('.cl-s-form-wrap').removeClass('active');
                            if(val.length == 0) {
                                $(this).closest('.cl-s-form-wrap').removeClass('error').addClass('empty');
                                $(this).closest('.cl-s-form-wrap').find('.cl-s-control-label.error').remove();
                                return false;
                            } else {
                                $(this).closest('.cl-s-form-wrap').removeClass('empty');
                                if(val.length < 5) {
                                    $(this).closest('.cl-s-form-wrap').addClass('error');
                                    if($(this).parent().find('.cl-s-control-label.error').length > 0) {
                                        $(this).parent().find('.cl-s-control-label.error').html($.lang[LANG]['customsite.validate.message.minlengthto5']);
                                    } else {
                                        $(this).after('<label for="input" class="cl-s-control-label error">'+$.lang[LANG]['customsite.validate.message.minlengthto5']+'</label>');
                                    }
                                    return false;
                                }
                            }

                            $(this).closest('.cl-s-form-wrap').removeClass('error').removeClass('empty');
                            $(this).closest('.cl-s-form-wrap').find('.cl-s-control-label.error').remove();
                        }
                    });

                    $('.cl-s-form-wrap .cl-s-form-control').on({
                        focus: function(e) {
                            $(this).closest('.cl-s-form-wrap').addClass('active');
                        },
                        blur: function(e) {
                            var val = $(this).val().trim();

                            $(this).closest('.cl-s-form-wrap').removeClass('active');
                            if(val.length == 0) {
                                $(this).closest('.cl-s-form-wrap').removeClass('error').addClass('empty');
                                $(this).closest('.cl-s-form-wrap').find('.cl-s-control-label.error').remove();
                                return false;
                            } else {
                                $(this).closest('.cl-s-form-wrap').removeClass('empty');
                            }

                            $(this).closest('.cl-s-form-wrap').removeClass('error').removeClass('empty');
                            $(this).closest('.cl-s-form-wrap').find('.cl-s-control-label.error').remove();
                        }
                    });

                });

            },'json');
        },
        orderReturnExchangeModal: function(sid, pnum, onum, ognum, status, pclass) {
            if(typeof sid == "undefined" || typeof pnum == "undefined" || typeof onum == "undefined") {
                alert('정보가 올바르지 않습니다');
                return false;
            }

            $.post('/_check_order', { sid:sid, pnum:pnum, onum:onum, mode:'return', ognum: ognum }, function(data) {

                if(typeof data.error != "undefined" && data.error) {
                    $(this).showModalFlat('ERROR', data.error, true, false, '', 'close');
                    return false;
                }
                var c_data = data.r;

                var c_data = data.r, checkboxNone = '', noneAll = '', noneChecked = '', checkNoneAll = '', checkEscrowFooter = '', checkEscrowClass = '';
                var checkEscrow = '', exchangeCheck = 'N';
                if (status == 'Y') {
                    checkboxNone = 'checked';
                    noneAll = ' noneAll';
                    checkNoneAll = 'fule';
                    checkEscrow = '<div class="escrow-warring top-escrow">\
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 13 13" width="15" height="15">\
                                        <path fill="#4789e7" d="M6.5 0C2.91 0 0 2.91 0 6.5S2.91 13 6.5 13 13 10.09 13 6.5 10.09 0 6.5 0zM6.5 12C3.47 12 1 9.53 1 6.5S3.47 1 6.5 1 12 3.47 12 6.5 9.53 12 6.5 12z"/>\
                                        <rect fill="#4789e7" x="6" y="3" width="1" height="5"/>\
                                        <rect fill="#4789e7" x="6" y="9" width="1" height="1"/>\
                                    </svg>\
                                    에스크로 결제 상품은 취소/반품 요청 시 전체선택만 가능합니다.\
                                </div>';

                    checkEscrowFooter = '<div class="escrow-warring bottom-escrow">\
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 13 13" width="15" height="15">\
                                                <path fill="#4789e7" d="M6.5 0C2.91 0 0 2.91 0 6.5S2.91 13 6.5 13 13 10.09 13 6.5 10.09 0 6.5 0zM6.5 12C3.47 12 1 9.53 1 6.5S3.47 1 6.5 1 12 3.47 12 6.5 9.53 12 6.5 12z"/>\
                                                <rect fill="#4789e7" x="6" y="3" width="1" height="5"/>\
                                                <rect fill="#4789e7" x="6" y="9" width="1" height="1"/>\
                                            </svg>\
                                            에스크로 환불 안내\
                                            <div class="escrow-return-info">- 취소처리 시 구매자의 환불정산액에서 취소 수수료(330원)가 차감됩니다.</div>\
                                            <div class="escrow-return-info">- 환불정산액은 취소처리 후 1~3영업일 후에 지급됩니다.</div>\
                                        </div>';
                    checkEscrowClass = 'cl-s-escrow-info';
                }
                
                var modal_str = '\
                    <form name="re_form" method="post" action="/_return_exchange">\
                        <input type="hidden" name="sid" value="' + sid + '">\
                        <input type="hidden" name="order_group" id="cancel-order-group" value="' + ognum + '">\
                        <input type="hidden" name="order_number" id="cancel-order-number" value="' + onum + '">\
                        <input type="hidden" name="m_status" value="M">\
                        <div class="cl-s-btn-group-toggle btn-group btn-group-toggle" data-toggle="buttons">\
                            <label class="btn btn-secondary active">\
                                <input type="radio" name="status" id="order-radio-return" value="R" checked> 반품 요청\
                            </label>\
                            <label class="btn btn-secondary">\
                                <input type="radio" name="status" id="order-radio-exchange" value="E"> 교환 요청\
                            </label>\
                        </div>\
                        '+checkEscrow+'\
                        <div class="cancel-product-title">\
                            <div class="newcheckbox hand">\
                                <label>\
                                    <input type="checkbox" class="'+noneAll+'" id="product-check" '+checkboxNone+'>\
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16">\
                                        <path d="M13 0H3C1.3 0 0 1.3 0 3v10c0 1.7 1.3 3 3 3h10c1.7 0 3-1.3 3-3V3C16 1.3 14.7 0 13 0zM15 13c0 1.1-0.9 2-2 2H3c-1.1 0-2-0.9-2-2V3c0-1.1 0.9-2 2-2h10c1.1 0 2 0.9 2 2V13z"/>\
                                    </svg>\
                                    <svg class="active" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16">\
                                        <path d="M13 0H3C1.34 0 0 1.34 0 3v10c0 1.66 1.34 3 3 3h10c1.66 0 3-1.34 3-3V3C16 1.34 14.66 0 13 0zM13.03 6.03l-5.5 5.5C7.38 11.68 7.19 11.75 7 11.75s-0.38-0.07-0.53-0.22l-3.5-3.5c-0.29-0.29-0.29-0.77 0-1.06s0.77-0.29 1.06 0L7 9.94l4.97-4.97c0.29-0.29 0.77-0.29 1.06 0S13.32 5.74 13.03 6.03z"/>\
                                    </svg>\
                                </label>\
                            </div>\
                            반품/교환요청 상품\
                        </div>';
                        for (var i=0;i<data.r.odata.length;i++) {
                            if (c_data.odata[i].exchange_check == 'Y') exchangeCheck = 'Y';
                            if (c_data.odata[i].d_status == '') {
                                noneChecked = '';
                                if (!checkNoneAll) noneAll = '';
                            } else {
                                if (!checkNoneAll) noneAll = 'noneAll';
                                noneChecked = 'noneChecked';
                            }
                            modal_str += '\
                            <div class="cl-s-product-jumbotron clearfix">\
                                <div class="newcheckbox hand">\
                                    <label>\
                                        <input type="checkbox" class="status-checkbox cancel-info-data '+noneAll+' '+noneChecked+'" data-type="'+c_data.pdata[i].state+'" name="order_number_ary[]" value="'+c_data.odata[i].order_number+'" '+checkboxNone+'>\
                                        <svg viewBox="0 0 16 16" width="16" height="16">\
                                            <path d="M13 0H3C1.3 0 0 1.3 0 3v10c0 1.7 1.3 3 3 3h10c1.7 0 3-1.3 3-3V3C16 1.3 14.7 0 13 0zM15 13c0 1.1-0.9 2-2 2H3c-1.1 0-2-0.9-2-2V3c0-1.1 0.9-2 2-2h10c1.1 0 2 0.9 2 2V13z"/>\
                                        </svg>\
                                        <svg class="active" viewBox="0 0 16 16" width="16" height="16">\
                                            <path d="M13 0H3C1.34 0 0 1.34 0 3v10c0 1.66 1.34 3 3 3h10c1.66 0 3-1.34 3-3V3C16 1.34 14.66 0 13 0zM13.03 6.03l-5.5 5.5C7.38 11.68 7.19 11.75 7 11.75s-0.38-0.07-0.53-0.22l-3.5-3.5c-0.29-0.29-0.29-0.77 0-1.06s0.77-0.29 1.06 0L7 9.94l4.97-4.97c0.29-0.29 0.77-0.29 1.06 0S13.32 5.74 13.03 6.03z"/>\
                                        </svg>\
                                    </label>\
                                </div>\
                                <div class="cl-s-product-thumb">\
                                    <img src="' + c_data.pdata[i].img + '" alt="' + c_data.pdata[i].name + '" class="' + c_data.pdata[i].img_align + '" />\
                                </div>\
                                <div class="cl-s-product-info">\
                                    <h5 class="cl-s-product-title">' + c_data.pdata[i].name + '</h5>\
                            ';

                            var price = c_data.odata[i].price,
                                quantity = Number(c_data.odata[i].quantity),
                                sum_price = quantity * price;
                                option_name = (typeof c_data.pdata[i].option != "undefined" && c_data.pdata[i].option) ? c_data.pdata[i].option : '',
                                option_str = (option_name) ? '<span>옵션: '+option_name+'</span>' : '',
                                etc_str = (typeof c_data.pdata[i].etc_date != "undefined" && c_data.pdata[i].etc_date) ? '<span>선택일자: '+c_data.pdata[i].etc_date+'</span>' : '';
                        
                            modal_str += '\
                                    <div class="option-str option-check" data-optionState="" data-optionPrice="'+sum_price+'" data-deliveryPirce="'+c_data.odata[i].delivery_price+'"><span>' + number_format(sum_price) + '원</span>' + option_str + etc_str + '<span>' + quantity + '개</span></div>\
                                </div>\
                            </div>';
                        }

                        modal_str += '<div class="order-re-content">\
                            <div class="cl-s-form-selector">\
                                <select class="selectpicker dropdown" id="re-reason" name="reason">\
                                    <option value="구매의사 취소">구매의사 취소</option>\
                                    <option value="다른 상품 잘못 주문">다른 상품 잘못 주문</option>\
                                    <option value="상품파손">상품파손</option>\
                                    <option value="배송지연">배송지연</option>\
                                    <option value="상품정보 상이">상품정보 상이</option>\
                                    <option value="오배송">오배송</option>\
                                    <option value="기타">기타</option>\
                                </select>\
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 4" width="8" height="4"><polygon points="0 0 4 4 8 0 "></polygon></svg>\
                            </div>\
                            <div class="cl-s-form-wrap">\
                                <div class="cl-s-form-group input-label-hide">\
                                    <textarea class="cl-s-form-control cl-s-form-textarea" id="re-requests" name="requests" maxlength="500" required="required"></textarea>\
                                    <label for="input" class="cl-s-control-label">자세한 내용을 적어주세요. (500자 이내)</label>\
                                </div>\
                            </div>\
                        </div>';
                        /*  반품/교환 사진 제거
                            <div class="cl-s-files re-files">\
                                <input id="re-file" type="file" name="files[]" multiple data-sid="' + sid + '" data-uid=\"' + c_data.writer.id + '\">\
                                <label class="cl-s-file-update re-file-update clearfix"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20"><path d="M0 0v20h20V0H0zM19 1v11.3l-3-3 -4 4 -6-6 -5 5V1H19zM1 19v-5.3l5-5 6 6 4-4 3 3V19H1z"/><circle cx="14.5" cy="5.5" r="1.5"/></svg> <span>사진</span></label>\
                                <ul class="cl-s-files-list re-files-list clearfix">\
                                </ul>\
                            </div>\
                        */

                        modal_str += '<div class="order-cancel-content">\
                            <div class="cancel-info-box">\
                                <div class="cancel-info"><span class="cancel-info-title">반품상품 합계</span><span class="cancel-info-price" id="cancel-price">0원</span></div>\
                                <div class="cancel-info"><span class="cancel-info-title">반품 배송비 합계</span><span class="cancel-info-price" id="cancel-delivery-price">0원</span></div>\
                                <div class="cancel-info"><span class="cancel-info-title">적립금</span><span class="cancel-info-price" id="cancel-point-price">0원</span></div>\
                                <div class="cancel-info-line"></div>\
                                <div class="return-total-info"><span class="cancel-info-title">환불 예정금액</span><span class="cancel-info-price" id="return-total-price">0원</span></div>\
                            </div>'+checkEscrowFooter+'\
                        </div>';

                    if (pclass == '무통장 입금' || pclass == '가상계좌') {
                        var returnClass = '';
                        if (c_data.return_bank.length > 1 && c_data.return_bank.includes('')===false) returnClass = 'returnDisabled';
                        modal_str += '\
                            <div id="return-modal">\
                                <div class="modal-sub-title">환불 계좌</div>\
                                <ul class="qna-writer clearfix">\
                                    <li class="">\
                                        <div class="cl-s-form-wrap '+returnClass+'">\
                                            <div class="cl-s-form-group">';
                                            if (c_data.return_bank.length > 1 && c_data.return_bank.includes('')===false) modal_str += '<input type="text" class="cl-s-form-control has-value" id="no-bank" name="no_bank" readonly required="required" value="'+c_data.return_bank[1]+'">';
                                            else modal_str += '<input type="text" class="cl-s-form-control" id="no-bank" name="no_bank" required="required" value="">';
                                            modal_str += '<label for="input" class="cl-s-control-label">은행명</label>\
                                            </div>\
                                        </div>\
                                    </li>\
                                    <li>\
                                        <div class="cl-s-form-wrap '+returnClass+'">\
                                            <div class="cl-s-form-group">';
                                            if (c_data.return_bank.length > 1 && c_data.return_bank.includes('')===false) modal_str += '<input type="text" class="cl-s-form-control has-value" id="no-bank-name" readonly name="no_bank_name" required="required" value="'+c_data.return_bank[2]+'">';
                                            else modal_str += '<input type="text" class="cl-s-form-control" id="no-bank-name" name="no_bank_name" required="required">';
                                            modal_str += '<label for="input" class="cl-s-control-label">예금주</label>\
                                            </div>\
                                        </div>\
                                    </li>\
                                    <li>\
                                        <div class="cl-s-form-wrap '+returnClass+'">\
                                            <div class="cl-s-form-group">';
                                            if (c_data.return_bank.length > 1 && c_data.return_bank.includes('')===false) modal_str += '<input type="text" class="cl-s-form-control has-value" id="no-bank-number" name="no_bank_number" readonly data-type="email" required="required" value="'+c_data.return_bank[3]+'">';
                                            else modal_str += '<input type="text" class="cl-s-form-control" id="no-bank-number" name="no_bank_number" data-type="email" required="required" value="">';
                                            modal_str += '<label for="input" class="cl-s-control-label">계좌번호</label>\
                                            </div>\
                                        </div>\
                                    </li>\
                                </ul>\
                                <div class="modal-comment">동일 주문 내 여러 상품을 환불 요청하시는 경우, 최초 입력한 환불계좌로 일괄 환불처리됩니다.</div>\
                            </div>\
                        ';
                    }
                    modal_str += '</form>\
                ';

                var oreModal = $(this).showModalFlat('반품/교환 요청', modal_str,true,true,function () {

                    var f = document.re_form;

                    if(oreModal.find('#re-reason').prop('value') == '') {
                        // $('#re-reason').selectpicker('toggle');
                        // return false;
                        $('#re-reason').closest('.cl-s-form-selector').addClass('empty');
                    }

                    oreModal.find('.cl-s-form-wrap').each(function() {
                        var check_input = $(this).find('.cl-s-form-control'),
                            val = check_input.val().trim();

                        if(val.length == 0) {
                            $(this).removeClass('error').addClass('empty');
                            $(this).find('.cl-s-control-label.error').remove();
                        } else {
                            if($(this).hasClass('error')) {
                                check_input.focus();
                            }
                        }
                    });
                    var checkCnt = 0;

                    $(".status-checkbox").each(function (i, index) {
                        if ($(this).is(":checked") === true) {
                            checkCnt++;
                        }
                    });

                    if (checkCnt < 1) {
                        alert('상품을 1개 이상 선택해 주세요');
                        return false;
                    }

                    if(oreModal.find('.cl-s-form-wrap.empty, .cl-s-form-wrap.error').length > 0) {
                        // oreModal.find('.cl-s-form-wrap.empty, .cl-s-form-wrap.error').eq(0).find('.cl-s-form-control').focus();
                        return false;
                    }
                    $.processON();

                    f.submit();

                },'close','등록하기','cl-s-order-returnexchange cl-s-order-cancel cl-modal cl-s-btn cover ' + checkEscrowClass, false, '', function() {
                    var totalCnt = 0, totalNomalCheck = 0, nomalCheck = 0;
                    var price = 0;
                    var deliveryPrice = 0;
                    $(".status-checkbox").each(function (i, index) {
                        if ($(this).is(":checked") === true) {
                            price += ($(this).closest('.cl-s-product-jumbotron').find('.option-check').attr('data-optionPrice') * 1);
                            totalCnt++;
                            if ($(this).attr('data-type') == 'normal') {
                                nomalCheck++;
                            }
                        }

                        if ($(this).attr('data-type') == 'normal') {
                            totalNomalCheck++;
                        }
                    });
                    if ($('.status-checkbox').length == totalCnt) {
                        deliveryPrice += ($('.status-checkbox').closest('.cl-s-product-jumbotron').find('.option-check').attr('data-deliveryPirce') * 1);
                    } else if (totalNomalCheck <= nomalCheck) {
                        deliveryPrice += ($('.status-checkbox').closest('.cl-s-product-jumbotron').find('.option-check').attr('data-deliveryPirce') * 1);
                    } else {
                        deliveryPrice = 0;
                    }

                    var product_price = price + deliveryPrice,
                        rePayment = parseInt(c_data.pay_info.request.payment.total) - parseInt(c_data.pay_info.request.cancel.total) - parseInt(c_data.pay_info.request.return.total);

                    rePayment = (rePayment > 0) ? rePayment : 0;
                    var use_point = (rePayment - product_price > 0) ? 0 : rePayment - product_price;
                    product_price = product_price + use_point;

                    $('#cancel-price').html(number_format(price)+'원');
                    $('#cancel-delivery-price').html(number_format(deliveryPrice)+'원');
                    $('#cancel-point-price').html('0원');
                    $('#return-total-price').html('0원');

                    $('.cancel-info-data').on('change', function () {
                        var price = 0;
                        var oLength = $('.option-check').length;
                        var totalCnt = 0, totalNomalCheck = 0, nomalCheck = 0;
                        var deliveryPrice = 0;
                        if ($(this).hasClass('noneAll') === true) {
                            if ($(this).hasClass('noneChecked') === true) {
                                $(this).prop('checked', false);
                            } else {
                                $(this).prop('checked', true);
                                $(".status-checkbox").each(function () {
                                    if ($(this).prop('disabled') !== true) $(this).prop('checked', true);
                                });
                            }
                        }

                        $(".status-checkbox").each(function (i, index) {
                            if ($(this).is(":checked") === true) {
                                price += ($(this).closest('.cl-s-product-jumbotron').find('.option-check').attr('data-optionPrice') * 1);
                                totalCnt++;
                                if ($(this).attr('data-type') == 'normal') {
                                    nomalCheck++;
                                }
                            }

                            if ($(this).attr('data-type') == 'normal') {
                                totalNomalCheck++;
                            }
                        });

                        if ($('.status-checkbox').length == totalCnt) {
                            deliveryPrice += ($('.status-checkbox').closest('.cl-s-product-jumbotron').find('.option-check').attr('data-deliveryPirce') * 1);
                        } else if (totalNomalCheck <= nomalCheck) {
                            deliveryPrice += ($('.status-checkbox').closest('.cl-s-product-jumbotron').find('.option-check').attr('data-deliveryPirce') * 1);
                        } else {
                            deliveryPrice = 0;
                        }

                        var product_price = price + deliveryPrice,
                            rePayment = parseInt(c_data.pay_info.request.payment.total) - parseInt(c_data.pay_info.request.cancel.total) - parseInt(c_data.pay_info.request.return.total);

                        rePayment = (rePayment > 0) ? rePayment : 0;
                        var use_point = (rePayment - product_price > 0) ? 0 : rePayment - product_price;
                        product_price = product_price + use_point;

                        $('#cancel-price').html(number_format(price)+'원');
                        $('#cancel-delivery-price').html(number_format(deliveryPrice)+'원');
                        $('#cancel-point-price').html(number_format(use_point)+'원');
                        $('#return-total-price').html(number_format((product_price>0) ? product_price : '0') +'원');
                    });

                    $(document).on('click', '#product-check', function () {
                        var price = 0;
                        var deliveryPrice = 0;
                        var totalCnt = 0;
                        if ($(this).hasClass('noneAll') === true) {
                            $(this).prop('checked', true);
                            $(".status-checkbox").each(function () {
                                if ($(this).prop('disabled') !== true) $(this).prop('checked', true);
                            });
                        }
                        if ($(this).is(":checked") === true) {
                            $(".status-checkbox").each(function (i) {
                                if ($(this).prop('disabled') !== true) {
                                    $(this).prop('checked', true);

                                    price += ($(this).closest('.cl-s-product-jumbotron').find('.option-check').attr('data-optionPrice') * 1);
                                    totalCnt++;
                                    if ($(this).attr('data-type') == 'normal') {
                                        nomalCheck++;
                                    }
                                }

                                if ($(this).attr('data-type') == 'normal') {
                                    totalNomalCheck++;
                                }
                            });

                            if ($('.status-checkbox').length == totalCnt) {
                                deliveryPrice += ($('.status-checkbox').closest('.cl-s-product-jumbotron').find('.option-check').attr('data-deliveryPirce') * 1);
                            } else if (totalNomalCheck <= nomalCheck) {
                                deliveryPrice += ($('.status-checkbox').closest('.cl-s-product-jumbotron').find('.option-check').attr('data-deliveryPirce') * 1);
                            } else {
                                deliveryPrice = 0;
                            }

                            var product_price = price + deliveryPrice,
                                rePayment = parseInt(c_data.pay_info.request.payment.total) - parseInt(c_data.pay_info.request.cancel.total) - parseInt(c_data.pay_info.request.return.total);

                            rePayment = (rePayment > 0) ? rePayment : 0;
                            var use_point = (rePayment - product_price > 0) ? 0 : rePayment - product_price;
                            product_price = product_price + use_point;

                            $('#cancel-price').html(number_format(price)+'원');
                            $('#cancel-delivery-price').html(number_format(deliveryPrice)+'원');
                            $('#cancel-point-price').html(number_format(use_point)+'원');
                            $('#return-total-price').html(number_format((product_price>0) ? product_price : '0') +'원');
                        } else {
                            $(".status-checkbox").each(function () {
                                if ($(this).prop('disabled') !== true) $(this).prop('checked', false);
                            });

                            $('#cancel-price').html('0원');
                            $('#cancel-delivery-price').html('0원');
                            $('#cancel-point-price').html('0원');
                            $('#return-total-price').html('0원');
                        }
                    });

                    /* first option setting */
                    $('.cl-s-order-returnexchange .cl-s-form-selector').each(function(e) {
                        var checkSelectOption = ($(this).find('select option').length > 0) ? true : false;
                        if(checkSelectOption) {
                            var selectId = $(this).find('select').attr('id'),
                                val = $(this).find('select').children().eq(0).val();
                            $(this).find('select').selectpicker({'val':val, dropupAuto:false});
                        }
                    });

                    $('.cl-s-order-returnexchange .cl-s-btn-group-toggle input:radio').on({
                        change: function() {
                            var order_status = $(this).val(),
                                re_reason_obj = {
                                'R' : '\
                                    <option value="구매의사 취소">구매의사 취소</option>\
                                    <option value="다른 상품 잘못 주문">다른 상품 잘못 주문</option>\
                                    <option value="상품파손">상품파손</option>\
                                    <option value="배송지연">배송지연</option>\
                                    <option value="상품정보 상이">상품정보 상이</option>\
                                    <option value="오배송">오배송</option>\
                                    <option value="기타">기타</option>\
                                ',
                                'E' : '\
                                    <option value="컬러 및 사이즈 변경">컬러 및 사이즈 변경</option>\
                                    <option value="다른 상품 잘못 주문">다른 상품 잘못 주문</option>\
                                    <option value="상품파손">상품파손</option>\
                                    <option value="상품정보 상이">상품정보 상이</option>\
                                    <option value="오배송">오배송</option>\
                                    <option value="기타">기타</option>\
                                '
                            };
                            if (order_status == 'R') {
                                if (status == 'Y' && exchangeCheck == 'Y') {
                                    alert('에스크로 결제 상품은 교환 요청/완료가 있는 경우 반품 요청이 불가능합니다.\n기타 요청이 있는 경우 관리자에게 문의해 주세요.');
                                    setTimeout(function () {
                                        $('#order-radio-exchange').click();
                                    }, 500);
                                    return false;
                                }
                                $('#return-modal').css('display', 'block');
                                $('.order-cancel-content').css('display', 'block');
                                $('#no-bank').parent().parent().addClass('cl-s-form-wrap');
                                $('#no-bank-name').parent().parent().addClass('cl-s-form-wrap');
                                $('#no-bank-number').parent().parent().addClass('cl-s-form-wrap');
                                if (status == 'Y') {
                                    $('.status-checkbox').each(function () {
                                        $(this).prop('checked', true);
                                        $(this).addClass('noneAll');
                                    });
                                    $('#product-check').addClass('noneAll');
                                    $('#product-check').prop('checked', true);
                                    $('.escrow-warring').css({'display': 'block'});
                                    
                                    var totalCnt = 0, totalNomalCheck = 0, nomalCheck = 0;
                                    var price = 0;
                                    var deliveryPrice = 0;
                                    $(".status-checkbox").each(function (i, index) {
                                        if ($(this).is(":checked") === true) {
                                            price += ($(this).closest('.cl-s-product-jumbotron').find('.option-check').attr('data-optionPrice') * 1);
                                            totalCnt++;
                                            if ($(this).attr('data-type') == 'normal') {
                                                nomalCheck++;
                                                deliveryPrice = ($(this).closest('.cl-s-product-jumbotron').find('.option-check').attr('data-deliveryPirce') * 1);
                                            }
                                        }

                                        if ($(this).attr('data-type') == 'normal') {
                                            totalNomalCheck++;
                                        }
                                    });

                                    var product_price = price + deliveryPrice,
                                        rePayment = parseInt(c_data.pay_info.request.payment.total) - parseInt(c_data.pay_info.request.cancel.total) - parseInt(c_data.pay_info.request.return.total);

                                    rePayment = (rePayment > 0) ? rePayment : 0;
                                    var use_point = (rePayment - product_price > 0) ? 0 : rePayment - product_price;
                                    product_price = product_price + use_point;

                                    $('#cancel-price').html(number_format(price)+'원');
                                    $('#cancel-delivery-price').html(number_format(deliveryPrice)+'원');
                                    $('#cancel-point-price').html(number_format(use_point)+'원');
                                    $('#return-total-price').html(number_format(product_price)+'원');
                                }
                            } else {
                                $('#return-modal').css('display', 'none');
                                $('.order-cancel-content').css('display', 'none');
                                $('#no-bank').parent().parent().removeClass('cl-s-form-wrap');
                                $('#no-bank-name').parent().parent().removeClass('cl-s-form-wrap');
                                $('#no-bank-number').parent().parent().removeClass('cl-s-form-wrap');
                                if (status == 'Y') {
                                    $('.status-checkbox').each(function () {
                                        $(this).prop('checked', false);
                                        $(this).removeClass('noneAll');
                                    });
                                    $('#product-check').removeClass('noneAll');
                                    $('#product-check').prop('checked', false);
                                    $('.escrow-warring').css({'display': 'none'});
                                }
                            }

                            $('#re-reason').closest('.cl-s-form-selector').removeClass('empty');
                            $('#re-reason').html(re_reason_obj[order_status]).selectpicker('refresh');
                        }
                    });
                    if (status == 'Y' && exchangeCheck == 'Y') {
                        $('#order-radio-exchange').click();
                    }

                    $('#re-reason').on({
                        'show.bs.select': function (e) {
                            $(this).closest('.cl-s-form-selector').addClass('active');
                        },
                        'hidden.bs.select': function(e) {
                            $(this).closest('.cl-s-form-selector').removeClass('active');

                            if($('#re-reason').prop('value') == '') {
                                $(this).closest('.cl-s-form-selector').addClass('empty');
                            } else {
                                $(this).closest('.cl-s-form-selector').removeClass('empty');
                            }
                        },
                        'changed.bs.select': function (e, clickedIndex, newValue, oldValue) {
                            // console.log(this.value, clickedIndex, newValue, oldValue);
                        }
                    });


                    $('.cl-s-order-returnexchange .cl-s-form-group').on('click',function(e) {
                        if($(e.target).hasClass('cl-s-form-group')) {
                            $(e.target).find('.cl-s-form-control:not([type=hidden])').focus();
                        }
                    });


                    $('.cl-s-order-returnexchange .cl-s-form-textarea').on({
                        focus: function(e) {
                            $(this).closest('.cl-s-form-wrap').addClass('active');
                        },
                        blur: function(e) {
                            var val = $(this).val().trim();

                            $(this).closest('.cl-s-form-wrap').removeClass('active');
                            if(val.length == 0) {
                                $(this).closest('.cl-s-form-wrap').removeClass('error').addClass('empty');
                                $(this).closest('.cl-s-form-wrap').find('.cl-s-control-label.error').remove();
                                return false;
                            } else {
                                $(this).closest('.cl-s-form-wrap').removeClass('empty');
                                if(val.length < 5) {
                                    $(this).closest('.cl-s-form-wrap').addClass('error');
                                    if($(this).parent().find('.cl-s-control-label.error').length > 0) {
                                        $(this).parent().find('.cl-s-control-label.error').html($.lang[LANG]['customsite.validate.message.minlengthto5']);
                                    } else {
                                        $(this).after('<label for="input" class="cl-s-control-label error">'+$.lang[LANG]['customsite.validate.message.minlengthto5']+'</label>');
                                    }
                                    return false;
                                }
                            }

                            $(this).closest('.cl-s-form-wrap').removeClass('error').removeClass('empty');
                            $(this).closest('.cl-s-form-wrap').find('.cl-s-control-label.error').remove();
                        }
                    });

                    $('.cl-s-form-wrap .cl-s-form-control').on({
                        focus: function(e) {
                            $(this).closest('.cl-s-form-wrap').addClass('active');
                        },
                        blur: function(e) {
                            var val = $(this).val().trim();

                            $(this).closest('.cl-s-form-wrap').removeClass('active');
                            if(val.length == 0) {
                                $(this).closest('.cl-s-form-wrap').removeClass('error').addClass('empty');
                                $(this).closest('.cl-s-form-wrap').find('.cl-s-control-label.error').remove();
                                return false;
                            } else {
                                $(this).closest('.cl-s-form-wrap').removeClass('empty');
                            }

                            $(this).closest('.cl-s-form-wrap').removeClass('error').removeClass('empty');
                            $(this).closest('.cl-s-form-wrap').find('.cl-s-control-label.error').remove();
                        }
                    });



                    $(document).on('click', '.cl-s-order-returnexchange .re-img-close', function() {
                        $(this).closest('li').remove();
                    })

                    $('.cl-s-order-returnexchange .re-file-update').on('click', function () {
                        $("#re-file").click();
                    });

                    $('.cl-s-order-returnexchange #re-file').on({
                        click: function () {

                            var reImageCnt = $('.re-files-list').children('li').length;
                            if (reImageCnt >= 5) {
                                alert('이미지는 최대 5개까지 등록이 가능합니다.');
                                return false;
                            }

                            var sid = $('#re-file').attr('data-sid'),
                                uid = $('#re-file').attr('data-uid');

                            $.uploadON();
                            $(this).fileupload({
                                url: '/_upload/type/re/sid/'+sid+'/uid/'+uid,
                                dataType: 'json',
                                pasteZone: null,
                                async: true,
                                sequentialUploads: true,
                                add: function(e, data) {
                                    var r = $.upload_add(e,data);

                                    if(r.submit) {
                                        var jqXHR = data.submit();
                                        UPLOAD++;
                                    } else {
                                        data.context.find('.loading').html('<i class="fa fa-times error"></i>');
                                        data.context.find('.ing').addClass('error').text(r.err);
                                    }

                                    $(document).on('click','.upload-cancel .btn', function(e) {
                                        if(jqXHR != undefined) jqXHR.abort();
                                        data.context.fadeOut().remove();
                                        $('.uploadModal #file-upload-progress').css('width','0%');
                                        $.uploadOFF();
                                    });
                                },
                                progress: function(e, data) {
                                    $.upload_progress(e,data);
                                },                        
                                done: function(e, data) {
                                    $.upload_done(e,data);
                                    UPLOADED++;
                                    var src = (typeof data.result.magic != 'undefined') ? data.result.magic : data.result.src;
                                    var reImage = '\
                                        <li id="re-image-'+reImageCnt+'">\
                                            <img src="'+src+'" class="img-responsive" />\
                                            <input type="hidden" name="review_image[]" value="'+src+'" />\
                                            <div class="cl-s-files-img-close re-img-close"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 8" width="8" height="8"><path d="M4.71 4l3.15-3.15c0.2-0.2 0.2-0.51 0-0.71s-0.51-0.2-0.71 0L4 3.29 0.85 0.15c-0.2-0.2-0.51-0.2-0.71 0s-0.2 0.51 0 0.71L3.29 4 0.15 7.15c-0.2 0.2-0.2 0.51 0 0.71C0.24 7.95 0.37 8 0.5 8s0.26-0.05 0.35-0.15L4 4.71l3.15 3.15C7.24 7.95 7.37 8 7.5 8s0.26-0.05 0.35-0.15c0.2-0.2 0.2-0.51 0-0.71L4.71 4z"/></svg></div>\
                                        </li>\
                                    ';

                                    $(".cl-s-order-returnexchange .re-files-list").append(reImage);
                                    reImageCnt++;

                                    if(UPLOADED) {
                                        if(UPLOAD==UPLOADED) {
                                            setTimeout(function() {
                                                UPLOAD = 0;
                                                UPLOADED = 0;
                                                UPLOADSIZE = 0;
                                                PROGRESS = 0;
                                                $.uploadOFF();
                                            },1000);
                                        }
                                    }
                                },
                                progressall: function (e, data) {
                                    $.upload_progressall(e,data);
                                },
                                start : function(e, data) {
                                    $.upload_start(e,data);
                                    progress1 = 0; progress2 = 0; PROGRESS = 0;
                                },
                                dragover : function(e, data) {
                                    e.preventDefault();
                                },
                            }).prop('disabled', !$.support.fileInput)
                                .parent().addClass($.support.fileInput ? undefined : 'disabled');
                        }
                    });
                });
            },'json');

            $('.close-button-dialog').css({'display': 'block'});
        },
        writeReviewModal: function(sid, pnum, onum, type) {
            if(typeof sid == "undefined" || typeof pnum == "undefined" || typeof onum == "undefined") {
                alert('정보가 올바르지 않습니다');
                return false;
            }

            $.post('/_check_order', { sid:sid, pnum:pnum, onum:onum, mode:'review' }, function(data) {

                if(typeof data.error != "undefined" && data.error) {
                    $(this).showModalFlat('', data.error, true, false, '', 'close');
                    return false;
                }

                var c_data = data.r,
                    modal_str = '',
                    order_group = data.order_group,
                    picturePointStr = '';
                    if (c_data.pay_info.settings.point_data != null && c_data.pay_info.settings.point_data['point_use'] == 'Y' && c_data.writer.status != 'T') {
                        if (c_data.pay_info.settings.point_data['review_point_status'] == 'Y') {
                            if(typeof c_data.pay_info.settings.point_data != "undefined" && c_data.pay_info.settings) {  
                                var photoPoint = (c_data.pay_info.settings.point_data['review_photo_point'] > 0) ? c_data.pay_info.settings.point_data['review_photo_point'] : 0,
                                    textPoint = (c_data.pay_info.settings.point_data['review_point'] > 0) ? c_data.pay_info.settings.point_data['review_point'] : 0;
                                picturePointStr = '\
                                        <div class="cl-s-ps">\
                                            <svg viewBox="0 0 13 13" width="13" height="13">\
                                                <path d="M6.5 0C2.91 0 0 2.91 0 6.5S2.91 13 6.5 13 13 10.09 13 6.5 10.09 0 6.5 0zM6.5 12C3.47 12 1 9.53 1 6.5S3.47 1 6.5 1 12 3.47 12 6.5 9.53 12 6.5 12z"/>\
                                                <rect x="6" y="3" width="1" height="5"/><rect x="6" y="9" width="1" height="1"/>\
                                            </svg>사진 첨부 시 <span>'+number_format(photoPoint)+'원</span>이 적립됩니다.\
                                        </div>\
                                ';
                            }

                            modal_str += '\
                                <div class="review-point review-icon">후기 작성 시 적립금 <span>최대 '+number_format(photoPoint)+'원</span>\
                                    <svg viewBox="0 0 13 13" width="13" height="13" class="cm-popover-info hand" tabindex="0" data-trigger="focus" data-toggle="popover" data-placement="bottom" data-html="true" data-content="텍스트 후기 : &nbsp; '+number_format(textPoint)+'원 <br>포토 후기 : &nbsp; '+number_format(photoPoint)+'원<br>\
                                    <p>텍스트 후기와 포토 후기 적립금은 중복지급되지 않으며, 최초 작성한 후기를 기준으로 지급됩니다.</p>">\
                                        <path d="M6.5 0C2.91 0 0 2.91 0 6.5S2.91 13 6.5 13 13 10.09 13 6.5 10.09 0 6.5 0zM6.5 12C3.47 12 1 9.53 1 6.5S3.47 1 6.5 1 12 3.47 12 6.5 9.53 12 6.5 12z"/>\
                                        <rect x="6" y="9" width="1" height="1"/>\
                                        <path d="M6.66 3.01C5.61 3.01 4.58 3.5 4.5 4.8c0 0.06-0.01 0.12 0 0.2h1.02c0-0.07 0.01-0.15 0.02-0.23 0.08-0.62 0.52-0.76 1.08-0.76 0.63 0 1.02 0.37 1.02 0.95 -0.01 0.48-0.3 0.87-0.76 1.34C6.21 6.97 6.02 7.37 6 8h0.99C7 7.66 7.04 7.37 7.67 6.75 8.17 6.27 8.7 5.68 8.7 4.87 8.7 3.85 7.89 3.01 6.66 3.01z"/>\
                                    </svg>\
                                </div>\
                            ';
                        }
                    }

                    modal_str += '\
                    <div class="review-body">\
                        <div class="cl-s-product-jumbotron clearfix">\
                            <div class="cl-s-product-thumb">\
                                <img src="' + c_data.pdata.img + '" alt="' + c_data.pdata.name + '" class="' + c_data.pdata.img_align + '" />\
                            </div>\
                            <div class="cl-s-product-info">\
                                <h5 class="cl-s-product-title">' + c_data.pdata.name + '</h5>\
                    ';
                    if(typeof c_data.pdata.option != "undefined" && c_data.pdata.option) {
                        modal_str += '\
                                <div class="option-str">옵션: ' + c_data.pdata.option + '</div>\
                        ';
                    }
                    modal_str += '\
                            </div>\
                        </div>\
                        <div class="review-star">\
                            <h5>상품이 만족스러우셨나요?</h5>\
                            <div class="star text-center">\
                                <span data-idx="1" class="active"></span>\
                                <span data-idx="2" class="active"></span>\
                                <span data-idx="3" class="active"></span>\
                                <span data-idx="4" class="active"></span>\
                                <span data-idx="5" class="active"></span>\
                            </div>\
                        </div>\
                        <div class="review-content">\
                            <h5>어떤 점이 좋았나요?</h5>\
                            <div class="cl-s-form-wrap">\
                                <div class="cl-s-form-group input-label-hide">\
                                    <textarea class="cl-s-form-control" id="review-str" name="review" maxlength="1000" required="required"></textarea>\
                                    <label for="input" class="cl-s-control-label">자세한 내용을 적어주세요. (1000자 이내)</label>\
                                </div>\
                            </div>\
                            <div class="cl-s-files review-files file-center">\
                                <input id="review-file" type="file" name="files[]" multiple data-sid="' + sid + '" data-uid=\"' + c_data.writer.id + '\">\
                                <label class="cl-s-file-update review-file-update clearfix"><svg viewBox="0 0 42 36" width="18" height="16"><path d="M36 6h-5l-3-5c0 0-0.71-1-1.99-1 -0.72 0-2.54 0-3.99 0 0 0-0.91 0-2.04 0 -1.45 0-3.27 0-3.99 0C14.71 0 14 1 14 1l-3 5H6c-3.31 0-6 2.69-6 6v18c0 3.31 2.69 6 6 6h30c3.31 0 6-2.69 6-6V12C42 8.69 39.31 6 36 6zM21 31c-5.52 0-10-4.48-10-10 0-5.52 4.48-10 10-10 5.52 0 10 4.48 10 10C31 26.52 26.52 31 21 31z"/><circle cx="21" cy="21" r="6"/></svg><span>사진 첨부하기</span></label>\
                                <ul class="cl-s-files-list review-files-list clearfix files-list-wrap">\
                                </ul>\
                            </div>\
                            </div>\
                        </div>\
                            ';
                    if(c_data.pay_info.settings.point_data != null && c_data.pay_info.settings.point_data['point_use'] == 'Y' && c_data.pay_info.settings.point_data['review_point_status'] == 'Y') modal_str += picturePointStr;
                
                
                // $('.flat-modal .modal').modal('hide');
                var wrModal = $(this).showModalFlat('후기 작성', modal_str, true, true,function () {

                    var cl_s_f_body = $('.cl-s-product-review-write .review-content');
                    cl_s_f_body.find('.cl-s-form-wrap').each(function() {
                        var check_input = $(this).find('.cl-s-form-control'),
                            val = check_input.val().trim();

                        if(val.length == 0) {
                            $(this).removeClass('error').addClass('empty');
                            $(this).find('.cl-s-control-label.error').remove();
                        } else {
                            if($(this).hasClass('error')) {
                                check_input.focus();
                            }
                        }
                    });

                    if(cl_s_f_body.find('.cl-s-form-wrap.empty, .cl-s-form-wrap.error').length > 0) {
                        cl_s_f_body.find('.cl-s-form-wrap.empty, .cl-s-form-wrap.error').eq(0).find('.cl-s-form-control').focus();
                        return false;
                    }

                    var page_mode = ($('.cl-s-mypage').length > 0) ? 'mypage' : 'no_member',
                        review = $('#review-str').val().trim(),
                        review_star = $('.cl-s-product-review-write .review-star .star .active').length,
                        review_image = new Array();

                    $('input[name="review_image[]"]').each(function(i) {
                        review_image[i] = $(this).val();
                    });

                    var review_data = {
                        status : 'S',
                        page_mode : page_mode,

                        pnum : pnum,
                        onum : onum,
                        mb_status : c_data.writer.status,
                        review : review,
                        review_count : review_star,
                        images : review_image
                    };

                    if(c_data.writer.status == 'T') {
                        review_data['name'] = c_data.odata.name;
                        // review_data['order_group'] = c_data.order_data.group;
                    }

                    $.post('/_review_write', { sid:sid, order_group: order_group, data:JSON.stringify(review_data) }, function(rw_data) {
                        if(typeof rw_data.error != "undefined" && rw_data.error) {
                            $(this).showModalFlat('ERROR', rw_data.error, true, false, '', 'close');
                            return false;
                        }

                        wrModal.modal('hide');
                        location.reload();
                    }, 'json');



                },'close','등록하기','cl-s-product-review-write cl-modal cl-s-btn cover', false, '', function() {
                    $('.cl-s-product-review-write .cl-s-form-group').on('click',function(e) {
                        if($(e.target).hasClass('cl-s-form-group')) {
                            $(e.target).find('.cl-s-form-control:not([type=hidden])').focus();
                        }
                    });
                    $('[data-toggle="popover"]').popover();
                    $('.cl-s-product-review-write .cl-s-form-control').on({
                        focus: function(e) {
                            $(this).closest('.cl-s-form-wrap').addClass('active');
                        },
                        blur: function(e) {
                            var val = $(this).val().trim();

                            $(this).closest('.cl-s-form-wrap').removeClass('active');
                            if(val.length == 0) {
                                $(this).closest('.cl-s-form-wrap').removeClass('error').addClass('empty');
                                $(this).closest('.cl-s-form-wrap').find('.cl-s-control-label.error').remove();
                                return false;
                            } else {
                                $(this).closest('.cl-s-form-wrap').removeClass('empty');
                                if(val.length < 5) {
                                    $(this).closest('.cl-s-form-wrap').addClass('error');
                                    if($(this).parent().find('.cl-s-control-label.error').length > 0) {
                                        $(this).parent().find('.cl-s-control-label.error').html($.lang[LANG]['customsite.validate.message.minlengthto5']);
                                    } else {
                                        $(this).after('<label for="input" class="cl-s-control-label error">'+$.lang[LANG]['customsite.validate.message.minlengthto5']+'</label>');
                                    }
                                    return false;
                                }
                            }

                            $(this).closest('.cl-s-form-wrap').removeClass('error').removeClass('empty');
                            $(this).closest('.cl-s-form-wrap').find('.cl-s-control-label.error').remove();
                        }
                    });


                    $(document).on('click', '.cl-s-product-review-write .review-img-close', function() {
                        $(this).closest('li').remove();
                    })

                    $('.cl-s-product-review-write .review-file-update').on('click', function () {
                        $("#review-file").click();
                    });

                    $('.cl-s-product-review-write #review-file').on({
                        click: function () {

                            var reviewImageCnt = $('.review-files-list').children('li').length;
                            if (reviewImageCnt >= 5) {
                                alert('이미지는 최대 5개까지 등록이 가능합니다.');
                                return false;
                            }

                            var sid = $('#review-file').attr('data-sid'),
                                uid = $('#review-file').attr('data-uid');

                            $.uploadON();
                            $(this).fileupload({
                                url: '/_upload/type/review/sid/'+sid+'/uid/'+uid,
                                dataType: 'json',
                                pasteZone: null,
                                async: true,
                                sequentialUploads: true,
                                add: function(e, data) {
                                    var r = $.upload_add(e,data);

                                    if(r.submit) {
                                        var jqXHR = data.submit();
                                        UPLOAD++;
                                    } else {
                                        data.context.find('.loading').html('<i class="fa fa-times error"></i>');
                                        data.context.find('.ing').addClass('error').text(r.err);
                                    }

                                    $(document).on('click','.upload-cancel .btn', function(e) {
                                        if(jqXHR != undefined) jqXHR.abort();
                                        data.context.fadeOut().remove();
                                        $('.uploadModal #file-upload-progress').css('width','0%');
                                        $.uploadOFF();
                                    });
                                },
                                progress: function(e, data) {
                                    $.upload_progress(e,data);
                                },                        
                                done: function(e, data) {
                                    $.upload_done(e,data);
                                    UPLOADED++;

                                    var src = (typeof data.result.magic != 'undefined') ? data.result.magic : data.result.src;
                                    var reviewImage = '\
                                        <li id="review-image-'+reviewImageCnt+'">\
                                            <img src="'+src+'" class="img-responsive" />\
                                            <input type="hidden" name="review_image[]" value="'+src+'" />\
                                            <div class="cl-s-files-img-close review-img-close"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 8" width="8" height="8"><path d="M4.71 4l3.15-3.15c0.2-0.2 0.2-0.51 0-0.71s-0.51-0.2-0.71 0L4 3.29 0.85 0.15c-0.2-0.2-0.51-0.2-0.71 0s-0.2 0.51 0 0.71L3.29 4 0.15 7.15c-0.2 0.2-0.2 0.51 0 0.71C0.24 7.95 0.37 8 0.5 8s0.26-0.05 0.35-0.15L4 4.71l3.15 3.15C7.24 7.95 7.37 8 7.5 8s0.26-0.05 0.35-0.15c0.2-0.2 0.2-0.51 0-0.71L4.71 4z"/></svg></div>\
                                        </li>\
                                    ';

                                    $(".cl-s-product-review-write .review-files-list").append(reviewImage);
                                    reviewImageCnt++;

                                    if(UPLOADED) {
                                        if(UPLOAD==UPLOADED) {
                                            setTimeout(function() {
                                                UPLOAD = 0;
                                                UPLOADED = 0;
                                                UPLOADSIZE = 0;
                                                PROGRESS = 0;
                                                $.uploadOFF();
                                            },1000);
                                        }
                                    }
                                },
                                progressall: function (e, data) {
                                    $.upload_progressall(e,data);
                                },
                                start : function(e, data) {
                                    $.upload_start(e,data);
                                    progress1 = 0; progress2 = 0; PROGRESS = 0;
                                },
                                dragover : function(e, data) {
                                    e.preventDefault();
                                },
                            }).prop('disabled', !$.support.fileInput)
                                .parent().addClass($.support.fileInput ? undefined : 'disabled');
                        }
                    });

                    $('.cl-s-product-review-write .review-star .star span').on('click', function() {
                        var rCount = $(this).attr('data-idx');
                        $(this).parent().children('span').removeClass('active');
                        $(this).addClass('active').prevAll('span').addClass('active');
                    });


                });


            },'json');

        },
        editReviewModal: function(sid, pnum, onum, seq) {
            if(typeof sid == "undefined" || typeof pnum == "undefined" || typeof onum == "undefined") {
                alert('정보가 올바르지 않습니다');
                return false;
            }

            $.post('/_check_review', { sid:sid, seq: seq, mode:'review' }, function(data) {

                if(typeof data.error != "undefined" && data.error) {
                    $(this).showModalFlat('', data.error, true, false, '', 'close');
                    return false;
                }

                var c_data = data.r,
                    modal_str = '\
                    <div class="review-body">\
                        <div class="cl-s-product-jumbotron clearfix">\
                            <div class="cl-s-product-thumb">\
                                <img src="' + c_data.pdata.img + '" alt="' + c_data.pdata.name + '" class="' + c_data.pdata.img_align + '" />\
                            </div>\
                            <div class="cl-s-product-info">\
                                <h5 class="cl-s-product-title">' + c_data.pdata.name + '</h5>\
                    ';
                    if(typeof c_data.pdata.option != "undefined" && c_data.pdata.option) {
                        modal_str += '\
                                <div class="option-str">옵션: ' + c_data.pdata.option + '</div>\
                        ';
                    }

                    var image = c_data.review.review_image.split("||");
                    var reviewImage = '';
                    for (var i=0;i<image.length;i++) {
                        reviewImage += '\
                            <li id="review-image-'+i+'">\
                                <img src="'+image[i]+'" class="img-responsive" />\
                                <input type="hidden" name="review_image[]" value="'+image[i]+'" />\
                                <div class="cl-s-files-img-close review-img-close"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 8" width="8" height="8"><path d="M4.71 4l3.15-3.15c0.2-0.2 0.2-0.51 0-0.71s-0.51-0.2-0.71 0L4 3.29 0.85 0.15c-0.2-0.2-0.51-0.2-0.71 0s-0.2 0.51 0 0.71L3.29 4 0.15 7.15c-0.2 0.2-0.2 0.51 0 0.71C0.24 7.95 0.37 8 0.5 8s0.26-0.05 0.35-0.15L4 4.71l3.15 3.15C7.24 7.95 7.37 8 7.5 8s0.26-0.05 0.35-0.15c0.2-0.2 0.2-0.51 0-0.71L4.71 4z"/></svg></div>\
                            </li>\
                        ';
                    }
                    modal_str += '\
                            </div>\
                        </div>\
                        <div class="review-star">\
                            <h5>상품이 만족스러우셨나요?</h5>\
                            <div class="star text-center">';
                            for(var i=0;i<5;i++) {
                                var rs_onof = (i < c_data.review.review_score) ? 'active' : '';
                                modal_str += '<span data-idx="'+(i+1)+'" class="'+rs_onof+'"></span>';
                            }
                            modal_str += '\
                            </div>\
                        </div>\
                        <div class="review-content">\
                            <h5>어떤 점이 좋았나요?</h5>\
                            <div class="cl-s-form-wrap">\
                                <div class="cl-s-form-group input-label-hide">\
                                    <textarea class="cl-s-form-control" id="review-str" name="review" maxlength="1000" required="required">'+c_data.review.review+'</textarea>\
                                    <label for="input" class="cl-s-control-label">자세한 내용을 적어주세요. (1000자 이내)</label>\
                                </div>\
                            </div>\
                            <div class="cl-s-files review-files">\
                                <input id="review-file" type="file" name="files[]" multiple data-sid="' + sid + '" data-uid=\"' + c_data.writer.id + '\">\
                                <label class="cl-s-file-update review-file-update clearfix"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20"><path d="M0 0v20h20V0H0zM19 1v11.3l-3-3 -4 4 -6-6 -5 5V1H19zM1 19v-5.3l5-5 6 6 4-4 3 3V19H1z"/><circle cx="14.5" cy="5.5" r="1.5"/></svg> <span>사진</span></label>\
                                <ul class="cl-s-files-list review-files-list clearfix">\
                                '+reviewImage+'\
                                </ul>\
                            </div>\
                        </div>\
                    </div>\
                \
                ';

                // $('.flat-modal .modal').modal('hide');
                var wrModal = $(this).showModalFlat('후기 작성', modal_str, true, true,function () {

                    var cl_s_f_body = $('.cl-s-product-review-write .review-content');
                    cl_s_f_body.find('.cl-s-form-wrap').each(function() {
                        var check_input = $(this).find('.cl-s-form-control'),
                            val = check_input.val().trim();

                        if(val.length == 0) {
                            $(this).removeClass('error').addClass('empty');
                            $(this).find('.cl-s-control-label.error').remove();
                        } else {
                            if($(this).hasClass('error')) {
                                check_input.focus();
                            }
                        }
                    });

                    if(cl_s_f_body.find('.cl-s-form-wrap.empty, .cl-s-form-wrap.error').length > 0) {
                        cl_s_f_body.find('.cl-s-form-wrap.empty, .cl-s-form-wrap.error').eq(0).find('.cl-s-form-control').focus();
                        return false;
                    }

                    var review = $('#review-str').val().trim(),
                        review_star = $('.cl-s-product-review-write .review-star .star .active').length,
                        review_image = new Array();

                    $('input[name="review_image[]"]').each(function(i) {
                        review_image[i] = $(this).val();
                    });

                    var review_data = {
                        status : 'U',
                        page_mode : 'product',

                        pnum : pnum,
                        onum : onum,
                        seq : seq,
                        mb_status : c_data.writer.status,
                        review : review,
                        review_count : review_star,
                        images : review_image
                    };

                    if(c_data.writer.status == 'T') {
                        review_data['name'] = c_data.odata.name;
                        // review_data['order_group'] = c_data.order_data.group;
                    }

                    $.post('/_review_write', { sid:sid, data:JSON.stringify(review_data) }, function(rw_data) {
                        if(typeof rw_data.error != "undefined" && rw_data.error) {
                            $(this).showModalFlat('ERROR', rw_data.error, true, false, '', 'close');
                            return false;
                        }

                        wrModal.modal('hide');
                        setTimeout(function () {
                            location.reload();
                        }, 200); 
                    }, 'json');



                },'close','수정하기','cl-s-product-review-write cl-modal cl-s-btn cover', false, '', function() {
                    $('.cl-s-product-review-write .cl-s-form-group').on('click',function(e) {
                        if($(e.target).hasClass('cl-s-form-group')) {
                            $(e.target).find('.cl-s-form-control:not([type=hidden])').focus();
                        }
                    });

                    $('.cl-s-product-review-write .cl-s-form-control').on({
                        focus: function(e) {
                            $(this).closest('.cl-s-form-wrap').addClass('active');
                        },
                        blur: function(e) {
                            var val = $(this).val().trim();

                            $(this).closest('.cl-s-form-wrap').removeClass('active');
                            if(val.length == 0) {
                                $(this).closest('.cl-s-form-wrap').removeClass('error').addClass('empty');
                                $(this).closest('.cl-s-form-wrap').find('.cl-s-control-label.error').remove();
                                return false;
                            } else {
                                $(this).closest('.cl-s-form-wrap').removeClass('empty');
                                if(val.length < 5) {
                                    $(this).closest('.cl-s-form-wrap').addClass('error');
                                    if($(this).parent().find('.cl-s-control-label.error').length > 0) {
                                        $(this).parent().find('.cl-s-control-label.error').html($.lang[LANG]['customsite.validate.message.minlengthto5']);
                                    } else {
                                        $(this).after('<label for="input" class="cl-s-control-label error">'+$.lang[LANG]['customsite.validate.message.minlengthto5']+'</label>');
                                    }
                                    return false;
                                }
                            }

                            $(this).closest('.cl-s-form-wrap').removeClass('error').removeClass('empty');
                            $(this).closest('.cl-s-form-wrap').find('.cl-s-control-label.error').remove();
                        }
                    });


                    $(document).on('click', '.cl-s-product-review-write .review-img-close', function() {
                        $(this).closest('li').remove();
                    })

                    $('.cl-s-product-review-write .review-file-update').on('click', function () {
                        $("#review-file").click();
                    });

                    $('.cl-s-product-review-write #review-file').on({
                        click: function () {

                            var reviewImageCnt = $('.review-files-list').children('li').length;
                            if (reviewImageCnt >= 5) {
                                alert('이미지는 최대 5개까지 등록이 가능합니다.');
                                return false;
                            }

                            var sid = $('#review-file').attr('data-sid'),
                                uid = $('#review-file').attr('data-uid');

                            $.uploadON();
                            $(this).fileupload({
                                url: '/_upload/type/review/sid/'+sid+'/uid/'+uid,
                                dataType: 'json',
                                pasteZone: null,
                                async: true,
                                sequentialUploads: true,
                                add: function(e, data) {
                                    var r = $.upload_add(e,data);

                                    if(r.submit) {
                                        var jqXHR = data.submit();
                                        UPLOAD++;
                                    } else {
                                        data.context.find('.loading').html('<i class="fa fa-times error"></i>');
                                        data.context.find('.ing').addClass('error').text(r.err);
                                    }

                                    $(document).on('click','.upload-cancel .btn', function(e) {
                                        if(jqXHR != undefined) jqXHR.abort();
                                        data.context.fadeOut().remove();
                                        $('.uploadModal #file-upload-progress').css('width','0%');
                                        $.uploadOFF();
                                    });
                                },
                                progress: function(e, data) {
                                    $.upload_progress(e,data);
                                },                        
                                done: function(e, data) {
                                    $.upload_done(e,data);
                                    UPLOADED++;

                                    var src = (typeof data.result.magic != 'undefined') ? data.result.magic : data.result.src;
                                    var reviewImage = '\
                                        <li id="review-image-'+reviewImageCnt+'">\
                                            <img src="'+src+'" class="img-responsive" />\
                                            <input type="hidden" name="review_image[]" value="'+src+'" />\
                                            <div class="cl-s-files-img-close review-img-close"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 8" width="8" height="8"><path d="M4.71 4l3.15-3.15c0.2-0.2 0.2-0.51 0-0.71s-0.51-0.2-0.71 0L4 3.29 0.85 0.15c-0.2-0.2-0.51-0.2-0.71 0s-0.2 0.51 0 0.71L3.29 4 0.15 7.15c-0.2 0.2-0.2 0.51 0 0.71C0.24 7.95 0.37 8 0.5 8s0.26-0.05 0.35-0.15L4 4.71l3.15 3.15C7.24 7.95 7.37 8 7.5 8s0.26-0.05 0.35-0.15c0.2-0.2 0.2-0.51 0-0.71L4.71 4z"/></svg></div>\
                                        </li>\
                                    ';

                                    $(".cl-s-product-review-write .review-files-list").append(reviewImage);
                                    reviewImageCnt++;

                                    if(UPLOADED) {
                                        if(UPLOAD==UPLOADED) {
                                            setTimeout(function() {
                                                UPLOAD = 0;
                                                UPLOADED = 0;
                                                UPLOADSIZE = 0;
                                                PROGRESS = 0;
                                                $.uploadOFF();
                                            },1000);
                                        }
                                    }
                                },
                                progressall: function (e, data) {
                                    $.upload_progressall(e,data);
                                },
                                start : function(e, data) {
                                    $.upload_start(e,data);
                                    progress1 = 0; progress2 = 0; PROGRESS = 0;
                                },
                                dragover : function(e, data) {
                                    e.preventDefault();
                                },
                            }).prop('disabled', !$.support.fileInput)
                                .parent().addClass($.support.fileInput ? undefined : 'disabled');
                        }
                    });

                    $('.cl-s-product-review-write .review-star .star span').on('click', function() {
                        var rCount = $(this).attr('data-idx');
                        $(this).parent().children('span').removeClass('active');
                        $(this).addClass('active').prevAll('span').addClass('active');
                    });


                });


            },'json');

        },
        viewReviewModal: function(sid, seq) {
            if(typeof sid == "undefined" || typeof seq == "undefined") {
                alert('정보가 올바르지 않습니다');
                return false;
            }

            $.post('/_check_review', { sid:sid, seq:seq }, function(data) {
                if(typeof data.error != "undefined" && data.error) {
                    $(this).showModalFlat('', data.error, true, false, '', 'close');
                    return false;
                }

                var c_data = data.r;
                var image = c_data.review.review_image.split("||");
                var reviewImage = '';
                for (var i=0;i<image.length;i++) {
                    reviewImage += '<img src="'+image[i]+'">';
                }

                var modal_str = '\
                    <div class="review-body">\
                        <div class="cl-s-product-jumbotron clearfix">\
                            <div class="cl-s-product-thumb">\
                                <img src="' + c_data.pdata.img + '" alt="' + c_data.pdata.name + '" class="' + c_data.pdata.img_align + '" />\
                            </div>\
                            <div class="cl-s-product-info">\
                                <h5 class="cl-s-product-title">' + c_data.pdata.name + '</h5>\
                            </div>\
                        </div>\
                        <div class="review-member-info">\
                            <span>' + c_data.odata.name + '<span class="view-review-date">' + c_data.review.reg_date + '</span></span>';
                            if (c_data.review_status == 'Y' || c_data.review_status == 'A') {
                                modal_str += '<div class="review-edit-box" data-pnum="'+c_data.review.product_number+'" data-onum="'+c_data.review.order_number+'" data-seq="'+c_data.review.seq+'">';
                                 if (c_data.review_status == 'Y') {
                                    modal_str += '\
                                        <svg viewBox="0 0 13 13" width="13px" height="13px" fill="#8c8c8c" class="review-edit">\
                                            <path d="M4.32 8.05C4.2 8.39 4.46 8.71 4.79 8.71c0.05 0 0.11-0.01 0.16-0.03L7 8l6-6 -2-2L5 6 4.32 8.05zM5.87 6.54L11 1.41 11.59 2 6.46 7.13 5.58 7.42 5.87 6.54z"/>\
                                            <path d="M9 11c0 0.55-0.45 1-1 1H2c-0.55 0-1-0.45-1-1V4c0-0.55 0.45-1 1-1h3V2H2C0.9 2 0 2.9 0 4v7c0 1.1 0.9 2 2 2h6c1.1 0 2-0.9 2-2V8H9V11z"/>\
                                        </svg>\
                                    ';
                                }
                                modal_str += '\
                                        <svg viewBox="0 0 12 13" width="12px" height="13px" fill="#8c8c8c" class="review-delete">\
                                            <path d="M12 2h-1H9V0H3.02v2H1 0v1h1v8c0 1.1 0.9 2 2 2h6c1.1 0 2-0.9 2-2V3h1V2zM4.02 1H8v1H4.02V1zM10 11c0 0.55-0.45 1-1 1H3c-0.55 0-1-0.45-1-1V3h1.02H9h1V11z"/>\
                                            <rect x="4" y="4" width="1" height="7"/>\
                                            <rect x="7" y="4" width="1" height="7"/>\
                                        </svg>\
                                    </div>\
                                ';
                            }
                        modal_str += '\
                        </div>\
                        <div class="view-review-box">\
                            <div class="review-score">';
                            for(var i=0;i<5;i++) {
                                var rs_onof = (i < c_data.review.review_score) ? 'on' : 'off';
                                modal_str += '<img src="//storage.googleapis.com/i.addblock.net/shopping_mall/cl_icon_star_'+rs_onof+'.png">';
                            }
                            modal_str += '\
                            </div>\
                            <div class="review-box-content">'+c_data.review.review+'</div>\
                            <div class="review-box-image">'+reviewImage+'</div>\
                        </div>\
                    </div>\
                \
                ';

                // $('.flat-modal .modal').modal('hide');
                var wrModal = $(this).showModalFlat('상품 후기', modal_str, false, false, '', '','','cl-s-product-review-write cl-modal cl-s-btn cover', false, '', function () {
                    $(document).on('click', '.review-edit', function () {
                        var $parent = $(this).parent(),
                            pnum = $parent.attr('data-pnum'),
                            onum = $parent.attr('data-onum'),
                            seq = $parent.attr('data-seq');

                        $('.modal-backdrop').fadeOut(200);
                        $('.modal').fadeOut(200);
                        setTimeout(function () {
                            $('.modal-backdrop').remove();
                            $('.modal').remove();
                            $.shoppingmall.editReviewModal(sid, pnum, onum, seq);
                        }, 200);
                    });

                    $(document).on('click', '.review-delete', function () {
                        if (confirm('정말로 삭제하시겠습니까?')) {
                            var $parent = $(this).parent(),
                                pnum = $parent.attr('data-pnum'),
                                onum = $parent.attr('data-onum'),
                                seq = $parent.attr('data-seq');

                            $.ajax({
                                url: '/_review_delete',
                                type: 'post',
                                data: {
                                    sid: sid,
                                    seq: seq,
                                },
                                success: function (data) {
                                    alert('삭제가 완료되었습니다.');
                                    location.reload();
                                }
                            });
                        }
                    });
                });


            },'json');

        },
        editQnAModal: function(sid, pnum, seq) {
            if(typeof property == 'undefined') {
                alert('편집모드에서 지원하지 않습니다');
                return false;
            }
            if(typeof property.LOAD != 'undefined' && property.LOAD == 'RENDER') {
                alert('미리보기에서는 지원하지 않습니다');
                return false;
            }


            if(typeof seq == "undefined") seq = -1;
            var mode = (seq == -1) ? 'new' : 'edit';
            $.ajax({
                url: '/_qna_edit',
                type: 'POST',
                dataType: 'json',
                data: { sid:sid, pnum:pnum, seq:seq, mode:mode },
                async: false,
                cache: false,
                success: function(data) {
                    if (data.result == 'fail') {
                        location.href = "/_login";
                        return false;
                    }
                    
                    var status = data.um_status;
                    if(status == 'A') {
                        alert('관리자는 상품문의하기를 사용할 수 없습니다.');
                        return false;
                    }

                    var qna_files_str = qna_secret_str = '';

                    if(mode == 'edit') {
                        if(data['secret'] == 'Y') qna_secret_str = 'checked';

                        if(data['qna_image']) {
                            var qna_files_arr = data['qna_image'].split('||');
                            $.each(qna_files_arr, function(i,v) {
                                qna_files_str += '\
                                    <li id="qna-image-' + i + '">\
                                        <img src="' + v + '" class="img-responsive" />\
                                        <input type="hidden" class="qna_image[]" value="' + v + '"/>\
                                        <div class="cl-s-files-img-close qna-img-close"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 8" width="8" height="8"><path d="M4.71 4l3.15-3.15c0.2-0.2 0.2-0.51 0-0.71s-0.51-0.2-0.71 0L4 3.29 0.85 0.15c-0.2-0.2-0.51-0.2-0.71 0s-0.2 0.51 0 0.71L3.29 4 0.15 7.15c-0.2 0.2-0.2 0.51 0 0.71C0.24 7.95 0.37 8 0.5 8s0.26-0.05 0.35-0.15L4 4.71l3.15 3.15C7.24 7.95 7.37 8 7.5 8s0.26-0.05 0.35-0.15c0.2-0.2 0.2-0.51 0-0.71L4.71 4z"></path></svg></div>\
                                    </li>\
                                ';
                            });
                        }
                    }

                    var qna_writer_str = (data['member']) ? '\
                        <input type="hidden" id="qna-name" class="cl-s-form-control" name="qna_name" value="' + data['name'] + '">\
                        <input type="hidden" id="qna-email" class="cl-s-form-control" name="qna_email" value="' + data['email'] + '">\
                    ' : '\
                            <ul class="qna-writer clearfix">\
                                <li>\
                                    <div class="cl-s-form-wrap">\
                                        <div class="cl-s-form-group">\
                                            <input type="text" class="cl-s-form-control" id="qna-name" name="qna_name" required="required" value="' + data['name'] + '">\
                                            <label for="input" class="cl-s-control-label">이름</label>\
                                        </div>\
                                    </div>\
                                </li>\
                                <li>\
                                    <div class="cl-s-form-wrap">\
                                        <div class="cl-s-form-group">\
                                            <input type="password" class="cl-s-form-control" id="qna-password" name="qna_password" required="required">\
                                            <label for="input" class="cl-s-control-label">비밀번호</label>\
                                        </div>\
                                    </div>\
                                </li>\
                                <li>\
                                    <div class="cl-s-form-wrap">\
                                        <div class="cl-s-form-group">\
                                            <input type="text" class="cl-s-form-control" id="qna-email" name="qna_email" data-type="email" required="required" value="' + data['email'] + '">\
                                            <label for="input" class="cl-s-control-label">이메일 주소</label>\
                                        </div>\
                                    </div>\
                                </li>\
                            </ul>\
                        ',
                        qna_privacy_str = (data['member']) ? '' : '\
                            <hr class="line"/>\
                            <div class="qna-privacy">\
                                <div class="cl-s-checkbox">\
                                    <label>\
                                        <input type="checkbox" id="qna-btn-privacy" name="qna_btn_privacy">\
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M13 0H3C1.3 0 0 1.3 0 3v10c0 1.7 1.3 3 3 3h10c1.7 0 3-1.3 3-3V3C16 1.3 14.7 0 13 0zM15 13c0 1.1-0.9 2-2 2H3c-1.1 0-2-0.9-2-2V3c0-1.1 0.9-2 2-2h10c1.1 0 2 0.9 2 2V13z"/></svg>\
                                        <svg class="active" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M13 0H3C1.34 0 0 1.34 0 3v10c0 1.66 1.34 3 3 3h10c1.66 0 3-1.34 3-3V3C16 1.34 14.66 0 13 0zM13.03 6.03l-5.5 5.5C7.38 11.68 7.19 11.75 7 11.75s-0.38-0.07-0.53-0.22l-3.5-3.5c-0.29-0.29-0.29-0.77 0-1.06s0.77-0.29 1.06 0L7 9.94l4.97-4.97c0.29-0.29 0.77-0.29 1.06 0S13.32 5.74 13.03 6.03z"/></svg>\
                                        <a href="#qna-privacy-textarea" class="qna-view-privacy" data-toggle="collapse">개인정보 수집 및 이용</a>에 동의합니다.\
                                    </label>\
                                </div>\
                                <div class="qna-privacy-textarea collapse" name="privacy_textarea" id="qna-privacy-textarea">\
                                    ※ 비회원 서비스문의를 위한 개인정보 수집·이용 동의(필수)<br>\
                                    서비스 이용자의 개인정보를 수집하는 목적은 다음과 같습니다.\
                                    <table>\
                                        <colgroup>\
                                            <col width="25%">\
                                            <col width="45%">\
                                            <col width="30%">\
                                        </colgroup>\
                                        <thead>\
                                            <tr>\
                                                <th>수집목적</th>\
                                                <th>수집항목</th>\
                                                <th>이용기간</th>\
                                            </tr>\
                                        </thead>\
                                        <tbody>\
                                            <tr>\
                                                <td>문의 응대 및 서비스 개선</td>\
                                                <td>(필수) 이름, 이메일, 문의내용</td>\
                                                <td>문의 종료일로 5년</td>\
                                            </tr>\
                                        </tbody>\
                                    </table>\
                                    <br>\
                                    - 동의를 거부할 권리가 있으나, 동의거부에 따른 서비스 이용에 제한이 있을 수 있습니다.<br>\
                                    - 회사는 계약 및 서비스 이행을 위해 개인정보 처리업무를 위탁할 수 있으며, 개인정보처리방침에 그 내용을 고지합니다.<br>\
                                </div>\
                            </div>\
                        ',
                        modal_str = '\
                        <div class="qna-body">\
                            <h5 class="product-title">' + data['ptitle'] + '</h5>\
                            \
                            \
                            ' + qna_writer_str + '\
                            \
                            \
                            <ul class="qna-content">\
                                <li>\
                                    <div class="cl-s-form-wrap">\
                                        <div class="cl-s-form-group">\
                                            <input type="text" class="cl-s-form-control" id="qna-title" name="title" required="required" maxlength="100" value="' + data['title'] + '">\
                                            <label for="input" class="cl-s-control-label">제목</label>\
                                        </div>\
                                    </div>\
                                </li>\
                                <li>\
                                    <div class="cl-s-form-wrap">\
                                        <div class="cl-s-form-group input-label-hide">\
                                            <textarea type="text" class="cl-s-form-control" id="qna-str" name="qna" maxlength="500" required="required">' + data['qna'] + '</textarea>\
                                            <label for="input" class="cl-s-control-label">자세한 내용을 적어주세요. (500자 이내)</label>\
                                        </div>\
                                    </div>\
                                </li>\
                                <li class="last clearfix">\
                                    <div class="qna-secret">\
                                        <div class="secret cl-s-checkbox">\
                                            <label>\
                                                <input type="checkbox" id="secret-checkbox" name="secret" value="Y" ' + qna_secret_str + '>\
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M13 0H3C1.3 0 0 1.3 0 3v10c0 1.7 1.3 3 3 3h10c1.7 0 3-1.3 3-3V3C16 1.3 14.7 0 13 0zM15 13c0 1.1-0.9 2-2 2H3c-1.1 0-2-0.9-2-2V3c0-1.1 0.9-2 2-2h10c1.1 0 2 0.9 2 2V13z"/></svg>\
                                                <svg class="active" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M13 0H3C1.34 0 0 1.34 0 3v10c0 1.66 1.34 3 3 3h10c1.66 0 3-1.34 3-3V3C16 1.34 14.66 0 13 0zM13.03 6.03l-5.5 5.5C7.38 11.68 7.19 11.75 7 11.75s-0.38-0.07-0.53-0.22l-3.5-3.5c-0.29-0.29-0.29-0.77 0-1.06s0.77-0.29 1.06 0L7 9.94l4.97-4.97c0.29-0.29 0.77-0.29 1.06 0S13.32 5.74 13.03 6.03z"/></svg>\
                                                비밀글\
                                            </label>\
                                        </div>\
                                    </div>\
                                    <!--\
                                    <div class="cl-s-files qna-files f-left">\
                                        <input id="qna-file" type="file" name="files[]" multiple data-sid="' + sid + '" data-uid=\"' + data['um_id'] + '\">\
                                        <label class="cl-s-file-update qna-file-update clearfix"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" width="20" height="20"><path d="M0 0v20h20V0H0zM19 1v11.3l-3-3 -4 4 -6-6 -5 5V1H19zM1 19v-5.3l5-5 6 6 4-4 3 3V19H1z"/><circle cx="14.5" cy="5.5" r="1.5"/></svg> <span>사진</span></label>\
                                        <ul class="cl-s-files-list qna-files-list clearfix">\
                                            ' + qna_files_str + '\
                                        </ul>\
                                    </div>\
                                    -->\
                                </li>\
                            </ul>\
                            \
                            \
                            ' + qna_privacy_str + '\
                            \
                        </div>\
                    ';


                    $('.flat-modal .modal').modal('hide');
                    var eqnaModal = $(this).showModalFlat('문의 작성', modal_str,true,true,function () {

                        var error_cnt = 0,
                            error_message = '필수항목을 입력해주세요.',
                            input_data = new Object();

                        $('.cl-s-form-control').each(function() {

                            if($(this).val().trim().length == 0) {
                                $(this).closest('.cl-s-form-wrap').addClass('empty');
                                error_cnt++;
                                if(error_cnt == 1) $(this).focus();

                            } else {
                                $(this).closest('.cl-s-form-wrap').removeClass('empty');
                                var key = $(this).attr('name'),
                                    regexp = {
                                        email : /^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*.[a-zA-Z]{2,3}$/i
                                    };

                                if(typeof regexp[key] != "undefined" && !regexp[key].test($(this).val())) {
                                    error_cnt ++;
                                    if(error_cnt == 1) {
                                        error_message = '입력값을 다시 확인해주세요.';
                                        $(this).focus();
                                    }

                                    $(this).closest('.cl-s-form-wrap').addClass('error');
                                    if($(this).closest('.cl-s-form-group').find('.cl-s-control-label.error').length > 0) {
                                        $(this).closest('.cl-s-form-group').find('.cl-s-control-label.error').html($.lang[LANG]['siteum.regexp.check.'+key]);
                                    } else {
                                        $(this).closest('.cl-s-form-group input').after('<label class="cl-s-control-label error">'+$.lang[LANG]['siteum.regexp.check.'+key]+'</label>');
                                    }
                                } else {
                                    $(this).closest('.cl-s-form-wrap').removeClass('error');
                                    $(this).closest('.cl-s-form-group').find('.cl-s-control-label.error').remove();
                                    input_data[key] = $(this).val().trim();
                                }
                            }

                        });


                        if(status != 'U') {
                            if(!$('#qna-btn-privacy').prop('checked')) {
                                $("#qna-btn-privacy").addClass('error');
                                error_cnt++;
                            }
                        }

                        if(error_cnt > 0) {
                            alert(error_message);
                            return false;
                        }

                        if($('.qna-files-list').children('li').length > 0) {
                            var qna_files = '';
                            $('.qna-files-list').children('li').each(function() {
                                if(qna_files != '')  qna_files +='||';
                                qna_files += $(this).find('input').val();
                            });
                        }
                        input_data['qna_image'] = (qna_files) ? qna_files : '';
                        input_data['secret'] = ($('#secret-checkbox').prop('checked')) ? 'Y' : '';

                        var qna_status = { new:'S', edit:'E' },
                            page_type = (property.VIEW) ? 'product' : '';
                            
                        if($('.cl-s-mypage').length > 0) page_type = 'mypage';
                        else if($('.cl-s-nonmember-payment').length > 0) page_type = 'no_member';

                        input_data['sid'] = sid;
                        input_data['page_mode'] = page_type;
                        input_data['qna_seq'] = (seq > 0) ? seq : '';
                        input_data['qna_type'] = 'P';
                        input_data['product_number'] = pnum;
                        input_data['status'] = qna_status[mode];
                        input_data['mb_status'] = status;
                        input_data['qna_page'] = (property.VIEW) ? property.PAGE : '';
                        
                        $.ajax({
                            url: '/_qna_update',
                            type: 'post',
                            data: input_data,
                            async: false,
                            cache: false,
                            success: function(data) {
                                if(typeof data.error != "undefined") {
                                    alert(data.error);
                                    return false;
                                }
                                window.location.reload(true);
                            },
                            error: function(request,status,error) {
                                console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                                return false;
                            }

                        });

                        eqnaModal.modal('hide');

                    },'close','등록하기','cl-s-product-qna-edit cl-modal cl-s-btn cover', false, '', function() {
                        $('.cl-s-product-qna-edit .cl-s-form-group').on('click',function(e) {
                            if($(e.target).hasClass('cl-s-form-group')) {
                                $(e.target).find('.cl-s-form-control:not([type=hidden])').focus();
                            }
                        });

                        $('.cl-s-product-qna-edit .cl-s-form-control').on({
                            focus: function(e) {
                                $(this).closest('.cl-s-form-wrap').addClass('active');
                            },
                            blur: function(e) {
                                var type = $(this).attr('data-type'),
                                    regexp = {
                                        email : /^[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_.]?[0-9a-zA-Z])*.[a-zA-Z]{2,3}$/i
                                    },
                                    checkRegexp = (typeof type != 'undefined' && typeof regexp[type] != 'undefined') ? true : false,
                                    val = $(this).val().trim();

                                $(this).closest('.cl-s-form-wrap').removeClass('active');
                                if(val.length == 0) {
                                    $(this).closest('.cl-s-form-wrap').removeClass('error').addClass('empty');
                                    $(this).closest('.cl-s-form-wrap').find('.cl-s-control-label.error').remove();
                                    return false;
                                } else {
                                    $(this).closest('.cl-s-form-wrap').removeClass('empty');
                                    if(checkRegexp) {
                                        if(!regexp[type].test(val)) {
                                            $(this).closest('.cl-s-form-wrap').addClass('error');
                                            if($(this).parent().find('.cl-s-control-label.error').length > 0) {
                                                $(this).parent().find('.cl-s-control-label.error').html($.lang[LANG]['siteum.regexp.check.'+type]);
                                            } else {
                                                $(this).after('<label for="input" class="cl-s-control-label error">'+$.lang[LANG]['siteum.regexp.check.'+type]+'</label>');
                                            }
                                            return false;
                                        }
                                    }
                                }

                                $(this).closest('.cl-s-form-wrap').removeClass('error').removeClass('empty');
                                $(this).closest('.cl-s-form-wrap').find('.cl-s-control-label.error').remove();
                            }
                        });

                        $('.cl-s-product-qna-edit #qna-btn-privacy').on('change', function(e) {
                            if($(this).prop('checked')) $(this).removeClass('error');
                            else $(this).addClass('error');
                        });


                        $(document).on('click', '.cl-s-product-qna-edit .qna-img-close', function() {
                            $(this).closest('li').remove();
                        })

                        $('.cl-s-product-qna-edit .qna-file-update').on('click', function () {
                            $("#qna-file").click();
                        });

                        $('.cl-s-product-qna-edit #qna-files').on({
                            click: function () {
                                var qnaImageCnt = $('.qna-files-list').children('li').length;
                                if (qnaImageCnt >= 5) {
                                    alert('이미지는 최대 5개까지 등록이 가능합니다.');
                                    return false;
                                }

                                var sid = $('#qna-file').attr('data-sid'),
                                    uid = $('#qna-file').attr('data-uid');

                                $.uploadON();
                                $(this).fileupload({
                                    url: '/_upload/type/qna/sid/'+sid+'/uid/'+uid,
                                    dataType: 'json',
                                    pasteZone: null,
                                    async: true,
                                    sequentialUploads: true,
                                    add: function(e, data) {
                                        var r = $.upload_add(e,data);

                                        if(r.submit) {
                                            var jqXHR = data.submit();
                                            UPLOAD++;
                                        } else {
                                            data.context.find('.loading').html('<i class="fa fa-times error"></i>');
                                            data.context.find('.ing').addClass('error').text(r.err);
                                        }

                                        $(document).on('click','.upload-cancel .btn', function(e) {
                                            if(jqXHR != undefined) jqXHR.abort();
                                            data.context.fadeOut().remove();
                                            $('.uploadModal #file-upload-progress').css('width','0%');
                                            $.uploadOFF();
                                        });
                                    },
                                    progress: function(e, data) {
                                        $.upload_progress(e,data);
                                    },                        
                                    done: function(e, data) {
                                        $.upload_done(e,data);
                                        UPLOADED++;

                                        var src = (typeof data.result.magic != 'undefined') ? data.result.magic : data.result.src;
                                        var qnaImage = '\
                                            <li id="qna-image-'+qnaImageCnt+'">\
                                                <img src="'+src+'" class="img-responsive" />\
                                                <input type="hidden" name="qna_image[]" value="'+src+'" />\
                                                <div class="cl-s-files-img-close qna-img-close"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8 8" width="8" height="8"><path d="M4.71 4l3.15-3.15c0.2-0.2 0.2-0.51 0-0.71s-0.51-0.2-0.71 0L4 3.29 0.85 0.15c-0.2-0.2-0.51-0.2-0.71 0s-0.2 0.51 0 0.71L3.29 4 0.15 7.15c-0.2 0.2-0.2 0.51 0 0.71C0.24 7.95 0.37 8 0.5 8s0.26-0.05 0.35-0.15L4 4.71l3.15 3.15C7.24 7.95 7.37 8 7.5 8s0.26-0.05 0.35-0.15c0.2-0.2 0.2-0.51 0-0.71L4.71 4z"/></svg></div>\
                                            </li>\
                                        ';

                                        $(".cl-s-product-qna-edit .qna-files-list").append(qnaImage);
                                        qnaImageCnt++;

                                        if(UPLOADED) {
                                            if(UPLOAD==UPLOADED) {
                                                setTimeout(function() {
                                                    UPLOAD = 0;
                                                    UPLOADED = 0;
                                                    UPLOADSIZE = 0;
                                                    PROGRESS = 0;
                                                    $.uploadOFF();
                                                },1000);
                                            }
                                        }
                                    },
                                    progressall: function (e, data) {
                                        $.upload_progressall(e,data);
                                    },
                                    start : function(e, data) {
                                        $.upload_start(e,data);
                                        progress1 = 0; progress2 = 0; PROGRESS = 0;
                                    },
                                    dragover : function(e, data) {
                                        e.preventDefault();
                                    },
                                }).prop('disabled', !$.support.fileInput)
                                    .parent().addClass($.support.fileInput ? undefined : 'disabled');
                            }
                        });

                    });

                },
                error: function(request,status,error) {
                    console.log("code:"+request.status+"\n"+"message:"+request.responseText+"\n"+"error:"+error);
                    return false;
                }
            });

        },
        orderReceiptModal: function(sid, ogroup) {

            $.post('/_check_receipt', { sid:sid, order_group:ogroup, mode:'default' }, function(data) {

                if(typeof data.error != "undefined" && data.error) {
                    $(this).showModalFlat('ERROR', data.error, true, false, '', 'ok');
                    return false;
                }

                var d_price = (typeof data.r.delivery_price != "undefined" && data.r.delivery_price) ? data.r.delivery_price : 0,
                    d_price_str = number_format(d_price) + ' 원',
                    o_list_cnt = data.r.list.length,
                    o_org_total = 0,
                    o_total = 0;

                var orm_html = '\
                    <div class="receipt-wrap">\
                        <table>\
                            <colgroup>\
                                <col width="*" />\
                                <col width="120px" />\
                                <col width="100px" />\
                            </colgroup>\
                            \
                            <thead>\
                                <tr>\
                                    <th>상품정보</th>\
                                    <th>상품가격</th>\
                                    <th>배송비<span class="visible-xs"> ' + d_price_str + '</span></th>\
                                </tr>\
                            </thead>\
                            <tbody>\
                ';

                $.each(data.r.list, function(i, val) {
                    var option_name    = (!$.isEmptyObject(val['option_list']) && val['option_list']['option_name']) ? val['option_list']['option_name'] : '',
                        option_str     = (option_name) ? '<span>옵션 : ' + option_name + '</span>' : '';

                    var checkSale = (typeof val['option_list']['sale_price'] != "undefined" && val['option_list']['sale_price']) ? true : false,
                        oi_org_price = (checkSale) ? val['option_list']['sale_price'] : val['option_list']['price'],
                        oi_price     = val['option_list']['price'],
                        oi_quantity  = val['option_list']['quantity'],
                        oi_sum       = oi_price * oi_quantity;

                    o_org_total += (oi_org_price * oi_quantity);
                    o_total += oi_sum;

                    orm_html += '\
                                <tr class="or-grid">\
                                    <td class="mp-info">\
                                        <div class="cl-s-product-jumbotron clearfix">\
                                            <div class="cl-s-product-thumb">\
                                                <img src="' + val["pimg"] + '" alt="' + val["pname"] + '" class="img-responsive"/>\
                                            </div>\
                                            <div class="cl-s-product-info">\
                                                <h5 class="cl-s-product-title">' + val["pname"] + '</h5>\
                                                <div class="option-str">\
                                                    <div>\
                                                        <span class="visible-xs option-price">' + number_format(oi_sum) + ' 원</span>\
                                                        ' + option_str + '\
                                                        <span>' + oi_quantity + '개</span>\
                                                    </div>\
                                                </div>\
                                            </div>\
                                        </div>\
                                    </td>\
                                    <td>' + number_format(oi_sum) + ' 원</td>\
                    ';

                    if(i == 0) orm_html += '<td rowspan="' + o_list_cnt + '">' + d_price_str + '</td>';

                    orm_html += '\
                                </tr>\
                    ';

                });

                orm_html += '\
                            </tbody> \
                        </table>\
                        <p class="description">현금영수증은 발급 완료된 주문건에 한해 조회 및 출력이 가능하며, 구매확정일 기준으로 발급됩니다.<br>신용카드 매출 전표는 결제완료 시 자동 발급되며, 결제완료 후 확인 및 출력이 가능합니다.</p>\
                        <div class="receipt-btn-box">\
                ';
                if(data.r.pay_method != '무통장 입금') {
                    orm_html += '<span class="cl-s-btn cl-s-btn-12 cl-s-btn-primary btn-card-slip">카드전표</span>';
                }
                orm_html += '\
                            <span class="cl-s-btn cl-s-btn-12 cl-s-btn-primary btn-receipt-details">구매영수증</span>\
                        </div>\
                        <span class="cl-s-btn cl-s-btn-12 cl-s-btn-default btn-order-receipt-close">닫기</span>\
                    </div">\
                ';

                var orModal = $(this).showModalFlat('영수증 발급내역', orm_html, true, false, '', 'close', '', 'cl-s-receipt cl-modal cover', false, '', function() {
                    $('.btn-order-receipt-close').on('click', function() {
                        orModal.modal('hide');
                    });

                    $('.btn-card-slip').on('click', function() {
                        window.open('https://www.kcp.co.kr/center.paysearch.do', '', 'width=1000,height=500,scrollbars=yes');
                    });

                    $('.btn-receipt-details').on('click', function() {
                        $.shoppingmall.orderReceiptDetailModal(sid, ogroup);
                    });

                });

            }, 'json');

        },
        orderReceiptDetailModal: function(sid, ogroup) {

            $.post('/_check_receipt', { sid:sid, order_group:ogroup, mode:'detail' }, function(data) {

                if(typeof data.error != "undefined" && data.error) {
                    $(this).showModalFlat('ERROR', data.error, true, false, '', 'ok');
                    return false;
                }
                    
                var ordm_html = '\
                    <div class="receipt-wrap">\
                        <table>\
                            <colgroup>\
                                <col width="25%" />\
                                <col width="75%" />\
                            </colgroup>\
                            \
                            <tbody id="receipt-list">\
                                <tr>\
                                    <td><span>주문번호</span><br>ORDER NO.</td>\
                                    <td>' + ogroup + '</td>\
                                </tr>\
                                <tr>\
                                    <td><span>주문날짜</span><br>TRANS DATE</td>\
                                    <td>' + data.pay_info.reg_date + '</td>\
                                </tr>\
                                <tr>\
                                    <td><span>상품명</span><br>DESCRIPTION</td>\
                                    <td>' + data.pay_info.product_name + '</td>\
                                </tr>\
                                <tr>\
                                    <td><span>합계</span><br>TOTAL</td>\
                                    <td><span>'+number_format(data.pay_info.payment)+'</span> 원</td>\
                                </tr>\
                                <tr>\
                                    <td><span>회사명</span><br>COMPANY NAME</td>\
                                    <td>' + data.setting.b_name + '</td>\
                                </tr>\
                                <tr>\
                                    <td><span>대표자</span><br>MASTER</td>\
                                    <td>' + data.setting.b_rep + '</td>\
                                </tr>\
                                <tr>\
                                    <td><span>사업자등록번호</span><br>BUSINESS NO.</td>\
                                    <td>' + data.setting.b_number + '</td>\
                                </tr>\
                                <tr>\
                                    <td><span>회사주소</span><br>ADDRESS</td>\
                                    <td>' + data.setting.b_addr + '</td>\
                                </tr>\
                                <tr>\
                                    <td><span>문의전화</span><br>TEL</td>\
                                    <td>' + data.setting.b_tel + '</td>\
                                </tr>\
                                <tr>\
                                    <td><span>서명</span><br>SIGNATUE</td>\
                                    <td>' + data.pay_info.buyr_name + '</td>\
                                </tr>\
                            </tbody>\
                        </table>\
                        <div class="additional-box">구매 영수증은 세금계산서 등 증빙서류로 활용할 수 없습니다.</div>\
                    </div>\
                ';
                var ordModal = $(this).showModalFlat('구매영수증', ordm_html, true, true, function() {

                    $.shoppingmall.printModal(".cl-s-receipt-view");

                }, 'close', '출력', 'cl-s-receipt-view cl-modal cover', false);


            }, 'json');
        },
        printModal: function(modalEL) {
            var popupWindow = window.open("", "printPopup", "_blank" );

            var style = $('#cl_shopping').attr('href');

            popupWindow.document.write('<head>');
            popupWindow.document.write($('head').html());
            popupWindow.document.write('<link rel="stylesheet" href="'+style+'">');
            popupWindow.document.write('<style>');
            popupWindow.document.write($('#el_0css').html());
            popupWindow.document.write('.close-button-dialog, .ok-button-dialog {display:none !important;}');
            popupWindow.document.write('.cl-mobile-btn, button.close {display:none !important;}');
            popupWindow.document.write('.modal-dialog {width:700px !important;max-width:700px !important;}');
            popupWindow.document.write('</style>');
            popupWindow.document.write('</head>');

            var $table = $(modalEL);
     
            popupWindow.document.write('<body>');
            popupWindow.document.write('<div style="display:block;" class="flat-modal cl-flat-modal">');
            popupWindow.document.write($table.parent().parent().html());
            popupWindow.document.write('</div></body>');

            popupWindow.document.close();

            setTimeout(function () {
                popupWindow.print();
            }, 1500);
        },
        orderDownloadModal: function(sid, pnum, onum) {

            $.post('/_check_download', { sid:sid, pnum:pnum, onum:onum }, function(data) {
                
                if(typeof data.error != "undefined" && data.error) {
                    $(this).showModalFlat('ERROR', data.error, true, false, '', 'close');
                    return false;
                }
                
                $('.mypayment-btn').each(function () {
                    var mode = $(this).attr('data-fn');
                    if (mode == 'orderCancel') {$(this).remove();}
                });

                var download_href = data.r.url,
                    download_name = data.r.name,
                    download_real_name = data.r.real_name,
                    download_count = data.r.count;

                var download_url = new getLocation(download_href),
                    file_name = encodeURIComponent(download_name),
                    file_real_name = encodeURIComponent(download_real_name),
                    go = '/down?n=' + file_real_name + '&s=' + (download_url.pathname).replace('/cr-resource/forum/','').replace('/','&f='),
                    temp_el = '<a href="'+go+'" target="_blank" download id="cl-download-a"></a>';

                $('body').append(temp_el);
                document.querySelector('#cl-download-a').click();
                $('#cl-download-a').remove();
                
                if(download_count > 0) {
                    $('.mp-table[data-onum=' + onum + ']').find('.download-str span').text(download_count);
                } else {
                    $('.mp-table[data-onum=' + onum + ']').find('.download-str').html('<div class="cl-red">다운로드 기한이 지났거나<br>다운로드 횟수를 모두 사용하였습니다.</div>');
                    $('.mp-table[data-onum=' + onum + ']').find('button[data-fn="orderDownload"]').remove();
                }

            }, 'json');

        }
    }




    $.products = {
        init : function() {
            $.category.init();
            var isMainImageClick = false, idx = -1, replace = false;
            $(document).on('click', '.prod-modal', function(e) {
                $('.category-lists').slideUp(200, function() {
                    $('.category-wrap').removeClass('open');    
                });
                $('.option-price-status-select').slideUp(200, function() {
                    $('.option-price-status-str').removeClass('open');    
                });
            });

            $(document).on('click','.form-label.textarea', function() { $('#prod-desc').focus(); });

            $(document).on('change','.switch-product', function() {
                if($(this).is(':checked')) {
                    var check = $('.cl_icon_check02_on').parent().attr('for');
                    var a = 0;

                    if ($('#none-option-file').length > 0) {
                        var fileBoxCnt = $('.file-box-list').length;
                        $('.file-box-list').each(function () {
                            var downloadCnt = $(this).find('.file-name').length;
                            if (fileBoxCnt > 1) {
                                if (a == 0) a++;
                                else {
                                    if (check == 'download-product' && downloadCnt == 0) {
                                        alert('다운로드 상품일 경우 파일이 1개 이상 등록되어 있어야 합니다.');
                                        $('.switch-product').prop('checked','').parents('.form-wrap').addClass('disabled');
                                        a++;
                                        return false;
                                    }
                                }
                            } else {
                                if (check == 'download-product' && downloadCnt == 0) {
                                    alert('다운로드 상품일 경우 파일이 1개 이상 등록되어 있어야 합니다.');
                                    $('.switch-product').prop('checked','').parents('.form-wrap').addClass('disabled');
                                    a += 2;
                                    return false;
                                }
                            }
                        });
                        if (a <= 1) {
                            $('.switch-product').prop('checked','checked').parents('.form-wrap').removeClass('disabled');
                        }
                    } else {
                        $('.switch-product').prop('checked','checked').parents('.form-wrap').removeClass('disabled');
                    }
                } else {
                    $(this).parents('.form-wrap').addClass('disabled');                    
                }
            });
            $(document).on('change','.switch-quantity', function() {
                if($(this).is(':checked')) {
                    $(this).parents('.form-wrap').removeClass('disabled');
                    $('.prod-option-quantity, #plus-quantity, .edit-option-quantity').show();

                    if($('.prod-option-list > li').length > 1) {
                        // $('#prod-quantity').attr('readonly','true').removeClass('hide').attr('placeholder','옵션에서 재고 관리');
                        $('.quantity-label').addClass('on');
                    } else {
                        $('.quantity-label').removeClass('on');
                        $('#prod-quantity').removeAttr('readonly').removeClass('hide');
                    }
                } else {
                    $('.quantity-label').removeClass('on');
                    $(this).parents('.form-wrap').addClass('disabled');
                    $('#prod-quantity').addClass('hide');
                    $('.prod-option-quantity, #plus-quantity, .edit-option-quantity').hide();
                }
            });
            $(document).on('click','.switch-category', function() {
                if($(this).is(':checked')) {
                    $(this).parents('.form-wrap').removeClass('disabled');
                    $(this).parents('.form-wrap').find('.category-text').removeClass('hide');
                } else {
                    $(this).parents('.form-wrap').addClass('disabled');
                    $(this).parents('.form-wrap').find('.category-text').addClass('hide');
                }
            });
            $(document).on('click','#prod-sale-check', function() {
                if($(this).is(':checked')) {
                    var prod_price = ($('#prod-price').val()) ? $('#prod-price').val() : 0;
                    $('#prod-sale').addClass('strike');
                    $('#prod-sale').text(prod_price);
                    $('#prod-sale').show();
                    $('#prod-price').val('').attr('placeholder','할인 가격을 입력하세요').focus();
                    $('#prod-price').addClass('sale-on');
                    $('#check-sale').html('<path d="M13 0H3C1.34 0 0 1.34 0 3v10c0 1.66 1.34 3 3 3h10c1.66 0 3-1.34 3-3V3C16 1.34 14.66 0 13 0zM13.03 6.03l-5.5 5.5C7.38 11.68 7.19 11.75 7 11.75s-0.38-0.07-0.53-0.22l-3.5-3.5c-0.29-0.29-0.29-0.77 0-1.06s0.77-0.29 1.06 0L7 9.94l4.97-4.97c0.29-0.29 0.77-0.29 1.06 0S13.32 5.74 13.03 6.03z"/>');
                    $('#check-sale').css('fill', '#4789e7');
                } else {
                    var prod_price = ($('#prod-sale').text()) ? $('#prod-sale').text() : '';
                    $('#prod-price').val(prod_price);
                    $('#prod-price').removeClass('sale-on').attr('placeholder','가격을 입력하세요').focus();
                    $('#prod-sale').removeClass('strike');
                    $('#prod-sale').hide();
                    $('#check-sale').html('<path d="M13 0H3C1.3 0 0 1.3 0 3v10c0 1.7 1.3 3 3 3h10c1.7 0 3-1.3 3-3V3C16 1.3 14.7 0 13 0zM15 13c0 1.1-0.9 2-2 2H3c-1.1 0-2-0.9-2-2V3c0-1.1 0.9-2 2-2h10c1.1 0 2 0.9 2 2V13z"/>');
                    $('#check-sale').css('fill', '#8c8c8c');
                }
            });

            $(document).on('focusout', '#prod-price', function () {
                var price = $(this).val();
                price = removeCommas(price);
                price = price * 1;
                price = addCommas(price);
                $(this).val(price);
            });

            $(document).on('click','.prod-item-image-add,.prod-item-image',function(e) {
                idx = -1;
                isMainImageClick = ($(this).hasClass('prod-item-image')) ? true : false;
                replace = (isMainImageClick && $('.prod-item-image .preview-img').length) ? true : false;
                if($(this).hasClass('.prod-item-image-add')) {
                    $('img').removeClass('replace');
                }
                if($(this).hasClass('.prod-item-image')) $(this).find('.preview-img').addClass('replace');
                $.resource.open();
            });

            $(document).on('click','.prod-item-thumb img:not(.guide-img)',function(e) {
                isMainImageClick = false;
                idx = $(this).parent().index();
                replace = true;
                $(this).addClass('replace');
                $(this).attr('data-idx',idx);
                $.resource.open();
            });

            $(document).on('hover', '.prod-item-thumb li',function(e) {
                e.stopPropagation();
                $('.img-delete').hide();
                $(this).find('.img-delete').show();
            });

            $(document).on('click','.img-delete',function(e) {
                $(this).parent().remove();
                if($('.prod-item-thumb li').length < 11) $('.prod-item-image-add').removeClass('hide');
                if($(this).index() == 1) {
                    var src = $('.prod-item-thumb li:not(.prod-item-image-add):eq(0)').find('img:not(.guide-img)').attr('src');
                    if(typeof src != 'undefined') {
                        src = src.replace('/250/','/800/');
                        $('.prod-item-image .preview-img').css('background-image', 'url("'+ src +'")');
                    } else {
                        $('.prod-item-image').removeClass('active').find('.preview-img').remove();
                    }
                }
            });

            $(document).on('click','.resource-useit',function(e) {
                if($('.prod-modal').length == 0) return;
                var imgs = $.resource.selected(),
                    empty = ($('.prod-item-image').find('.preview-img').length) ? false : true;

                var url = (typeof RESOURCE == 'undefined') ? property.RESOURCE : RESOURCE,
                    site = (typeof SID == 'undefined') ? property.SID : SID,
                    folder = '', f = '';

                var thumbs = $('.prod-item-thumb li:not(.prod-item-image-add)').length,
                    remain = 10-thumbs;

                replace = ($('.replace').length) ? true : false;
                if(imgs.length > remain && !replace) imgs.length = remain;
                if(replace) imgs.length = 1;
                if(replace && imgs.length > 1) {
                    $(this).showModalFlat('INFORMATION', $.lang[LANG]['editor.resource.choose.count.1'], true, false, '', 'ok');
                    return false;
                }
                if($('.fr-selected-files li').length) {
                    $.processON('Image upload to storage...');
                    var frUpload = frStorageUpload(imgs.join("|"),800);

                    frUpload.then(function(data) {
                        $.each(data.u, function(i,v) {
                            if(empty && i == 0) {
                                folder = 800;
                                f = v.path + folder + '/' + v.file;
                                var thumb = v.path + '250/' + v.file,
                                    img_src = (v.magic) ? v.magic : v.file,
                                    src_s800 = getServeImage(img_src,"800",v.path),
                                    src_s250 = getServeImage(img_src,"250",v.path);

                                $('.prod-item-image').append('<div class="preview-img" style="background-image: url(' + src_s800 + ')">').addClass('active');
                                $('.prod-item-thumb .prod-item-image-add').before('<li><img src="' + src_s250 + '"><span class="img-delete"><i class="fa fa-times-circle" aria-hidden="true"></i></span></li>');
                            } else {
                                if(isMainImageClick && i == 0) {
                                    folder = 800;
                                    f = v.path + folder + '/' + v.file;
                                    var thumb = v.path + '250/' + v.file,
                                        img_src = (v.magic) ? v.magic : v.file,
                                        src_s800 = getServeImage(img_src,"800",v.path),
                                        src_s250 = getServeImage(img_src,"250",v.path);

                                    $('.prod-item-image').addClass('active').find('.preview-img').css('background-image','url("'+ src_s800 +'")');
                                    if($('.prod-item-thumb .prod-item-image-add').before().hasClass('.prod-item-image-add')) {
                                        $('.prod-item-thumb .prod-item-image-add').before('<li><img src="' + src_s250 + '"><span class="img-delete"><i class="fa fa-times-circle" aria-hidden="true"></i></span></li>');
                                    } else {
                                        $('.prod-item-thumb li:eq(0) img').replaceWith('<img src="' + src_s250 + '">');   
                                    }
                                } else {
                                    folder = 250;
                                    f = v.path + folder + '/' + v.file;
                                    var thumb = v.path + '250/' + v.file,
                                        img_src = (v.magic) ? v.magic : v.file,
                                        src_s800 = getServeImage(img_src,"800",v.path),
                                        src_s250 = getServeImage(img_src,"250",v.path);

                                    if(idx > -1) {
                                        if(idx == 0) $('.prod-item-image .preview-img').css('background-image', 'url("' + src_s800 + '")');
                                        $('.prod-item-thumb li:eq(' + idx +') img').replaceWith('<img src="' + src_s250 + '">');
                                    } else {
                                        $('.prod-item-thumb .prod-item-image-add').before('<li><img src="' + src_s250 + '"><span class="img-delete"><i class="fa fa-times-circle" aria-hidden="true"></i></span></li>');
                                    }
                                }
                            }
                            if($('.prod-item-thumb li').length > 10) $('.prod-item-image-add').addClass('hide');
                        });
                        $('#el-fileupload').modal('hide');
                    });
                } else {
                    $.each(imgs, function(i,v) {
                        if(empty && i == 0) {
                            p = url + '/' + site + '/';
                            var thumb = p + '250/' + v,
                                src_s800 = getServeImage(v,"800",p),
                                src_s250 = getServeImage(v,"250",p);
                            $('.prod-item-image').append('<div class="preview-img" style="background-image: url(' + src_s800 + ');">').addClass('active');
                            $('.prod-item-thumb .prod-item-image-add').before('<li><img src="' +  src_s250 + '"><span class="img-delete"><i class="fa fa-times-circle" aria-hidden="true"></i></span></li>');
                        } else {
                            if(isMainImageClick && i == 0) {
                                p = url + '/' + site + '/';
                                var thumb = p + '250/' + v,
                                    src_s800 = getServeImage(v,"800",p),
                                    src_s250 = getServeImage(v,"250",p);
                                $('.prod-item-image').addClass('active').find('.preview-img').css('background-image','url("'+ src_s800 +'")');
                                $('.prod-item-thumb li:eq(0) img').replaceWith('<img src="' + src_s250 + '">');
                            } else {
                                p = url + '/' + site + '/';
                                var thumb = p + '250/' + v,
                                    src_s800 = getServeImage(v,"800",p),
                                    src_s250 = getServeImage(v,"250",p);
                                if(idx > -1) {
                                    if(idx == 0) $('.prod-item-image .preview-img').css('background-image', 'url("' + src_s800 + '")');
                                    $('.prod-item-thumb li:eq(' + idx +') img').replaceWith('<img src="' + src_s250 + '">');
                                } else {
                                    $('.prod-item-thumb .prod-item-image-add').before('<li><img src="' + src_s250 + '"><span class="img-delete"><i class="fa fa-times-circle" aria-hidden="true"></i></span></li>');
                                }
                            }
                        }
                    });
                }
                if($('.prod-item-thumb li').length > 10) $('.prod-item-image-add').addClass('hide');
                $('#el-fileupload').modal('hide');
            });
            
            $(document).on('keyup', '.option-price-number', function(e) {
                var key = e.keyCode || e.which;
                    txt = $(this).val();
                var match = txt.match(/[0-9,\-\+]+/g);
                $(this).val(match);
                var price = removeCommas($('#prod-price').val());
                if(parseInt(price) + parseInt(match) < 0) {
                    alert('실 결제 금액이 0원 보다 작습니다');
                    $(this).val('0').focus();
                }
            });
        },
        add : function(id) {
            var site = (typeof SID == 'undefined') ? property.SID : SID,
                page = (typeof PAGE == 'undefined') ? property.PAGE : PAGE,
                pid = (typeof selectID == 'undefined') ? null : selectID;

            fileUpdateCnt = 0;
            //     pid = $('.gallery-add-items').attr('data-pid');
            // if(typeof pid == 'undefined' || pid == null) pid = $('.config-image-edit').attr('data-pid');
            // if(typeof pid == 'undefined' || pid == null) { pid = (typeof PARENT == 'undefined') ? property.PARENT.pid : PARENT.pid }
            // if(typeof pid == 'undefined' || pid == null) pid = (typeof selectID == 'string') ? selectID : null;
            // console.log(site,page,pid);

            if(pid.toLowerCase().match(/^cl-s-product-detail,/g) !== null) {
                pid = PARENT.pid;
            }

            if(!site || !page || !pid || typeof pid == 'undefined' || pid == null) {
                alert('Undefined gallery');
                return false;
            }

            $.ajax({
                url: '/template/products/',
                data: { type:'get', sid:site, id:id, page:page, pid:pid },
                dataType: 'json',
                type: 'POST',
                async: false,
                cache: false,
                success: function (data) {
                    if(data.error != 'undefined' && data.error) {
                        alert(data.error);
                        return false;
                    }
                    var i = data.item,
                        url = (typeof RESOURCE == 'undefined') ? property.RESOURCE : RESOURCE,
                        folder = '', f = '';

                    closeProductNumber = i.no;

                    var prod_quantity = parseInt(i.quantity);
                    if(prod_quantity < 0 || isNaN(prod_quantity)) i.quantity = 0;
                    $m = $(data.r).hide();
                    $('body').append($m);
                    $('#sid').val(i.sid);
                    $('#prod-page').val(page);
                    $('#prod-pid').val(pid);
                    $('#prod-no').val(i.no);
                    $('#prod-title').val(i.title);
                    $('#prod-desc').val(i.desc);
                    $('#prod-price').val(i.price);
                    $('#prod-sale').text(i.sale);
                    $('#prod-quantity').val(i.quantity);
                    $('#prod-category-text').text(i.category);
                    $('#prod-category-lists ul').empty();
                    $('#prod-category').attr('data-category',i.category_lists.toString());


                    var etcAry = [];
                    if (i.etc_info) etcAry = i.etc_info.split('||');

                    if (etcAry[0] == 'Y') {
                        $('#cl_etc_state_n').removeClass('active');
                        $('#cl_etc_state_y').addClass('active');

                        $('.etc-setting').css('display', 'block');

                        if (etcAry[1] == 'S') {
                            $('#cl_etc_state_s').addClass('active');
                            $('#cl_etc_state_p').removeClass('active');
                        } else {
                            $('#cl_etc_status_s').removeClass('active');
                            $('#cl_etc_status_p').addClass('active');
                        }

                        if (etcAry[2] == 'A') {
                            $('#cl_etc_week_a').addClass('active');
                            $('#cl_etc_week_w').removeClass('active');
                            $('#cl_etc_week_k').removeClass('active');
                        } else if (etcAry[2] == 'W') {
                            $('#cl_etc_week_a').removeClass('active');
                            $('#cl_etc_week_w').addClass('active');
                            $('#cl_etc_week_k').removeClass('active');
                        } else {
                            $('#cl_etc_week_a').removeClass('active');
                            $('#cl_etc_week_w').removeClass('active');
                            $('#cl_etc_week_k').addClass('active');
                        }

                        $('#etc-date-state').val(etcAry[0]);
                        $('#etc-date-status').val(etcAry[1]);
                        $('#etc-date-week').val(etcAry[2]);
                        $('#etc-start-date').val(etcAry[3]);
                        $('#etc-end-date').val(etcAry[4]);

                        if (etcAry.length > 5) {
                            $('.cl_etc_date_time').each(function () {
                                var dayCheck = $(this).attr('data-day');

                                if (dayCheck == etcAry[5]) {
                                    $(this).addClass('active');
                                }
                            });
                        }

                        var startDateCheckAry =  $('#etc-start-date').val().split('.');
                        var endDateCheckAry =  $('#etc-end-date').val().split('.');
                    }

                    var cate = (i.category) ? i.category.split(', ') : [];
                    $.each(i.category_lists, function(i,v) {
                        $li = $('<li>' + v + '</li>');
                        if(cate.includes(v)) $li.addClass('active');
                        $('#prod-category-lists ul').append($li);
                    });

                    $.each(i.footer, function(idx,v) {
                        if(v == 'true') {
                            if (idx == 3) {
                                if (v == 'true') {
                                    $('.page-options .radio-checkbox input:eq(0)').attr('checked','checked');
                                } else {
                                    $('.page-options .radio-checkbox input:eq(1)').attr('checked','checked');
                                }
                            } else {
                                $('.page-options .checkbox input:eq(' + idx + ')').attr('checked','checked');
                            }
                        }
                        if (idx == 1) {
                            if (v == 'true') {
                                $('.photo-review-tab').css('display', 'block');
                            } else {
                                $('.photo-review-tab').css('display', 'none');
                            }
                        }
                    });

                    if(i.imgs.length > 10) $('.prod-item-image-add').addClass('hide');
                    $.each(i.imgs, function(idx,img) {
                        if(idx > 10) return true;
                        if(img) {
                            (idx == 0) ? $('.prod-item-image').addClass('active').append('<div class="preview-img" style="background-image: url(' + img + ');">') :
                                         $('.prod-item-thumb .prod-item-image-add').before('<li><img src="' + img + '"><span class="img-delete"><i class="fa fa-times-circle" aria-hidden="true"></i></li>');
                        }
                    });

                    if(i.options.length == 0) {
                        i.options = { 
                            0 : {
                                'seq' : '',
                                'option_name' : 'noneOption',
                                'option_price' : 0
                            }
                        }
                    } else {
                        if(i.options.length > 1) {
                            $('#plus-price').text('추가금액');
                            $('#plus-quantity').text('수량');
                            $('#plus-status').text('상태');
                            // $('.switch-quantity').prop('checked','checked').parents('.form-wrap').removeClass('disabled');
                            // $('#prod-quantity').attr('readonly','true').removeClass('hide').attr('placeholder','옵션에서 재고 관리');
                        }
                    }

                    $.each(i.options, function(idx,o) {
                        switch(o.option_status) {
                            case "S" : str = '판매'; break;
                            case "O" : str = '품절'; break;
                            case "H" : str = '숨김'; break;
                            default : str = '판매'; o.option_status = 'S'; break;
                        }
                        if(typeof o.option_quantity == 'undefined' || o.option_quantity == null) o.option_quantity = 0;
                        if(typeof o.option_price == 'undefined' || o.option_price == null) o.option_price = 0;

                        var s = "\
                        <li>\
                            <div class='prod-option-item'>\
                                <span class='prod-option-title' data-seq='" + o.seq + "'>" + o.option_name + "</span>\
                                <span class='prod-option-price'>" + o.option_price + "</span>\
                                <span class='prod-option-quantity'>" + number_format(o.option_quantity) + "</span>\
                                <span class='prod-option-status' data-val='" + o.option_status + "'>" + str + "</span>\
                                <span class='prod-option-move'><i class='fa fa-arrows' aria-hidden='true'></i></span>\
                            </div>\
                            <div class='prod-option-edit'>\
                                <div class='form-wrap'>\
                                    <div class='form-group edit-option-title'>\
                                        <input type='text' maxlength='50' required='required' placeholder='옵션명'/>\
                                    </div>\
                                    <div class='form-group edit-option-price'>\
                                        <input type='text' required='required' class='option-price-number' placeholder='0'/>\
                                    </div>\
                                    <div class='form-group edit-option-quantity'>\
                                        <input type='text' required='required' class='option-price-quantity' maxlength='5' placeholder='0' numberonly/>\
                                    </div>\
                                    <div class='form-group edit-option-select'>\
                                        <div class='option-price-status-str hand' data-val='" + o.option_status + "'>" + str + "</div>\
                                        <ul class='option-price-status-select'>\
                                            <li data-val='S'>판매</li>\
                                            <li data-val='O'>품절</li>\
                                            <li data-val='H'>숨김</li>\
                                        </ul>\
                                    </div>\
                                    <div class='edit-option-delete' data-seq='" + o.seq + "'><i class='fa fa-trash-o'></i></div>\
                                </div>\
                            </div>";
                        if (o.product_state) {
                            var p_s_data = JSON.parse(o.product_state);

                            if (p_s_data.file_name) {
                                if (fileUpdateCnt == 0) fileUpdateCnt++;
                                if (loadFile == 0) loadFile++;
                                s += '<div class="form-group product-status">\
                                        <div class="product-state-box">\
                                            <div class="product-upload">\
                                                <div class="title">파일 업로드</div>\
                                                <div class="download-contents">\
                                                    <span class="cl_icon_upload02" data-cnt="'+fileUpdateCnt+'">업로드</span>\
                                                    <div class="file-box-list" id="file-box-'+fileUpdateCnt+'">';

                                                        var serverName = p_s_data.file_url.split('/');
                                                        s += '<div class="file-name file-name-'+loadFile+'">\
                                                                <span class="real-file-name">'+p_s_data.file_name+'</span>\
                                                                <span class="file-name-detail" title="'+p_s_data.file_name+'">'+p_s_data.file_str_name+'</span>\
                                                                <span class="file-size">'+p_s_data.file_size+'</span>\
                                                                <span class="cl-icon cl_icon_close" data-cnt="'+loadFile+'" data-pn="'+i.no+'" data-file="'+serverName[8]+'" data-seq="'+o.seq+'"></span>\
                                                                <span class="file-url">'+p_s_data.file_url+'</span>\
                                                            </div>';
                                                        loadFile++;

                                s += '              </div>\
                                                </div>\
                                            </div>\
                                        </div>\
                                    </div>';
                            }
                        }
                        fileUpdateCnt++;
                        s += "</li>";
                        $('.prod-option-list').append(s);
                        $('#product-state').find('input[type="file"]').attr('data-cnt', loadFile).click();
                    });

                    if(i.product_on == 'off') {
                        $('.switch-product').prop('checked','').parents('.form-wrap').addClass('disabled');
                    } else {
                        $('.switch-product').prop('checked', true).parents('.form-wrap').removeClass('disabled');
                    }
                    if(i.quantity_on == 'on') {
                        $('.switch-quantity').prop('checked','checked').parents('.form-wrap').removeClass('disabled');
                        if($('.prod-option-list > li').length > 1) {
                            // $('#prod-quantity').attr('readonly','true').removeClass('hide').attr('placeholder','옵션에서 재고 관리');
                            $('.quantity-label').addClass('on');
                        } else {
                            $('#prod-quantity').removeAttr('readonly').removeClass('hide').attr('placeholder','수량 입력');
                            $('.quantity-label').removeClass('on');
                        }
                    } else {
                        $('.prod-option-quantity, #plus-quantity, .edit-option-quantity').hide();
                    }
                    if(i.sale) {
                        $('#prod-price').addClass('sale-on');
                        $('#prod-sale').show().addClass('strike');
                        $('#prod-sale-check').prop('checked','checked');
                        $('#check-sale').html('<path d="M13 0H3C1.34 0 0 1.34 0 3v10c0 1.66 1.34 3 3 3h10c1.66 0 3-1.34 3-3V3C16 1.34 14.66 0 13 0zM13.03 6.03l-5.5 5.5C7.38 11.68 7.19 11.75 7 11.75s-0.38-0.07-0.53-0.22l-3.5-3.5c-0.29-0.29-0.29-0.77 0-1.06s0.77-0.29 1.06 0L7 9.94l4.97-4.97c0.29-0.29 0.77-0.29 1.06 0S13.32 5.74 13.03 6.03z"/>');
                        $('#check-sale').css('fill', '#4789e7');
                    }
                    $m.fadeIn(300);
                    $('.prod-option-list').sortable({
                        handle : ".prod-option-move"
                    });

                    if (i.product_state == 'download') {
                        $('#download-product').attr('checked', true);
                        $('.cl_product_state_check').each(function () {
                            if ($(this).attr('for') == 'download-product') {
                                $(this).find('.cl-icon').removeClass('cl_icon_check02_off').removeClass('cl_icon_check02_on').addClass('cl_icon_check02_on');
                                $(this).click();
                                $('#download-date').val(i.download_date);
                                $('#download-count').val(i.download_count);
                            } else {
                                $(this).find('.cl-icon').removeClass('cl_icon_check02_off').removeClass('cl_icon_check02_on').addClass('cl_icon_check02_off');
                            }
                        });
                    }

                    if (i.product_state == 'normal') {
                        $('#normal-product').attr('checked', true);
                        $('.cl_product_state_check').each(function () {
                            if ($(this).attr('for') == 'normal-product') {
                                $(this).find('.cl-icon').removeClass('cl_icon_check02_off').removeClass('cl_icon_check02_on').addClass('cl_icon_check02_on');
                                $(this).click();
                            } else {
                                $(this).find('.cl-icon').removeClass('cl_icon_check02_off').removeClass('cl_icon_check02_on').addClass('cl_icon_check02_off');
                            }
                        });
                    }

                    if (i.product_state == 'etc') {
                        $('#etc-product').attr('checked', true);
                        $('.cl_product_state_check').each(function () {
                            if ($(this).attr('for') == 'etc-product') {
                                $(this).find('.cl-icon').removeClass('cl_icon_check02_off').removeClass('cl_icon_check02_on').addClass('cl_icon_check02_on');
                                $(this).click();
                            } else {
                                $(this).find('.cl-icon').removeClass('cl_icon_check02_off').removeClass('cl_icon_check02_on').addClass('cl_icon_check02_off');
                            }
                        });
                    }

                    taxUse = i.tax_use;
                    if (i.tax_use == 'TG03') {
                        $('#state-append').fadeIn(0);
                        $('#normal-product-state').fadeIn(0);
                        if (i.tax == 'TG01') {
                            $('#tax').attr('data-val', 'TG01');
                            $('#tax').html('과세');
                        }

                        if (i.tax == 'TG02') {
                            $('#tax').attr('data-val', 'TG02');
                            $('#tax').html('비과세');
                        }
                        $('#tax').attr('data-total-tax', 'TG03');
                    } else {
                        if (i.product_state == 'normal') $('#state-append').fadeOut(0);
                        $('#normal-product-state').fadeOut(0);
                        $('#tax').attr('data-val', 'TG01');
                        $('#tax').html('과세');
                    }
                }               
            });
        },
        review : function(id,page) {
            var site = (typeof SID == 'undefined') ? property.SID : SID;

            $.ajax({
                url: '/template/products/',
                data: { type:'review', sid:site, id:id, page:page },
                dataType: 'json',
                type: 'POST',
                async: false,
                cache: false,
                success: function (data) {
                    if(data.error != 'undefined' && data.error) {
                        alert(data.error);
                        return false;
                    }
                    var $review = $(data.r).hide();
                    if(typeof property == "undefined") {
                        $lastEl = ($('.el-footer_ctrl').length) ? $('.el-footer_ctrl') : $('.add-footer-information');
                        if($('.page-bottomlist').length) $lastEl = $('.page-bottomlist');
                        if($('.fnav').length) $lastEl = $('.fnav');
                        $lastEl.before($review);
                        $review.show();
                    } else {
                        if($('.el-footer').length) {
                            $lastEl = ($('.page-bottomlist').length) ? $('.page-bottomlist') : $('.el-footer');
                            if($('.fnav').length) $lastEl = $('.fnav');
                            $lastEl.before($review);
                            $review.show();
                        } else {
                            $('.dsgn-body').append($review);
                            $review.show();
                        }
                    }
                    var cnt = ($('.review-wrap h4 > span').text()=="") ? 0 : $('.review-wrap h4 > span').text();
                    $('.review-count').text(' ' + cnt);
                }
            });

        },
        qna : function(id,page) {
            var site = (typeof SID == 'undefined') ? property.SID : SID;

            $.ajax({
                url: '/template/products/',
                data: { type:'qna', sid:site, id:id, page:page },
                dataType: 'json',
                type: 'POST',
                async: false,
                cache: false,
                success: function (data) {
                    if(data.error != 'undefined' && data.error) {
                        alert(data.error);
                        return false;
                    }
                    var $qna = $(data.r).hide();
                    if(typeof property == "undefined") {
                        $lastEl = ($('.el-footer_ctrl').length) ? $('.el-footer_ctrl') : $('.add-footer-information');
                        if($('.page-bottomlist').length) $lastEl = $('.page-bottomlist');
                        if($('.fnav').length) $lastEl = $('.fnav');
                        $lastEl.before($qna);
                        $qna.show();
                    } else {
                        if($('.el-footer').length) {
                            $lastEl = ($('.page-bottomlist').length) ? $('.page-bottomlist') : $('.el-footer');
                            if($('.fnav').length) $lastEl = $('.fnav');
                            $lastEl.before($qna);
                            $qna.show();
                        } else {
                            $('.dsgn-body').append($qna);
                            $qna.show();
                        }
                    }
                    var cnt = ($('.qna-wrap h4 > span').text()=="") ? 0 : $('.qna-wrap h4 > span').text();
                    $('.qna-count').text(' ' + cnt);
                }
            });

        },
        list : function(id, page, view, page_num, sfl, stx, scate) {

        },
        save : function(go) {
            var seq = $('#prod-no').val(),
                page = $('#prod-page').val(),
                pid = $('#prod-pid').val(),
                $title = $('#prod-title'),
                $price = $('#prod-price'),
                $sale = $('#prod-sale'),
                $quantity = $('#prod-quantity'),
                $img = $('.prod-item-image'),
                $desc = $('#prod-desc'),
                $category = $('#prod-category-text'),
                quantity_on = ($('.switch-quantity').is(":checked") == true) ? 'on' : 'off',
                product_on =  ($('.switch-product').is(":checked") == true) ? 'on' : 'off',
                category_on = ($('.switch-category').is(":checked") == true) ? 'ON' : 'OFF',
                submit = true,
                downloadDate = $('#download-date').val(),
                downloadCount = $('#download-count').val(),
                submit = true,
                productState = '',
                taxState = $('#tax').attr('data-val'),
                etcDateState = '',
                etcDateStatus = '', etcDateWeek = '',
                startDate = '', endDate = '', etcDate = '',
                dayCheck = false, dayCheckLan = '';

            if ($('#download-product').is(":checked") == true) productState = 'download';
            if ($('#normal-product').is(":checked") == true) productState = 'normal';
            if ($('#etc-product').is(":checked") == true) {
                productState = 'etc';

                etcDateState = $('#etc-date-state').val();
                if (etcDateState == 'Y') {
                    etcDateStatus = $('#etc-date-status').val();
                    etcDateWeek = $('#etc-date-week').val();
                    startDate = $('#etc-start-date').val();
                    endDate = $('#etc-end-date').val();
                    $('.cl_etc_date_time').each(function () {
                        if (dayCheck == false) {
                            if ($(this).hasClass('active') === true) {
                                dayCheck = true;
                                dayCheckLan = $(this).attr('data-day');
                            } else {
                                dayCheckLan = '';
                            }
                        }
                    });

                    var checkStartDate = startDate.split('.');
                    var checkEndDate = endDate.split('.');
                    var checkStart = new Date(checkStartDate[0], (checkStartDate[1] * 1) - 1, checkStartDate[2]);
                    var checkEnd = new Date(checkEndDate[0], (checkEndDate[1] * 1) - 1, checkEndDate[2]);
                    if (checkStart.getTime() > checkEnd.getTime()) {
                        alert('시작일이 종료일보다 큽니다.');
                        return false;
                    }
                }

                etcDate = etcDateState+'||'+etcDateStatus+'||'+etcDateWeek+'||'+startDate+'||'+endDate;
                if (dayCheckLan) {
                    etcDate += '||' + dayCheckLan;
                }
            }

            if($img.find('.preview-img').length == 0) {
                $img.addClass('empty');
                submit = false;
            } else $img.removeClass('.empty');

            if(!$title.val().trim()) {
                $title.focus().parents('.form-wrap').addClass('empty');
                submit = false;
            } else $title.parents('.form-wrap').removeClass('empty');
            if(!$price.val().trim()) {
                $price.focus().parents('.form-wrap').addClass('empty');
                submit = false;
            } else $price.parents('.form-wrap').removeClass('empty');
            // if(!$quantity.val().trim()) {
            //     $quantity.focus().parents('.form-wrap').addClass('empty');
            //     submit = false;
            // } else $quantity.parents('.form-wrap').removeClass('empty');

            var item_quantity = ($quantity.val().trim()) ? parseInt($quantity.val().trim().replace(/\,/g, ''), 10) : 0,
                item_price = ($price.val().trim()) ? parseInt($price.val().trim().replace(/\,/g, ''), 10) : 0;
            if(item_quantity > 1000000000) {
                $quantity.focus().parents('.form-wrap').addClass('empty');
                alert('최대 수량은 10억개입니다');
                return false;
            }
            if(item_price > 1000000000) {
                $price.focus().parents('.form-wrap').addClass('empty');
                alert('최대상품가격은 10억입니다');
                return false;
            }

            var options = $('.prod-option-list > li').map(function(i,v) {
                if($(this).find('.prod-option-title').text().trim()) {
                    var quantity = $(this).find('.prod-option-quantity').text().trim(),
                        status = $(this).find('.option-price-status-str').attr('data-val');
                    if(quantity == '') quantity = '0';
                    if(quantity == '0' && quantity_on == 'on') status = 'O'; 

                    var fileUrl = [],
                        fileSize = [],
                        fileStrName = [],
                        fileName = [];

                    var fileUrlCheck = $(this).find('.file-url'),
                        fileSizeCheck = $(this).find('.file-size'),
                        fileStrNameCheck = $(this).find('.file-name-detail'),
                        fileNameCheck = $(this).find('.real-file-name');

                    if (fileUrlCheck.length > 0) $(this).find('.file-url').each(function () { fileUrl.push($(this).text()); });
                    else fileUrl.push('');
                    if (fileUrlCheck.length > 0) $(this).find('.file-size').each(function () { fileSize.push($(this).text()); });
                    else fileUrl.push('');
                    if (fileUrlCheck.length > 0) $(this).find('.file-name-detail').each(function () { fileStrName.push($(this).text()); });
                    else fileUrl.push('');
                    if (fileUrlCheck.length > 0) $(this).find('.real-file-name').each(function () { fileName.push($(this).text()); });
                    else fileUrl.push('');

                    var strFileUrl = fileUrl.join('||'),
                        strFileSize = fileSize.join('||'),
                        strFileStrName = fileStrName.join('||'),
                        strFileName = fileName.join('||');

                    return { 
                        s : $(this).find('.prod-option-title').attr('data-seq'),
                        o : $(this).find('.prod-option-title').text().trim(), 
                        v : $(this).find('.prod-option-price').text().trim(),
                        fn : strFileName,
                        fdn : strFileStrName,
                        fs : strFileSize,
                        fu : strFileUrl,
                        q : quantity,
                        t : status,
                        a : i
                    }
                }
            }).get();
            if(options.length==0) {
                $('.prod-option-add').addClass('empty');
                submit = false;
            }

            var optionsAry = division(options, 50);

            var price1 = removeCommas($price.val().trim()),
                price2 = removeCommas($sale.text().trim());

            if($sale.css('display') == 'none') {
                $sale.text('');
                price2 = 0;
            }
            if(price2 !=0 && parseInt(price1) - parseInt(price2) >= 0) {
                console.log(parseInt(price1), parseInt(price2));
                alert('할인 가격은 정가보다 높거나 동일할 수 없습니다');
                submit = false;
            }
            var imgs = [];
            if(submit) {
                $('.prod-item-thumb li').each(function(i,v) {
                    var s = $(this).find('img:not(.guide-img)').attr('src');
                    if($(this).hasClass('prod-item-image-add')) return true;
                    imgs.push(s);
                });
                var func = $('.page-options input[type=checkbox]').map(function () {
                    return (this.checked) ? true : false;
                }).get();
                func[3] = $('#photo-review').is(":checked");

                func[0] = true;
                var cate = ($category.text().trim()) ? $category.text().trim().split(',') : '';

                $.processON('상품을 등록중입니다...');
                for (var optionCnt=0;optionCnt<optionsAry.length;optionCnt++) {
                    var prod = {
                        'seq' : seq,
                        'page' : page,
                        'pid' : pid,
                        'title' : $title.val().trim(),
                        'price' : $price.val().trim(),
                        'sale' : $sale.text().trim(),
                        'product_on' : product_on,
                        'quantity' : $quantity.val().trim(),
                        'quantity_on' : quantity_on,
                        'desc' : $desc.val().trim(),
                        'category' : cate,
                        'category_on' : category_on,
                        'imgs' : imgs,
                        'func' : func,
                        'product_state' : productState,
                        'tax' : taxState,
                        'download_date' : downloadDate,
                        'download_count' : downloadCount,
                        'etc_data' : etcDate,
                        'options' : optionsAry[optionCnt],
                    }

                    $.post('/template/products', { sid: SID, type : 'add', s: prod }, function (data) {
                        checkError(data);
                        // control panel
                        if (optionsAry.length == (optionCnt + 1)) {
                            $('img.galleryItemEdit[data-seq="' + data.r.id + '"]').attr('src',data.r.imgs[0].path+'/60/'+data.r.imgs[0].file);
                            $('.image-title.galleryItemEdit[data-seq="' + data.r.id + '"]').text(data.r.title);

                            setTimeout(function() {
                                if(typeof MODE == "undefined") ;
                                else {
                                    if(go) {
                                        var block = ($('.el_1').length) ? '.el_1' : '.default_project_contents',
                                            menuPage = PAGE.split(',');
                                        if(VIEW) {
                                            location.href = '/'+CONFIG_URL+'config/page/'+menuPage[0]+'/view/'+data.r.id;
                                        } else {
                                            $.cookie('product-detail', true, { expires: 60*60, path : '/' });
                                            location.href = '/'+CONFIG_URL+'config/page/'+menuPage[0]+'/view/'+data.r.id;
                                        }

                                    } else {
                                        showPageCallback(showPage);
                                        $.processOFF();
                                        $.products.close();
                                        if($('.gallery-modal').length)
                                            $.gallery.show($.gallery.block_id);
                                    }
                                }
                            },2000);
                        }
                    }, 'json');
                }
            }
        },
        close : function() {
            if($('.prod-modal').length) {
                $('.prod-modal').fadeOut(300, function() {
                    $(this).remove();
                });
            }
        }
    }

    var clicking = false;
    $.gallery = {
        mode : '',
        block_id : '',
        seqs : [],
        copy : [],
        move : [],
        delete : [],
        view_item : 20,
        update : false,
        category : '',
        cates : '',
        drag : '',
        last : '',
        reset : function() { $.gallery.move = []; $.gallery.copy = []; $.gallery.seqs = []; },
        init : function() {
            $(window).resize(function(e) { 
                if($('.gallery-items').length == 0) return;
                resizeGalleryModal();
            });

            $(document).bind('cut', '.gallery-modal', function(e) {
                $.gallery.move = $.gallery.seqs;
                $.gallery.seqs = [];
                $.each($.gallery.move, function(i,v) {
                    $('.gallery-items .item[data-seq="' + v + '"]').removeClass('copy').addClass('move');
                    $('.gallery-items .toolbar.mod-gallery').remove();
                });
            });

            $(document).bind('copy', '.gallery-modal', function(e) {
                $.gallery.copy = $.gallery.seqs;
                $.gallery.seqs = [];
                $.each($.gallery.copy, function(i,v) {
                    $('.gallery-items .item[data-seq="' + v + '"]').removeClass('move').addClass('copy');
                    $('.gallery-items .toolbar.mod-gallery').remove();
                });
            });

            $(document).bind('paste', '.gallery-modal', function(e) {
                if($('.gallery-modal').length == 0 || $('.galleryController').length) return;
                if(($.gallery.copy).length) $.gallery.cp();
                if(($.gallery.move).length) $.gallery.mv();
            });

            $(document).bind('keydown', 'ctrl+a', function(e) { 
                if(e.ctrlKey && $('.prod-modal').length == 0 && $('.galleryController').length == 0) {
                    if(e.keyCode == 65 || e.keyCode == 85) {
                        $.gallery.seqs = [];
                        var group = ($('.table-item').length) ? '.table-item' : '.gallery-items .item';
                        $(group).removeClass('ui-selected return');
                        $.each($(group), function(i,v) {
                            $('.td-check > input').prop('checked',true);
                            $.gallery.seqs.push($(v).attr('data-seq'));
                            $(v).addClass('ui-selected');
                        });
                        $('.col-check > input').prop('checked',true);
                        $.gallery.setNumber();
                        stickyToolbar();
                        return false;
                    }
                }
            });
            $(document).on('click','.gallery-category > .category-text', function(e) {
                var s = $(this).text().trim(),
                    pid = $('.gallery-modal').attr('data-pid');
                $.gallery.show(pid,1,s);
            });

            $(document).on('click', '.gallery-modal', function(e) {
                $(this).find('.gallery-items .toolbar.mod-gallery').remove();
                if($.gallery.mode == 'shopping') {
                    if(e.target.className.indexOf('ui-selectable') === -1) {
                        $('.gallery-items .table-item').removeClass('ui-selected return');
                        $('.table-toolbar > li').removeClass('open');
                        $('.table-toolbar .toolbar-cmd').addClass('hide');
                        $('.gallery-items .table-item > div').removeClass('hide-text');
                        $('.gallery-items .table-item input').prop('checked',false);
                        $('.table-col').css('z-index','2').css('width','100%');
                        $('.col-check > input').prop('checked',false);
                    }
                } else {
                    if(e.target.className.indexOf('item') === -1) {
                        $.gallery.seqs = [];
                        $('.gallery-items .item').removeClass('ui-selected return');    
                        $('.gallery-toolbar').empty();
                    } else {

                    }
                }
                $('.toolbar-sort').removeClass('open');
                $('.gallery-view-count').removeClass('open').find('.view-submenu').hide();
                // $('.table-toolbar > li').addClass('disabled').removeClass('open');
                $('.gallery-blocks .btn-group').removeClass('open');
            });

            $(document).on('mousemove', '.gallery-modal', function(e) {
                if($(".item-title").is(":focus")) return;
                if($('.gallery-modal .clone-item').length) {
                    $('.gallery-modal .clone-item').css({
                        'left' : e.pageX+10,
                        'top' : e.pageY+10
                    }).attr('data-count',($.gallery.seqs).length).find('input').remove();
                    if(($.gallery.seqs).length >1) $('.gallery-modal .clone-item').addClass('multi');
                    $('.gallery-items .table-item').removeClass('prev last');
                    if(window.innerHeight-80 < e.pageY) $('.gallery-modal').scrollTop($('.gallery-modal').scrollTop() + 30);
                    if(e.pageY < 80) $('.gallery-modal').scrollTop($('.gallery-modal').scrollTop() - 30);
                }
                if($('.ui-selectable-helper').length == 0) return;
                if(e.target.className.match(/(gallery-items ui-selectable|item-ctrl|img-responsive|ui-selected|ui-selectee|item-title|table-item|td-handle|item-handle|td-check|td-input|td-check|td-number|td-title|td-edit|td-img|info-link|td-edut|td-category|td-price|td-quantity)/)) { 
                    $('.gallery-modal, .gallery-items-loadmore, .gallery-category, .gallery-category li, .checkbox label, .gallery-toolbar .toolbar li, .btn, .gallery-button li').removeClass('not-allowed');
                } else {
                    $('.gallery-modal, .gallery-items-loadmore, .gallery-category, .gallery-category li, .checkbox label, .gallery-toolbar .toolbar li, .btn, .gallery-button li').addClass('not-allowed');
                }
            }).on('mouseup', function(e) {
                if($('.gallery-modal .clone-item').length) {
                    $('.gallery-modal .clone-item').remove();
                    $('.gallery-items .item').removeClass('prev last drag');
                    $('.gallery-items .table-item').removeClass('prev last drag');
                    clicking = false;
                }
                // $('.gallery-items').selectable('enable');
                $('.gallery-modal, .gallery-items-loadmore, .gallery-category, .gallery-category li, .checkbox label, .gallery-toolbar .toolbar li, .btn, .gallery-button li').removeClass('not-allowed');
                stickyToolbar();
            });
            $(document).on('mousedown','.gallery-items',function(e) {
                // $('.gallery-items').selectable('enable');
            });
            $(document).on('mouseup','.gallery-items',function(e) {
                var group = ($('.table-item').length) ? '.table-item' : '.gallery-items .item';
                if($(group + '.ui-selected').length == 0 && $(group).length) {
                    if($.gallery.mode == 'shopping') {
                        $('.gallery-items .table-item').removeClass('ui-selected return');
                        $('.table-toolbar > li').removeClass('open').find('.item-submenu').hide();
                        $('.gallery-view-count').removeClass('open').find('.view-submenu').hide();
                        $('.table-toolbar .toolbar-cmd').addClass('hide');
                        $('.gallery-items .table-item > div').removeClass('hide-text');
                        $('.gallery-items .table-item input').prop('checked',false);
                        $('.table-col').css('z-index','2').css('width','100%');
                        $('.col-check > input').prop('checked',false);
                    } else {
                        $.gallery.seqs = [];
                        $('.gallery-items .item').removeClass('ui-selected return');    
                        $('.gallery-toolbar').empty();
                    }
                }
                $('.ui-selectable-helper').removeClass('hide');
                // $(".gallery-items").selectable("enable");
                if($.gallery.seqs.length && ($('.gallery-items .item').hasClass('prev') || $('.gallery-items .item').hasClass('last'))) {
                    if($('.gallery-items .item.last').length) {
                        if($('.gallery-items .item.last').next().length) {
                            $.gallery.drag = $('.gallery-items .item.last').next().attr('data-seq');
                        } else {
                            $.gallery.drag = $('.gallery-items .item.last').attr('data-seq');
                            $.gallery.last = '-1';
                        }
                    } else if($('.gallery-items .item.prev').length) {
                        $.gallery.drag = $('.gallery-items .item.prev').attr('data-seq');
                    }
                    $('.gallery-modal .clone-item').remove();
                    $('.gallery-items .item').removeClass('prev drag last');

                    $.gallery.move = $.gallery.seqs;
                    $.gallery.mv();
                }
                if(e.target.className.indexOf('gallery-items') > -1) {
                    $.each($('.item-title'), function(i,v) {
                        if($(this).is(':focus')) {
                            console.log('ok');
                            $(this).blur();
                        }
                    });
                }
            });

            var isDragging = false;
            var startingPos = [];
            $(document).on('mousedown','.gallery-items .table-item',function(e) {
                isDragging = false;
                clicking = true;
                startingPos = [e.pageX, e.pageY];

                if(e.shiftKey) {
                    var seq_start = $('.gallery-items .table-item[data-seq="' + $.gallery.seqs[0] + '"]').index(),
                        seq_end = $(this).index();
                    $.gallery.seqs = [];
                    $('.gallery-items .item').removeClass('ui-selected return');
                    console.log(seq_start,seq_end);
                    var start = 0, end = 0;
                    if(seq_start<seq_end) {
                        for(var i=seq_start; i<=seq_end; i++) {
                            var $shifted_item = $('.gallery-items .table-item');
                            $shifted_item.eq(i).addClass('ui-selected');
                            // $.gallery.seqs.push($shifted_item.eq(i).attr('data-seq'));
                        }
                    } else {
                        for(var i=seq_start; i>=seq_end; i--) {
                            var $shifted_item = $('.gallery-items .table-item');
                            $shifted_item.eq(i).addClass('ui-selected');
                            // $.gallery.seqs.push($shifted_item.eq(i).attr('data-seq'));
                        }
                    }
                    stickyToolbar();
                }
            });

            $(document).on('mousedown','.gallery-items .item',function(e) {
                if($('.item-title').is(':focus')) return;
                isDragging = false;
                clicking = true;
                startingPos = [e.pageX, e.pageY];
                $('.gallery-modal .clone-item').remove();
                if(e.target.className.indexOf('item') === 0) {
                    $(".ui-selectable-helper").addClass('hide');
                    $(".gallery-items").selectable("disable");
                }

                $('.gallery-blocks .btn-group').removeClass('open');
                var key = e.keyCode || e.which,
                    seq = $(this).attr('data-seq'),
                    seq_idx = ($.gallery.seqs).indexOf(seq);

                if(e.ctrlKey) {
                    if(seq_idx > -1) {
                        $(this).removeClass('ui-selected return');
                        // ($.gallery.seqs).splice(seq_idx,1);
                    } else {
                        $(this).addClass('ui-selected');
                        // $.gallery.seqs.push(seq);
                    }
                    $.gallery.selected();
                    stickyToolbar();
                } else if(e.shiftKey) {
                    if(($.gallery.seqs).length > 0) {
                        var seq_start = $('.gallery-items .item[data-seq="' + $.gallery.seqs[0] + '"]').index(),
                            seq_end = $(this).index();
                        $.gallery.seqs = [];
                        $('.gallery-items .item').removeClass('ui-selected return');
                        console.log(seq_start,seq_end);
                        var start = 0, end = 0;
                        if(seq_start<seq_end) {
                            for(var i=seq_start; i<=seq_end; i++) {
                                var $shifted_item = $('.gallery-items .item');
                                $shifted_item.eq(i).addClass('ui-selected');
                                // $.gallery.seqs.push($shifted_item.eq(i).attr('data-seq'));
                            }
                        } else {
                            for(var i=seq_start; i>=seq_end; i--) {
                                var $shifted_item = $('.gallery-items .item');
                                $shifted_item.eq(i).addClass('ui-selected');
                                // $.gallery.seqs.push($shifted_item.eq(i).attr('data-seq'));
                            }
                        }
                        $.gallery.selected();
                        stickyToolbar();
                    }
                } else {
                    if(!$(this).hasClass('ui-selected')) {
                        $.gallery.seqs = []; 
                        $.gallery.seqs.push(seq);
                        $('.gallery-items .item').removeClass('ui-selected return');
                        // $(this).parent().removeClass('move').removeClass('copy');
                        $(this).addClass('ui-selected');
                        stickyToolbar();

                        // cut, copy remove
                        var i = ($.gallery.copy).indexOf(seq);
                        if(i !== -1) ($.gallery.copy).splice(i,1);

                        var i = ($.gallery.move).indexOf(seq);
                        if(i !== -1) ($.gallery.move).splice(i,1);
                    }
                }
            });
            $(document).on('mousedown','.gallery-items .td-handle',function(e) {
                // if($('.gallery-items .table-item.ui-selected').length == 0) {
                if($(this).parent().hasClass('ui-selected') == false) {
                    $(this).parent().addClass('ui-selected').find('.td-check input').prop('checked',true);
                    $.gallery.seqs.push($(this).parent().attr('data-seq'));
                }
            });
            $(document).on('mousemove','.gallery-items .table-item',function(e) {
                if(clicking === false) return;
                $('.gallery-items .table-item').removeClass('prev');

                if($('.gallery-modal .clone-item').length) {
                    var $clone = $('.gallery-modal .clone-item');
                    $clone.css({
                        'position' : 'fixed',
                        'cursor' : 'move',
                        'z-index' : '1090'
                    });
                    $clone.css({
                        'left' : e.pageX+10,
                        'top' : e.pageY+10
                    }).attr('data-count',($.gallery.seqs).length).find('input').remove();
                    if(($.gallery.seqs).length >1) $clone.addClass('multi');

                    var this_top = e.pageY - $(this).offset().top;
                    if($(this).is(':last-child') && this_top > 45) {
                        $(this).removeClass('prev').addClass('last');
                    } else $(this).removeClass('last').addClass('prev');
                    if(window.innerHeight-80 < e.pageY) $('.gallery-modal').scrollTop($('.gallery-modal').scrollTop() + 30);
                    if(e.pageY < 80) $('.gallery-modal').scrollTop($('.gallery-modal').scrollTop() - 30);
                    e.stopPropagation();
                } 
            });
            $(document).on('mousemove','.gallery-items .td-handle',function(e) {
                if(clicking === false || $('.gallery-items .table-item.ui-selected').length == 0) return;
                $('.td-edit .item-edit').css('display','none');
                if ((e.pageX  < startingPos[0]-10 || e.pageX  > startingPos[0]+10) ||
                    (e.pageY  < startingPos[1]-10 || e.pageY  > startingPos[1]+10)) {
                    $('.gallery-items .table-item.ui-selected').addClass('drag');
                    if($('.gallery-modal .clone-item').length == 0) {
                        var $clone = $(this).parent().clone();
                        $clone.css({
                            'position' : 'fixed',
                            'cursor' : 'move',
                            'z-index' : '1090'
                        }).addClass('clone-item').attr('data-count',($.gallery.seqs).length).find('input').remove();
                        $('.gallery-modal').append($clone);

                        $clone.css({
                            'left' : e.pageX+10,
                            'top' : e.pageY+10
                        });
                        if(($.gallery.seqs).length >1) $clone.addClass('multi');
                    } 
                    isDragging = true;
                    // var parentOffset = $(this).parent().offset(); 
                    // var relX = e.pageX - parentOffset.left;
                    // var relY = e.pageY - parentOffset.top;
                    // $('.gallery-items .item').removeClass('prev last');
                    // var this_top = $(this).position().top,
                    //     next_top = ($(this).next().length) ? $(this).next().position() : -1;
                    // console.log(parentOffset);
                    // if(this_top == next_top) {
                    //     (relX - $(this).position().left < 62) ? $(this).addClass('prev') : $(this).next().addClass('prev');
                    // } else {
                    //     (relX - $(this).position().left < 62) ? $(this).addClass('prev') : $(this).addClass('last');
                    // }
                }
            });
            $(document).on('mousemove','.gallery-items .item',function(e) {
                if(clicking === false || $('.item-title').is(':focus')) return;
                if ((e.pageX  < startingPos[0]-10 || e.pageX  > startingPos[0]+10) ||
                    (e.pageY  < startingPos[1]-10 || e.pageY  > startingPos[1]+10)) {
                    $('.gallery-items .item.ui-selected').addClass('drag');
                    if($('.gallery-modal .clone-item').length == 0) {
                        var $clone = $(this).clone();
                        $clone.css({
                            'position' : 'fixed'
                        }).addClass('clone-item').attr('data-count',($.gallery.seqs).length).find('input').remove();
                        $('.gallery-modal').append($clone);
                        if(($.gallery.seqs).length >1) $clone.addClass('multi');
                    } 
                    isDragging = true;
                    var parentOffset = $(this).parent().offset(); 
                    var relX = e.pageX - parentOffset.left;
                    var relY = e.pageY - parentOffset.top;
                    $('.gallery-items .item').removeClass('prev last');
                    var this_top = $(this).position().top,
                        next_top = ($(this).next().length) ? $(this).next().position() : -1;
                    if(this_top == next_top) {
                        (relX - $(this).position().left < 62) ? $(this).addClass('prev') : $(this).next().addClass('prev');
                    } else {
                        (relX - $(this).position().left < 62) ? $(this).addClass('prev') : $(this).addClass('last');
                    }
                }
            });
            $(document).on('mouseup','.gallery-items .table-item',function(e) {
                e.preventDefault();
                clicking = false;
                if (isDragging) {
                    if($.gallery.seqs.length && $('.gallery-modal .clone-item').length) {
                        if($('.gallery-items .table-item.last').length) {
                            if($('.gallery-items .table-item.last').next().length) {
                                $.gallery.drag = $('.gallery-items .table-item.last').next().attr('data-seq');
                            } else {
                                $.gallery.drag = $('.gallery-items .table-item.last').attr('data-seq');
                                $.gallery.last = '-1';
                            }
                        } else if($('.gallery-items .table-item.prev').length) {
                            $.gallery.drag = $('.gallery-items .table-item.prev').attr('data-seq');
                        }
                        $('.gallery-modal .clone-table-item').remove();
                        $('.gallery-items .table-item').removeClass('prev drag last');

                        $.gallery.move = $.gallery.seqs;
                        $.gallery.mv();
                    }
                } else {
                    var parentOffset = $(this).parent().offset(),
                        relX = e.pageX - parentOffset.left,
                        relY = e.pageY - parentOffset.top;
                    $('.gallery-items .table-item.ui-selecting').removeClass('active').addClass('ui-selected');
                    stickyToolbar();
                }
                isDragging = false;
                startingPos = [];

                var l = ($(this).index()%7 > 3) ? 'right' : '',
                    mode = $('.gallery-add-items').attr('data-mode');

                if(typeof mode == "undefined" || !mode) {
                    alert('Undefined gallery mode');
                    return false;
                }                        
                $.gallery.setNumber();     
                $('.ui-selectable-helper').removeClass('hide');
                $(".gallery-items").selectable("enable");
            });

            $(document).on('mouseup','.gallery-items .item',function(e) {
                e.preventDefault();
                clicking = false;
                if (isDragging) {
                    if($.gallery.seqs.length && $('.gallery-modal .clone-item').length) {
                        if($('.gallery-items .item.last').length) {
                            if($('.gallery-items .item.last').next().length) {
                                $.gallery.drag = $('.gallery-items .item.last').next().attr('data-seq');
                            } else {
                                $.gallery.drag = $('.gallery-items .item.last').attr('data-seq');
                                $.gallery.last = '-1';
                            }
                        } else if($('.gallery-items .item.prev').length) {
                            $.gallery.drag = $('.gallery-items .item.prev').attr('data-seq');
                        }
                        $('.gallery-modal .clone-item').remove();
                        $('.gallery-items .item').removeClass('prev drag last');

                        $.gallery.move = $.gallery.seqs;
                        $.gallery.mv();
                    }
                } else {
                    var parentOffset = $(this).parent().offset(),
                        relX = e.pageX - parentOffset.left,
                        relY = e.pageY - parentOffset.top;
                    $('.gallery-items .item.ui-selecting').removeClass('active').addClass('ui-selected');
                    stickyToolbar();
                }
                isDragging = false;
                startingPos = [];

                var l = ($(this).index()%7 > 3) ? 'right' : '',
                    mode = $('.gallery-add-items').attr('data-mode');

                if(typeof mode == "undefined" || !mode) {
                    alert('Undefined gallery mode');
                    return false;
                }                        
                $.gallery.toolbar();
                
                $.gallery.setNumber();     
                $('.ui-selectable-helper').removeClass('hide');
                // $(".gallery-items").selectable("enable");
            });

            $(document).on('click','.gallery-controller',function(e) { 
                $.gallery.show($.gallery.block_id);
            });
            $(document).on('click','.gallery-all',function(e) { 
                $.gallery.show($.gallery.block_id);
            });
            $(document).on('click','.gallery-button .modal-close', function(e) {
                $.gallery.close();
            });
            $(document).on('keyup','.item-title', function(e) {
                if(e.keyCode == 13) $('#empty-text').focus().blur();
            });
            $(document).on('mouseenter', '.gallery-items .item > img', function(e) {
                // e.stopPropagation();
                $('.gallery-items .item .gallery-paste-icon').remove();
                var s = '<div class="item-ctrl"></div>',
                    $ctrl = $(s);
                if($(this).parent().find('.item-ctrl').length == 0)
                    $(this).parent().append($ctrl);
            });
            $(document).on('mouseleave', '.gallery-items .item', function(e) {
                $(this).find('.item-ctrl').remove();
                $('.gallery-paste-icon').remove();
            });

            $(document).on('click','.gallery-items .item .gallery-paste-icon', function(e) {
                e.stopPropagation();
                ($.gallery.seqs).push($(this).parents('.item').attr('data-seq'));
                if(($.gallery.copy).length) $.gallery.cp();
                if(($.gallery.move).length) $.gallery.mv();
            });

            $(document).on('click', '.gallery-items .item input', function(e) {
                e.stopPropagation();
                $('.gallery-items .toolbar.mod-gallery').remove();
            });

            $(document).on('keypress click', '.gallery-items .item .item-ctrl', function(e) {
                $('.gallery-blocks .btn-group').removeClass('open');
                var key = e.keyCode || e.which,
                    seq = $(this).parent().attr('data-seq'),
                    seq_idx = ($.gallery.seqs).indexOf(seq);
                if(e.ctrlKey) {
                    if(seq_idx > -1) {
                        $(this).parents().removeClass('ui-selected');
                        ($.gallery.seqs).splice(seq_idx,1);
                    } else {
                        $(this).parent().addClass('ui-selected');
                        $.gallery.seqs.push(seq);
                    }
                } else if(e.shiftKey) {
                    if(($.gallery.seqs).length > 0) {
                        var seq_start = $('.gallery-items .item[data-seq="' + $.gallery.seqs[0] + '"]').index(),
                            seq_end = $(this).parent().index();
                        $.gallery.seqs = [];
                        $('.gallery-items .item').removeClass('ui-selected');
                        console.log(seq_start,seq_end);
                        var start = 0, end = 0;
                        if(seq_start<seq_end) {
                            for(var i=seq_start; i<=seq_end; i++) {
                                var $shifted_item = $('.gallery-items .item');
                                $shifted_item.eq(i).addClass('ui-selected');
                                $.gallery.seqs.push($shifted_item.eq(i).attr('data-seq'));
                            }
                        } else {
                            for(var i=seq_start; i>=seq_end; i--) {
                                var $shifted_item = $('.gallery-items .item');
                                $shifted_item.eq(i).addClass('ui-selected');
                                $.gallery.seqs.push($shifted_item.eq(i).attr('data-seq'));
                            }
                        }
                    }
                } else {
                    $.gallery.seqs = []; 
                    $.gallery.seqs.push(seq);
                    $('.gallery-items .item').removeClass('ui-selected return');
                    // $(this).parent().removeClass('move').removeClass('copy');
                    $(this).parent().addClass('ui-selected');

                    // cut, copy remove
                    var i = ($.gallery.copy).indexOf(seq);
                    if(i !== -1) ($.gallery.copy).splice(i,1);

                    var i = ($.gallery.move).indexOf(seq);
                    if(i !== -1) ($.gallery.move).splice(i,1);
                }
                var l = ($(this).index()%7 > 3) ? 'right' : '',
                    mode = $('.gallery-add-items').attr('data-mode');

                if(typeof mode == "undefined" || !mode) {
                    alert('Undefined gallery mode');
                    return false;
                }
                $(this).parents('.gallery-items').find('.toolbar.mod-gallery').remove();
                // var str = '', cmd = '';
                // if(($.gallery.move).length || ($.gallery.copy).length) {
                //     str = '붙여넣기'; cmd = 'paste';
                // } else {
                //     str = '잘라내기'; cmd = 'move';
                // }

                var seq = $(this).parent().attr('data-seq'),
                    pid = $(this).parent().attr('data-pid'),
                    link = $(this).parent().attr('data-link'),
                    target = $(this).parent().attr('data-target'),
                    visible = $(this).parent().attr('data-visible');

                var vstr = (visible == "1") ? $.lang[LANG]["editor.gallery.icon.visible.on"] : $.lang[LANG]["editor.gallery.icon.visible.off"],
                    vicon = (visible == "1") ? 'cl_icon_hide02' : 'cl_icon_show';
                var s = '\
                    <ul>\
                        <li class="active gallery-item-edit">\
                            <i class="" data-glseq="' + seq + '" data-cmd="edit"></i>' + $.lang[LANG]['editor.block.gallery.item.edit'] + '\
                        </li>\
                    ';
                if($.gallery.category == '') 
                    s = s + '<li><i class="" data-glseq="' + seq + '" data-cmd="copy"></i>' + $.lang[LANG]['editor.gallery.icon.clone'] + '</li>';

                s = s + '<li class="toolbar-sort item-sort">' + $.lang[LANG]['editor.gallery.icon.order'] + ' <i class="fa fa-caret-down" aria-hidden="true" data-glseq="" data-cmd="item-sort"></i>\
                            <ul class="item-submenu">\
                                <li class="sort-top">' + $.lang[LANG]['editor.gallery.icon.order.front'] + '</li>\
                                <li class="sort-bottom">' + $.lang[LANG]['editor.gallery.icon.order.end'] + '</li>\
                            </ul>\
                        </li>';
                s = s + '<li class="toolbar-category"><i class="" data-glseq="" data-cmd="category"></i>' + $.lang[LANG]['editor.block.gallery.category.change'] + ' <i class="fa fa-caret-down" aria-hidden="true"></i>';
                s = s + '<ul class="item-submenu">' + $.gallery.cates + '</ul>';
                s = s + '</li>';
                
                s = s + '\
                        <li><i class="" data-glseq="' + seq + '" data-glink="' + link + '" data-glink-target="' + target + '" data-cmd="link"></i>' + $.lang[LANG]['editor.gallery.icon.link'] + '</li>\
                ';
                // if($.gallery.category == '') 
                //     s = s + '<li><i class="" data-glseq="' + seq + '" data-cmd="' + cmd + '"></i>' + str + '</li>';
                        
                s = s + '\
                        <li><i class="" data-glseq="' + seq + '" data-visible="' + visible + '" data-cmd="visible">' + vstr + '</i></li>\
                        <li><i class="" data-glseq="' + seq + '" data-cmd="delete"></i>' + $.lang[LANG]['editor.gallery.icon.delete'] + '</li>\
                    </ul>\
                ';
                var $tool_back = $('<div class="toolbar mod-gallery ' + l + '">' + s + '</div>');
                $(this).parents('.container').find('.gallery-toolbar').empty();
                $(this).parents('.container').find('.gallery-toolbar').append($tool_back);
                
                // $(this).parent().prev().append($tool_back);
                $.gallery.selected();
                stickyToolbar();
                $.gallery.setNumber();
            });

            $(document).on('click','.gallery-modal .check-all', function(e) {
                e.stopPropagation();
                var check = $(this).prop('checked');
                if(check) {
                    $('.table-item .td-check input').prop('checked',true);
                    $('.table-item').addClass('ui-selected');
                    $.each($('.table-item'), function(i,v) {
                        $.gallery.seqs.push($(this).attr('data-seq'));
                    });
                    $('.gallery-toolbar .toolbar-cmd').removeClass('hide');
                    $('.table-col').css('z-index','1').css('width','100%');
                    $('.check-all').prop('checked',true);
                    stickyToolbar();
                } else {
                    $('.table-item .td-check input').prop('checked',false);   
                    $('.table-item').removeClass('ui-selected return');
                    $('.gallery-toolbar .toolbar-cmd').addClass('hide');
                    $('.table-col').css('z-index','2').css('width','100%');
                    $('.check-all').prop('checked',false);
                    $.gallery.seqs = [];
                }
                $.gallery.setNumber();
            });
            $(document).on('click','.gallery-view-count', function(e) {
                e.stopPropagation();
                $(this).toggleClass('open');
                if($(this).hasClass('open')) {
                    console.log('..');
                    $(this).find('.view-submenu').show();
                } else $(this).find('.view-submenu').hide();
            });
            $(document).on('click','.gallery-view-count li', function(e) {
                $('.gallery-view-count li').removeClass('active');
                $(this).addClass('active');
            });
            $(document).on('click', '.gallery-modal .toolbar li', function(e) {
                e.stopPropagation();
                var cmd = $(this).find('i').attr('data-cmd'),
                    mode = $('.gallery-add-items').attr('data-mode'),
                    seq = $(this).find('i').attr('data-glseq');

                if($(this).hasClass('disabled')) {
                    if($(this).hasClass('gallery-item-edit')) {
                        $(this).showModalFlat('INFORMATION', "여러 개의 컨텐츠가 선택된 상태에서는 편집을 할 수 없습니다.<br>한 개의 컨텐츠만 선택 후 다시 시도해주세요", true, false, '', 'ok');
                    }
                    return false;
                }
                if(($.gallery.seqs).length == 0 && cmd != 'checkall') {
                    $(this).showModalFlat('INFORMATION', $.lang[LANG]["editor.gallery.select.item"], true, false, '', 'ok');
                    return false;
                }
                switch(cmd) {
                    case "item-sort":
                        break;
                    case "category":
                        $(this).toggleClass('open');
                        if($(this).hasClass('open')) {
                            $(this).find('.item-submenu').show();
                        } else $(this).find('.item-submenu').hide();
                        $('.toolbar-sort').removeClass('open');
                        $('.toolbar-sort .item-submenu').hide();
                        if(($.gallery.seqs).length == 1) {
                            var s = ($('.table-item').length) ? $('.table-item[data-seq="' + $.gallery.seqs[0] + '"]').attr('data-category') : $('.gallery-items .item[data-seq="' + $.gallery.seqs[0] + '"]').attr('data-category');
                            if(s) {
                                var c = s.substring(1, s.length-1),
                                    a = c.split('|,|');
                                if(a.length) {
                                    $.each(a, function(i,v) {
                                        $('.toolbar-category .item-submenu li:contains("' + v + '")').addClass('active');
                                    });
                                }
                            }
                        } else {
                            $('.toolbar-category .item-submenu li').removeClass('active');
                        }
                        break;
                    case "checkall": 
                        var check = $(this).find('input').prop('checked');
                        if(check) {
                            $('.table-item input').prop('checked',true);
                            $('.table-item').addClass('ui-selected');
                            $.each($('.table-item'), function(i,v) {
                                $.gallery.seqs.push($(this).attr('data-seq'));
                            });
                            stickyToolbar();
                        } else {
                            $('.table-item input').prop('checked',false);   
                            $('.table-item').removeClass('ui-selected return');
                            $.gallery.seqs = [];
                        }
                        break;
                    case "edit": 
                        ($.gallery.mode == 'shopping') ? $.products.add(seq) : galleryItemController(seq); break;
                    case "copy": 
                        $.gallery.copy = $.gallery.seqs; $.gallery.move = []; $.gallery.delete = [];  $.gallery.seqs = [];
                        $('.gallery-items .item').removeClass('move');
                        $('.gallery-items .toolbar.mod-gallery').remove();
                        $.gallery.cp();
                        break;
                    case "move":
                        $.gallery.move = $.gallery.seqs; $.gallery.copy = []; $.gallery.delete = []; $.gallery.seqs = [];
                        $('.gallery-items .item').removeClass('copy');
                        $('.gallery-items .toolbar.mod-gallery').remove();
                        break;
                    case "paste":
                        if(($.gallery.copy).length) $.gallery.cp();
                        if(($.gallery.move).length) $.gallery.mv();
                        break;
                    case "delete":
                        $.gallery.delete = $.gallery.seqs; $.gallery.move = []; $.gallery.copy = [];
                        $('.gallery-items .toolbar.mod-gallery').remove();
                        $.gallery.del();
                        break;
                    case "visible":
                        var seq = $(this).find('i').attr('data-glseq'),
                            visible = $(this).find('i').attr('data-visible');
                        visible = (visible == 1) ? 0 : 1;

                        $.post('/template/gallery/visible', { s: $.gallery.seqs, view: visible }, function (data) {
                            checkError(data);
                        },'json');
                        // showPageCallback(showPage);
                        var type = getElementType(),
                            checked = (visible) ? false : true;
                        setLogs(type,"gallery.item.visible."+checked,"visible-"+checked,type);

                        $.each($.gallery.seqs, function(i,v) {
                            if($('.table-item').length) {
                                (visible == "1") ? $('.gallery-items .table-item[data-seq="' + v + '"]').addClass('invisible').attr('data-visible','1')
                                                 : $('.gallery-items .table-item[data-seq="' + v + '"]').removeClass('invisible').attr('data-visible','0');
                            } else {
                                (visible == "1") ? $('.gallery-items .item[data-seq="' + v + '"]').addClass('invisible').attr('data-visible','1')
                                                 : $('.gallery-items .item[data-seq="' + v + '"]').removeClass('invisible').attr('data-visible','0');
                            }
                        });

                        (visible == "1") ? $(this).find('i').attr('data-visible','1') : $(this).find('i').attr('data-visible','0');
                        (visible == "1") ? $('.gallery-modal .toolbar li > i[data-cmd="visible"]').text($.lang[LANG]["editor.gallery.icon.visible.on"])
                                         : $('.gallery-modal .toolbar li > i[data-cmd="visible"]').text($.lang[LANG]["editor.gallery.icon.visible.off"]);
                        // $('.gallery-items .toolbar').empty();
                        // galleryStatusInit();
                        $.gallery.update = true;
                        // $.gallery.reset();

                        break;
                    case "link":
                        var config_icon = ($(this).hasClass('gl-item-link')) ? 'gl-item-link' : 'gallery-item-link-icon',
                            seq = $(this).find('i').attr('data-glseq'),
                            glink = $(this).find('i').attr('data-glink'),
                            is_glink_target = $(this).find('i').attr('data-glink-target'),
                            glmode = $('.gallery-modal').attr('data-mode'),
                            glpid = $('.gallery-modal').attr('data-pid'),
                            glel = $('.'+selectEL),
                            prev_glink = '', input_glink = '',
                            target_check = (typeof is_glink_target != 'undefined' && is_glink_target == '_blank') ? 'checked' : '',
                            link_content = '';

                        var group = ($('.table-item').length) ? '.table-item' : '.gallery-items .item';
                        $select_glink = $('.gallery-item[data-seq="'+seq+'"]').find('a');
                        if(typeof glink != 'undefined' && glink) {
                            if($select_glink.attr('data-user-link')) {
                                prev_glink = glink;
                            } else if ($select_glink.attr('attr-bookmark')) {
                                prev_glink = $select_glink.attr('href');
                            } else if ($select_glink.attr('attr-link')) {
                                prev_glink = $select_glink.attr('attr-link');
                            } else {
                                prev_glink = glink;
                            }
                        }

                        link_content = '<ul class="link-content gallery" data-type="' + glmode + '" data-name="' + glel.attr('data-name') + '">\
                                        ' + makeLinkList(SMENU,"gallery",glel.attr("data-name"),glink);
                        link_content = link_content + '\
                            </ul>\
                            <div class="link-target">\
                                <span>'+ $.lang[LANG]['editor.link.open.target'] +'</span><input type="checkbox" class="img-link-target" id="linktarget-onoff" '+target_check+' data-el="'+selectEL+'" />\
                            </div>\
                        \
                        ';

                        var modal = $(this).showModalFlat('GALLERY LINK', link_content, true, true, function() {
                            var input_type = $('.link-content').find('.link-type.active').children().attr('class');
                            var result = getInputLink(input_type);
                                link = result[0], isOkay = result[1], isActive = result[2], 
                                target_val = '', target_change = '';

                            target_val = ($('#linktarget-onoff').prop('checked')) ? '_blank' : '';
                            target_change = (((target_check=='checked') ? 'on' : 'off') == ((target_val=='_blank') ? 'on' : 'off')) ? false : true;

                            if(isOkay) {
                                $.each($.gallery.seqs, function(i,v) {
                                    if((isActive && prev_glink==link || isActive==false && prev_glink=='') && !target_change && ($.gallery.seqs).length == 1) {
                                        modal.modal('hide'); 
                                        return true;
                                    }

                                    var gsettings = {
                                        'glink' : Base64.encode(link),
                                        'glink_target' : target_val
                                    }
                                    $.post('/template/settings', {sid: SID, settings: JSON.stringify(gsettings), el: 'gallery_settings', seq: v}, function(data) {
                                        checkError(data);

                                        $select_glink.removeAttr('data-gallery').removeAttr('data-user-link').removeAttr('attr-link').removeAttr('attr-bookmark');
                                        $select_glink_config = $('#el-property[data-element="'+selectEL+'"] #gallery-list-config');

                                        if(link) {
                                            var gallery_link = makeLinkUrl(link, ONE, VIEW);

                                            $select_glink.attr('href',gallery_link);
                                            if(MENULIST.includes(link.replace(/ /g,'-'))) {
                                                $select_glink.attr('data-user-link',gallery_link);
                                            } else if(link.match(/^\@/g) !== null) {
                                                $select_glink.attr('attr-bookmark',link.replace(/^\@/g,''));
                                            } else {
                                                $select_glink.attr('attr-link',link);
                                            }

                                            $select_glink_config.find('.gl-item-link[data-glseq="'+v+'"]').attr('data-glink',link).addClass('active');
                                            if(config_icon == 'gallery-item-link-icon') $('.gallery-item-link-icon[data-glseq="'+v+'"]').attr('data-glink',link);
                                            
                                        } else {
                                            $select_glink_config.find('.gl-item-link[data-glseq="'+v+'"]').attr('data-glink',link).removeClass('active');
                                            if(config_icon == 'gallery-item-link-icon') $('.gallery-item-link-icon[data-glseq="'+v+'"]').attr('data-glink',link);
                                            var imgURL =  $('.gallery-item[data-seq="' + v + '"]').find('img').prop('src');
                                            if(glmode == 'gallery' || glmode == 'shopping') {
                                                $('.gallery-item[data-seq="' + v + '"]').find('a').attr({'href': imgURL ,'data-gallery': '#gframe-' + glpid});
                                            } else {
                                                $('.gallery-item[data-seq="' + v + '"]').find('a').removeAttr('data-gallery');
                                                $('.gallery-item[data-seq="' + v + '"]').find('a').attr('href', '/'+CONFIG_URL+'config/page/' + PAGE + '/view/' + v);
                                            }

                                        }

                                        $(group + '[data-seq="' + v + '"]').attr('data-link',Base64.decode(data.data.glink)).attr('data-target',data.data.glink_target).find('.toolbar li i[data-cmd="link"]').attr('data-glink',data.data.glink).attr('data-glink-target',data.data.glink_target);
                                        $('.toolbar-link i').attr('data-glink',Base64.decode(data.data.glink)).attr('data-glink-target',data.data.glink_target);
                                        $('.cl_icon_link').attr('data-glink',data.data.glink).attr('data-glink-target',data.data.glink_target);

                                        if(data.data.glink == '') {
                                            $('.gallery-items .item[data-seq="' + v + '"]').find('.info').remove();
                                            $('.gallery-items .table-item[data-seq="' + v + '"]').find('.info-link').remove();
                                        }
                                        else {
                                            if($('.gallery-items .item[data-seq="' + v + '"]').find('.info-link').length == 0) {
                                                // $('.gallery-items .item[data-seq="' + v + '"]').find('.info').append('<span class="info-link"><svg class="svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15 15"><path d="M6 9.85c-0.22 0-0.44-0.08-0.6-0.25 -0.33-0.33-0.33-0.87 0-1.2l3-3c0.33-0.33 0.87-0.33 1.2 0 0.33 0.33 0.33 0.87 0 1.2l-3 3C6.44 9.77 6.22 9.85 6 9.85z"/><path d="M3.85 15c-1.03 0-2-0.4-2.72-1.13C0.4 13.15 0 12.18 0 11.15s0.4-2 1.13-2.72l2-2C3.46 6.1 4 6.1 4.33 6.43c0.33 0.33 0.33 0.87 0 1.2l-2 2c-0.41 0.41-0.63 0.95-0.63 1.52s0.22 1.11 0.63 1.52c0.81 0.81 2.23 0.81 3.04 0l2-2c0.33-0.33 0.87-0.33 1.2 0 0.33 0.33 0.33 0.87 0 1.2l-2 2C5.85 14.6 4.88 15 3.85 15z"/><path d="M11.2 8.85c-0.22 0-0.44-0.08-0.6-0.25 -0.33-0.33-0.33-0.87 0-1.2l2.07-2.07c0.41-0.41 0.63-0.95 0.63-1.52s-0.22-1.11-0.63-1.52c-0.81-0.81-2.23-0.81-3.04 0L7.56 4.36c-0.33 0.33-0.87 0.33-1.2 0 -0.33-0.33-0.33-0.87 0-1.2l2.07-2.07c1.45-1.46 3.99-1.46 5.44 0C14.6 1.82 15 2.78 15 3.81s-0.4 2-1.13 2.72L11.8 8.61C11.64 8.77 11.42 8.85 11.2 8.85z"/></svg></span>');
                                                $('.gallery-items .item[data-seq="' + v + '"]').append('<div class="info"><span class="info-link"><svg class="svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15 15"><path d="M6 9.85c-0.22 0-0.44-0.08-0.6-0.25 -0.33-0.33-0.33-0.87 0-1.2l3-3c0.33-0.33 0.87-0.33 1.2 0 0.33 0.33 0.33 0.87 0 1.2l-3 3C6.44 9.77 6.22 9.85 6 9.85z"/><path d="M3.85 15c-1.03 0-2-0.4-2.72-1.13C0.4 13.15 0 12.18 0 11.15s0.4-2 1.13-2.72l2-2C3.46 6.1 4 6.1 4.33 6.43c0.33 0.33 0.33 0.87 0 1.2l-2 2c-0.41 0.41-0.63 0.95-0.63 1.52s0.22 1.11 0.63 1.52c0.81 0.81 2.23 0.81 3.04 0l2-2c0.33-0.33 0.87-0.33 1.2 0 0.33 0.33 0.33 0.87 0 1.2l-2 2C5.85 14.6 4.88 15 3.85 15z"/><path d="M11.2 8.85c-0.22 0-0.44-0.08-0.6-0.25 -0.33-0.33-0.33-0.87 0-1.2l2.07-2.07c0.41-0.41 0.63-0.95 0.63-1.52s-0.22-1.11-0.63-1.52c-0.81-0.81-2.23-0.81-3.04 0L7.56 4.36c-0.33 0.33-0.87 0.33-1.2 0 -0.33-0.33-0.33-0.87 0-1.2l2.07-2.07c1.45-1.46 3.99-1.46 5.44 0C14.6 1.82 15 2.78 15 3.81s-0.4 2-1.13 2.72L11.8 8.61C11.64 8.77 11.42 8.85 11.2 8.85z"/></svg></span></div>');
                                            }
                                            if($('.gallery-items .table-item[data-seq="' + v + '"] .td-img .info-link').length == 0) {
                                                $('.gallery-items .table-item[data-seq="' + v + '"]').find('.td-img').append('<span class="info-link"><svg class="svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15 15"><path d="M6 9.85c-0.22 0-0.44-0.08-0.6-0.25 -0.33-0.33-0.33-0.87 0-1.2l3-3c0.33-0.33 0.87-0.33 1.2 0 0.33 0.33 0.33 0.87 0 1.2l-3 3C6.44 9.77 6.22 9.85 6 9.85z"/><path d="M3.85 15c-1.03 0-2-0.4-2.72-1.13C0.4 13.15 0 12.18 0 11.15s0.4-2 1.13-2.72l2-2C3.46 6.1 4 6.1 4.33 6.43c0.33 0.33 0.33 0.87 0 1.2l-2 2c-0.41 0.41-0.63 0.95-0.63 1.52s0.22 1.11 0.63 1.52c0.81 0.81 2.23 0.81 3.04 0l2-2c0.33-0.33 0.87-0.33 1.2 0 0.33 0.33 0.33 0.87 0 1.2l-2 2C5.85 14.6 4.88 15 3.85 15z"/><path d="M11.2 8.85c-0.22 0-0.44-0.08-0.6-0.25 -0.33-0.33-0.33-0.87 0-1.2l2.07-2.07c0.41-0.41 0.63-0.95 0.63-1.52s-0.22-1.11-0.63-1.52c-0.81-0.81-2.23-0.81-3.04 0L7.56 4.36c-0.33 0.33-0.87 0.33-1.2 0 -0.33-0.33-0.33-0.87 0-1.2l2.07-2.07c1.45-1.46 3.99-1.46 5.44 0C14.6 1.82 15 2.78 15 3.81s-0.4 2-1.13 2.72L11.8 8.61C11.64 8.77 11.42 8.85 11.2 8.85z"/></svg></span>');
                                            }
                                        }
                                        // if(target_change) {
                                        //     if(target_val) $select_glink.attr('target',target_val);
                                        //     else $select_glink.removeAttr('target');
                                        //     // $select_glink_config.find('.gl-item-link[data-glseq="'+seq+'"]').attr('data-glink-target',target_val);
                                        //     // if(config_icon == 'gallery-item-link-icon') $('.gallery-item-link-icon[data-glseq="'+seq+'"]').attr('data-glink-target',target_val);
                                        // }

                                        var log_text = (isActive || !isActive && target_change) ? 'active' : 'broken',
                                            type = getElementType();
                                        setLogs(type,'gallery.link.'+log_text,'link-'+log_text,type);

                                        // galleryStatusInit();
                                    }, 'json');
                                });

                                modal.modal('hide');
                            }
                        }, 'cancel', '', 'w450 modal-portfolio-link');
                        break;
                }
            });

            $(document).on('click','.gallery-add-items', function(e) {
                var mode = $(this).attr('data-mode');
                if(typeof mode == 'undefined' || !mode) {
                    alert('Undefined gallery mode');
                    return false;
                }
                switch(mode) {
                    case 'shopping' : $.products.add(-1); break;
                    default:
                        $('.resource-useit')
                            .removeAttr('data-property')
                            .removeAttr('data-element')
                            .attr('data-replace-count','0');
                        selectCount = 0;
                        selectID = $('.gallery-modal').attr('data-pid');
                        $.resource.open();
                        // galleryController(-1);
                        break;
                }
            });

            $(document).on('blur','.item-title', function(e) {
                var title = $(this).val().trim(),
                    s = $(this).attr('data-title'),
                    seq = $(this).attr('data-seq'),
                    caption = $(this).attr('data-caption'),
                    hashtag = $(this).attr('data-hashtag'),
                    category = $(this).attr('data-category'),
                    datetime = $(this).attr('data-datetime'),
                    thumb = $(this).attr('data-url'),
                    file = (thumb.indexOf('googleusercontent') > -1) ? thumb : thumb.replace(/^.*[\\\/]/, ''),
                    $gitem = $('.'+selectEL).find('.gallery-item[data-seq="'+seq+'"]'),
                    pathinfo = thumb.split('/');

                if(title != s && title) {
                    if(typeof seq == "undefined" || !seq) {
                        alert('Invalid item');
                        return false;
                    }

                    $gitem.find("[data-gallery]").attr({"data-title":title});
                    var type = getElementType(),
                        s = '';
                    if(pathinfo[4]!= 'free') s = 'false';
                    else {
                        var p = pathinfo.slice(1,6);
                        p.unshift('');
                        p.push('');
                        s = p.join('/');
                    }

                    $.post('/template/update/type/gallery',{ s: seq, id : SID, title : title, caption : caption, datetime : datetime, hashtag : hashtag, category : category, file : file, storage : s}, function(data) {
                        var isCheck = checkError(data);
                        if(!isCheck) return false;
                        setLogs(type,'gallery.data.edit','modify',type);
                    }, 'json');    

                    (title.length>0) ? $gitem.find('h5.figure').html(title) :  $gitem.find('h5.figure').text('Title');
                }
            });

            $(document).on('click', '.prod-button .modal-save, .prod-detail-edit', function(e) {
                var go = $(this).hasClass('prod-detail-edit') ? true : false;
                // var modal = $(this).showModalFlat('INFORMATION', '편집한 내용 저장 시 실 사이트에도 반영이 됩니다.<br>저장 하시겠습니까?', true, true, function() {
                //     modal.modal('hide');
                    $.products.save(go);
                // });
            });

            $(document).on('click', '.gallery-name', function(e) {
                e.stopPropagation();
                var id = $(this).attr('data-gallery-id');
                if(typeof id == 'undefined') return false;
                $.gallery.block_id = id;
                $.gallery.show($.gallery.block_id);
            });

            $(document).on('click','.gallery-items-loadmore', function(e) {
                var id = $(this).attr('data-pid'),
                    page = Number($(this).attr('data-page')),
                    cate_str = $(this).attr('data-category-str');
                page++;
                $.gallery.list(id,page,cate_str);
            });

            $(document).on('hover','.gallery-items .table-item', function(e) {
                if (e.type == "mouseenter") {
                    $(this).find('.item-handle').show();
                    $(this).find('.item-edit').show();
                } else { // mouseleave
                    $(this).find('.item-handle').hide();
                    $(this).find('.item-edit').hide();
                }
            });

            $(document).on('click','.item-edit', function(e) {
                var seq = $(this).attr('data-seq');
                if(typeof seq == 'undefined' || seq == '') {
                    alert('Undefined product seq!');
                    return false;
                }
                $.products.add(seq);
            });

            $(document).on('click', '.td-check input', function(e) {
                e.stopPropagation();

                var seq = $(this).parents('.table-item').attr('data-seq'),
                    pid = $(this).parents('.table-item').attr('data-pid'),
                    link = $(this).parents('.table-item').attr('data-link'),
                    target = $(this).parents('.table-item').attr('data-target'),
                    visible = $(this).parents('.table-item').attr('data-visible'),
                    seq_idx = ($.gallery.seqs).indexOf(seq);

                if($(this).is(':checked')) {
                    $(this).parents('.table-item').addClass('ui-selected return');
                    $.gallery.seqs.push(seq);
                    $('.table-col').css('z-index','1');
                } else {
                    if(seq_idx > -1) ($.gallery.seqs).splice(seq_idx,1);
                    $(this).parents('.table-item').removeClass('ui-selected return');
                    if($.gallery.seqs.length == 0) $('.table-col').css('z-index','2');
                }
                var str = '', cmd = '';
                var vstr = (visible == '1') ? $.lang[LANG]['editor.gallery.icon.visible.on'] : $.lang[LANG]['editor.gallery.icon.visible.off'],
                    vicon = (visible == '1') ? 'cl_icon_hide02' : 'cl_icon_show';

                $('.table-toolbar li i[data-cmd="checkall"]').attr('data-glseq',seq);
                $('.table-toolbar li i[data-cmd="item-sort"]').attr('data-glseq',seq);
                $('.table-toolbar li i[data-cmd="copy"]').attr('data-glseq',seq);
                $('.table-toolbar li i[data-cmd="link"]').attr('data-glseq',seq).attr('data-glink',link).attr('data-glink-target',target);
                $('.table-toolbar li i[data-cmd="' + cmd + '"]').attr('data-glseq',seq);
                $('.table-toolbar li i[data-cmd="category"]').attr('data-glseq',seq);
                $('.table-toolbar li i[data-cmd="visible"]').attr('data-glseq',seq).attr('data-visible',visible).text(vstr);
                $('.table-toolbar li i[data-cmd="delete"]').attr('data-glseq',seq);
                stickyToolbar();

                $('.gallery-items .table-item > div').addClass('hide-text');
                $('.table-toolbar > li').removeClass('open').find('.item-submenu').hide();
                $('.gallery-view-count').removeClass('open').find('.view-submenu').hide();

                if($('.gallery-items .table-item.ui-selected').length == 0) {
                    $('.gallery-toolbar .toolbar-cmd').addClass('hide');
                    $('.gallery-items .table-item > div').removeClass('hide-text');
                } else $('.gallery-toolbar .toolbar-cmd').removeClass('hide');
                $.gallery.setNumber();
            }); 
           
            $(document).on('change','.category-onoff-check', function(e) {
                var checked = $(this).prop('checked'),
                    gc = (checked) ? 'ON' : 'OFF',
                    settings = {
                        category_display : gc
                    };
                $.gallery.update = true;
                if(checked) {
                    $('.gallery-category-menu').removeClass('hide');
                    $('.category-title-str').addClass('on');
                    $('.td-category').removeClass('hide');
                } else {
                    $('.gallery-category-menu').addClass('hide');
                    $('.category-title-str').removeClass('on');
                    $('.td-category').addClass('hide');
                }
                $.post('/template/settings', {sid: SID, settings : JSON.stringify(settings), el: $.gallery.block_id}, function(data) {
                    checkError(data);
                    $.gallery.show($.gallery.block_id);
                }, 'json');
                
                var type = getElementType();
                setLogs(type,'gallery.category.' + gc,'toggle-' + gc, type);
            });

            $(document).on('click','.toolbar-category ul.item-submenu li', function(e) {
                if(($.gallery.seqs).length) {
                    $(this).toggleClass('active');
                    var click_cate = $(this).text(),
                        cate_str = $('.toolbar-category ul.item-submenu li.active').map(function() { return $(this).text(); }).get(),
                        text_str = cate_str.join(),
                        data_str = '|' + text_str.replace(/\,/g,'|,|') + '|';

                    if(cate_str == '') console.log('ok');
                    $.each($.gallery.seqs, function(i,v) {
                        ($('.table-item').length) ? $('.table-item[data-seq="' + v + '"]').attr('data-category', data_str).find('.td-category').text(text_str) :
                                                    $('.gallery-items .item[data-seq="' + v + '"]').attr('data-category', data_str).find('.td-category').text(text_str);
                        $.post('/template/gallery/category', { sid : SID, s : cate_str, mode : 'gallery', seq : v }, function(r) {
                            // console.log(r);
                            
                            if($('.element[data-id="' + $.gallery.block_id + '"] .gallery-category-nav li:nth-child(1)').hasClass('hide')) {
                                if($('.element[data-id="' + $.gallery.block_id + '"] .gallery-category-nav li.active a').text() == click_cate) {
                                    $.gallery.update = true;
                                }
                            }

                        }, 'json');
                    });
                }
            });

            $(document).on('click','.toolbar-sort ul.item-submenu li', function(e) {
                if(($.gallery.seqs).length) {
                    var group = ($('.table-item').length) ? '.table-item' : '.gallery-items .item';
                    if($(this).hasClass('sort-top')) {
                        $.gallery.drag = $(group).first().attr('data-seq');
                        $.gallery.move = $.gallery.seqs;
                        $.gallery.seqs = [];
                        $.gallery.mv();
                    } else if($(this).hasClass('sort-bottom')) {
                        if($('.gallery-items-loadmore').length == 0) {
                            var last = $(group).last().attr('data-seq');
                            if($.gallery.seqs[0] == last) {
                                var s = (group == '.gallery-items .item') ? '맨 뒤에' : '가장 아래에';
                                $(this).showModalFlat('', '현재 컨텐츠가 ' + s + ' 있습니다', true, false, '', 'close');
                                return false;
                            }
                        }

                        var modal = $(this).showModalFlat('INFORMATION',$.lang[LANG]['editor.gallery.move'],true,true,function() {
                            modal.modal('hide');
                            $.processON('move gallery item(s)...');
                            $.ajax({
                                url: '/template/gallery/sort-bottom',
                                data: { sid : SID, seq : $.gallery.seqs, block_id : $.gallery.block_id },
                                dataType: 'json',
                                type: 'POST',
                                async: false,
                                cache: false,
                                success: function (data) {
                                    checkError(data);
                                    var p = $.gallery.pages();
                                    $.gallery.show($.gallery.block_id,p.page,'', function() {
                                        $.each(data.seqs, function(i,v) {
                                            $(group + '[data-seq="' + v + '"]').addClass('return');
                                        });
                                        setTimeout(function() { 
                                            $('.gallery-modal').scrollTop(p.pos); 
                                            $.processOFF();
                                        }, 500);
                                    });
                                    $.gallery.update = true;
                                    $.gallery.reset();
                                    $.processOFF();
                                }
                            });
                        });
                    }
                }
            });

            $(document).on('click','.view-submenu li', function(e) {
                var view = $(this).attr('data-view'),
                    view = (typeof view == 'undefined') ? 30 : view,
                    settings = {
                        gallery_view : view
                    }
                $.processON();
                $.post('/template/settings',{ sid : SID, el : $.gallery.block_id, settings : JSON.stringify(settings) }, function(data) {
                    checkError(data);
                    $.gallery.show($.gallery.block_id,'','',function() {
                        setTimeout(function() { 
                            $.processOFF();
                        }, 500);
                    });

                },'json');

            });
            $(document).on('mouseenter', '.gallery-toolbar .toolbar > ul > li', function(e) {
                $('.gallery-modal .toolbar li').removeClass('open');
                $('.item-submenu').hide();
            });
            $(document).on('mouseenter','.submenu', function(e) {
                $(this).addClass('open');
                $(this).find('.item-submenu').show();
            });
            $(document).on('click', '.edit-gallery-detail', function(e) {
                var seq = $(this).attr('data-seq');
                if(typeof seq == 'undefined') return;
                location.href = '/config/page/' + PAGE + '/view/' + seq;
            });

            $(document).on('click','.gallery-name-edit', function(e) {
                e.stopPropagation();
                $('.gallery-name-edit-input').remove();
                var v = $(this).parents('.gallery-name').text(),
                    s = '<div class="gallery-name-edit-input"><input type="text" class="gallery-name-edit-inputbox" value="' + v.trim() + '"><div class="gallery-name-edit-close"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12"><polygon points="12 0.71 11.29 0 6 5.29 0.71 0 0 0.71 5.29 6 0 11.29 0.71 12 6 6.71 11.29 12 12 11.29 6.71 6 "/></svg></div><div class="gallery-name-edit-save"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15 10"><path d="M14.29 0L5.5 8.79 0.71 4 0 4.71l5.15 5.15C5.24 9.95 5.37 10 5.5 10s0.26-0.05 0.35-0.15L15 0.71 14.29 0z"/></svg></div></div>';
                $(this).parents('.gallery-name').append(s);

            });

            $(document).on('click','.gallery-name-edit-inputbox',function(e) {
                e.stopPropagation();
            });

            $(document).on('keypress', '.gallery-name-edit-inputbox', function(e) {
                var keyCode = e.keyCode,
                    blockname = $(this).val().trim();

                if(keyCode == 13) {
                    saveGalleryBlockName($(this), blockname);
                }
            });
            $(document).on('click','.gallery-name-edit-save',function(e) {
                e.stopPropagation();
                var blockname = $('.gallery-name-edit-inputbox').val().trim(),
                    $input = $('.gallery-name-edit-inputbox');
                saveGalleryBlockName($input, blockname);
            });
            $(document).on('click','.gallery-name-edit-close',function(e) {
                e.stopPropagation();
                $(this).parents('.gallery-name-edit-input').remove();
            });
        },
        cp : function() {
            var seqs = $.gallery.copy,
                page = $('.gallery-modal').attr('data-page');

            seqs = seqs.reverse();
            if(typeof seqs.length == 0 || seqs == '') {
                alert('Invalid variable');
                return false;
            }

            var modal = $(this).showModalFlat('INFORMATION',$.lang[LANG]['editor.gallery.clone'],true,true,function() {
                var count = seqs.length,
                    selected = (($.gallery.seqs).length) ? $.gallery.seqs[0] : '';

                modal.modal('hide');
                var item = $(group).length
                    cpage = ($.gallery.mode == 'shopping') ? Math.ceil(item/20) : Math.ceil(item/27),
                    spos = $('.gallery-modal').scrollTop();

                $.processON('copy gallery item(s)...');
                var group = ($('.table-item').length) ? '.table-item' : '.gallery-items .item';
                $.ajax({
                    url: '/template/gallery/copy',
                    data: { s: seqs, sid : SID, page : page, block_id : $.gallery.block_id, selected : selected },
                    dataType: 'json',
                    type: 'POST',
                    async: true,
                    cache: false,
                    success: function (data) {
                        checkError(data);
                        console.log(data);
                        galleryStatusInit();
                        $.gallery.copy = [];
                        var type = getElementType();
                        setLogs(type,'gallery.item.clone','clone',type);

                        var p = $.gallery.pages();
                        $.gallery.show($.gallery.block_id,p.page,'',function() {
                            $.each(data.r, function(i,v) {
                                console.log(v.seq);
                                $(group + '[data-seq="' + v.seq + '"]').addClass('return');
                            });
                            setTimeout(function() { 
                                $('.gallery-modal').scrollTop(p.pos); 
                                $.processOFF();
                            }, 500);
                        });
    
                        $.gallery.update = true;                        
                    }
                });
            });
        },
        mv : function(func) {
            var seqs = $.gallery.move,
                page = $('.gallery-modal').attr('data-page');
            // seqs = seqs.reverse();
            if(typeof seqs.length == 0 || seqs == '') {
                alert('Invalid variable');
                return false;
            }
            clicking = false;
            var group = ($('.table-item').length) ? '.table-item' : '.gallery-items .item';

            if($.gallery.drag) {
                if(($.gallery.drag == seqs[0] || 
                    $.gallery.drag == $(group + '[data-seq="' + seqs[0] + '"]').next().attr('data-seq')) ||
                    $.gallery.drag == $(group + '[data-seq="' + seqs[0] + '"]').next().hasClass('prev')) {
                    if($('.clone-item').length) {
                        $('.clone-item').remove();
                        $.gallery.seqs = [];
                    } else {
                        if($('.item-sort .item-submenu').css('display') == 'block') {
                            var s = (group == '.gallery-items .item') ? '맨 앞에' : '가장 앞에';
                            $.gallery.seqs = $.gallery.move;
                            $(this).showModalFlat('', '현재 컨텐츠가 ' + s + ' 있습니다', true, false, '', 'close');
                        }
                    }
                    return false;
                }
            }
            // var modal = $(this).showModalFlat('',$.lang[LANG]['editor.gallery.move'],true,true,function() {
                var count = seqs.length,
                    selected = $.gallery.drag;

                var item = $(group).length
                    cpage = ($.gallery.mode == 'shopping') ? Math.ceil(item/20) : Math.ceil(item/27),
                    spos = $('.gallery-modal').scrollTop();

                // modal.modal('hide');
                $.processON('move gallery item(s)...');
                $.ajax({
                    url: '/template/gallery/move',
                    data: { s: seqs, sid : SID, page : page, block_id : $.gallery.block_id, selected : selected, last : $.gallery.last },
                    dataType: 'json',
                    type: 'POST',
                    async: true,
                    cache: false,
                    success: function (data) {
                        checkError(data);
                        $.gallery.update = true;
                        $.gallery.drag = '';
                        $.gallery.last = '';
                        if(typeof func == 'function') {
                            func();
                        } else {
                            $.gallery.show($.gallery.block_id,cpage,'', function() {
                                $.each(data.seqs, function(i,v) {
                                    $(group + '[data-seq="' + v + '"]').addClass('return');
                                });
                                setTimeout(function() { 
                                    $('.gallery-modal').scrollTop(spos); 
                                    $.processOFF();
                                }, 500);
                            });
                        }

                    }
                });
            // }, $.lang[LANG]['editor.cancel'], '', '', '', function() { 
            //     console.log($.gallery.seqs);
            //     $.gallery.seqs = $.gallery.move; $.gallery.move = []; 
            // });
        },
        del : function() {
            var seqs = $.gallery.delete;
                page = $('.gallery-modal').attr('data-page'),
                pid = $('.gallery-modal').attr('data-pid'),
                total = Number($('.gallery-modal').attr('data-total'));

            if(typeof seqs.length == 0 || seqs == '') {
                alert('Invalid variable');
                return false;
            }   
            var modal = $(this).showModalFlat('',$.lang[LANG]['editor.gallery.selected.1'] + (seqs.length) + $.lang[LANG]['editor.gallery.selected.2'] + $.lang[LANG]['editor.gallery.selected.delete'],true,true, function() {
                var count = seqs.length;
                modal.modal('hide');
                $.processON('delete gallery item(s)...');

                var group = ($('.table-item').length) ? '.table-item' : '.gallery-items .item';
                $.each(seqs, function(i,v) {
                    $(group + '[data-seq="' + v + '"]').fadeOut(100, function() { $(this).remove(); });
                    $.ajax({
                        url: '/template/element/type/get-projectPage-bookmarkBlock/seq/' + v,
                        data: {sid: SID, page: PAGE},
                        dataType: 'json',
                        type: 'POST',
                        async: true,
                        cache: false,
                        success: function (data) {
                            checkError(data);
                            var d = data.data;
                            $.each(d, function(i,o) {
                                blockBookmarkDelete(o.sid,o.seq);
                            });
                            glItemDelete(v,PAGE);

                            if(i+1 == count) {
                                var type = getElementType();
                                setLogs(type,'gallery.item.delete','delete',type);
                                $.gallery.reset();
                                $.gallery.update = true;

                                var p = $.gallery.pages();
                                $.gallery.show($.gallery.block_id,p.page,'', function() {
                                    setTimeout(function() { 
                                        $('.gallery-modal').scrollTop(p.pos); 
                                        $.processOFF();
                                    }, 500);
                                });
                            }
                        }
                    }, 'json');
                });
            },$.lang[LANG]['editor.cancel']);
        },
        show : function(id,page,category,func) {
            if(typeof id == 'undefined' || !id) {
                alert('Undefined gallery ID');
                return false;
            }
            if(typeof page =='undefined' || !page) page = 1;
            if(typeof category =='undefined') category = '';
            $.gallery.seqs = [];
            $.gallery.block_id = id;
            $.gallery.category = category;
            $.post('/template/gallery/show', { mode : 'show', id : id, page : page, category : category }, function(data) {
                if(data.error != 'undefined' && data.error) {
                    alert(data.error);
                    return false;
                }

                $.gallery.mode = data.mode;
                var $backdrop = $('<div id="dummy-drop" style="position:fixed;top:0;left:0;right:0;bottom:0;background-color:#fff;z-index:1039;"></div>');
                if($('#dummy-drop').length == 0)
                    $('body').append($backdrop);

                $('.gallery-modal').hide().remove();
                $('#gallery-style').remove();
                $m = $(data.r).hide();
                $('body').append($m);
    
                $('.gallery-modal').attr('data-page',data.page).attr('data-pid',data.pid).attr('data-mode',data.mode).attr('data-category',data.category).attr('data-total',data.total);
                if(data.mode == 'shopping') $('.gallery-modal').addClass('shopping');
                $('#gallery-name').text(data.name);
                $('.gallery-add-items').attr('data-mode',data.mode).attr('data-page',data.page);
                (data.mode == 'shopping') ? $('.gallery-modal-title').text('상품 관리') : $('.gallery-modal-title').text($.lang[LANG]['editor.block.gallery.title']);
                $('.view-submenu li[data-view="' + data.view + '"]').addClass('active');
                $('#gallery_view').text(data.view);
                var icon = '';
                $.each(data.lists, function(i,v) {
                    $.each(v, function(m, s) {
                        $('.gallery-blocks ul').append('<li>' + m + '</li>');
                        if(s.length) {
                            $.each(s, function(k,n) {
                                switch(n.mode) {
                                    case 'shopping': icon = '<svg class="shopping" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 13 14"><path d="M9.82 2C9.4 0.84 8.3 0 7 0H6C4.7 0 3.6 0.84 3.18 2H0v12h13V2H9.82zM6 1h1c0.74 0 1.37 0.41 1.72 1H4.28C4.63 1.41 5.26 1 6 1zM12 13H1V3h2v3h1V3h5v3h1V3h2V13z"/></svg>　'; break;
                                    case 'project' : icon = '<svg class="project" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M13 0H3v3H0v13h13v-3h3V3L13 0zM13 1.41L14.59 3H13V1.41zM1 15V4h8v3h3v8H1zM10 4.41L11.59 6H10V4.41zM15 12h-2V6l-3-3H4V1h8v3h3V12z"/><rect x="3" y="9" width="7" height="1"/><rect x="3" y="12" width="7" height="1"/></svg>　'; break;
                                    case 'gallery' : icon = '<svg class="gallery" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 13 13"><path d="M0 0v13h13V0H0zM12 1v7.29l-2-2 -2 2 -4-4 -3 3V1H12zM1 12V8.71l3-3 4 4 2-2 2 2V12H1z"/><circle cx="10" cy="3" r="1"/></svg>　'; break;
                                }
                                $('.gallery-blocks ul').append('<li class="gallery-name ' + ((n.id == id) ? 'active' : '') + '" data-gallery-id="' + n.id + '">' + icon + '<span class="gallery-block-name">' + n.name + '</span><span class="f-right gallery-name-edit"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M15.41 0.76l-0.17-0.17C14.85 0.2 14.34 0 13.83 0s-1.02 0.2-1.41 0.59L1 12l-1 4 4-1L15.41 3.59C16.2 2.8 16.2 1.54 15.41 0.76zM3.49 14.1l-2.11 0.53 0.53-2.11 8.95-8.95 1.59 1.59L3.49 14.1zM14.71 2.88l-1.56 1.56 -1.59-1.59 1.56-1.56C13.31 1.1 13.56 1 13.83 1s0.52 0.1 0.71 0.29l0.17 0.17C15.1 1.85 15.1 2.49 14.71 2.88z"/></svg></span></li>');
                                cates = cates + '<li class="gallery-name" data-gallery-id="' + n.id + '">' + n.name + '</li>';
                            });
                        }
                    });
                });

                var cates = '';
                var show = (data.cate_onoff == 'ON') ? '' : 'hide';
                $.each(data.category, function(i,v) {
                    var active = (data.cate_str == v) ? 'active' : '';
                    $('.gallery-category .gallery-category-onoff').before('<li class="category-text gallery-category-menu ' + show + ' ' + active + '">' + v + '</li>');
                    cates = cates + '<li>' + v + '</li>';
                    if(data.cate_str == '') {
                        $('.gallery-category > li:nth-child(2)').addClass('active');
                    }
                });
                $.gallery.cates = cates;
                if(data.cate_onoff == 'ON') {
                    $('.category-onoff-check').prop('checked','checked');
                    $('.category-title-str').addClass('on');
                } else {
                    $('.category-onoff-check').prop('checked','');
                    $('.gallery-category > li:nth-child(2)').addClass('hide');
                    $('.gallery-category > li:last-child').addClass('hide');
                }

                var s = '<ul class="table-toolbar">';
                s = s + '<li class="checkbox-cmd toolbar-cmd hide"><i class="" data-glseq="" data-cmd="checkall"></i> <input type="checkbox" class="check-all"></li>';
                if($.gallery.category == '') 
                    s = s + '<li class="toolbar-copy toolbar-cmd hide"><i class="" data-glseq="" data-cmd="copy"></i>' + $.lang[LANG]['editor.gallery.icon.clone'] + '</li>';
                s = s + '<li class="toolbar-sort item-sort toolbar-cmd submenu hide">' + $.lang[LANG]['editor.gallery.icon.order'] + ' <i class="fa fa-caret-down" aria-hidden="true" data-glseq="" data-cmd="item-sort"></i>\
                            <ul class="item-submenu">\
                                <li class="sort-top">' + $.lang[LANG]['editor.gallery.icon.order.shopping.front'] + '</li>\
                                <li class="sort-bottom">' + $.lang[LANG]['editor.gallery.icon.order.shopping.end'] + '</li>\
                            </ul>\
                        </li>';
                s = s + '<li class="toolbar-link toolbar-cmd hide"><i class="" data-glseq="" data-glink="" data-glink-target="" data-cmd="link"></i>' + $.lang[LANG]['editor.gallery.icon.link'] + '</li>';

                if(!$('.gallery-modal .gallery-category .gallery-all').hasClass('hide')) {
                    s = s + '<li class="toolbar-category toolbar-cmd submenu hide"><i class="" data-glseq="" data-cmd="category"></i>' + $.lang[LANG]['editor.block.gallery.category.change'] + ' <i class="fa fa-caret-down" aria-hidden="true"></i>';
                    s = s + '<ul class="item-submenu">' + cates + '</ul>';
                    s = s + '</li>';
                }                        
                s = s + '\
                        <li class="toolbar-visible toolbar-cmd hide"><i class="" data-glseq="" data-visible="" data-cmd="visible">숨김</i></li>\
                        <li class="toolbar-delete toolbar-cmd hide"><i class="" data-glseq="" data-cmd="delete"></i>' + $.lang[LANG]['editor.gallery.icon.delete'] + '</li>\
                    </ul>\
                ';
                var $tool_back = $('<div class="toolbar sort-disabled">' + s + '</div>'),
                    col = '';

                col = col + '<ul class="table-col">';
                col = col + '<li class="col-check"><input type="checkbox" class="check-all"></li>';
                col = col + '<li class="col-number">번호</li>';
                col = col + '<li class="col-img"></li>';
                col = col + '<li class="col-title">상품</li>';
                col = col + '<li class="col-price">카테고리</li>';
                col = col + '<li class="col-price">가격</li>';
                col = col + '<li class="col-quantity">재고</li>';
                col = col + '</ul>'
                if(data.mode == 'shopping') {
                    $('.gallery-toolbar').append($tool_back);
                    $('.gallery-toolbar').append(col);
                }

                var num = (page > 1) ? data.total : data.total - ((page-1) * data.view);
                $.each(data.items, function(i,v) {
                    var settings = (v.gsettings) ? $.parseJSON(v.gsettings) : {},
                        link = (typeof settings.glink != 'undefined') ? settings.glink : '',
                        target = (typeof settings.glink_target != 'undefined') ? settings.glink_target : '',
                        cp_class = ($.inArray(v.seq,$.gallery.copy) > -1) ? ' active copy' : '',
                        mv_class = ($.inArray(v.seq,$.gallery.move) > -1) ? ' active move' : '',
                        invisible = (v.visible == '1') ? true : false;
                        // file = ((v.image).indexOf('googleusercontent') > -1) ? v.image : v.url
                        imgPATH = (typeof settings.storage == 'undefined') ? RPATH : settings.storage,
                        src_s250 = getServeImage(v.image,'250',imgPATH);

                    link = Base64.decode(link);
                    if(data.mode == 'shopping') {
                        $table = $('<div class="table-item" data-pos="' + v.pos + '" data-pid="' + v.pid + '" data-seq="' + v.seq + '" data-link="' + link + '" data-target="' + target + '" data-visible="' + v.visible + '" data-category="' + v.category + '">');
                        var price = (v.price && v.price != '0') ? addCommas(v.price) + '원' : '-',
                            sale = (v.sale && v.sale != '0') ? addCommas(v.sale) + '원' : '',
                            quantity = (v.quantity) ? addCommas(v.quantity) : '-',
                            invisible = (v.visible == '1') ? true : false,
                            title = (v.title) ? v.title : '상품명을 입력하세요';

                        if(sale) sale = '<span class="price-sale">' + sale + '</span>';
                        if(invisible) $table.addClass('invisible');
                        var soldout = '';

                        if(v.quantity_on == 'off' || v.quantity_on == null || v.quantity_on == '') {
                            if(v.status == 'off') {
                                $table.addClass('soldout');
                                // soldout = '<span class="item-soldout">품절</span>';
                            }
                        } else {
                            if(v.status == 'off') $table.addClass('soldout');
                            if(v.quantity == 0) {
                                $table.addClass('soldout');
                                soldout = '<span class="item-soldout">품절</span>';
                            }
                        }
                        var link_icon = '';
                        if(typeof settings.glink != 'undefined' && settings.glink) {
                            link_icon = '<span class="info-link"><svg class="svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15 15"><path d="M6 9.85c-0.22 0-0.44-0.08-0.6-0.25 -0.33-0.33-0.33-0.87 0-1.2l3-3c0.33-0.33 0.87-0.33 1.2 0 0.33 0.33 0.33 0.87 0 1.2l-3 3C6.44 9.77 6.22 9.85 6 9.85z"/><path d="M3.85 15c-1.03 0-2-0.4-2.72-1.13C0.4 13.15 0 12.18 0 11.15s0.4-2 1.13-2.72l2-2C3.46 6.1 4 6.1 4.33 6.43c0.33 0.33 0.33 0.87 0 1.2l-2 2c-0.41 0.41-0.63 0.95-0.63 1.52s0.22 1.11 0.63 1.52c0.81 0.81 2.23 0.81 3.04 0l2-2c0.33-0.33 0.87-0.33 1.2 0 0.33 0.33 0.33 0.87 0 1.2l-2 2C5.85 14.6 4.88 15 3.85 15z"/><path d="M11.2 8.85c-0.22 0-0.44-0.08-0.6-0.25 -0.33-0.33-0.33-0.87 0-1.2l2.07-2.07c0.41-0.41 0.63-0.95 0.63-1.52s-0.22-1.11-0.63-1.52c-0.81-0.81-2.23-0.81-3.04 0L7.56 4.36c-0.33 0.33-0.87 0.33-1.2 0 -0.33-0.33-0.33-0.87 0-1.2l2.07-2.07c1.45-1.46 3.99-1.46 5.44 0C14.6 1.82 15 2.78 15 3.81s-0.4 2-1.13 2.72L11.8 8.61C11.64 8.77 11.42 8.85 11.2 8.85z"/></svg></span>';
                        }
                        var s = '\
                            <div class="td-handle"><div class="item-handle"><img src="https://storage.googleapis.com/i.addblock.net/handle.png"></div></div>\
                            <div class="td-check"><input type="checkbox" name="item_check[]" class="td-input"></div>\
                            <div class="td-number">' + (num - i) + '</div>\
                            <div class="td-img"><img src="' + src_s250 + '" class="img-responsive">' + link_icon + '</div>\
                            <div class="td-title' + ((v.title == '') ? ' empty' : '') + '">' + title + soldout + '</div>\
                            <div class="td-edit"><div class="item-edit" data-seq="' + v.seq + '"><span class="cl-icon cl_icon_edit04"></span>&nbsp;&nbsp;' + $.lang[LANG]['editor.block.gallery.item.edit'] + '</div></div>\
                            <div class="td-category ' + ((data.cate_onoff == 'OFF') ? 'hide' : '') + '">' + v.item_category + '</div>\
                            <div class="td-price">' + price + sale + '</div>\
                            <div class="td-quantity">' + ((v.quantity_on == 'on') ? quantity : '-') + '</div>\
                        ';
                        $table.append(s);
                        $('.gallery-items').append($table);
                    } else {
                        var $info = $('<div class="info"></div>'),
                            $item = $('<div class="item" data-pos="' + v.pos + '" data-pid="' + v.pid + '" data-seq="' + v.seq + '" data-link="' + link + '" data-target="' + target + '" data-visible="' + v.visible + '" data-category="' + v.category + '"><img src="' + src_s250 + '" class="img-responsive"><input type="text" name="item_name" class="item-title" value="' + v.title + '" placeholder="' + $.lang[LANG]['board.enter-title'] + '" data-seq="' + v.seq + '" data-title="' + v.title + '" data-caption="' + v.content + '" data-category="' + v.category + '" data-date="' + v.datetime2 + '" data-hash="' + v.hashtag + '" data-url="' + src_s250 + '"></div>');

                        // if(mv_class) $item.addClass('active move');
                        // if(cp_class) $item.addClass('active copy');
                        $info.empty();
                        if(invisible) $item.addClass('invisible');
                        if(typeof settings.glink != 'undefined' && settings.glink) {
                            $info.append('<span class="info-link"><svg class="svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15 15"><path d="M6 9.85c-0.22 0-0.44-0.08-0.6-0.25 -0.33-0.33-0.33-0.87 0-1.2l3-3c0.33-0.33 0.87-0.33 1.2 0 0.33 0.33 0.33 0.87 0 1.2l-3 3C6.44 9.77 6.22 9.85 6 9.85z"/><path d="M3.85 15c-1.03 0-2-0.4-2.72-1.13C0.4 13.15 0 12.18 0 11.15s0.4-2 1.13-2.72l2-2C3.46 6.1 4 6.1 4.33 6.43c0.33 0.33 0.33 0.87 0 1.2l-2 2c-0.41 0.41-0.63 0.95-0.63 1.52s0.22 1.11 0.63 1.52c0.81 0.81 2.23 0.81 3.04 0l2-2c0.33-0.33 0.87-0.33 1.2 0 0.33 0.33 0.33 0.87 0 1.2l-2 2C5.85 14.6 4.88 15 3.85 15z"/><path d="M11.2 8.85c-0.22 0-0.44-0.08-0.6-0.25 -0.33-0.33-0.33-0.87 0-1.2l2.07-2.07c0.41-0.41 0.63-0.95 0.63-1.52s-0.22-1.11-0.63-1.52c-0.81-0.81-2.23-0.81-3.04 0L7.56 4.36c-0.33 0.33-0.87 0.33-1.2 0 -0.33-0.33-0.33-0.87 0-1.2l2.07-2.07c1.45-1.46 3.99-1.46 5.44 0C14.6 1.82 15 2.78 15 3.81s-0.4 2-1.13 2.72L11.8 8.61C11.64 8.77 11.42 8.85 11.2 8.85z"/></svg></span>');
                            $item.append($info);
                        }

                        $('.gallery-items').append($item);
                    }
                });
                
                $('.gallery-items-loadmore').remove();
                if((data.items).length == 0) {
                    $('.gallery-items').append('<p class="text-center sort-disabled category-empty"> ' + $.lang[LANG]['editor.gallery.category.empty'] + '</p>');
                } else {
                    if((data.items).length < data.total) {
                        var count = (data.mode == 'shopping') ? $('.gallery-items .table-item').length : $('.gallery-items .item').length;
                        $('.gallery-items').after('<div class="gallery-items-loadmore" data-pid="' + data.pid + '" data-category-str="' + data.cate_str + '" data-page="1">' + $.lang[LANG]['data.loadmore'] + ' (' + count + '/' + data.total + ')</div>');
                    }
                }
                $('.gallery-ctrl-category').attr('data-category',data.category.toString()).attr('data-pid',data.pid);

                var handle = (data.mode == 'shopping') ? '.td-handle' : '.item-ctrl';
                var $item = $('.gallery-items .item');

                $(".gallery-items").selectable({
                    // distance: 3,
                    filter : '.table-item,.item',
                    cancel : '.item-edit, .item.ui-selected, .td-check, .td-handle, .item-title, .item .info, svg',
                    stop : function(event,ui) {
                        $.gallery.selected(event,ui);
                    }
                });            

                $m.fadeIn(300, function() {
                    if(typeof func == 'function') func();
                    $('#dummy-drop').remove();
                });

                $('.gallery-modal').off('scroll').on('scroll', function(e) {
                    stickyToolbar();
                });
                resizeGalleryModal();
                setLanguage(LANG);
            },'json');
        },

        list : function(id, page, category) {
            if(typeof id == 'undefined' || !id) {
                alert('Undefined gallery ID');
                return false;
            }
            if(typeof page =='undefined') page = 1;
            if(typeof category =='undefined') category = '';

            $.post('/template/gallery/show', { mode : 'list', id : id, page : page, category : category }, function(data) {
                if(data.error != 'undefined' && data.error) {
                    alert(data.error);
                    return false;
                }
                var num = data.total - ((page-1) * data.view);
                $.each(data.items, function(i,v) {
                    if(data.mode == 'shopping') {
                        $table = $('<div class="table-item" data-pos="' + v.pos + '" data-pid="' + v.pid + '" data-seq="' + v.seq + '" data-link="' + link + '" data-target="' + target + '" data-visible="' + v.visible + '" data-category="' + v.category + '">');
                        var price = (v.price && v.price != '0') ? addCommas(v.price) + '원' : '-',
                            sale = (v.sale && v.sale != '0') ? addCommas(v.sale) + '원' : '',
                            quantity = (v.quantity) ? addCommas(v.quantity) : '-',
                            invisible = (v.visible == "1") ? true : false,
                            title = (v.title) ? v.title : '상품명을 입력하세요';

                        if(sale) sale = '<span class="price-sale">' + sale + '</span>';
                        if(invisible) $table.addClass('invisible');
                        if(quantity == '0') $table.addClass('soldout');
                        var s = '\
                            <div class="td-handle"><div class="item-handle"><img src="https://storage.googleapis.com/i.addblock.net/handle.png"></div></div>\
                            <div class="td-check"><input type="checkbox" name="item_check"></div>\
                            <div class="td-number">' + (num - i) + '</div>\
                            <div class="td-img"><img src="' + v.url + '" class="img-responsive"></div>\
                            <div class="td-title' + ((v.title == '') ? ' empty' : '') + '">' + title + '</div>\
                            <div class="td-edit"><div class="item-edit" data-seq="' + v.seq + '"><span class="cl-icon cl_icon_edit04"></span>&nbsp;&nbsp;' + $.lang[LANG]['editor.block.gallery.item.edit'] + '</div></div>\
                            <div class="td-category">' + v.item_category + '</div>\
                            <div class="td-price">' + price + sale + '</div>\
                            <div class="td-quantity">' + quantity + '</div>\
                        ';
                        $table.append(s);
                        $('.gallery-items').append($table);
                    } else {
                        var settings = (v.gsettings) ? $.parseJSON(v.gsettings) : {},
                            link = (typeof settings.glink != 'undefined') ? settings.glink : '',
                            target = (typeof settings.glink_target != 'undefined') ? settings.glink_target : '',
                            invisible = (v.visible == "1") ? true : false,
                            $info = $('<div class="info"></div>'),
                            $item = $('<div class="item" data-pos="' + v.pos + '" data-pid="' + v.pid + '" data-seq="' + v.seq + '" data-link="' + link + '" data-target="' + target + '" data-visible="' + v.visible + '"><img src="' + v.url + '" class="img-responsive"><input type="text" name="item_name" class="item-title" value="' + v.title + '" placeholder="제목을 입력하세요" data-seq="' + v.seq + '" data-title="' + v.title + '" data-caption="' + v.content + '" data-category="' + v.category + '" data-date="' + v.datetime2 + '" data-hash="' + v.hashtag + '" data-url="' + v.url + '"></div>');

                        $info.empty();
                        if(invisible) $item.addClass('invisible');
                        if(typeof settings.glink != 'undefined' && settings.glink) {
                            $info.append('<span class="info-link"><svg class="svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15 15"><path d="M6 9.85c-0.22 0-0.44-0.08-0.6-0.25 -0.33-0.33-0.33-0.87 0-1.2l3-3c0.33-0.33 0.87-0.33 1.2 0 0.33 0.33 0.33 0.87 0 1.2l-3 3C6.44 9.77 6.22 9.85 6 9.85z"/><path d="M3.85 15c-1.03 0-2-0.4-2.72-1.13C0.4 13.15 0 12.18 0 11.15s0.4-2 1.13-2.72l2-2C3.46 6.1 4 6.1 4.33 6.43c0.33 0.33 0.33 0.87 0 1.2l-2 2c-0.41 0.41-0.63 0.95-0.63 1.52s0.22 1.11 0.63 1.52c0.81 0.81 2.23 0.81 3.04 0l2-2c0.33-0.33 0.87-0.33 1.2 0 0.33 0.33 0.33 0.87 0 1.2l-2 2C5.85 14.6 4.88 15 3.85 15z"/><path d="M11.2 8.85c-0.22 0-0.44-0.08-0.6-0.25 -0.33-0.33-0.33-0.87 0-1.2l2.07-2.07c0.41-0.41 0.63-0.95 0.63-1.52s-0.22-1.11-0.63-1.52c-0.81-0.81-2.23-0.81-3.04 0L7.56 4.36c-0.33 0.33-0.87 0.33-1.2 0 -0.33-0.33-0.33-0.87 0-1.2l2.07-2.07c1.45-1.46 3.99-1.46 5.44 0C14.6 1.82 15 2.78 15 3.81s-0.4 2-1.13 2.72L11.8 8.61C11.64 8.77 11.42 8.85 11.2 8.85z"/></svg></span>');
                            $item.append($info);
                        }

                        $('.gallery-items').append($item);
                    }
                });
                
                $('.gallery-items-loadmore').remove();
                var itemCheck = (data.mode == 'shopping') ? '.table-item' : '.item';

                if($('.gallery-items ' + itemCheck).length < data.total) {
                    $('.gallery-items').after('<div class="gallery-items-loadmore" data-pid="' + data.pid + '" data-category-str="' + data.cate_str + '" data-page="' + data.page_num + '">' + $.lang[LANG]['data.loadmore'] + ' (' + $('.gallery-items ' + itemCheck).length + '/' + data.total + ')</div>');
                }

                // $('.gallery-items').sortable('refresh');
            },'json');            
        },
        setNumber: function() {
            var items = $.gallery.seqs;
            if(items.length) {
                var group = ($('.table-item').length) ? '.table-item' : '.gallery-items .item';
                $.each(items, function(i,v) {
                    $(group+'[data-seq="' + v + '"]').attr('data-index',(i+1));
                });
            }
        },
        selected: function(e,ui) {
            $.gallery.seqs = [];
            if($.gallery.mode == 'shopping') {
                $('.table-item .td-check > input').prop('checked',false);
                $.each($('.gallery-items .table-item.ui-selected'), function(i,v) {
                    $(this).find('.td-check > input').prop('checked',true);
                    ($.gallery.seqs).push($(v).attr('data-seq'));
                });
                if($.gallery.seqs.length) {
                    if($('.gallery-items .table-item.ui-selected').length && $('.gallery-items .table-item').length) {
                        $('.table-toolbar li').removeClass('hide open');
                        $('.table-col').css('z-index','1');
                    }

                    var str = '', cmd = '';
                    var $s = $('.gallery-items .table-item[data-seq="' + $.gallery.seqs[0] + '"]'),
                        seq = $s.attr('data-seq'),
                        pid = $s.attr('data-pid'),
                        link = $s.attr('data-link'),
                        target = $s.attr('data-target'),
                        visible = $s.attr('data-visible');

                    var vstr = (visible == "1") ? $.lang[LANG]["editor.gallery.icon.visible.on"] : $.lang[LANG]["editor.gallery.icon.visible.off"],
                        vicon = (visible == "1") ? 'cl_icon_hide02' : 'cl_icon_show';

                    $('.table-toolbar li i[data-cmd="checkall"]').attr('data-glseq',seq);
                    $('.table-toolbar li i[data-cmd="item-sort"]').attr('data-glseq',seq);
                    $('.table-toolbar li i[data-cmd="copy"]').attr('data-glseq',seq);
                    $('.table-toolbar li i[data-cmd="link"]').attr('data-glseq',seq).attr('data-glink',link).attr('data-glink-target',target);
                    $('.table-toolbar li i[data-cmd="' + cmd + '"]').attr('data-glseq',seq);
                    $('.table-toolbar li i[data-cmd="category"]').attr('data-glseq',seq);
                    $('.table-toolbar li i[data-cmd="visible"]').attr('data-glseq',seq).attr('data-visible',visible).text(vstr);
                    $('.table-toolbar li i[data-cmd="delete"]').attr('data-glseq',seq);
                    stickyToolbar();
                    $.gallery.setNumber();
                }
            } else {
                $.each($('.gallery-items .item.ui-selected'), function(i,v) {
                    ($.gallery.seqs).push($(v).attr('data-seq'));
                });
                $.gallery.toolbar();
                stickyToolbar();
            }
            $('.item-submenu, .view-submenu').hide();
            $('.toolbar-sort, .gallery-view-count').removeClass('open');
            $('.gallery-blocks .btn-group').removeClass('open');
        },
        toolbar : function() {
            $('.gallery-items').find('.toolbar.mod-gallery').remove();
            if($.gallery.seqs.length == 0) return false;
            var $s = $('.gallery-items .item[data-seq="' + $.gallery.seqs[0] + '"]'),
                seq = $s.attr('data-seq'),
                pid = $s.attr('data-pid'),
                link = $s.attr('data-link'),
                target = $s.attr('data-target'),
                visible = $s.attr('data-visible');

            var l = ($s.index()%7 > 3) ? 'right' : '',
                mode = $('.gallery-add-items').attr('data-mode');

            var vstr = (visible == "1") ? $.lang[LANG]["editor.gallery.icon.visible.on"] : $.lang[LANG]["editor.gallery.icon.visible.off"],
                vicon = (visible == "1") ? 'cl_icon_hide02' : 'cl_icon_show',
                editable = ($.gallery.seqs.length > 1) ? "disabled" : "";

            var s = '\
                <ul>\
                    <li class="active gallery-item-edit submenu' + editable + '">\
                ';
            if($.gallery.mode == 'project') {
                s = s + '\
                        ' + $.lang[LANG]['editor.block.gallery.item.edit'] + '</span> <i class="fa fa-caret-down"></i>\
                        <ul class="item-submenu">\
                            <li class="edit-gallery-item"><i class="" data-glseq="' + seq + '" data-cmd="edit">'+$.lang[LANG]["editor.gallery.icon.thumnail.config"]+'</i></li>\
                            <li class="edit-gallery-detail" data-seq="' + seq + '" >'+$.lang[LANG]["editor.gallery.icon.Project.page"]+'</li>\
                        </ul>\
                    </li>\
                ';
            } else {
                s = s + '\
                        <i class="" data-glseq="' + seq + '" data-cmd="edit"></i>' + $.lang[LANG]['editor.block.gallery.item.edit'] + '\
                    </li>\
                ';
            }


            if($.gallery.category == '') 
                s = s + '<li><i class="" data-glseq="' + seq + '" data-cmd="copy"></i>' + $.lang[LANG]['editor.gallery.icon.clone'] + '</li>';

            s = s + '<li class="toolbar-sort item-sort submenu">' + $.lang[LANG]['editor.gallery.icon.order'] + ' <i class="fa fa-caret-down" aria-hidden="true" data-glseq="" data-cmd="item-sort"></i>\
                        <ul class="item-submenu">\
                            <li class="sort-top">' + $.lang[LANG]['editor.gallery.icon.order.front'] + '</li>\
                            <li class="sort-bottom">' + $.lang[LANG]['editor.gallery.icon.order.end'] + '</li>\
                        </ul>\
                    </li>';
            if(!$('.gallery-modal .gallery-category .gallery-all').hasClass('hide')) {
                s = s + '<li class="toolbar-category submenu"><i class="" data-glseq="" data-cmd="category"></i>' + $.lang[LANG]['editor.block.gallery.category.change'] + ' <i class="fa fa-caret-down" aria-hidden="true"></i>';
                s = s + '<ul class="item-submenu">' + $.gallery.cates + '</ul>';
                s = s + '</li>';
            }
            
            s = s + '\
                    <li><i class="" data-glseq="' + seq + '" data-glink="' + link + '" data-glink-target="' + target + '" data-cmd="link"></i>' + $.lang[LANG]['editor.gallery.icon.link'] + '</li>\
            ';
            s = s + '\
                    <li><i class="" data-glseq="' + seq + '" data-visible="' + visible + '" data-cmd="visible">' + vstr + '</i></li>\
                    <li><i class="" data-glseq="' + seq + '" data-cmd="delete"></i>' + $.lang[LANG]['editor.gallery.icon.delete'] + '</li>\
                </ul>\
            ';
            var $tool_back = $('<div class="toolbar mod-gallery ' + l + '">' + s + '</div>');
            $('.gallery-toolbar').empty();
            $('.gallery-toolbar').append($tool_back);

            if($.gallery.seqs.length > 1) { 
                $('.gallery-toolbar .toolbar .gallery-item-edit').addClass('disabled');
            } else {
                $('.gallery-toolbar .toolbar .gallery-item-edit').removeClass('disabled');
            }
            // $('.gallery-items').selectable('disable');
        },
        pages : function() {
            var group = ($('.table-item').length) ? '.table-item' : '.gallery-items .item',
                item = $(group).length,
                cpage = ($.gallery.mode == 'shopping') ? Math.ceil(item/20) : Math.ceil(item/27),
                spos = $('.gallery-modal').scrollTop();
            return {
                page : cpage, pos : spos
            }
        },

        close : function() {
            $.gallery.mode = '';
            if($('.gallery-modal').length) {
                $('.gallery-modal').fadeOut(300, function() {
                    $('#gallery-style').remove();
                    $(this).remove();
                });
            }
            if($.gallery.update) showPageCallback(showPage);
        }
    }    
})(jQuery);
var SFOLDER_ACTIVE = '';
var updateOutputFolder = function (e) {
    var list = e.length ? e : $(e.target),
        output = list.data('output');

    if (window.JSON && list.attr('class') == 'dd') {
        output.val(window.JSON.stringify(list.nestable('serialize')));
    } else {
        if (typeof output != "undefined") output.val('JSON browser support required');
    }

    if (SID) {
        $.post('/template/update/type/folder', { s: $('#nestableFolder-output').val(), id: SID }, function (data) {
            checkError(data);
        }, 'json');
    }

}

var displaySelectedFilesStr = function() {
    if($('.selected-files').children().length) {
        $('.selected-files-count').text($('.selected-files').children().length);
        $('.resource-selected-str').show();    
    } else {
        $('.resource-selected-str').hide();
    }
}

var resetFileSelectedStr = function() {
    if($('.selected-files').children().length>0) {
        $('.resource-useit').addClass('active');
        $('.resource-selected-str').show();
        $('.selected-files-count').text($('.selected-files').children().length);
    } else {
        $('.resource-useit').removeClass('active');
        $('.resource-selected-str').hide();
        $('.selected-files-count').text('0');
    }
}

var resetFileSelectedFr = function() {
    if($('.fr-selected-files').children().length>0) {
        $('.resource-useit').addClass('active');
        $('.resource-selected-str').show();
        $('.selected-files-count').text($('.selected-files').children().length);
    } else {
        $(".fr-selected-files").empty();
        $('.resource-useit').removeClass('active');
        $('.resource-selected-str').hide();
        $('.selected-files-count').text('0');
    }
}

var resourceGetPage = function(page,ffolder,keep) {
    if(page == 1) {
        $('#resource-files').empty();
        for(var i=0; i<6; i++) {
            $('#resource-files').append('<li class="f-wrap">');
        }
    }

    $('#resource-files').removeClass('empty');
    $('#selectAll').prop('checked',false);
    var selectedAll = true;
    ffolder = (typeof ffolder == 'undefined') ? SFOLDER_ACTIVE : ffolder;
    $.getJSON('/template/resource/files/page/' + page + '/ffolder/' + ffolder , function (data) {
        if (typeof(data.error) == "undefined") {
            cTotal = data.total;
            var path = data.path;

            var selected = $('.selected-files li').map(function (i, n) {
                return $(this).find("p.selected-file-name").text();
            }).get();
            
            resourceNoticeTextTop = $.lang[LANG]['editor.resource.notice.text.top'];
            resourceNoticeTextBottom = $.lang[LANG]['editor.resource.notice.text.bottom'];

            page = (data.file.length <2) ? page-1 : page;
            page = (page) ? page : 1;

            var $fHeight = $('#resource-files .f-wrap');
            var fi = 0, 
                height = [
                    $fHeight.eq(0).height(),
                    $fHeight.eq(1).height(),
                    $fHeight.eq(2).height(),
                    $fHeight.eq(3).height(),
                    $fHeight.eq(4).height(),
                    $fHeight.eq(5).height()
                ];
            $.each(data.file, function (idx, val) {
                fi = idx%6;
                var set = (idx < 3 && page==1) ? idx : height.indexOf(Math.min.apply(null,height));

                var tag = resourceFileTag(val.filename, val.seq, path, selected, val.ffolder, page, val.origname, parseInt(val.filesize), val.magic);
                if($.inArray(val,selected)<0) selectedAll = false;

                var r = Math.round(val.h*800/val.w);
                height[set] = height[set] + r;
                $('#resource-files .f-wrap').eq(set).append(tag);
            });
            $('#resource-files').selectable({ filter: " .fitem"});

            var folder_size = (parseInt(data.fsize_total/1024)>0) ? parseInt(data.fsize_total/1024) : parseInt(data.fsize_total),
                folder_size_unit = (parseInt(data.fsize_total/1024)>0) ? 'MB' : 'KB' ;

            $('.fli.active > .dd-flc').attr('attr-count',data.total).text(data.total);
            $('.fli.active > .dd-fls').attr({'attr-size': parseInt(data.fsize_total), 'attr-size-unit':folder_size_unit}).text(folder_size);

            if(data.total==0) {
                selectedAll = false;
                $('#resource-files').addClass('empty');
                var str = ""
                    +"<li class='resource-empty-area'>"
                    + " <div class='resource-empty'>"
                    + " <div class='img-wrap'><img src='https://storage.googleapis.com/i.addblock.net/config/fa_resource_img_icon.png' alt='image storage' /></div>"
                    + " <p>" + resourceNoticeTextTop + "<br>"
                    + "" + resourceNoticeTextBottom + "</p>"
                    + "</div>"
                    + "</li>"
                ;
                $('#resource-files').append(str);
            } else {
                var upgrade_link = (HOST.indexOf('gabia') > -1) ? "https://www.gabia.com/mygabia/service" : "/upgrade/site/" + SID,
                    load_btn = '\
                            <img src="https://storage.googleapis.com/i.addblock.net/image-upload.gif">&nbsp;&nbsp;\
                            <span class="resource-info"><span>' + $.lang[LANG]["config.file.browse"] + '</span></span>\
                            <input id="fileupload-resource" class="modal-upload-button-resource" type="file" name="files[]" multiple>\
                    ',
                    upgrade_btn = '\
                        <a href="' + upgrade_link + '" style="color: #fff; text-decoration:none;">\
                            <i class="fa fa-level-up" aria-hidden="true" style="margin-right: 5px;"></i>\
                            <span class="resource-info">' + $.lang[LANG]["plan.upgrade"] + '</span>\
                        </a>\
                    ';

                var str = (data.is_limit) ? upgrade_btn : load_btn,
                    css_str = (data.is_limit) ? {'background-color':'#4889e7', 'margin-left':'5px'} : {}, 
                    max_str = (data.is_limit) ? '<span class="error">' + $.lang[LANG]['plan.disk-space.limit.info'] + '</span> ' : '';

                $('#el-fileupload .fileinput-button').attr('data-limit',data.is_limit).html(str).css(css_str);
                $('.upload-max-size').html(max_str);
            }

        } else {
            checkError(data);
            $('<li class="text-center resource-none"/>').text('No files uploaded').appendTo('#resource-files');
        }
        $('.listprogress').remove();
    });
    if(selectedAll) $('#selectAll').prop('checked',true);
    displaySelectedFilesStr();
}

var resourcePaging = function(page,total,ffolder) {
    view = RVIEW;
    $('.resource-paging').empty();

    page_view = 10;
    start = Math.floor((page-1) / page_view) * page_view;
    pages = Math.ceil(total/view);
    end = (Math.floor((page-1) / page_view) + 1) * page_view;
    end = (end>pages) ? pages : end;

    prev = (start > 0) ? start : 1;
    next = ((end+1) > pages) ? pages : end+1;

    ffolder = (ffolder) ? 'ffolder' : 'all';

    var str = '\
    <ul class="pagination pagination-sm" data-pages="'+pages+'">\
        <li><a href="javascript:;" onclick="resourceGetPage(' + prev + ')">&laquo;</a></li>\
    ';
    for(i=start;i<end;i++) {
        active = ((i+1)==page) ? "active" : "";
        str = str + '\
        <li class="' + active + '"><a href="javascript:;" onclick="resourceGetPage(' + (i+1) + ')">' + (i+1) + '</a></li>\
        ';
    }
    str = str + '\
        <li><a href="javascript:;" onclick="resourceGetPage(' + next+ ')">&raquo;</a></li>\
    </ul>\
    ';
    if(total) $('.resource-paging').append(str);
}

var initResource = function () {
    $('#progress .progress-bar').css('width', '0%');
    $('.selected-files').empty();
    //$('#resource-files').html('');
    $('.resource-useit').removeClass('active');
    $('.fr-selected-files').empty();
    $('.fr-storage .imgs').removeClass('ui-selected');
}
var resourceFileTag = function (source, seq, path, selected, ffolder, page, origname, filesize, magic) {
    active = ($.inArray(source,selected)>-1) ? " ui-selected" : "";
    var image = (magic == '') ? path + '/800/' + source : magic;
    var control_box = '<ul data-ffolder="'+ffolder+'" data-page="'+page+'" data-source="'+source+'" data-seq="'+seq+'" data-fsize="'+filesize+'">\
        <li><i class="fa fa-search resource-file-search" aria-hidden="true"></i></li>\
        <li><a href="' + path + '/' + source + '" target="_blank" alt="' + source + '" download="'+origname+'"><i class="fa fa-download" aria-hidden="true"></i></a></li>\
        <li><i class="fa fa-trash-o resource-file-delete" aria-hidden="true"></i></li>\
    </ul>\
    ';
    // <span class="resource-file-delete" data-page="' + page + '">&times;</span> //20160908
    var $item = $("<div class='fitem" + active + "'></div>"),
        $img = $('<div class="resource-image"><img src="' + image + '" alt="' + source + '"></div><div class="control-area">'+control_box+'</div>');

    $item.append($img);
    $item.append('<p class="resource-file-name" data-seq="' + seq + '" data-source="' + source + '" data-magic="' + magic + '">' + origname + '</p><p class="resource-file-size">'+filesize+'</p>');
    // $li.append('<p class="resource-file-name" data-seq="' + seq + '" data-source="' + source + '">' + origname + '</p><span class="resource-file-delete" data-page="' + page + '">&times;</span>'); //20160908
    return $item;
}

var resetFolderInfo = function(count, size, ffolder, state) {
    if(ffolder!='all' ||  ffolder=='all' && state!='move' ) {
        var flc = $('#nestableFolder .fli[data-id="'+ ffolder +'"]').find('.dd-flc').attr('attr-count'),
            fls = $('#nestableFolder .fli[data-id="'+ ffolder +'"]').find('.dd-fls').attr('attr-size'),
            fls_u = $('#nestableFolder .fli[data-id="'+ ffolder +'"]').find('.dd-fls').attr('attr-size-unit');

        fls = parseInt(fls);
        fls_v = (parseInt((fls+size)/1024) > 0 ) ? (fls+size)/1024 : fls+size;
        fls_u = (parseInt((fls+size)/1024) > 0 ) ? "MB" : "KB";

        $('#nestableFolder .fli[data-id="'+ ffolder +'"]').find('.dd-flc').attr('attr-count', parseInt(flc)+count ).text(parseInt(flc)+count);
        $('#nestableFolder .fli[data-id="'+ ffolder +'"]').find('.dd-fls').attr({'attr-size':fls+size, 'attr-size-unit':fls_u}).text(parseInt(fls_v));
    }
}
var myStorageActive = function() {
    return ($('#mystorage').hasClass('active')) ? true : false;
}


var frStorageUpload = function(v,w,id) {
    var deferred = $.Deferred(),
        id = (typeof id != 'undefined' && id) ? id : $('li[data-source="' + v + '"]').attr('data-id');

    var ex = v.split("|"),
        s = [];
    if(ex.length>1) {
        $.each(ex, function(i,d) {
            s[i] = $('li[data-source="' + d + '"]').attr('data-id');
        });
    } else {
        s[0] = id;
    }
    var ids = s.join("|");

    $.ajax({
        type : 'post',
        url: '/template/frstorage/upload',
        data: { img : v, sid : SID, w : w, ids : ids },
        dataType: 'json',
        async: true,
        success: function (data) {
            $.processOFF();
            if(data.error) { 
                alert(data.error);
                return false;
            }
            deferred.resolve(data);
        }
    });
    return deferred.promise();
}




var addrSearchModal = function(input_mode) {
    if(typeof input_mode == "undefined" || input_mode.length == 0)  input_mode = 'input';

    if($('script[src="https://ssl.daumcdn.net/dmaps/map_js_init/postcode.v2.js"]').length === 0) {
        $.getScript('https://ssl.daumcdn.net/dmaps/map_js_init/postcode.v2.js')
            .done(function() { 
                $('head').append('<script src="https://ssl.daumcdn.net/dmaps/map_js_init/postcode.v2.js"></script>'); 
                // $('head').append('<script src="http://dmaps.daum.net/map_js_init/postcode.v2.js?autoload=false"></script>'); 
                setTimeout(function() { addrSearchModal(input_mode); }, 500);
            }).fail(function() { console.log('daum maps script fail'); });
    } else {

        if($('#addr-modal').length === 0) {
            var add_position = ($('.mall-mypage-wrap').length > 0) ? $('.mall-mypage-wrap') : $('body'),
                as_backdrop = '<div class="addr-modal-backdrop" style="display: none;"></div>';
                as_modal = '<div id="addr-modal" style="display: none;">\
                                <div class="close">\
                                    주소 찾기\
                                    <div id="btn-addr-close"><img src="https://storage.googleapis.com/i.addblock.net/fa-close-modal.png" alt="close"></div>\
                                </div>\
                                <div id="addr-body"></div>\
                            </div>';

            add_position.append(as_backdrop + as_modal);
        } else {
            $('#addr-body').html('');
        }


        $(document).on('click','#btn-addr-close, .addr-modal-backdrop', function() {
            $('#addr-modal').fadeOut(300);
            $('.addr-modal-backdrop').fadeOut(300, function() { $(this).removeClass('in'); });
        });



        // Internet Explorer 6-11
        var isIE = /*@cc_on!@*/false || !!document.documentMode;

        if(isIE && input_mode == 'my-input') {

            daum.postcode.load(function(){
                new daum.Postcode({
                    oncomplete: function(data) {
                        var addr = ''; // 주소 변수
                        var extraAddr = ''; // 참고항목 변수

                        if (data.userSelectedType === 'R') { // 사용자가 도로명 주소를 선택했을 경우
                            addr = data.roadAddress;
                        } else { // 사용자가 지번 주소를 선택했을 경우(J)
                            addr = data.jibunAddress;
                        }

                        if(data.userSelectedType === 'R'){
                            if(data.bname !== '' && /[동|로|가]$/g.test(data.bname)){
                                extraAddr += data.bname;
                            }

                            if(data.buildingName !== '' && data.apartment === 'Y'){
                                extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                            }

                            if(extraAddr !== ''){
                                extraAddr = ' (' + extraAddr + ')';
                            }
                        }

                        $('#'+input_mode+"-postcode").attr('value',data.zonecode);
                        $('#'+input_mode+"-addr1").attr('value',addr+extraAddr).addClass('has-value');

                        setTimeout(function() {
                            $('#'+input_mode+"-addr2").focus();
                        },200);

                    },
                    width : '100%',
                    height : '100%',
                    maxSuggestItems : 5
                }).open();
            });

        } else {


            daum.postcode.load(function(){
                new daum.Postcode({
                    oncomplete: function(data) {
                        var addr = ''; // 주소 변수
                        var extraAddr = ''; // 참고항목 변수

                        if (data.userSelectedType === 'R') { // 사용자가 도로명 주소를 선택했을 경우
                            addr = data.roadAddress;
                        } else { // 사용자가 지번 주소를 선택했을 경우(J)
                            addr = data.jibunAddress;
                        }

                        if(data.userSelectedType === 'R'){
                            if(data.bname !== '' && /[동|로|가]$/g.test(data.bname)){
                                extraAddr += data.bname;
                            }

                            if(data.buildingName !== '' && data.apartment === 'Y'){
                                extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                            }

                            if(extraAddr !== ''){
                                extraAddr = ' (' + extraAddr + ')';
                            }
                        }

                        $('#'+input_mode+"-postcode").attr('value',data.zonecode);
                        $('#'+input_mode+"-addr1").attr('value',addr+extraAddr).addClass('has-value');  
                        $('#addr-modal').fadeOut(300);
                        $('.addr-modal-backdrop').fadeOut(300, function() { $(this).removeClass('in'); });

                        setTimeout(function() {
                            $('#'+input_mode+"-addr2").focus();
                        },200);

                    },
                    width : '100%',
                    height : '100%',
                    maxSuggestItems : 5
                }).embed(document.getElementById('addr-body'));

                $('#addr-modal').fadeIn(300);
                $('.addr-modal-backdrop').fadeIn(300, function() { $(this).addClass('in'); });
            });

        }
    }
}
var stickyToolbar = function() {
    if($('.gallery-header').length == 0) return;
    var sticky = $('.gallery-header').offset().top;
    if($('.gallery-header').outerHeight() + sticky < 0) { 
        $('.gallery-modal .toolbar, .gallery-modal .table-col').addClass('sticky');
    } else {
        $('.gallery-modal .toolbar, .gallery-modal .table-col').removeClass('sticky');
    }
}            

var saveGalleryBlockName = function($this,blockname) {
    var blockID = $this.parents('.gallery-name').attr('data-gallery-id');
    if(typeof blockID == "undefined" || !blockID) {
        $this.showModalFlat('ERROR',$.lang[LANG]['board.error-setting-value'],true,false,'','ok');
        return false;
    }

    var bookmark_list = (typeof SETTINGS.blockBookmarkList != 'undefined' && SETTINGS.blockBookmarkList) ? SETTINGS.blockBookmarkList : {},
        isBookmark = (typeof bookmark_list['bookmark'+blockID] != 'undefined' && bookmark_list['bookmark'+blockID]) ? true : false,
        before_bookmark_name_arr = [],
        blockname_list = (typeof SETTINGS.blocknameList != 'undefined' && SETTINGS.blocknameList) ? SETTINGS.blocknameList : {},
        regex = /[\{\}\[\]\/!?.,;:|\)*~`^\-_+<>@\#$%&\\\=\(\'\"]/gi,
        err_str = '', 
        isUpdate = false;

    if(!$.isEmptyObject(bookmark_list)) { // 이전 bookmark name 설정한 블럭 이름 포함
        $.each(bookmark_list, function(k,v) { 
            if(typeof blockname_list[k.replace('bookmark','blockname')] == 'undefined') {
                before_bookmark_name_arr.push(v);
            }
        });
    }

    var blockname_list_arr = (!$.isEmptyObject(blockname_list)) ? Object.keys(blockname_list).map(function(e) { return blockname_list[e]; }) : new Array();

    if(typeof blockname_list['blockname'+blockID] != 'undefined' && blockname_list['blockname'+blockID] == blockname) {
        $('.blockname-edit').remove();
        return false;
    } else if (blockname.length == 0 || blockname.length > 20) {
        err_str = $.lang[LANG]['config.blockinfo.name.length'];
    } else if (regex.test(blockname)) {
        err_str = $.lang[LANG]['config.blockinfo.name.specialchar'];
    } else if ($.inArray(blockname,blockname_list_arr) > -1 || $.inArray(blockname,before_bookmark_name_arr) > -1) {
        err_str = $.lang[LANG]['config.blockinfo.name.overlap'];
    } else {
        isUpdate = true;
    }

    if(err_str.length > 0 ) {
        $this.showModalFlat('ERROR',err_str,true,false,'','ok');
    } else {
        $this.parents('.gallery-name').find('.gallery-block-name').text(blockname);
        $this.parents('.gallery-name-edit-input').remove();
        if($.gallery.block_id == blockID) {
            $('#gallery-name').text(blockname);
        }
    }

    if(!isUpdate) return false;
    blocknameUpdate(SID,blockID,blockname);
    blocknameListUpdate('update',SID,blockID,blockname);
    if(isBookmark) blockBookmarkListUpdate('update',SID,blockID,blockname);

}

var galleryStatusInit = function() {
    $('.gallery-items > div').removeClass('active ui-selected').find('input').prop('checked','');
    // $('.table-toolbar > li').addClass('disabled').find('i[data-cmd="visible"]').text('숨김');
    $('.table-toolbar > li').find('i[data-cmd="visible"]').text('숨김');
    $('.gallery-toolbar .toolbar.mod-gallery').remove();
}

var resizeGalleryModal = function() {
    var w = $('.gallery-modal')[0]['clientWidth'],
        $c = $('.gallery-items'),
        t = ($('.gallery-modal').hasClass('shopping')) ? true : false,
        g = (t) ? 1124 : 1146,
        p = ((w-g) > 0) ? (w-g)/2 : 0;
    $c.css('padding','0 ' + p + 'px');
}

var shoppingSetOption = function() {
    if($('.prod-option-item.hide').length) {
        var $o = $('.prod-option-item.hide'),
            $t = $o.parent().find('.prod-option-edit input');

        var $title = $t.parents('.form-wrap').find('.edit-option-title input'),
            $price = $t.parents('.form-wrap').find('.edit-option-price input'),
            $quantity = $t.parents('.form-wrap').find('.edit-option-quantity input'),
            $status = $t.parents('.form-wrap').find('.option-price-status-str');

        var price = $price.val(), quantity = $quantity.val();
        if (!price) price = 0;
        if (!quantity) quantity = 0;

        quantity = quantity.replace(/,/gi,'');

        price = (price * 1);
        quantity = (quantity * 1);

        $t.parents('li').find('.prod-option-title').text($title.val());
        $t.parents('li').find('.prod-option-price').text(price);
        $t.parents('li').find('.prod-option-quantity').text(number_format(quantity));
        $t.parents('li').find('.prod-option-status').text($status.text());

        if($title.val().trim().length == 0) {
            $t.parents('.form-wrap').addClass('err');
            return false;
        }
        if($quantity.val() == '') $t.parents('li').find('.prod-option-quantity').text('0');
        if($('.switch-quantity').is(':checked') == true && $t.parents('li').find('.prod-option-quantity').text() == '0') {
            $t.parents('li').find('.option-price-status-str').attr('data-val','O').text('품절');
            $t.parents('li').find('.prod-option-status').attr('data-val','O').text('품절');
        }
        $t.parents('.prod-option-edit').hide();
        $t.parents('li').find('.prod-option-item').removeClass('hide');
        return true;
    }
}

var siteConfigOthersCheckModal = function(sid,check_id,check_uadmin,success_callback,cancel_callback) {

    var config_url = (check_uadmin) ? '/_config' : '/config',
        check_data = {
            'id': check_id,
            'edit': check_uadmin,
            'step': 'check'
        };

    $.post('/umember/login/others', {
        'sid': sid,
        'data': JSON.stringify(check_data)
    }, function(data) {

        if(typeof data.error != "undefined" && data.error) {
            $(this).showModalFlat("ERROR", data.error, true, false, '', 'close');
            return false;
        }


        if(typeof success_callback == "undefined" || !success_callback) {
            success_callback = function() { location.href = config_url; };

        }

        if(!data.result) {
            success_callback();
        } else {
            var o_id = data.others_id,
                str = o_id + $.lang[LANG]['config.modal.others-login.1'] + o_id + $.lang[LANG]['config.modal.others-login.2'],
                checkOtherLoginModal = $(this).showModalFlat('INFORMATION', str, true, true, function() {
                    $.processON('Other Login Disconnecting...');

                    var set_data = check_data;
                    set_data['step'] = 'set';

                    $.ajax({
                        type: 'POST',
                        url: '/umember/login/others',
                        data: { sid: SID, data: JSON.stringify(set_data) },
                        dataType: 'json',
                        async: true,
                        success: function(data) {
                            setTimeout(function() {
                                $.processOFF();
                                success_callback();
                            }, 400);
                        }
                    });
                    
                }, 'cancel', 'ok', '', '', '', '', cancel_callback);
        }

    }, 'json');

}

var getServeImage = function(f,w,path) {
    if(f == undefined) return;
    var r = '';
    if(typeof w === 'number') w = String(w);
    if(f.indexOf('googleusercontent') > -1) {
        var n = f.indexOf('=');
        f = f.substring(0, n != -1 ? n : f.length);
        switch(w) {
            case "0"      : r = f + '=s0';            break;
            case "60"     : r = f + '=w60-h60-n';     break;
            case "250"    : r = f + '=w250-h250-n';   break;
            case "300"    : r = f + '=w300-h300-n';   break;
            case "600"    : r = f + '=w600-h600-n';   break;
            case "650"    : r = f + '=w650-h370-n';   break;
            case "670"    : r = f + '=w670-h980-n';   break;
            case "700"    : r = f + '=w700-h500-n';   break;
            case "800"    : r = f + '=w800';          break;
            case "1920"   :
                $.ajax({
                    type: 'POST',
                    url: '/template/image',
                    data: { url : f, width : w },
                    dataType: 'json',                    
                    async: false,
                    success: function(data) {
                        if(typeof data.s800 != 'undefined') {
                            if(w == "800")
                                r = (Number(data.s800) > 2560) ? f + '=s0' : f + '=w800-h' + data.s800 + '-n';
                            if(w == "1920")
                                r = (Number(data.s1920) > 2560) ? f + '=s0' : f + '=w1920-h' + data.s1920 + '-n';
                        } else r = f;
                    }
                });
                break;
            default       : r = f;                    break;
        }
    } else {
        path = (path.slice(-1) == '/') ? path : path + '/';
        r = (f.indexOf('http:') > -1) ? f : (w == "0" || w == "") ? path + f : path + w + '/' + f;
    }
    return r;
}

Date.prototype.format = function (f) {
    if (!this.valueOf()) return " ";

    var weekName = ["일요일", "월요일", "화요일", "수요일", "목요일", "금요일", "토요일"];
    var d = this;
    
    return f.replace(/(yyyy|yy|MM|dd|E|hh|mm|ss|a\/p)/gi, function(da) {
        switch (da) {
            case "yyyy": return d.getFullYear();
            case "yy": return (d.getFullYear() % 1000).zf(2);
            case "MM": return (d.getMonth() + 1).zf(2);
            case "dd": return d.getDate().zf(2);
            case "E": return weekName[d.getDay()];
            case "HH": return d.getHours().zf(2);
            case "hh": return ((h = d.getHours() % 12) ? h : 12).zf(2);
            case "mm": return d.getMinutes().zf(2);
            case "ss": return d.getSeconds().zf(2);
            case "a/p": return d.getHours() < 12 ? "오전" : "오후";
            default: return da;
        }
    });
};

String.prototype.string = function(len){var s = '', i = 0; while (i++ < len) { s += this; } return s;};
String.prototype.zf = function(len){return "0".string(len - this.length) + this;};
Number.prototype.zf = function(len){return this.toString().zf(len);};

$(function () {
    $(document).on('change', '.review-checkbox-check', function () {
        if ($(this).is(':checked') === true) {
            $('.photo-review-tab').css('display', 'block');
        } else {
            $('.photo-review-tab').css('display', 'none');
        }
    });

    $(document).on('click','.btn-fblogin.btn-warning', function(e) {
        var facebook_disabled_str = '\
        <div class="text-left" style="padding: 20px 15px;"><br>\
        ' + $.lang[LANG]['config.modal.fblogin.error.1'] + '\
            <ol style="padding-inline-start: 15px; margin-top: 10px; line-height: 2;">\
            ' + $.lang[LANG]['config.modal.fblogin.error.2'] + '\
            </ol>\
        ' + $.lang[LANG]['config.modal.fblogin.error.3'] + '\
        </div>';

        $(this).showModalFlat('INFORMATION',facebook_disabled_str,true,false,'','ok','','w555');
    });



    $(document).on('click', '#etc-start-date', function () {
        $('.cl_etc_date_time').each(function () {
            $(this).removeClass('active');
        });
        if ($(this).hasClass('active') == true) {
            $('#etc-start-date-picker').css('display', 'none');
            $(this).removeClass('active');
        } else {
            $('#etc-start-date-picker').css('display', 'block');
            $(this).addClass('active');
        }

        $('#select-calendar').val('etc-start-date');
        $('#etc-end-date-picker').css('display', 'none');
        startPicker.generateDates();
        var i = 0;
        var width = 0;
        $('#etc-end-date-picker .Datepickk .d-table input + label').each(function () {
            if (i == 0) width = $(this).width();
            $(this).css('height', width+'px');
            i++;
        });
        var i = 0;
        var width = 0;
        $('#etc-start-date-picker .Datepickk .d-table input + label').each(function () {
            if (i == 0) width = $(this).width();
            $(this).css('height', width+'px');
            i++;
        });
    });

    $(document).on('click', '#etc-end-date', function () {
        $('.cl_etc_date_time').each(function () {
            $(this).removeClass('active');
        });

        if ($(this).hasClass('active') == true) {
            $('#etc-start-date-picker').css('display', 'none');
            $('#etc-end-date-picker').css('display', 'none');
            $(this).removeClass('active');
        } else {
            $('#etc-start-date-picker').css('display', 'none');
            $('#etc-end-date-picker').css('display', 'block');
            $(this).addClass('active');
        }

        $('#select-calendar').val('etc-end-date');
        endPicker.generateDates();
        var i = 0;
        var width = 0;
        $('#etc-end-date-picker .Datepickk .d-table input + label').each(function () {
            if (i == 0) width = $(this).width();
            $(this).css('height', width+'px');
            i++;
        });
        var i = 0;
        var width = 0;
        $('#etc-start-date-picker .Datepickk .d-table input + label').each(function () {
            if (i == 0) width = $(this).width();
            $(this).css('height', width+'px');
            i++;
        });
    });

    $(document).on('keypress', '#email-add-input', function (e) {
        if (e.keyCode == 44 || e.keyCode == 13) {
            e.preventDefault();
            var regExp = /^[0-9a-zA-Z]([-_\.]?[0-9a-zA-Z])*@[0-9a-zA-Z]([-_\.]?[0-9a-zA-Z])*\.[a-zA-Z]{2,3}$/i;

            var val = $(this).val();
            if (val == '') return false;
            var email = regExp.test(val);
            var emailCheck = (email) ? '' : 'none';
            var html = '<div class="email-box '+emailCheck+'">'+val+'<span class="email-box-delt"><svg viewBox="0 0 8 8"><polygon points="8 0.71 7.29 0 4 3.29 0.71 0 0 0.71 3.29 4 0 7.29 0.71 8 4 4.71 7.29 8 8 7.29 4.71 4 "/></svg></span></div>';

            $(this).before(html);

            var boxWidth = $('.email-add-box .email-box:nth-last-child(2)').innerWidth();
            var textWidth = $(this).innerWidth(),
                uni = 'px';

            var totalWidth = (textWidth - boxWidth) - 10;

            if (totalWidth <= 40) {
                totalWidth = 100;
                uni = '%'
            }

            $(this).css('width', totalWidth+uni);
            $(this).val('');
        }
    });

    $(document).on('click', '.email-box-delt', function () {
        $(this).parent().remove();

        var boxWidth = 0;
        $('.email-add-box .email-box').each(function () {
            boxWidth += $(this).innerWidth() + 10;
        });
        var textWidth = $('#email-add-input').parent().innerWidth() - 20,
            uni = 'px';

        var totalWidth = textWidth - boxWidth;
        
        if (totalWidth <= 40) {
            totalWidth = 100;
            uni = '%'
        }

        $('#email-add-input').css('width', totalWidth+uni);
        $('#email-add-input').val('');
    });

    if ($('#email-line-box').length > 0) {
        var name = $('#email-line-box').attr('name');
        var className = $('#email-line-box').attr('class');
        var value = $('#email-line-box').val();

        var emailList = value.split(',');

        var html = '\
            <input type="hidden" id="email-line-box" name="'+name+'" class="'+className+'" value="'+value+'">\
            <div class="email-add-box">\
                <textarea id="email-add-input"></textarea>\
            </div>\
        ';
        $('#email-line-box').before(html);

        var html = '';
        if (emailList.length >= 1) {
            if (emailList[0] != '') {
                for (var i=0;i<emailList.length;i++) {
                    html += '<div class="email-box">'+emailList[i]+'<span class="email-box-delt"><svg viewBox="0 0 8 8"><polygon points="8 0.71 7.29 0 4 3.29 0.71 0 0 0.71 3.29 4 0 7.29 0.71 8 4 4.71 7.29 8 8 7.29 4.71 4 "/></svg></span></div>'
                }

                $('#email-add-input').before(html);
                var boxWidth = 0;
                $('.email-add-box .email-box').each(function () {
                    boxWidth += $(this).innerWidth() + 10;
                });
                var textWidth = $('#email-add-input').parent().innerWidth() - 20,
                    uni = 'px';

                var totalWidth = textWidth - boxWidth;

                if (totalWidth <= 40) {
                    totalWidth = 100;
                    uni = '%'
                }

                $('#email-add-input').css('width', totalWidth+uni);
            }
        }
        $('#email-line-box').remove();
    }
});

function emailLineFunc () {
    if ($('.email-box.none').length > 0) {
        alert('옳바르지 않은 이메일 주소가 포함되어있습니다.');
        return false;
    }
    var value = [], emailText = '';
    $('.email-box').each(function (i) {
        value[i] = $(this).text();
    });
    emailText = value.join(',');
    $('#email-line-box').val(emailText);
    return true;
}


function division (option, n) {
    var arr = option;
    var len = arr.length;
    var cnt = Math.floor(len / n) + (Math.floor(len % n) > 0 ? 1 : 0);
    var tmp = [];

    for (var i=0;i<cnt;i++) {
        tmp.push(arr.splice(0, n));
    }

    return tmp;
}